cscope 15 $HOME/leveldb -q 0000002021 0000376216
	@db/builder.cc

5 
	~"db/bud”.h
"

7 
	~"db/f’ame.h
"

8 
	~"db/dbfÜm©.h
"

9 
	~"db/bË_ÿche.h
"

10 
	~"db/v”siÚ_ed™.h
"

11 
	~"Ëv–db/db.h
"

12 
	~"Ëv–db/’v.h
"

13 
	~"Ëv–db/™”©Ü.h
"

15 
Çme¥aû
 
	gËv–db
 {

17 
Stus
 
BudTabË
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
,

18 
Env
* 
’v
,

19 cÚ¡ 
O±iÚs
& 
İtiÚs
,

20 
TabËCache
* 
bË_ÿche
,

21 
I‹¿tÜ
* 
™”
,

22 
FeM‘aD©a
* 
m‘a
,

23 
V”siÚEd™
* 
ed™
) {

24 
Stus
 
	gs
;

25 
	gm‘a
->
	gfe_size
 = 0;

26 
	g™”
->
S“kToFœ¡
();

28 
	g¡d
::
¡ršg
 
âame
 = 
TabËFeName
(
dbÇme
, 
m‘a
->
numb”
);

29 ià(
	g™”
->
V®id
()) {

30 
Wr™abËFe
* 
	gfe
;

31 
	gs
 = 
’v
->
NewWr™abËFe
(
âame
, &
fe
);

32 ià(!
	gs
.
ok
()) {

33  
	gs
;

36 
TabËBud”
* 
	gbud”
 = 
Ãw
 TabËBud”(
İtiÚs
, 
fe
);

37 
	gm‘a
->
	gsm®Ë¡
.
DecodeFrom
(
™”
->
key
());

38 ; 
	g™”
->
V®id
(); i‹r->
Next
()) {

39 
Sliû
 
	gkey
 = 
™”
->
key
();

40 
	gm‘a
->
	gÏrge¡
.
DecodeFrom
(
key
);

41 
	gbud”
->
Add
(
key
, 
™”
->
v®ue
());

45 ià(
	gs
.
ok
()) {

46 
	gs
 = 
bud”
->
Fšish
();

47 ià(
	gs
.
ok
()) {

48 
	gm‘a
->
	gfe_size
 = 
bud”
->
FeSize
();

49 
as£¹
(
m‘a
->
fe_size
 > 0);

52 
	gbud”
->
AbªdÚ
();

54 
d–‘e
 
	gbud”
;

57 ià(
	gs
.
ok
()) {

58 
	gs
 = 
fe
->
Sync
();

60 ià(
	gs
.
ok
()) {

61 
	gs
 = 
fe
->
Clo£
();

63 
d–‘e
 
	gfe
;

64 
	gfe
 = 
NULL
;

66 ià(
	gs
.
ok
()) {

68 
I‹¿tÜ
* 
	g™
 = 
bË_ÿche
->
NewI‹¿tÜ
(
R—dO±iÚs
(),

69 
m‘a
->
numb”
,

70 
m‘a
->
fe_size
);

71 
	gs
 = 
™
->
¡©us
();

72 
d–‘e
 
	g™
;

77 ià(!
	g™”
->
¡©us
().
ok
()) {

78 
	gs
 = 
™”
->
¡©us
();

81 ià(
	gs
.
ok
(è&& 
	gm‘a
->
	gfe_size
 > 0) {

82 
	ged™
->
AddFe
(0, 
m‘a
->
numb”
, m‘a->
fe_size
,

83 
m‘a
->
sm®Ë¡
, m‘a->
Ïrge¡
);

85 
	g’v
->
D–‘eFe
(
âame
);

87  
	gs
;

	@db/builder.h

5 #iâdeà
STORAGE_LEVELDB_DB_BUILDER_H_


6 
	#STORAGE_LEVELDB_DB_BUILDER_H_


	)

8 
	~"Ëv–db/¡©us.h
"

10 
Çme¥aû
 
	gËv–db
 {

12 
	gO±iÚs
;

13 
	gFeM‘aD©a
;

15 
şass
 
	gEnv
;

16 
şass
 
	gI‹¿tÜ
;

17 
şass
 
	gTabËCache
;

18 
şass
 
	gV”siÚEd™
;

26 
Stus
 
BudTabË
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
,

27 
Env
* 
’v
,

28 cÚ¡ 
O±iÚs
& 
İtiÚs
,

29 
TabËCache
* 
bË_ÿche
,

30 
I‹¿tÜ
* 
™”
,

31 
FeM‘aD©a
* 
m‘a
,

32 
V”siÚEd™
* 
ed™
);

	@db/corruption_test.cc

5 
	~"Ëv–db/db.h
"

7 
	~<”ºo.h
>

8 
	~<fú.h
>

9 
	~<sys/¡©.h
>

10 
	~<sys/ty³s.h
>

11 
	~"Ëv–db/ÿche.h
"

12 
	~"Ëv–db/’v.h
"

13 
	~"Ëv–db/bË.h
"

14 
	~"Ëv–db/wr™e_b©ch.h
"

15 
	~"db/db_im¶.h
"

16 
	~"db/f’ame.h
"

17 
	~"db/log_fÜm©.h
"

18 
	~"db/v”siÚ_£t.h
"

19 
	~"ut/loggšg.h
"

20 
	~"ut/‹¡h¬Ãss.h
"

21 
	~"ut/‹¡ut.h
"

23 
Çme¥aû
 
	gËv–db
 {

25 cÚ¡ 
	gkV®ueSize
 = 1000;

27 şas 
	cCÜru±iÚTe¡
 {

28 
	gpublic
:

29 
‹¡
::
E¼ÜEnv
 
’v_
;

30 
Rªdom
 
	gºd_
;

31 
	g¡d
::
¡ršg
 
dbÇme_
;

32 
Cache
* 
	gtšy_ÿche_
;

33 
O±iÚs
 
	gİtiÚs_
;

34 
DB
* 
	gdb_
;

36 
CÜru±iÚTe¡
(è: 
ºd_
(
‹¡
::
RªdomS“d
()) {

37 
tšy_ÿche_
 = 
NewLRUCache
(100);

38 
	gİtiÚs_
.
	g’v
 = &
’v_
;

39 
	gdbÇme_
 = 
‹¡
::
TmpDœ
() + "/db_test";

40 
De¡royDB
(
dbÇme_
, 
İtiÚs_
);

42 
	gdb_
 = 
NULL
;

43 
	gİtiÚs_
.
	gü—‹_if_missšg
 = 
Œue
;

44 
Reİ’
();

45 
	gİtiÚs_
.
	gü—‹_if_missšg
 = 
çl£
;

48 ~
CÜru±iÚTe¡
() {

49 
d–‘e
 
	gdb_
;

50 
De¡royDB
(
dbÇme_
, 
O±iÚs
());

51 
d–‘e
 
	gtšy_ÿche_
;

54 
Stus
 
TryReİ’
(
O±iÚs
* 
İtiÚs
 = 
NULL
) {

55 
d–‘e
 
db_
;

56 
	gdb_
 = 
NULL
;

57 
O±iÚs
 
	gİt
 = (
İtiÚs
 ? *İtiÚ : 
İtiÚs_
);

58 
	gİt
.
	g’v
 = &
’v_
;

59 
	gİt
.
	gblock_ÿche
 = 
tšy_ÿche_
;

60  
	gDB
::
O³n
(
İt
, 
dbÇme_
, &
db_
);

63 
Reİ’
(
O±iÚs
* 
İtiÚs
 = 
NULL
) {

64 
ASSERT_OK
(
TryReİ’
(
İtiÚs
));

67 
R•aœDB
() {

68 
d–‘e
 
	gdb_
;

69 
	gdb_
 = 
NULL
;

70 
ASSERT_OK
(::
Ëv–db
::
R•aœDB
(
dbÇme_
, 
İtiÚs_
));

73 
Bud
(
n
) {

74 
	g¡d
::
¡ršg
 
key_¥aû
, 
	gv®ue_¥aû
;

75 
Wr™eB©ch
 
	gb©ch
;

76 
	gi
 = 0; i < 
	gn
; i++) {

78 
Sliû
 
	gkey
 = 
Key
(
i
, &
key_¥aû
);

79 
	gb©ch
.
CË¬
();

80 
	gb©ch
.
Put
(
key
, 
V®ue
(
i
, &
v®ue_¥aû
));

81 
ASSERT_OK
(
db_
->
Wr™e
(
Wr™eO±iÚs
(), &
b©ch
));

85 
Check
(
mš_ex³ùed
, 
max_ex³ùed
) {

86 
	gÃxt_ex³ùed
 = 0;

87 
	gmis£d
 = 0;

88 
	gbad_keys
 = 0;

89 
	gbad_v®ues
 = 0;

90 
	gcÜ»ù
 = 0;

91 
	g¡d
::
¡ršg
 
v®ue_¥aû
;

92 
I‹¿tÜ
* 
	g™”
 = 
db_
->
NewI‹¿tÜ
(
R—dO±iÚs
());

93 
	g™”
->
S“kToFœ¡
(); i‹r->
V®id
(); i‹r->
Next
()) {

94 
ušt64_t
 
	gkey
;

95 
Sliû
 
š
(
™”
->
key
());

96 ià(!
CÚsumeDecim®Numb”
(&
š
, &
key
) ||

97 !
	gš
.
em±y
() ||

98 
	gkey
 < 
	gÃxt_ex³ùed
) {

99 
	gbad_keys
++;

102 
	gmis£d
 +ğ(
key
 - 
Ãxt_ex³ùed
);

103 
	gÃxt_ex³ùed
 = 
key
 + 1;

104 ià(
	g™”
->
v®ue
(è!ğ
V®ue
(
key
, &
v®ue_¥aû
)) {

105 
	gbad_v®ues
++;

107 
	gcÜ»ù
++;

110 
d–‘e
 
	g™”
;

112 
årštf
(
¡d”r
,

114 
mš_ex³ùed
, 
max_ex³ùed
, 
cÜ»ù
, 
bad_keys
, 
bad_v®ues
, 
mis£d
);

115 
ASSERT_LE
(
mš_ex³ùed
, 
cÜ»ù
);

116 
ASSERT_GE
(
max_ex³ùed
, 
cÜ»ù
);

119 
CÜru±
(
FeTy³
 
f‘y³
, 
off£t
, 
by‹s_to_cÜru±
) {

121 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
f’ames
;

122 
ASSERT_OK
(
’v_
.
G‘Chd»n
(
dbÇme_
, &
f’ames
));

123 
ušt64_t
 
	gnumb”
;

124 
FeTy³
 
	gty³
;

125 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
ÿndid©es
;

126 
	gi
 = 0; i < 
	gf’ames
.
size
(); i++) {

127 ià(
P¬£FeName
(
f’ames
[
i
], &
numb”
, &
ty³
) &&

128 
	gty³
 =ğ
f‘y³
) {

129 
ÿndid©es
.
push_back
(
dbÇme_
 + "/" + 
f’ames
[
i
]);

132 
ASSERT_TRUE
(!
ÿndid©es
.
em±y
()è<< 
	gf‘y³
;

133 
	g¡d
::
¡ršg
 
âame
 = 
ÿndid©es
[
ºd_
.
UnifÜm
(ÿndid©es.
size
())];

135 
¡©
 
	gsbuf
;

136 ià(
¡©
(
âame
.
c_¡r
(), &
sbuf
) != 0) {

137 cÚ¡ * 
msg
 = 
¡»¼Ü
(
”ºo
);

138 
ASSERT_TRUE
(
çl£
è<< 
	gâame
 << ": " << 
	gmsg
;

141 ià(
	goff£t
 < 0) {

143 ià(-
	goff£t
 > 
	gsbuf
.
	g¡_size
) {

144 
	goff£t
 = 0;

146 
	goff£t
 = 
sbuf
.
¡_size
 + 
off£t
;

149 ià(
	goff£t
 > 
	gsbuf
.
	g¡_size
) {

150 
	goff£t
 = 
sbuf
.
¡_size
;

152 ià(
	goff£t
 + 
	gby‹s_to_cÜru±
 > 
	gsbuf
.
	g¡_size
) {

153 
	gby‹s_to_cÜru±
 = 
sbuf
.
¡_size
 - 
off£t
;

157 
	g¡d
::
¡ršg
 
cÚ‹Ás
;

158 
Stus
 
	gs
 = 
R—dFeToSŒšg
(
Env
::
DeçuÉ
(), 
âame
, &
cÚ‹Ás
);

159 
ASSERT_TRUE
(
s
.
ok
()è<< 
	gs
.
ToSŒšg
();

160 
	gi
 = 0; i < 
	gby‹s_to_cÜru±
; i++) {

161 
	gcÚ‹Ás
[
i
 + 
off£t
] ^= 0x80;

163 
	gs
 = 
Wr™eSŒšgToFe
(
Env
::
DeçuÉ
(), 
cÚ‹Ás
, 
âame
);

164 
ASSERT_TRUE
(
s
.
ok
()è<< 
	gs
.
ToSŒšg
();

167 
Prİ”ty
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
) {

168 
¡d
::
¡ršg
 
´İ”ty
;

169 
	g»suÉ
;

170 ià(
	gdb_
->
G‘Prİ”ty
(
Çme
, &
´İ”ty
) &&

171 
ssÿnf
(
´İ”ty
.
c_¡r
(), "%d", &
»suÉ
) == 1) {

172  
»suÉ
;

179 
Sliû
 
Key
(
i
, 
¡d
::
¡ršg
* 
¡Üage
) {

180 
buf
[100];

181 
¢´štf
(
buf
, (buf), "%016d", 
i
);

182 
	g¡Üage
->
assign
(
buf
, 
¡¾’
(buf));

183  
Sliû
(*
¡Üage
);

187 
Sliû
 
V®ue
(
k
, 
¡d
::
¡ršg
* 
¡Üage
) {

188 
Rªdom
 
r
(
k
);

189  
	g‹¡
::
RªdomSŒšg
(&
r
, 
kV®ueSize
, 
¡Üage
);

193 
	$TEST
(
CÜru±iÚTe¡
, 
Recov”y
) {

194 
	`Bud
(100);

195 
	`Check
(100, 100);

196 
	`CÜru±
(
kLogFe
, 19, 1);

197 
	`CÜru±
(
kLogFe
, 
log
::
kBlockSize
 + 1000, 1);

198 
	`Reİ’
();

201 
	`Check
(36, 36);

202 
	}
}

204 
	$TEST
(
CÜru±iÚTe¡
, 
Recov”Wr™eE¼Ü
) {

205 
’v_
.
wr™abË_fe_”rÜ_
 = 
Œue
;

206 
Stus
 
s
 = 
	`TryReİ’
();

207 
	`ASSERT_TRUE
(!
s
.
	`ok
());

208 
	}
}

210 
	$TEST
(
CÜru±iÚTe¡
, 
NewFeE¼ÜDuršgWr™e
) {

212 
’v_
.
wr™abË_fe_”rÜ_
 = 
Œue
;

213 cÚ¡ 
num
 = 3 + (
	`O±iÚs
().
wr™e_bufãr_size
 / 
kV®ueSize
);

214 
¡d
::
¡ršg
 
v®ue_¡Üage
;

215 
Stus
 
s
;

216 
i
 = 0; 
s
.
	`ok
(è&& i < 
num
; i++) {

217 
Wr™eB©ch
 
b©ch
;

218 
b©ch
.
	`Put
("a", 
	`V®ue
(100, &
v®ue_¡Üage
));

219 
s
 = 
db_
->
	`Wr™e
(
	`Wr™eO±iÚs
(), &
b©ch
);

221 
	`ASSERT_TRUE
(!
s
.
	`ok
());

222 
	`ASSERT_GE
(
’v_
.
num_wr™abË_fe_”rÜs_
, 1);

223 
’v_
.
wr™abË_fe_”rÜ_
 = 
çl£
;

224 
	`Reİ’
();

225 
	}
}

227 
	$TEST
(
CÜru±iÚTe¡
, 
TabËFe
) {

228 
	`Bud
(100);

229 
DBIm¶
* 
dbi
 = 
»š‹½»t_ÿ¡
<DBIm¶*>(
db_
);

230 
dbi
->
	`TEST_Com·ùMemTabË
();

231 
dbi
->
	`TEST_Com·ùRªge
(0, "", "~");

232 
dbi
->
	`TEST_Com·ùRªge
(1, "", "~");

234 
	`CÜru±
(
kTabËFe
, 100, 1);

235 
	`Check
(99, 99);

236 
	}
}

238 
	$TEST
(
CÜru±iÚTe¡
, 
TabËFeIndexD©a
) {

239 
	`Bud
(10000);

240 
DBIm¶
* 
dbi
 = 
»š‹½»t_ÿ¡
<DBIm¶*>(
db_
);

241 
dbi
->
	`TEST_Com·ùMemTabË
();

242 
dbi
->
	`TEST_Com·ùRªge
(0, "", "~");

243 
dbi
->
	`TEST_Com·ùRªge
(1, "", "~");

245 
	`CÜru±
(
kTabËFe
, -2000, 500);

246 
	`Reİ’
();

247 
	`Check
(5000, 9999);

248 
	}
}

250 
	$TEST
(
CÜru±iÚTe¡
, 
MissšgDesütÜ
) {

251 
	`Bud
(1000);

252 
	`R•aœDB
();

253 
	`Reİ’
();

254 
	`Check
(1000, 1000);

255 
	}
}

257 
	$TEST
(
CÜru±iÚTe¡
, 
Sequ’ûNumb”Recov”y
) {

258 
	`ASSERT_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), "foo", "v1"));

259 
	`ASSERT_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), "foo", "v2"));

260 
	`ASSERT_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), "foo", "v3"));

261 
	`ASSERT_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), "foo", "v4"));

262 
	`ASSERT_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), "foo", "v5"));

263 
	`R•aœDB
();

264 
	`Reİ’
();

265 
¡d
::
¡ršg
 
v
;

266 
	`ASSERT_OK
(
db_
->
	`G‘
(
	`R—dO±iÚs
(), "foo", &
v
));

267 
	`ASSERT_EQ
("v5", 
v
);

270 
	`ASSERT_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), "foo", "v6"));

271 
	`ASSERT_OK
(
db_
->
	`G‘
(
	`R—dO±iÚs
(), "foo", &
v
));

272 
	`ASSERT_EQ
("v6", 
v
);

273 
	`Reİ’
();

274 
	`ASSERT_OK
(
db_
->
	`G‘
(
	`R—dO±iÚs
(), "foo", &
v
));

275 
	`ASSERT_EQ
("v6", 
v
);

276 
	}
}

278 
	$TEST
(
CÜru±iÚTe¡
, 
CÜru±edDesütÜ
) {

279 
	`ASSERT_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), "foo", "hello"));

280 
DBIm¶
* 
dbi
 = 
»š‹½»t_ÿ¡
<DBIm¶*>(
db_
);

281 
dbi
->
	`TEST_Com·ùMemTabË
();

282 
dbi
->
	`TEST_Com·ùRªge
(0, "", "~");

284 
	`CÜru±
(
kDesütÜFe
, 0, 1000);

285 
Stus
 
s
 = 
	`TryReİ’
();

286 
	`ASSERT_TRUE
(!
s
.
	`ok
());

288 
	`R•aœDB
();

289 
	`Reİ’
();

290 
¡d
::
¡ršg
 
v
;

291 
	`ASSERT_OK
(
db_
->
	`G‘
(
	`R—dO±iÚs
(), "foo", &
v
));

292 
	`ASSERT_EQ
("h–lo", 
v
);

293 
	}
}

295 
	$TEST
(
CÜru±iÚTe¡
, 
Com·ùiÚIÅutE¼Ü
) {

296 
	`Bud
(10);

297 
DBIm¶
* 
dbi
 = 
»š‹½»t_ÿ¡
<DBIm¶*>(
db_
);

298 
dbi
->
	`TEST_Com·ùMemTabË
();

299 
	`ASSERT_EQ
(1, 
	`Prİ”ty
("leveldb.num-files-at-level0"));

301 
	`CÜru±
(
kTabËFe
, 100, 1);

302 
	`Check
(9, 9);

305 
	`Bud
(10000);

306 
	`Check
(10000, 10000);

307 
dbi
->
	`TEST_Com·ùRªge
(0, "", "~");

308 
	`ASSERT_EQ
(0, 
	`Prİ”ty
("leveldb.num-files-at-level0"));

309 
	}
}

311 
	$TEST
(
CÜru±iÚTe¡
, 
Com·ùiÚIÅutE¼ÜP¬ªoid
) {

312 
O±iÚs
 
İtiÚs
;

313 
İtiÚs
.
·¿noid_checks
 = 
Œue
;

314 
İtiÚs
.
wr™e_bufãr_size
 = 1048576;

315 
	`Reİ’
(&
İtiÚs
);

317 
	`Bud
(10);

318 
DBIm¶
* 
dbi
 = 
»š‹½»t_ÿ¡
<DBIm¶*>(
db_
);

319 
dbi
->
	`TEST_Com·ùMemTabË
();

320 
	`ASSERT_EQ
(1, 
	`Prİ”ty
("leveldb.num-files-at-level0"));

322 
	`CÜru±
(
kTabËFe
, 100, 1);

323 
	`Check
(9, 9);

326 
Stus
 
s
;

327 
¡d
::
¡ršg
 
tmp1
, 
tmp2
;

328 
i
 = 0; i < 10000 && 
s
.
	`ok
(); i++) {

329 
s
 = 
db_
->
	`Put
(
	`Wr™eO±iÚs
(), 
	`Key
(
i
, &
tmp1
), 
	`V®ue
(i, &
tmp2
));

331 
	`ASSERT_TRUE
(!
s
.
	`ok
()) << "write did‚ot fail in corrupted…aranoid db";

332 
	}
}

334 
	$TEST
(
CÜru±iÚTe¡
, 
UÄ–©edKeys
) {

335 
	`Bud
(10);

336 
DBIm¶
* 
dbi
 = 
»š‹½»t_ÿ¡
<DBIm¶*>(
db_
);

337 
dbi
->
	`TEST_Com·ùMemTabË
();

338 
	`CÜru±
(
kTabËFe
, 100, 1);

340 
¡d
::
¡ršg
 
tmp1
, 
tmp2
;

341 
	`ASSERT_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), 
	`Key
(1000, &
tmp1
), 
	`V®ue
(1000, &
tmp2
)));

342 
¡d
::
¡ršg
 
v
;

343 
	`ASSERT_OK
(
db_
->
	`G‘
(
	`R—dO±iÚs
(), 
	`Key
(1000, &
tmp1
), &
v
));

344 
	`ASSERT_EQ
(
	`V®ue
(1000, &
tmp2
).
	`ToSŒšg
(), 
v
);

345 
dbi
->
	`TEST_Com·ùMemTabË
();

346 
	`ASSERT_OK
(
db_
->
	`G‘
(
	`R—dO±iÚs
(), 
	`Key
(1000, &
tmp1
), &
v
));

347 
	`ASSERT_EQ
(
	`V®ue
(1000, &
tmp2
).
	`ToSŒšg
(), 
v
);

348 
	}
}

352 
	$maš
(
¬gc
, ** 
¬gv
) {

353  
Ëv–db
::
‹¡
::
	`RunAÎTe¡s
();

354 
	}
}

	@db/db_bench.cc

5 
	~<sys/ty³s.h
>

6 
	~<¡dio.h
>

7 
	~<¡dlib.h
>

8 
	~"db/db_im¶.h
"

9 
	~"db/v”siÚ_£t.h
"

10 
	~"Ëv–db/ÿche.h
"

11 
	~"Ëv–db/db.h
"

12 
	~"Ëv–db/’v.h
"

13 
	~"Ëv–db/wr™e_b©ch.h
"

14 
	~"pÜt/pÜt.h
"

15 
	~"ut/üc32c.h
"

16 
	~"ut/hi¡og¿m.h
"

17 
	~"ut/¿ndom.h
"

18 
	~"ut/‹¡ut.h
"

35 cÚ¡ * 
	gFLAGS_b’chm¬ks
 =

55 
	gFLAGS_num
 = 1000000;

58 
	gFLAGS_v®ue_size
 = 100;

62 
	gFLAGS_com´essiÚ_¿tio
 = 0.5;

65 
boŞ
 
	gFLAGS_hi¡og¿m
 = 
çl£
;

69 
	gFLAGS_wr™e_bufãr_size
 = 0;

73 
	gFLAGS_ÿche_size
 = -1;

75 
Çme¥aû
 
	gËv–db
 {

78 
	gÇme¥aû
 {

79 şas 
	cRªdomG’”©Ü
 {

80 
	g´iv©e
:

81 
¡d
::
¡ršg
 
d©a_
;

82 
	gpos_
;

84 
	gpublic
:

85 
RªdomG’”©Ü
() {

89 
Rªdom
 
ºd
(301);

90 
	g¡d
::
¡ršg
 
p›û
;

91 
	gd©a_
.
size
() < 1048576) {

94 
	g‹¡
::
Com´essibËSŒšg
(&
ºd
, 
FLAGS_com´essiÚ_¿tio
, 100, &
p›û
);

95 
	gd©a_
.
­³nd
(
p›û
);

97 
	gpos_
 = 0;

100 
Sliû
 
G’”©e
(
Ën
) {

101 ià(
	gpos_
 + 
	gËn
 > 
	gd©a_
.
size
()) {

102 
	gpos_
 = 0;

103 
as£¹
(
Ën
 < 
d©a_
.
size
());

105 
	gpos_
 +ğ
Ën
;

106  
Sliû
(
d©a_
.
d©a
(è+ 
pos_
 - 
Ën
,†en);

110 
Sliû
 
TrimS·û
(Sliû 
s
) {

111 
	g¡¬t
 = 0;

112 
	g¡¬t
 < 
	gs
.
size
(è&& 
is¥aû
(
s
[
¡¬t
])) {

113 
	g¡¬t
++;

115 
	glim™
 = 
s
.
size
();

116 
	glim™
 > 
	g¡¬t
 && 
is¥aû
(
s
[
lim™
-1])) {

117 
	glim™
--;

119  
Sliû
(
s
.
d©a
(è+ 
¡¬t
, 
lim™
 - start);

124 şas 
	cB’chm¬k
 {

125 
	g´iv©e
:

126 
Cache
* 
ÿche_
;

127 
DB
* 
	gdb_
;

128 
	gnum_
;

129 
	gh—p_couÁ”_
;

130 
	g¡¬t_
;

131 
	gÏ¡_İ_fšish_
;

132 
št64_t
 
	gby‹s_
;

133 
	g¡d
::
¡ršg
 
mes§ge_
;

134 
	g¡d
::
¡ršg
 
po¡_mes§ge_
;

135 
Hi¡og¿m
 
	ghi¡_
;

136 
RªdomG’”©Ü
 
	gg’_
;

137 
Rªdom
 
	g¿nd_
;

140 
	gdÚe_
;

141 
	gÃxt_»pÜt_
;

143 
PrštH—d”
() {

144 cÚ¡ 
	gkKeySize
 = 16;

145 
PrštEnvœÚm’t
();

146 
årštf
(
¡dout
, "Keys: %d by‹ —ch\n", 
kKeySize
);

147 
årštf
(
¡dout
, "Values: %d bytesƒach (%d bytes‡fter compression)\n",

148 
FLAGS_v®ue_size
,

149 
¡©ic_ÿ¡
<>(
FLAGS_v®ue_size
 * 
FLAGS_com´essiÚ_¿tio
 + 0.5));

150 
årštf
(
¡dout
, "EÁr›s: %d\n", 
num_
);

151 
årštf
(
¡dout
, "RawSize: %.1f MB (estimated)\n",

152 ((
¡©ic_ÿ¡
<
št64_t
>(
kKeySize
 + 
FLAGS_v®ue_size
è* 
num_
)

154 
årštf
(
¡dout
, "FileSize: %.1f MB (estimated)\n",

155 (((
kKeySize
 + 
FLAGS_v®ue_size
 * 
FLAGS_com´essiÚ_¿tio
è* 
num_
)

157 
PrštW¬nšgs
();

158 
årštf
(
¡dout
, "------------------------------------------------\n");

161 
PrštW¬nšgs
() {

162 #ià
defšed
(
__GNUC__
è&& !defšed(
__OPTIMIZE__
)

163 
årštf
(
¡dout
,

167 #iâdeà
NDEBUG


168 
årštf
(
¡dout
,

173 cÚ¡ 
	g‹xt
[] = "yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy";

174 
	g¡d
::
¡ršg
 
com´es£d
;

175 ià(!
	gpÜt
::
SÇµy_Com´ess
(
‹xt
, Ñext), &
com´es£d
)) {

176 
årštf
(
¡dout
, "WARNING: Snappy compression is‚otƒnabled\n");

177 } ià(
	gcom´es£d
.
size
(è>ğ(
‹xt
)) {

178 
årštf
(
¡dout
, "WARNING: Snappy compression is‚otƒffective\n");

182 
PrštEnvœÚm’t
() {

183 
årštf
(
¡d”r
, "LevelDB: version %d.%d\n",

184 
kMajÜV”siÚ
, 
kMšÜV”siÚ
);

186 #ià
defšed
(
__lšux
)

187 
time_t
 
	gnow
 = 
time
(
NULL
);

188 
årštf
(
¡d”r
, "D©e: %s", 
ùime
(&
now
));

190 
FILE
* 
	gıušfo
 = 
fİ’
("/proc/cpuinfo", "r");

191 ià(
	gıušfo
 !ğ
NULL
) {

192 
lše
[1000];

193 
	gnum_ıus
 = 0;

194 
	g¡d
::
¡ršg
 
ıu_ty³
;

195 
	g¡d
::
¡ršg
 
ÿche_size
;

196 
fg‘s
(
lše
, Öše), 
ıušfo
è!ğ
NULL
) {

197 cÚ¡ * 
£p
 = 
¡rchr
(
lše
, ':');

198 ià(
	g£p
 =ğ
NULL
) {

201 
Sliû
 
	gkey
 = 
TrimS·û
(Sliû(
lše
, 
£p
 - 1 -†ine));

202 
Sliû
 
	gv®
 = 
TrimS·û
(Sliû(
£p
 + 1));

203 ià(
	gkey
 == "model‚ame") {

204 ++
num_ıus
;

205 
	gıu_ty³
 = 
v®
.
ToSŒšg
();

206 } ià(
	gkey
 == "cache size") {

207 
ÿche_size
 = 
v®
.
ToSŒšg
();

210 
fşo£
(
ıušfo
);

211 
årštf
(
¡d”r
, "CPU: %d * %s\n", 
num_ıus
, 
ıu_ty³
.
c_¡r
());

212 
årštf
(
¡d”r
, "CPUCache: %s\n", 
ÿche_size
.
c_¡r
());

217 
S¹
() {

218 
	g¡¬t_
 = 
Env
::
DeçuÉ
()->
NowMiüos
() * 1e-6;

219 
	gby‹s_
 = 0;

220 
	gmes§ge_
.
ş—r
();

221 
	gÏ¡_İ_fšish_
 = 
¡¬t_
;

222 
	ghi¡_
.
CË¬
();

223 
	gdÚe_
 = 0;

224 
	gÃxt_»pÜt_
 = 100;

227 
FšishedSšgËOp
() {

228 ià(
	gFLAGS_hi¡og¿m
) {

229 
	gnow
 = 
Env
::
DeçuÉ
()->
NowMiüos
() * 1e-6;

230 
	gmiüos
 = (
now
 - 
Ï¡_İ_fšish_
) * 1e6;

231 
	ghi¡_
.
Add
(
miüos
);

232 ià(
	gmiüos
 > 20000) {

233 
årštf
(
¡d”r
, "lÚg op: %.1àmiüos%30s\r", 
miüos
, "");

234 
fæush
(
¡d”r
);

236 
	gÏ¡_İ_fšish_
 = 
now
;

239 
	gdÚe_
++;

240 ià(
	gdÚe_
 >ğ
Ãxt_»pÜt_
) {

241 ià(
Ãxt_»pÜt_
 < 1000)‚ext_report_ += 100;

242 ià(
	gÃxt_»pÜt_
 < 5000)‚ext_report_ += 500;

243 ià(
	gÃxt_»pÜt_
 < 10000)‚ext_report_ += 1000;

244 ià(
	gÃxt_»pÜt_
 < 50000)‚ext_report_ += 5000;

245 ià(
	gÃxt_»pÜt_
 < 100000)‚ext_report_ += 10000;

246 ià(
	gÃxt_»pÜt_
 < 500000)‚ext_report_ += 50000;

247 
	gÃxt_»pÜt_
 += 100000;

248 
årštf
(
¡d”r
, "... fšished %d ops%30s\r", 
dÚe_
, "");

249 
fæush
(
¡d”r
);

253 
Stİ
(cÚ¡ 
Sliû
& 
Çme
) {

254 
	gfšish
 = 
Env
::
DeçuÉ
()->
NowMiüos
() * 1e-6;

258 ià(
	gdÚe_
 < 1) done_ = 1;

260 ià(
	gby‹s_
 > 0) {

261 
	g¿‹
[100];

262 
¢´štf
(
¿‹
, (rate), "%6.1f MB/s",

263 (
by‹s_
 / 1048576.0è/ (
fšish
 - 
¡¬t_
));

264 ià(!
	gmes§ge_
.
em±y
()) {

265 
	gmes§ge_
 = 
¡d
::
¡ršg
(
¿‹
è+ " " + 
mes§ge_
;

267 
	gmes§ge_
 = 
¿‹
;

271 
årštf
(
¡dout
, "%-12s : %11.3f micros/op;%s%s\n",

272 
Çme
.
ToSŒšg
().
c_¡r
(),

273 (
fšish
 - 
¡¬t_
è* 1e6 / 
dÚe_
,

274 (
mes§ge_
.
em±y
() ? "" : " "),

275 
mes§ge_
.
c_¡r
());

276 ià(
	gFLAGS_hi¡og¿m
) {

277 
årštf
(
¡dout
, "Miüo£cÚd ³¸İ:\n%s\n", 
hi¡_
.
ToSŒšg
().
c_¡r
());

279 
fæush
(
¡dout
);

281 ià(!
	gpo¡_mes§ge_
.
em±y
()) {

282 
årštf
(
¡dout
, "\n%s\n", 
po¡_mes§ge_
.
c_¡r
());

283 
	gpo¡_mes§ge_
.
ş—r
();

287 
	gpublic
:

288 
	eOrd”
 {

289 
SEQUENTIAL
,

290 
	gRANDOM


292 
	eDBS‹
 {

293 
	gFRESH
,

294 
	gEXISTING


297 
B’chm¬k
()

298 : 
ÿche_
(
FLAGS_ÿche_size
 >ğ0 ? 
NewLRUCache
(FLAGS_ÿche_sizeè: 
NULL
),

299 
db_
(
NULL
),

300 
num_
(
FLAGS_num
),

301 
h—p_couÁ”_
(0),

302 
by‹s_
(0),

303 
¿nd_
(301) {

304 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
fes
;

305 
	gEnv
::
DeçuÉ
()->
G‘Chd»n
("/tmp/dbb’ch", &
fes
);

306 
	gi
 = 0; i < 
	gfes
.
size
(); i++) {

307 ià(
Sliû
(
fes
[
i
]).
¡¬ts_w™h
("heap-")) {

308 
	gEnv
::
DeçuÉ
()->
D–‘eFe
("/tmp/dbb’ch/" + 
fes
[
i
]);

311 
De¡royDB
("/tmp/dbb’ch", 
O±iÚs
());

314 ~
B’chm¬k
() {

315 
d–‘e
 
	gdb_
;

316 
d–‘e
 
	gÿche_
;

319 
Run
() {

320 
PrštH—d”
();

321 
O³n
();

323 cÚ¡ * 
	gb’chm¬ks
 = 
FLAGS_b’chm¬ks
;

324 
	gb’chm¬ks
 !ğ
NULL
) {

325 cÚ¡ * 
£p
 = 
¡rchr
(
b’chm¬ks
, ',');

326 
Sliû
 
	gÇme
;

327 ià(
	g£p
 =ğ
NULL
) {

328 
Çme
 = 
b’chm¬ks
;

329 
	gb’chm¬ks
 = 
NULL
;

331 
	gÇme
 = 
Sliû
(
b’chm¬ks
, 
£p
 - benchmarks);

332 
	gb’chm¬ks
 = 
£p
 + 1;

335 
S¹
();

337 
Wr™eO±iÚs
 
	gwr™e_İtiÚs
;

338 
boŞ
 
	gknown
 = 
Œue
;

339 ià(
	gÇme
 =ğ
Sliû
("fillseq")) {

340 
Wr™e
(
wr™e_İtiÚs
, 
SEQUENTIAL
, 
FRESH
, 
num_
, 
FLAGS_v®ue_size
, 1);

341 } ià(
	gÇme
 =ğ
Sliû
("fillbatch")) {

342 
Wr™e
(
wr™e_İtiÚs
, 
SEQUENTIAL
, 
FRESH
, 
num_
, 
FLAGS_v®ue_size
, 1000);

343 } ià(
	gÇme
 =ğ
Sliû
("fillrandom")) {

344 
Wr™e
(
wr™e_İtiÚs
, 
RANDOM
, 
FRESH
, 
num_
, 
FLAGS_v®ue_size
, 1);

345 } ià(
	gÇme
 =ğ
Sliû
("overwrite")) {

346 
Wr™e
(
wr™e_İtiÚs
, 
RANDOM
, 
EXISTING
, 
num_
, 
FLAGS_v®ue_size
, 1);

347 } ià(
	gÇme
 =ğ
Sliû
("fillsync")) {

348 
wr™e_İtiÚs
.
sync
 = 
Œue
;

349 
Wr™e
(
wr™e_İtiÚs
, 
RANDOM
, 
FRESH
, 
num_
 / 100, 
FLAGS_v®ue_size
, 1);

350 } ià(
	gÇme
 =ğ
Sliû
("fill100K")) {

351 
Wr™e
(
wr™e_İtiÚs
, 
RANDOM
, 
FRESH
, 
num_
 / 1000, 100 * 1000, 1);

352 } ià(
	gÇme
 =ğ
Sliû
("readseq")) {

353 
R—dSequ’tŸl
();

354 } ià(
	gÇme
 =ğ
Sliû
("readreverse")) {

355 
R—dRev”£
();

356 } ià(
	gÇme
 =ğ
Sliû
("readrandom")) {

357 
R—dRªdom
();

358 } ià(
	gÇme
 =ğ
Sliû
("readrandomsmall")) {

359 
n
 = 
num_
;

360 
	gnum_
 /= 1000;

361 
R—dRªdom
();

362 
	gnum_
 = 
n
;

363 } ià(
	gÇme
 =ğ
Sliû
("compact")) {

364 
Com·ù
();

365 } ià(
	gÇme
 =ğ
Sliû
("crc32c")) {

366 
Crc32c
(4096, "(4K…er op)");

367 } ià(
	gÇme
 =ğ
Sliû
("snappycomp")) {

368 
SÇµyCom´ess
();

369 } ià(
	gÇme
 =ğ
Sliû
("snappyuncomp")) {

370 
SÇµyUncom´ess
();

371 } ià(
	gÇme
 =ğ
Sliû
("heapprofile")) {

372 
H—pProfe
();

373 } ià(
	gÇme
 =ğ
Sliû
("stats")) {

374 
PrštSts
();

376 
	gknown
 = 
çl£
;

377 ià(
	gÇme
 !ğ
Sliû
()) {

378 
årštf
(
¡d”r
, "unknowÀb’chm¬k '%s'\n", 
Çme
.
ToSŒšg
().
c_¡r
());

381 ià(
	gknown
) {

382 
Stİ
(
Çme
);

387 
	g´iv©e
:

388 
Crc32c
(
size
, cÚ¡ * 
Ïb–
) {

390 
	g¡d
::
¡ršg
 
d©a
(
size
, 'x');

391 
št64_t
 
	gby‹s
 = 0;

392 
ušt32_t
 
	güc
 = 0;

393 
	gby‹s
 < 500 * 1048576) {

394 
	güc
 = 
üc32c
::
V®ue
(
d©a
.d©a(), 
size
);

395 
FšishedSšgËOp
();

396 
	gby‹s
 +ğ
size
;

399 
årštf
(
¡d”r
, "... crc=0x%x\r", 
¡©ic_ÿ¡
<>(
üc
));

401 
	gby‹s_
 = 
by‹s
;

402 
	gmes§ge_
 = 
Ïb–
;

405 
SÇµyCom´ess
() {

406 
Sliû
 
	gšput
 = 
g’_
.
G’”©e
(
O±iÚs
().
block_size
);

407 
št64_t
 
	gby‹s
 = 0;

408 
št64_t
 
	g´oduûd
 = 0;

409 
boŞ
 
	gok
 = 
Œue
;

410 
	g¡d
::
¡ršg
 
com´es£d
;

411 
	gok
 && 
	gby‹s
 < 1024 * 1048576) {

412 
	gok
 = 
pÜt
::
SÇµy_Com´ess
(
šput
.
d©a
(), iÅut.
size
(), &
com´es£d
);

413 
	g´oduûd
 +ğ
com´es£d
.
size
();

414 
	gby‹s
 +ğ
šput
.
size
();

415 
FšishedSšgËOp
();

418 ià(!
	gok
) {

419 
	gmes§ge_
 = "(snappy failure)";

421 
	gbuf
[100];

422 
¢´štf
(
buf
, (buf), "(output: %.1f%%)",

423 (
´oduûd
 * 100.0è/ 
by‹s
);

424 
	gmes§ge_
 = 
buf
;

425 
	gby‹s_
 = 
by‹s
;

429 
SÇµyUncom´ess
() {

430 
Sliû
 
	gšput
 = 
g’_
.
G’”©e
(
O±iÚs
().
block_size
);

431 
	g¡d
::
¡ršg
 
com´es£d
;

432 
boŞ
 
	gok
 = 
pÜt
::
SÇµy_Com´ess
(
šput
.
d©a
(), iÅut.
size
(), &
com´es£d
);

433 
št64_t
 
	gby‹s
 = 0;

434 
	g¡d
::
¡ršg
 
uncom´es£d
;

435 
	gok
 && 
	gby‹s
 < 1024 * 1048576) {

436 
	gok
 = 
pÜt
::
SÇµy_Uncom´ess
(
com´es£d
.
d©a
(), com´es£d.
size
(),

437 &
uncom´es£d
);

438 
	gby‹s
 +ğ
uncom´es£d
.
size
();

439 
FšishedSšgËOp
();

442 ià(!
	gok
) {

443 
	gmes§ge_
 = "(snappy failure)";

445 
	gby‹s_
 = 
by‹s
;

449 
O³n
() {

450 
as£¹
(
db_
 =ğ
NULL
);

451 
O±iÚs
 
	gİtiÚs
;

452 
	gİtiÚs
.
	gü—‹_if_missšg
 = 
Œue
;

453 
	gİtiÚs
.
	gblock_ÿche
 = 
ÿche_
;

454 
	gİtiÚs
.
	gwr™e_bufãr_size
 = 
FLAGS_wr™e_bufãr_size
;

455 
Stus
 
	gs
 = 
DB
::
O³n
(
İtiÚs
, "/tmp/dbb’ch", &
db_
);

456 ià(!
	gs
.
ok
()) {

457 
årštf
(
¡d”r
, "İ’ƒ¼Ü: %s\n", 
s
.
ToSŒšg
().
c_¡r
());

458 
ex™
(1);

462 
Wr™e
(cÚ¡ 
Wr™eO±iÚs
& 
İtiÚs
, 
Ord”
 
Üd”
, 
DBS‹
 
¡©e
,

463 
num_’Œ›s
, 
v®ue_size
, 
’Œ›s_³r_b©ch
) {

464 ià(
	g¡©e
 =ğ
FRESH
) {

465 
d–‘e
 
db_
;

466 
	gdb_
 = 
NULL
;

467 
De¡royDB
("/tmp/dbb’ch", 
O±iÚs
());

468 
O³n
();

469 
S¹
();

472 ià(
	gnum_’Œ›s
 !ğ
num_
) {

473 
msg
[100];

474 
¢´štf
(
msg
, (msg), "(%d ops)", 
num_’Œ›s
);

475 
	gmes§ge_
 = 
msg
;

478 
Wr™eB©ch
 
	gb©ch
;

479 
Stus
 
	gs
;

480 
	g¡d
::
¡ršg
 
v®
;

481 
	gi
 = 0; i < 
	gnum_’Œ›s
; i +ğ
’Œ›s_³r_b©ch
) {

482 
b©ch
.
CË¬
();

483 
	gj
 = 0; j < 
	g’Œ›s_³r_b©ch
; j++) {

484 cÚ¡ 
	gk
 = (
Üd”
 =ğ
SEQUENTIAL
è? 
i
+
j
 : (
¿nd_
.
Next
(è% 
FLAGS_num
);

485 
	gkey
[100];

486 
¢´štf
(
key
, (key), "%016d", 
k
);

487 
	gb©ch
.
Put
(
key
, 
g’_
.
G’”©e
(
v®ue_size
));

488 
	gby‹s_
 +ğ
v®ue_size
 + 
¡¾’
(
key
);

489 
FšishedSšgËOp
();

491 
	gs
 = 
db_
->
Wr™e
(
İtiÚs
, &
b©ch
);

492 ià(!
	gs
.
ok
()) {

493 
årštf
(
¡d”r
, "puˆ”rÜ: %s\n", 
s
.
ToSŒšg
().
c_¡r
());

494 
ex™
(1);

499 
R—dSequ’tŸl
() {

500 
I‹¿tÜ
* 
	g™”
 = 
db_
->
NewI‹¿tÜ
(
R—dO±iÚs
());

501 
	gi
 = 0;

502 
	g™”
->
S“kToFœ¡
(); 
	gi
 < 
	gnum_
 && i‹r->
V®id
(); i‹r->
Next
()) {

503 
	gby‹s_
 +ğ
™”
->
key
().
size
(è+ i‹r->
v®ue
().size();

504 
FšishedSšgËOp
();

505 ++
	gi
;

507 
d–‘e
 
	g™”
;

510 
R—dRev”£
() {

511 
I‹¿tÜ
* 
	g™”
 = 
db_
->
NewI‹¿tÜ
(
R—dO±iÚs
());

512 
	gi
 = 0;

513 
	g™”
->
S“kToLa¡
(); 
	gi
 < 
	gnum_
 && i‹r->
V®id
(); i‹r->
P»v
()) {

514 
	gby‹s_
 +ğ
™”
->
key
().
size
(è+ i‹r->
v®ue
().size();

515 
FšishedSšgËOp
();

516 ++
	gi
;

518 
d–‘e
 
	g™”
;

521 
R—dRªdom
() {

522 
R—dO±iÚs
 
	gİtiÚs
;

523 
	g¡d
::
¡ršg
 
v®ue
;

524 
	gi
 = 0; i < 
	gnum_
; i++) {

525 
	gkey
[100];

526 cÚ¡ 
	gk
 = 
¿nd_
.
Next
(è% 
FLAGS_num
;

527 
¢´štf
(
key
, (key), "%016d", 
k
);

528 
	gdb_
->
G‘
(
İtiÚs
, 
key
, &
v®ue
);

529 
FšishedSšgËOp
();

533 
Com·ù
() {

534 
DBIm¶
* 
	gdbi
 = 
»š‹½»t_ÿ¡
<DBIm¶*>(
db_
);

535 
	gdbi
->
TEST_Com·ùMemTabË
();

536 
	gmax_Ëv–_w™h_fes
 = 1;

537 
	gËv–
 = 1;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

538 
	g¡d
::
¡ršg
 
´İ”ty
;

539 
	gÇme
[100];

540 
¢´štf
(
Çme
, Òame), "Ëv–db.num-fes-©-Ëv–%d", 
Ëv–
);

541 ià(
	gdb_
->
G‘Prİ”ty
(
Çme
, &
´İ”ty
è&& 
©oi
Õrİ”ty.
c_¡r
()) > 0) {

542 
	gmax_Ëv–_w™h_fes
 = 
Ëv–
;

545 
	gËv–
 = 0;†ev– < 
	gmax_Ëv–_w™h_fes
;†evel++) {

546 
	gdbi
->
TEST_Com·ùRªge
(
Ëv–
, "", "~");

550 
PrštSts
() {

551 
	g¡d
::
¡ršg
 
¡©s
;

552 ià(!
	gdb_
->
G‘Prİ”ty
("Ëv–db.¡©s", &
¡©s
)) {

553 
	gmes§ge_
 = "(failed)";

555 
	gpo¡_mes§ge_
 = 
¡©s
;

559 
Wr™eToFe
(* 
¬g
, cÚ¡ * 
buf
, 
n
) {

560 
	g»š‹½»t_ÿ¡
<
	gWr™abËFe
*>(
	g¬g
)->
Aµ’d
(
Sliû
(
buf
, 
n
));

563 
H—pProfe
() {

564 
	gâame
[100];

565 
¢´štf
(
âame
, (âame), "/tmp/dbb’ch/h—p-%04d", ++
h—p_couÁ”_
);

566 
Wr™abËFe
* 
	gfe
;

567 
Stus
 
	gs
 = 
Env
::
DeçuÉ
()->
NewWr™abËFe
(
âame
, &
fe
);

568 ià(!
	gs
.
ok
()) {

569 
	gmes§ge_
 = 
s
.
ToSŒšg
();

572 
boŞ
 
	gok
 = 
pÜt
::
G‘H—pProfe
(
Wr™eToFe
, 
fe
);

573 
d–‘e
 
	gfe
;

574 ià(!
	gok
) {

575 
	gmes§ge_
 = "not supported";

576 
	gEnv
::
DeçuÉ
()->
D–‘eFe
(
âame
);

583 
	$maš
(
¬gc
, ** 
¬gv
) {

584 
FLAGS_wr™e_bufãr_size
 = 
Ëv–db
::
	`O±iÚs
().
wr™e_bufãr_size
;

585 
i
 = 1; i < 
¬gc
; i++) {

586 
d
;

587 
n
;

588 
junk
;

589 ià(
Ëv–db
::
	`Sliû
(
¬gv
[
i
]).
	`¡¬ts_w™h
("--benchmarks=")) {

590 
FLAGS_b’chm¬ks
 = 
¬gv
[
i
] + 
	`¡¾’
("--benchmarks=");

591 } ià(
	`ssÿnf
(
¬gv
[
i
], "--com´essiÚ_¿tio=%lf%c", &
d
, &
junk
) == 1) {

592 
FLAGS_com´essiÚ_¿tio
 = 
d
;

593 } ià(
	`ssÿnf
(
¬gv
[
i
], "--hi¡og¿m=%d%c", &
n
, &
junk
) == 1 &&

594 (
n
 == 0 ||‚ == 1)) {

595 
FLAGS_hi¡og¿m
 = 
n
;

596 } ià(
	`ssÿnf
(
¬gv
[
i
], "--num=%d%c", &
n
, &
junk
) == 1) {

597 
FLAGS_num
 = 
n
;

598 } ià(
	`ssÿnf
(
¬gv
[
i
], "--v®ue_size=%d%c", &
n
, &
junk
) == 1) {

599 
FLAGS_v®ue_size
 = 
n
;

600 } ià(
	`ssÿnf
(
¬gv
[
i
], "--wr™e_bufãr_size=%d%c", &
n
, &
junk
) == 1) {

601 
FLAGS_wr™e_bufãr_size
 = 
n
;

602 } ià(
	`ssÿnf
(
¬gv
[
i
], "--ÿche_size=%d%c", &
n
, &
junk
) == 1) {

603 
FLAGS_ÿche_size
 = 
n
;

605 
	`årštf
(
¡d”r
, "Inv®id fÏg '%s'\n", 
¬gv
[
i
]);

606 
	`ex™
(1);

610 
Ëv–db
::
B’chm¬k
 
b’chm¬k
;

611 
b’chm¬k
.
	`Run
();

613 
	}
}

	@db/db_impl.cc

5 
	~"db/db_im¶.h
"

7 
	~<®gÜ™hm
>

8 
	~<£t
>

9 
	~<¡ršg
>

10 
	~<¡dšt.h
>

11 
	~<¡dio.h
>

12 
	~<veùÜ
>

13 
	~"db/bud”.h
"

14 
	~"db/db_™”.h
"

15 
	~"db/dbfÜm©.h
"

16 
	~"db/f’ame.h
"

17 
	~"db/log_»ad”.h
"

18 
	~"db/log_wr™”.h
"

19 
	~"db/membË.h
"

20 
	~"db/bË_ÿche.h
"

21 
	~"db/v”siÚ_£t.h
"

22 
	~"db/wr™e_b©ch_š‹º®.h
"

23 
	~"Ëv–db/db.h
"

24 
	~"Ëv–db/’v.h
"

25 
	~"Ëv–db/¡©us.h
"

26 
	~"Ëv–db/bË.h
"

27 
	~"Ëv–db/bË_bud”.h
"

28 
	~"pÜt/pÜt.h
"

29 
	~"bË/block.h
"

30 
	~"bË/m”g”.h
"

31 
	~"bË/two_Ëv–_™”©Ü.h
"

32 
	~"ut/codšg.h
"

33 
	~"ut/loggšg.h
"

34 
	~"ut/mu‹xlock.h
"

36 
Çme¥aû
 
	gËv–db
 {

38 
	gDBIm¶
::
Com·ùiÚS‹
 {

39 
Com·ùiÚ
* cÚ¡ 
com·ùiÚ
;

45 
Sequ’ûNumb”
 
	gsm®Ë¡_¢­shÙ
;

48 
	sOuut
 {

49 
ušt64_t
 
	gnumb”
;

50 
ušt64_t
 
	gfe_size
;

51 
IÁ”ÇlKey
 
	gsm®Ë¡
, 
	gÏrge¡
;

53 
	g¡d
::
veùÜ
<
Ouut
> 
ouuts
;

56 
Wr™abËFe
* 
	goutfe
;

57 
TabËBud”
* 
	gbud”
;

59 
ušt64_t
 
	gtÙ®_by‹s
;

61 
Ouut
* 
cu¼’t_ouut
(è{  &
	gouuts
[
ouuts
.
size
()-1]; }

63 
ex¶ic™
 
Com·ùiÚS‹
(
Com·ùiÚ
* 
c
)

64 : 
com·ùiÚ
(
c
),

65 
outfe
(
NULL
),

66 
bud”
(
NULL
),

67 
tÙ®_by‹s
(0) {

71 
	gÇme¥aû
 {

72 şas 
	cNuÎWr™abËFe
 : 
public
 
Wr™abËFe
 {

73 
public
:

74 
vœtu®
 
Stus
 
Aµ’d
(cÚ¡ 
Sliû
& 
d©a
è{  Stus::
OK
(); }

75 
vœtu®
 
Stus
 
Clo£
(è{  
	gStus
::
OK
(); }

76 
vœtu®
 
Stus
 
Flush
(è{  
	gStus
::
OK
(); }

77 
vœtu®
 
Stus
 
Sync
(è{  
	gStus
::
OK
(); }

82 
	g‹m¶©e
 <
şass
 
	gT
,şas 
	gV
>

83 
	$ClToRªge
(
T
* 
±r
, 
V
 
mšv®ue
, V 
maxv®ue
) {

84 ià(
¡©ic_ÿ¡
<
V
>(*
±r
è> 
maxv®ue
) *ptr = maxvalue;

85 ià(
¡©ic_ÿ¡
<
V
>(*
±r
è< 
mšv®ue
) *ptr = minvalue;

86 
	}
}

87 
O±iÚs
 
Sª™izeO±iÚs
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
,

88 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
* 
icmp
,

89 cÚ¡ 
O±iÚs
& 
¤c
) {

90 
O±iÚs
 
	g»suÉ
 = 
¤c
;

91 
	g»suÉ
.
	gcom·¿tÜ
 = 
icmp
;

92 
ClToRªge
(&
»suÉ
.
max_İ’_fes
, 20, 50000);

93 
ClToRªge
(&
»suÉ
.
wr™e_bufãr_size
, 64<<10, 1<<30);

94 
ClToRªge
(&
»suÉ
.
block_size
, 1<<10, 4<<20);

95 ià(
	g»suÉ
.
	gšfo_log
 =ğ
NULL
) {

97 
¤c
.
’v
->
C»©eDœ
(
dbÇme
);

98 
	g¤c
.
	g’v
->
R’ameFe
(
InfoLogFeName
(
dbÇme
), 
OldInfoLogFeName
(dbname));

99 
Stus
 
	gs
 = 
¤c
.
’v
->
NewWr™abËFe
(
InfoLogFeName
(
dbÇme
),

100 &
»suÉ
.
šfo_log
);

101 ià(!
	gs
.
ok
()) {

103 
	g»suÉ
.
	gšfo_log
 = 
Ãw
 
NuÎWr™abËFe
;

106 ià(
	g»suÉ
.
	gblock_ÿche
 =ğ
NULL
) {

107 
»suÉ
.
block_ÿche
 = 
NewLRUCache
(8 << 20);

109  
	g»suÉ
;

112 
	gDBIm¶
::
DBIm¶
(cÚ¡ 
O±iÚs
& 
İtiÚs
, cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
)

113 : 
’v_
(
İtiÚs
.
’v
),

114 
š‹º®_com·¿tÜ_
(
İtiÚs
.
com·¿tÜ
),

115 
İtiÚs_
(
Sª™izeO±iÚs
(
dbÇme
, &
š‹º®_com·¿tÜ_
, 
İtiÚs
)),

116 
owns_šfo_log_
(
İtiÚs_
.
šfo_log
 !ğ
İtiÚs
.info_log),

117 
owns_ÿche_
(
İtiÚs_
.
block_ÿche
 !ğ
İtiÚs
.block_cache),

118 
dbÇme_
(
dbÇme
),

119 
db_lock_
(
NULL
),

120 
shu‰šg_down_
(
NULL
),

121 
bg_cv_
(&
mu‹x_
),

122 
com·ùšg_cv_
(&
mu‹x_
),

123 
mem_
(
Ãw
 
MemTabË
(
š‹º®_com·¿tÜ_
)),

124 
imm_
(
NULL
),

125 
logfe_
(
NULL
),

126 
log_
(
NULL
),

127 
bg_com·ùiÚ_scheduËd_
(
çl£
),

128 
	$com·ùšg_
(
çl£
) {

129 
has_imm_
.
	`R–—£_StÜe
(
NULL
);

132 cÚ¡ 
bË_ÿche_size
 = 
İtiÚs
.
max_İ’_fes
 - 10;

133 
bË_ÿche_
 = 
Ãw
 
	`TabËCache
(
dbÇme_
, &
İtiÚs_
, 
bË_ÿche_size
);

135 
v”siÚs_
 = 
Ãw
 
	`V”siÚS‘
(
dbÇme_
, &
İtiÚs_
, 
bË_ÿche_
,

136 &
š‹º®_com·¿tÜ_
);

137 
	}
}

139 
	gDBIm¶
::~
	$DBIm¶
() {

141 
mu‹x_
.
	`Lock
();

142 
shu‰šg_down_
.
	`R–—£_StÜe
(
this
);

143 ià(
bg_com·ùiÚ_scheduËd_
) {

144 
bg_com·ùiÚ_scheduËd_
) {

145 
bg_cv_
.
	`Wa™
();

148 
mu‹x_
.
	`UÆock
();

150 ià(
db_lock_
 !ğ
NULL
) {

151 
’v_
->
	`UÆockFe
(
db_lock_
);

154 
d–‘e
 
v”siÚs_
;

155 
d–‘e
 
mem_
;

156 
d–‘e
 
imm_
;

157 
d–‘e
 
log_
;

158 
d–‘e
 
logfe_
;

159 
d–‘e
 
bË_ÿche_
;

161 ià(
owns_šfo_log_
) {

162 
d–‘e
 
İtiÚs_
.
šfo_log
;

164 ià(
owns_ÿche_
) {

165 
d–‘e
 
İtiÚs_
.
block_ÿche
;

167 
	}
}

169 
Stus
 
	gDBIm¶
::
	$NewDB
() {

170 
V”siÚEd™
 
Ãw_db
;

171 
Ãw_db
.
	`S‘Com·¿tÜName
(
	`u£r_com·¿tÜ
()->
	`Name
());

172 
Ãw_db
.
	`S‘LogNumb”
(0);

173 
Ãw_db
.
	`S‘NextFe
(2);

174 
Ãw_db
.
	`S‘La¡Sequ’û
(0);

176 cÚ¡ 
¡d
::
¡ršg
 
mªiã¡
 = 
	`DesütÜFeName
(
dbÇme_
, 1);

177 
Wr™abËFe
* 
fe
;

178 
Stus
 
s
 = 
’v_
->
	`NewWr™abËFe
(
mªiã¡
, &
fe
);

179 ià(!
s
.
	`ok
()) {

180  
s
;

183 
log
::
Wr™”
 
	`log
(
fe
);

184 
¡d
::
¡ršg
 
»cÜd
;

185 
Ãw_db
.
	`EncodeTo
(&
»cÜd
);

186 
s
 = 
log
.
	`AddRecÜd
(
»cÜd
);

187 ià(
s
.
	`ok
()) {

188 
s
 = 
fe
->
	`Clo£
();

191 
d–‘e
 
fe
;

192 ià(
s
.
	`ok
()) {

194 
s
 = 
	`S‘Cu¼’tFe
(
’v_
, 
dbÇme_
, 1);

196 
’v_
->
	`D–‘eFe
(
mªiã¡
);

198  
s
;

199 
	}
}

201 
	gDBIm¶
::
	$MaybeIgnÜeE¼Ü
(
Stus
* 
s
) const {

202 ià(
s
->
	`ok
(è|| 
İtiÚs_
.
·¿noid_checks
) {

205 
	`Log
(
’v_
, 
İtiÚs_
.
šfo_log
, "IgnÜšgƒ¼Ü %s", 
s
->
	`ToSŒšg
().
	`c_¡r
());

206 *
s
 = 
Stus
::
	`OK
();

208 
	}
}

210 
	gDBIm¶
::
	$D–‘eObsŞ‘eFes
() {

212 
¡d
::
£t
<
ušt64_t
> 
live
 = 
³ndšg_ouuts_
;

213 
v”siÚs_
->
	`AddLiveFes
(&
live
);

215 
¡d
::
veùÜ
<¡d::
¡ršg
> 
f’ames
;

216 
’v_
->
	`G‘Chd»n
(
dbÇme_
, &
f’ames
);

217 
ušt64_t
 
numb”
;

218 
FeTy³
 
ty³
;

219 
size_t
 
i
 = 0; i < 
f’ames
.
	`size
(); i++) {

220 ià(
	`P¬£FeName
(
f’ames
[
i
], &
numb”
, &
ty³
)) {

221 
boŞ
 
k“p
 = 
Œue
;

222 
ty³
) {

223 
kLogFe
:

224 
k“p
 = ((
numb”
 =ğ
v”siÚs_
->
	`LogNumb”
()) ||

225 (
numb”
 =ğ
v”siÚs_
->
	`P»vLogNumb”
()));

227 
kDesütÜFe
:

230 
k“p
 = (
numb”
 >ğ
v”siÚs_
->
	`Mªiã¡FeNumb”
());

232 
kTabËFe
:

233 
k“p
 = (
live
.
	`fšd
(
numb”
è!ğlive.
	`’d
());

235 
kTempFe
:

238 
k“p
 = (
live
.
	`fšd
(
numb”
è!ğlive.
	`’d
());

240 
kCu¼’tFe
:

241 
kDBLockFe
:

242 
kInfoLogFe
:

243 
k“p
 = 
Œue
;

247 ià(!
k“p
) {

248 ià(
ty³
 =ğ
kTabËFe
) {

249 
bË_ÿche_
->
	`Eviù
(
numb”
);

251 
	`Log
(
’v_
, 
İtiÚs_
.
šfo_log
, "Deleteype=%d #%lld\n",

252 (
ty³
),

253 
¡©ic_ÿ¡
<>(
numb”
));

254 
’v_
->
	`D–‘eFe
(
dbÇme_
 + "/" + 
f’ames
[
i
]);

258 
	}
}

260 
Stus
 
	gDBIm¶
::
	$Recov”
(
V”siÚEd™
* 
ed™
) {

261 
mu‹x_
.
	`As£¹H–d
();

266 
’v_
->
	`C»©eDœ
(
dbÇme_
);

267 
	`as£¹
(
db_lock_
 =ğ
NULL
);

268 
Stus
 
s
 = 
’v_
->
	`LockFe
(
	`LockFeName
(
dbÇme_
), &
db_lock_
);

269 ià(!
s
.
	`ok
()) {

270  
s
;

273 ià(!
’v_
->
	`FeExi¡s
(
	`Cu¼’tFeName
(
dbÇme_
))) {

274 ià(
İtiÚs_
.
ü—‹_if_missšg
) {

275 
s
 = 
	`NewDB
();

276 ià(!
s
.
	`ok
()) {

277  
s
;

280  
Stus
::
	`Inv®idArgum’t
(

281 
dbÇme_
, "does‚otƒxist (create_if_missing is false)");

284 ià(
İtiÚs_
.
”rÜ_if_exi¡s
) {

285  
Stus
::
	`Inv®idArgum’t
(

286 
dbÇme_
, "exists (error_if_exists isrue)");

290 
s
 = 
v”siÚs_
->
	`Recov”
();

291 ià(
s
.
	`ok
()) {

293 
Sequ’ûNumb”
 
	`max_£qu’û
(0);

294 ià(
v”siÚs_
->
	`P»vLogNumb”
() != 0) {

295 
s
 = 
	`Recov”LogFe
(
v”siÚs_
->
	`P»vLogNumb”
(), 
ed™
, &
max_£qu’û
);

297 ià(
s
.
	`ok
(è&& 
v”siÚs_
->
	`LogNumb”
() != 0) {

298 
s
 = 
	`Recov”LogFe
(
v”siÚs_
->
	`LogNumb”
(), 
ed™
, &
max_£qu’û
);

300 ià(
s
.
	`ok
()) {

301 ià(
v”siÚs_
->
	`La¡Sequ’û
(è< 
max_£qu’û
) {

302 
v”siÚs_
->
	`S‘La¡Sequ’û
(
max_£qu’û
);

307  
s
;

308 
	}
}

310 
Stus
 
	gDBIm¶
::
	$Recov”LogFe
(
ušt64_t
 
log_numb”
,

311 
V”siÚEd™
* 
ed™
,

312 
Sequ’ûNumb”
* 
max_£qu’û
) {

313 
LogR•Ü‹r
 : 
public
 
log
::
R—d”
::
R•Ü‹r
 {

314 
Env
* 
’v
;

315 
Wr™abËFe
* 
šfo_log
;

316 cÚ¡ * 
âame
;

317 
Stus
* 
¡©us
;

318 
vœtu®
 
	`CÜru±iÚ
(
size_t
 
by‹s
, cÚ¡ 
Stus
& 
s
) {

319 
	`Log
(
’v
, 
šfo_log
, "%s%s: dropping %d bytes; %s",

320 (
this
->
¡©us
 =ğ
NULL
 ? "(ignoringƒrror) " : ""),

321 
âame
, 
¡©ic_ÿ¡
<>(
by‹s
), 
s
.
	`ToSŒšg
().
	`c_¡r
());

322 ià(
this
->
¡©us
 !ğ
NULL
 &&his->¡©us->
	`ok
()è*this->¡©u ğ
s
;

326 
mu‹x_
.
	`As£¹H–d
();

329 
¡d
::
¡ršg
 
âame
 = 
	`LogFeName
(
dbÇme_
, 
log_numb”
);

330 
Sequ’tŸlFe
* 
fe
;

331 
Stus
 
¡©us
 = 
’v_
->
	`NewSequ’tŸlFe
(
âame
, &
fe
);

332 ià(!
¡©us
.
	`ok
()) {

333 
	`MaybeIgnÜeE¼Ü
(&
¡©us
);

334  
¡©us
;

338 
LogR•Ü‹r
 
»pÜ‹r
;

339 
»pÜ‹r
.
’v
 = 
’v_
;

340 
»pÜ‹r
.
šfo_log
 = 
İtiÚs_
.info_log;

341 
»pÜ‹r
.
âame
 = fÇme.
	`c_¡r
();

342 
»pÜ‹r
.
¡©us
 = (
İtiÚs_
.
·¿noid_checks
 ? &¡©u : 
NULL
);

347 
log
::
R—d”
 
	`»ad”
(
fe
, &
»pÜ‹r
, 
Œue
 );

348 
	`Log
(
’v_
, 
İtiÚs_
.
šfo_log
, "Recovering†og #%llu",

349 (è
log_numb”
);

352 
¡d
::
¡ršg
 
sü©ch
;

353 
Sliû
 
»cÜd
;

354 
Wr™eB©ch
 
b©ch
;

355 
MemTabË
* 
mem
 = 
NULL
;

356 
»ad”
.
	`R—dRecÜd
(&
»cÜd
, &
sü©ch
) &&

357 
¡©us
.
	`ok
()) {

358 ià(
»cÜd
.
	`size
() < 12) {

359 
»pÜ‹r
.
	`CÜru±iÚ
(

360 
»cÜd
.
	`size
(), 
Stus
::
	`CÜru±iÚ
("log„ecordoo small"));

363 
Wr™eB©chIÁ”Çl
::
	`S‘CÚ‹Ás
(&
b©ch
, 
»cÜd
);

365 ià(
mem
 =ğ
NULL
) {

366 
mem
 = 
Ãw
 
	`MemTabË
(
š‹º®_com·¿tÜ_
);

368 
¡©us
 = 
Wr™eB©chIÁ”Çl
::
	`In£¹IÁo
(&
b©ch
, 
mem
);

369 
	`MaybeIgnÜeE¼Ü
(&
¡©us
);

370 ià(!
¡©us
.
	`ok
()) {

373 cÚ¡ 
Sequ’ûNumb”
 
Ï¡_£q
 =

374 
Wr™eB©chIÁ”Çl
::
	`Sequ’û
(&
b©ch
) +

375 
Wr™eB©chIÁ”Çl
::
	`CouÁ
(&
b©ch
) - 1;

376 ià(
Ï¡_£q
 > *
max_£qu’û
) {

377 *
max_£qu’û
 = 
Ï¡_£q
;

380 ià(
mem
->
	`Aµroxim©eMemÜyU§ge
(è> 
İtiÚs_
.
wr™e_bufãr_size
) {

381 
¡©us
 = 
	`Wr™eLev–0TabË
(
mem
, 
ed™
);

382 ià(!
¡©us
.
	`ok
()) {

387 
d–‘e
 
mem
;

388 
mem
 = 
NULL
;

392 ià(
¡©us
.
	`ok
(è&& 
mem
 !ğ
NULL
) {

393 
¡©us
 = 
	`Wr™eLev–0TabË
(
mem
, 
ed™
);

398 
d–‘e
 
mem
;

399 
d–‘e
 
fe
;

400  
¡©us
;

401 
	}
}

403 
Stus
 
	gDBIm¶
::
	$Wr™eLev–0TabË
(
MemTabË
* 
mem
, 
V”siÚEd™
* 
ed™
) {

404 
mu‹x_
.
	`As£¹H–d
();

405 cÚ¡ 
ušt64_t
 
¡¬t_miüos
 = 
’v_
->
	`NowMiüos
();

406 
FeM‘aD©a
 
m‘a
;

407 
m‘a
.
numb”
 = 
v”siÚs_
->
	`NewFeNumb”
();

408 
³ndšg_ouuts_
.
	`š£¹
(
m‘a
.
numb”
);

409 
I‹¿tÜ
* 
™”
 = 
mem
->
	`NewI‹¿tÜ
();

410 
	`Log
(
’v_
, 
İtiÚs_
.
šfo_log
, "Level-0able #%llu: started",

411 (è
m‘a
.
numb”
);

413 
Stus
 
s
;

415 
mu‹x_
.
	`UÆock
();

416 
s
 = 
	`BudTabË
(
dbÇme_
, 
’v_
, 
İtiÚs_
, 
bË_ÿche_
, 
™”
, &
m‘a
, 
ed™
);

417 
mu‹x_
.
	`Lock
();

420 
	`Log
(
’v_
, 
İtiÚs_
.
šfo_log
, "Level-0able #%llu: %lld bytes %s",

421 (è
m‘a
.
numb”
,

422 (è
m‘a
.
fe_size
,

423 
s
.
	`ToSŒšg
().
	`c_¡r
());

424 
d–‘e
 
™”
;

425 
³ndšg_ouuts_
.
	`”a£
(
m‘a
.
numb”
);

427 
Com·ùiÚSts
 
¡©s
;

428 
¡©s
.
miüos
 = 
’v_
->
	`NowMiüos
(è- 
¡¬t_miüos
;

429 
¡©s
.
by‹s_wr™‹n
 = 
m‘a
.
fe_size
;

430 
¡©s_
[0].
	`Add
(
¡©s
);

431  
s
;

432 
	}
}

434 
Stus
 
	gDBIm¶
::
	$Com·ùMemTabË
() {

435 
mu‹x_
.
	`As£¹H–d
();

436 
	`as£¹
(
imm_
 !ğ
NULL
);

437 
	`as£¹
(
com·ùšg_
);

440 
V”siÚEd™
 
ed™
;

441 
Stus
 
s
 = 
	`Wr™eLev–0TabË
(
imm_
, &
ed™
);

444 ià(
s
.
	`ok
()) {

445 
ed™
.
	`S‘P»vLogNumb”
(0);

446 
s
 = 
v”siÚs_
->
	`LogAndAµly
(&
ed™
, 
imm_
);

449 ià(
s
.
	`ok
()) {

451 
imm_
 = 
NULL
;

452 
has_imm_
.
	`R–—£_StÜe
(
NULL
);

453 
	`D–‘eObsŞ‘eFes
();

456 
com·ùšg_cv_
.
	`SigÇlAÎ
();

457  
s
;

458 
	}
}

460 
	gDBIm¶
::
TEST_Com·ùRªge
(

461 
Ëv–
,

462 cÚ¡ 
¡d
::
¡ršg
& 
begš
,

463 cÚ¡ 
¡d
::
¡ršg
& 
’d
) {

464 
Mu‹xLock
 
l
(&
mu‹x_
);

465 
	gcom·ùšg_
) {

466 
	gcom·ùšg_cv_
.
Wa™
();

468 
Com·ùiÚ
* 
	gc
 = 
v”siÚs_
->
Com·ùRªge
(

469 
Ëv–
,

470 
IÁ”ÇlKey
(
begš
, 
kMaxSequ’ûNumb”
, 
kV®ueTy³FÜS“k
),

471 
IÁ”ÇlKey
(
’d
, 0, 
¡©ic_ÿ¡
<
V®ueTy³
>(0)));

473 ià(
	gc
 !ğ
NULL
) {

474 
Com·ùiÚS‹
* 
com·ù
 = 
Ãw
 Com·ùiÚS‹(
c
);

475 
DoCom·ùiÚWÜk
(
com·ù
);

476 
CËªupCom·ùiÚ
(
com·ù
);

480 
MaybeScheduËCom·ùiÚ
();

483 
Stus
 
	gDBIm¶
::
	$TEST_Com·ùMemTabË
() {

484 
Mu‹xLock
 
	`l
(&
mu‹x_
);

485 
Stus
 
s
 = 
	`MakeRoomFÜWr™e
(
Œue
 );

486 ià(
s
.
	`ok
()) {

488 
imm_
 !ğ
NULL
 && 
bg_”rÜ_
.
	`ok
()) {

489 
com·ùšg_cv_
.
	`Wa™
();

491 ià(
imm_
 !ğ
NULL
) {

492 
s
 = 
bg_”rÜ_
;

495  
s
;

496 
	}
}

498 
	gDBIm¶
::
	$MaybeScheduËCom·ùiÚ
() {

499 
mu‹x_
.
	`As£¹H–d
();

500 ià(
bg_com·ùiÚ_scheduËd_
) {

502 } ià(
com·ùšg_
) {

504 } ià(
shu‰šg_down_
.
	`Acquœe_Lßd
()) {

506 } ià(
imm_
 =ğ
NULL
 && !
v”siÚs_
->
	`N“dsCom·ùiÚ
()) {

509 
bg_com·ùiÚ_scheduËd_
 = 
Œue
;

510 
’v_
->
	`ScheduË
(&
DBIm¶
::
BGWÜk
, 
this
);

512 
	}
}

514 
	gDBIm¶
::
	$BGWÜk
(* 
db
) {

515 
»š‹½»t_ÿ¡
<
DBIm¶
*>(
db
)->
	`BackgroundC®l
();

516 
	}
}

518 
	gDBIm¶
::
	$BackgroundC®l
() {

519 
Mu‹xLock
 
	`l
(&
mu‹x_
);

520 
	`as£¹
(
bg_com·ùiÚ_scheduËd_
);

521 ià(!
shu‰šg_down_
.
	`Acquœe_Lßd
() &&

522 !
com·ùšg_
) {

523 
	`BackgroundCom·ùiÚ
();

525 
bg_com·ùiÚ_scheduËd_
 = 
çl£
;

526 
bg_cv_
.
	`SigÇlAÎ
();

530 
	`MaybeScheduËCom·ùiÚ
();

531 
	}
}

533 
	gDBIm¶
::
	$BackgroundCom·ùiÚ
() {

534 
mu‹x_
.
	`As£¹H–d
();

535 
	`as£¹
(!
com·ùšg_
);

537 ià(
imm_
 !ğ
NULL
) {

538 
com·ùšg_
 = 
Œue
;

539 
	`Com·ùMemTabË
();

540 
com·ùšg_
 = 
çl£
;

541 
com·ùšg_cv_
.
	`SigÇlAÎ
();

545 
Com·ùiÚ
* 
c
 = 
v”siÚs_
->
	`PickCom·ùiÚ
();

546 ià(
c
 =ğ
NULL
) {

551 
Stus
 
¡©us
;

552 ià(
c
->
	`IsTrivŸlMove
()) {

554 
	`as£¹
(
c
->
	`num_šput_fes
(0) == 1);

555 
FeM‘aD©a
* 
f
 = 
c
->
	`šput
(0, 0);

556 
c
->
	`ed™
()->
	`D–‘eFe
(c->
	`Ëv–
(), 
f
->
numb”
);

557 
c
->
	`ed™
()->
	`AddFe
(c->
	`Ëv–
(è+ 1, 
f
->
numb”
, f->
fe_size
,

558 
f
->
sm®Ë¡
, f->
Ïrge¡
);

559 
¡©us
 = 
v”siÚs_
->
	`LogAndAµly
(
c
->
	`ed™
(), 
NULL
);

560 
	`Log
(
’v_
, 
İtiÚs_
.
šfo_log
, "Moved #%lldo†evel-%d %lld bytes %s\n",

561 
¡©ic_ÿ¡
<>(
f
->
numb”
),

562 
c
->
	`Ëv–
() + 1,

563 
¡©ic_ÿ¡
<>(
f
->
fe_size
),

564 
¡©us
.
	`ToSŒšg
().
	`c_¡r
());

566 
Com·ùiÚS‹
* 
com·ù
 = 
Ãw
 
	`Com·ùiÚS‹
(
c
);

567 
¡©us
 = 
	`DoCom·ùiÚWÜk
(
com·ù
);

568 
	`CËªupCom·ùiÚ
(
com·ù
);

570 
d–‘e
 
c
;

572 ià(
¡©us
.
	`ok
()) {

574 } ià(
shu‰šg_down_
.
	`Acquœe_Lßd
()) {

577 
	`Log
(
’v_
, 
İtiÚs_
.
šfo_log
,

578 "Com·ùiÚƒ¼Ü: %s", 
¡©us
.
	`ToSŒšg
().
	`c_¡r
());

579 ià(
İtiÚs_
.
·¿noid_checks
 && 
bg_”rÜ_
.
	`ok
()) {

580 
bg_”rÜ_
 = 
¡©us
;

583 
	}
}

585 
	gDBIm¶
::
	$CËªupCom·ùiÚ
(
Com·ùiÚS‹
* 
com·ù
) {

586 
mu‹x_
.
	`As£¹H–d
();

587 ià(
com·ù
->
bud”
 !ğ
NULL
) {

589 
com·ù
->
bud”
->
	`AbªdÚ
();

590 
d–‘e
 
com·ù
->
bud”
;

592 
	`as£¹
(
com·ù
->
outfe
 =ğ
NULL
);

594 
d–‘e
 
com·ù
->
outfe
;

595 
size_t
 
i
 = 0; i < 
com·ù
->
ouuts
.
	`size
(); i++) {

596 cÚ¡ 
Com·ùiÚS‹
::
Ouut
& 
out
 = 
com·ù
->
ouuts
[
i
];

597 
³ndšg_ouuts_
.
	`”a£
(
out
.
numb”
);

599 
d–‘e
 
com·ù
;

600 
	}
}

602 
Stus
 
	gDBIm¶
::
	$O³nCom·ùiÚOuutFe
(
Com·ùiÚS‹
* 
com·ù
) {

603 
	`as£¹
(
com·ù
 !ğ
NULL
);

604 
	`as£¹
(
com·ù
->
bud”
 =ğ
NULL
);

605 
ušt64_t
 
fe_numb”
;

607 
mu‹x_
.
	`Lock
();

608 
fe_numb”
 = 
v”siÚs_
->
	`NewFeNumb”
();

609 
³ndšg_ouuts_
.
	`š£¹
(
fe_numb”
);

610 
Com·ùiÚS‹
::
Ouut
 
out
;

611 
out
.
numb”
 = 
fe_numb”
;

612 
out
.
sm®Ë¡
.
	`CË¬
();

613 
out
.
Ïrge¡
.
	`CË¬
();

614 
com·ù
->
ouuts
.
	`push_back
(
out
);

615 
mu‹x_
.
	`UÆock
();

619 
¡d
::
¡ršg
 
âame
 = 
	`TabËFeName
(
dbÇme_
, 
fe_numb”
);

620 
Stus
 
s
 = 
’v_
->
	`NewWr™abËFe
(
âame
, &
com·ù
->
outfe
);

621 ià(
s
.
	`ok
()) {

622 
com·ù
->
bud”
 = 
Ãw
 
	`TabËBud”
(
İtiÚs_
, com·ù->
outfe
);

624  
s
;

625 
	}
}

627 
Stus
 
	gDBIm¶
::
	$FšishCom·ùiÚOuutFe
(
Com·ùiÚS‹
* 
com·ù
,

628 
I‹¿tÜ
* 
šput
) {

629 
	`as£¹
(
com·ù
 !ğ
NULL
);

630 
	`as£¹
(
com·ù
->
outfe
 !ğ
NULL
);

631 
	`as£¹
(
com·ù
->
bud”
 !ğ
NULL
);

633 cÚ¡ 
ušt64_t
 
ouut_numb”
 = 
com·ù
->
	`cu¼’t_ouut
()->
numb”
;

634 
	`as£¹
(
ouut_numb”
 != 0);

637 
Stus
 
s
 = 
šput
->
	`¡©us
();

638 cÚ¡ 
ušt64_t
 
cu¼’t_’Œ›s
 = 
com·ù
->
bud”
->
	`NumEÁr›s
();

639 ià(
s
.
	`ok
()) {

640 
s
 = 
com·ù
->
bud”
->
	`Fšish
();

642 
com·ù
->
bud”
->
	`AbªdÚ
();

644 cÚ¡ 
ušt64_t
 
cu¼’t_by‹s
 = 
com·ù
->
bud”
->
	`FeSize
();

645 
com·ù
->
	`cu¼’t_ouut
()->
fe_size
 = 
cu¼’t_by‹s
;

646 
com·ù
->
tÙ®_by‹s
 +ğ
cu¼’t_by‹s
;

647 
d–‘e
 
com·ù
->
bud”
;

648 
com·ù
->
bud”
 = 
NULL
;

651 ià(
s
.
	`ok
()) {

652 
s
 = 
com·ù
->
outfe
->
	`Sync
();

654 ià(
s
.
	`ok
()) {

655 
s
 = 
com·ù
->
outfe
->
	`Clo£
();

657 
d–‘e
 
com·ù
->
outfe
;

658 
com·ù
->
outfe
 = 
NULL
;

660 ià(
s
.
	`ok
(è&& 
cu¼’t_’Œ›s
 > 0) {

662 
I‹¿tÜ
* 
™”
 = 
bË_ÿche_
->
	`NewI‹¿tÜ
(
	`R—dO±iÚs
(),

663 
ouut_numb”
,

664 
cu¼’t_by‹s
);

665 
s
 = 
™”
->
	`¡©us
();

666 
d–‘e
 
™”
;

667 ià(
s
.
	`ok
()) {

668 
	`Log
(
’v_
, 
İtiÚs_
.
šfo_log
,

670 (è
ouut_numb”
,

671 (è
cu¼’t_’Œ›s
,

672 (è
cu¼’t_by‹s
);

675  
s
;

676 
	}
}

679 
Stus
 
	gDBIm¶
::
	$In¡®lCom·ùiÚResuÉs
(
Com·ùiÚS‹
* 
com·ù
) {

680 
mu‹x_
.
	`As£¹H–d
();

681 
	`Log
(
’v_
, 
İtiÚs_
.
šfo_log
, "Compacted %d@%d + %d@%d files => %lld bytes",

682 
com·ù
->
com·ùiÚ
->
	`num_šput_fes
(0),

683 
com·ù
->
com·ùiÚ
->
	`Ëv–
(),

684 
com·ù
->
com·ùiÚ
->
	`num_šput_fes
(1),

685 
com·ù
->
com·ùiÚ
->
	`Ëv–
() + 1,

686 
¡©ic_ÿ¡
<>(
com·ù
->
tÙ®_by‹s
));

689 
com·ù
->
com·ùiÚ
->
	`AddIÅutD–‘iÚs
(com·ù->com·ùiÚ->
	`ed™
());

690 cÚ¡ 
Ëv–
 = 
com·ù
->
com·ùiÚ
->
	`Ëv–
();

691 
size_t
 
i
 = 0; i < 
com·ù
->
ouuts
.
	`size
(); i++) {

692 cÚ¡ 
Com·ùiÚS‹
::
Ouut
& 
out
 = 
com·ù
->
ouuts
[
i
];

693 
com·ù
->
com·ùiÚ
->
	`ed™
()->
	`AddFe
(

694 
Ëv–
 + 1,

695 
out
.
numb”
, out.
fe_size
, out.
sm®Ë¡
, out.
Ïrge¡
);

696 
³ndšg_ouuts_
.
	`”a£
(
out
.
numb”
);

698 
com·ù
->
ouuts
.
	`ş—r
();

700 
Stus
 
s
 = 
v”siÚs_
->
	`LogAndAµly
(
com·ù
->
com·ùiÚ
->
	`ed™
(), 
NULL
);

701 ià(
s
.
	`ok
()) {

702 
com·ù
->
com·ùiÚ
->
	`R–—£IÅuts
();

703 
	`D–‘eObsŞ‘eFes
();

706 
size_t
 
i
 = 0; i < 
com·ù
->
ouuts
.
	`size
(); i++) {

707 
’v_
->
	`D–‘eFe
(
	`TabËFeName
(
dbÇme_
, 
com·ù
->
ouuts
[
i
].
numb”
));

710  
s
;

711 
	}
}

713 
Stus
 
	gDBIm¶
::
	$DoCom·ùiÚWÜk
(
Com·ùiÚS‹
* 
com·ù
) {

714 cÚ¡ 
ušt64_t
 
¡¬t_miüos
 = 
’v_
->
	`NowMiüos
();

715 
št64_t
 
imm_miüos
 = 0;

717 
	`Log
(
’v_
, 
İtiÚs_
.
šfo_log
, "Compacting %d@%d + %d@%d files",

718 
com·ù
->
com·ùiÚ
->
	`num_šput_fes
(0),

719 
com·ù
->
com·ùiÚ
->
	`Ëv–
(),

720 
com·ù
->
com·ùiÚ
->
	`num_šput_fes
(1),

721 
com·ù
->
com·ùiÚ
->
	`Ëv–
() + 1);

723 
	`as£¹
(
v”siÚs_
->
	`NumLev–Fes
(
com·ù
->
com·ùiÚ
->
	`Ëv–
()) > 0);

724 
	`as£¹
(
com·ù
->
bud”
 =ğ
NULL
);

725 
	`as£¹
(
com·ù
->
outfe
 =ğ
NULL
);

726 ià(
¢­shÙs_
.
	`em±y
()) {

727 
com·ù
->
sm®Ë¡_¢­shÙ
 = 
v”siÚs_
->
	`La¡Sequ’û
();

729 
com·ù
->
sm®Ë¡_¢­shÙ
 = 
¢­shÙs_
.
	`Şde¡
()->
numb”_
;

733 
com·ùšg_
 = 
Œue
;

734 
mu‹x_
.
	`UÆock
();

736 
I‹¿tÜ
* 
šput
 = 
v”siÚs_
->
	`MakeIÅutI‹¿tÜ
(
com·ù
->
com·ùiÚ
);

737 
šput
->
	`S“kToFœ¡
();

738 
Stus
 
¡©us
;

739 
P¬£dIÁ”ÇlKey
 
ikey
;

740 
¡d
::
¡ršg
 
cu¼’t_u£r_key
;

741 
boŞ
 
has_cu¼’t_u£r_key
 = 
çl£
;

742 
Sequ’ûNumb”
 
Ï¡_£qu’û_fÜ_key
 = 
kMaxSequ’ûNumb”
;

743 ; 
šput
->
	`V®id
(è&& !
shu‰šg_down_
.
	`Acquœe_Lßd
(); ) {

745 ià(
has_imm_
.
	`NoB¬r›r_Lßd
(è!ğ
NULL
) {

746 cÚ¡ 
ušt64_t
 
imm_¡¬t
 = 
’v_
->
	`NowMiüos
();

747 
mu‹x_
.
	`Lock
();

748 ià(
imm_
 !ğ
NULL
) {

749 
	`Com·ùMemTabË
();

750 
com·ùšg_cv_
.
	`SigÇlAÎ
();

752 
mu‹x_
.
	`UÆock
();

753 
imm_miüos
 +ğ(
’v_
->
	`NowMiüos
(è- 
imm_¡¬t
);

756 
Sliû
 
key
 = 
šput
->
	`key
();

757 
IÁ”ÇlKey
 
tmp_š‹º®_key
;

758 
tmp_š‹º®_key
.
	`DecodeFrom
(
key
);

759 ià(
com·ù
->
com·ùiÚ
->
	`ShouldStİBefÜe
(
tmp_š‹º®_key
) &&

760 
com·ù
->
bud”
 !ğ
NULL
) {

761 
¡©us
 = 
	`FšishCom·ùiÚOuutFe
(
com·ù
, 
šput
);

762 ià(!
¡©us
.
	`ok
()) {

768 
boŞ
 
drİ
 = 
çl£
;

769 ià(!
	`P¬£IÁ”ÇlKey
(
key
, &
ikey
)) {

771 
cu¼’t_u£r_key
.
	`ş—r
();

772 
has_cu¼’t_u£r_key
 = 
çl£
;

773 
Ï¡_£qu’û_fÜ_key
 = 
kMaxSequ’ûNumb”
;

775 ià(!
has_cu¼’t_u£r_key
 ||

776 
	`u£r_com·¿tÜ
()->
	`Com·»
(
ikey
.
u£r_key
,

777 
	`Sliû
(
cu¼’t_u£r_key
)) != 0) {

779 
cu¼’t_u£r_key
.
	`assign
(
ikey
.
u£r_key
.
	`d©a
(), ikey.u£r_key.
	`size
());

780 
has_cu¼’t_u£r_key
 = 
Œue
;

781 
Ï¡_£qu’û_fÜ_key
 = 
kMaxSequ’ûNumb”
;

784 ià(
Ï¡_£qu’û_fÜ_key
 <ğ
com·ù
->
sm®Ë¡_¢­shÙ
) {

786 
drİ
 = 
Œue
;

787 } ià(
ikey
.
ty³
 =ğ
kTy³D–‘iÚ
 &&

788 
ikey
.
£qu’û
 <ğ
com·ù
->
sm®Ë¡_¢­shÙ
 &&

789 
com·ù
->
com·ùiÚ
->
	`IsBa£Lev–FÜKey
(
ikey
.
u£r_key
)) {

797 
drİ
 = 
Œue
;

800 
Ï¡_£qu’û_fÜ_key
 = 
ikey
.
£qu’û
;

803 
	`Log
(
’v_
, 
İtiÚs_
.
šfo_log
,

806 
ikey
.
u£r_key
.
	`ToSŒšg
().
	`c_¡r
(),

807 ()
ikey
.
£qu’û
, ikey.
ty³
, 
kTy³V®ue
, 
drİ
,

808 
com·ù
->
com·ùiÚ
->
	`IsBa£Lev–FÜKey
(
ikey
.
u£r_key
),

809 ()
Ï¡_£qu’û_fÜ_key
, ()
com·ù
->
sm®Ë¡_¢­shÙ
);

812 ià(!
drİ
) {

814 ià(
com·ù
->
bud”
 =ğ
NULL
) {

815 
¡©us
 = 
	`O³nCom·ùiÚOuutFe
(
com·ù
);

816 ià(!
¡©us
.
	`ok
()) {

820 ià(
com·ù
->
bud”
->
	`NumEÁr›s
() == 0) {

821 
com·ù
->
	`cu¼’t_ouut
()->
sm®Ë¡
.
	`DecodeFrom
(
key
);

823 
com·ù
->
	`cu¼’t_ouut
()->
Ïrge¡
.
	`DecodeFrom
(
key
);

824 
com·ù
->
bud”
->
	`Add
(
key
, 
šput
->
	`v®ue
());

827 ià(
com·ù
->
bud”
->
	`FeSize
() >=

828 
com·ù
->
com·ùiÚ
->
	`MaxOuutFeSize
()) {

829 
¡©us
 = 
	`FšishCom·ùiÚOuutFe
(
com·ù
, 
šput
);

830 ià(!
¡©us
.
	`ok
()) {

836 
šput
->
	`Next
();

839 ià(
¡©us
.
	`ok
(è&& 
shu‰šg_down_
.
	`Acquœe_Lßd
()) {

840 
¡©us
 = 
Stus
::
	`IOE¼Ü
("Deleting DB during compaction");

842 ià(
¡©us
.
	`ok
(è&& 
com·ù
->
bud”
 !ğ
NULL
) {

843 
¡©us
 = 
	`FšishCom·ùiÚOuutFe
(
com·ù
, 
šput
);

845 ià(
¡©us
.
	`ok
()) {

846 
¡©us
 = 
šput
->
	`¡©us
();

848 
d–‘e
 
šput
;

849 
šput
 = 
NULL
;

851 
Com·ùiÚSts
 
¡©s
;

852 
¡©s
.
miüos
 = 
’v_
->
	`NowMiüos
(è- 
¡¬t_miüos
 - 
imm_miüos
;

853 
which
 = 0; which < 2; which++) {

854 
i
 = 0; i < 
com·ù
->
com·ùiÚ
->
	`num_šput_fes
(
which
); i++) {

855 
¡©s
.
by‹s_»ad
 +ğ
com·ù
->
com·ùiÚ
->
	`šput
(
which
, 
i
)->
fe_size
;

858 
size_t
 
i
 = 0; i < 
com·ù
->
ouuts
.
	`size
(); i++) {

859 
¡©s
.
by‹s_wr™‹n
 +ğ
com·ù
->
ouuts
[
i
].
fe_size
;

862 
mu‹x_
.
	`Lock
();

863 
¡©s_
[
com·ù
->
com·ùiÚ
->
	`Ëv–
(è+ 1].
	`Add
(
¡©s
);

865 ià(
¡©us
.
	`ok
()) {

866 
¡©us
 = 
	`In¡®lCom·ùiÚResuÉs
(
com·ù
);

868 
com·ùšg_
 = 
çl£
;

869 
com·ùšg_cv_
.
	`SigÇlAÎ
();

870  
¡©us
;

871 
	}
}

873 
I‹¿tÜ
* 
	gDBIm¶
::
	$NewIÁ”ÇlI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
,

874 
Sequ’ûNumb”
* 
Ï‹¡_¢­shÙ
) {

875 
mu‹x_
.
	`Lock
();

876 *
Ï‹¡_¢­shÙ
 = 
v”siÚs_
->
	`La¡Sequ’û
();

879 
¡d
::
veùÜ
<
I‹¿tÜ
*> 
li¡
;

880 
li¡
.
	`push_back
(
mem_
->
	`NewI‹¿tÜ
());

881 ià(
imm_
 !ğ
NULL
) {

882 
li¡
.
	`push_back
(
imm_
->
	`NewI‹¿tÜ
());

884 
v”siÚs_
->
	`cu¼’t
()->
	`AddI‹¿tÜs
(
İtiÚs
, &
li¡
);

885 
I‹¿tÜ
* 
š‹º®_™”
 =

886 
	`NewM”gšgI‹¿tÜ
(&
š‹º®_com·¿tÜ_
, &
li¡
[0],†i¡.
	`size
());

887 
v”siÚs_
->
	`cu¼’t
()->
	`Ref
();

888 
š‹º®_™”
->
	`Regi¡”CËªup
(&
DBIm¶
::
UÄef
, 
this
, 
v”siÚs_
->
	`cu¼’t
());

890 
mu‹x_
.
	`UÆock
();

891  
š‹º®_™”
;

892 
	}
}

894 
I‹¿tÜ
* 
	gDBIm¶
::
	$TEST_NewIÁ”ÇlI‹¿tÜ
() {

895 
Sequ’ûNumb”
 
ignÜed
;

896  
	`NewIÁ”ÇlI‹¿tÜ
(
	`R—dO±iÚs
(), &
ignÜed
);

897 
	}
}

899 
št64_t
 
	gDBIm¶
::
	$TEST_MaxNextLev–Ov”ÏµšgBy‹s
() {

900 
Mu‹xLock
 
	`l
(&
mu‹x_
);

901  
v”siÚs_
->
	`MaxNextLev–Ov”ÏµšgBy‹s
();

902 
	}
}

904 
Stus
 
	gDBIm¶
::
G‘
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
,

905 cÚ¡ 
Sliû
& 
key
,

906 
¡d
::
¡ršg
* 
v®ue
) {

908 
I‹¿tÜ
* 
™”
 = 
NewI‹¿tÜ
(
İtiÚs
);

909 
	g™”
->
S“k
(
key
);

910 
boŞ
 
	gfound
 = 
çl£
;

911 ià(
	g™”
->
V®id
(è&& 
u£r_com·¿tÜ
()->
Com·»
(
key
, 
™”
->key()) == 0) {

912 
Sliû
 
v
 = 
™”
->
v®ue
();

913 
	gv®ue
->
assign
(
v
.
d©a
(), v.
size
());

914 
	gfound
 = 
Œue
;

917 
Stus
 
	g»suÉ
 = 
™”
->
¡©us
();

918 ià(
	g»suÉ
.
ok
(è&& !
	gfound
) {

919 
	g»suÉ
 = 
Stus
::
NÙFound
(
Sliû
());

921 
d–‘e
 
	g™”
;

922  
	g»suÉ
;

925 
I‹¿tÜ
* 
	gDBIm¶
::
	$NewI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
) {

926 
Sequ’ûNumb”
 
Ï‹¡_¢­shÙ
;

927 
I‹¿tÜ
* 
š‹º®_™”
 = 
	`NewIÁ”ÇlI‹¿tÜ
(
İtiÚs
, &
Ï‹¡_¢­shÙ
);

928 
Sequ’ûNumb”
 
£qu’û
 =

929 (
İtiÚs
.
¢­shÙ
 ? o±iÚs.¢­shÙ->
numb”_
 : 
Ï‹¡_¢­shÙ
);

930  
	`NewDBI‹¿tÜ
(&
dbÇme_
, 
’v_
,

931 
	`u£r_com·¿tÜ
(), 
š‹º®_™”
, 
£qu’û
);

932 
	}
}

934 
	gDBIm¶
::
	$UÄef
(* 
¬g1
, * 
¬g2
) {

935 
DBIm¶
* 
im¶
 = 
»š‹½»t_ÿ¡
<DBIm¶*>(
¬g1
);

936 
V”siÚ
* 
v
 = 
»š‹½»t_ÿ¡
<V”siÚ*>(
¬g2
);

937 
Mu‹xLock
 
	`l
(&
im¶
->
mu‹x_
);

938 
v
->
	`UÄef
();

939 
	}
}

941 cÚ¡ 
SÇpshÙ
* 
	gDBIm¶
::
	$G‘SÇpshÙ
() {

942 
Mu‹xLock
 
	`l
(&
mu‹x_
);

943  
¢­shÙs_
.
	`New
(
v”siÚs_
->
	`La¡Sequ’û
());

944 
	}
}

946 
	gDBIm¶
::
	$R–—£SÇpshÙ
(cÚ¡ 
SÇpshÙ
* 
s
) {

947 
Mu‹xLock
 
	`l
(&
mu‹x_
);

948 
¢­shÙs_
.
	`D–‘e
(
s
);

949 
	}
}

952 
Stus
 
	gDBIm¶
::
	$Put
(cÚ¡ 
Wr™eO±iÚs
& 
o
, cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
v®
) {

953  
DB
::
	`Put
(
o
, 
key
, 
v®
);

954 
	}
}

956 
Stus
 
	gDBIm¶
::
	$D–‘e
(cÚ¡ 
Wr™eO±iÚs
& 
İtiÚs
, cÚ¡ 
Sliû
& 
key
) {

957  
DB
::
	`D–‘e
(
İtiÚs
, 
key
);

958 
	}
}

960 
Stus
 
	gDBIm¶
::
	$Wr™e
(cÚ¡ 
Wr™eO±iÚs
& 
İtiÚs
, 
Wr™eB©ch
* 
upd©es
) {

961 
Stus
 
¡©us
;

962 
Mu‹xLock
 
	`l
(&
mu‹x_
);

963 
¡©us
 = 
	`MakeRoomFÜWr™e
(
çl£
);

964 
ušt64_t
 
Ï¡_£qu’û
 = 
v”siÚs_
->
	`La¡Sequ’û
();

965 ià(
¡©us
.
	`ok
()) {

966 
Wr™eB©chIÁ”Çl
::
	`S‘Sequ’û
(
upd©es
, 
Ï¡_£qu’û
 + 1);

967 
Ï¡_£qu’û
 +ğ
Wr™eB©chIÁ”Çl
::
	`CouÁ
(
upd©es
);

968 
v”siÚs_
->
	`S‘La¡Sequ’û
(
Ï¡_£qu’û
);

971 
¡©us
 = 
log_
->
	`AddRecÜd
(
Wr™eB©chIÁ”Çl
::
	`CÚ‹Ás
(
upd©es
));

972 ià(
¡©us
.
	`ok
(è&& 
İtiÚs
.
sync
) {

973 
¡©us
 = 
logfe_
->
	`Sync
();

975 ià(
¡©us
.
	`ok
()) {

976 
¡©us
 = 
Wr™eB©chIÁ”Çl
::
	`In£¹IÁo
(
upd©es
, 
mem_
);

979 ià(
İtiÚs
.
po¡_wr™e_¢­shÙ
 !ğ
NULL
) {

980 *
İtiÚs
.
po¡_wr™e_¢­shÙ
 =

981 
¡©us
.
	`ok
(è? 
¢­shÙs_
.
	`New
(
Ï¡_£qu’û
è: 
NULL
;

983  
¡©us
;

984 
	}
}

986 
Stus
 
	gDBIm¶
::
	$MakeRoomFÜWr™e
(
boŞ
 
fÜû
) {

987 
mu‹x_
.
	`As£¹H–d
();

988 
Stus
 
s
;

989 
Œue
) {

990 ià(!
bg_”rÜ_
.
	`ok
()) {

992 
s
 = 
bg_”rÜ_
;

994 } ià(!
fÜû
 &&

995 (
mem_
->
	`Aµroxim©eMemÜyU§ge
(è<ğ
İtiÚs_
.
wr™e_bufãr_size
)) {

998 } ià(
imm_
 !ğ
NULL
) {

1001 
com·ùšg_cv_
.
	`Wa™
();

1004 
	`as£¹
(
v”siÚs_
->
	`P»vLogNumb”
() == 0);

1005 
ušt64_t
 
Ãw_log_numb”
 = 
v”siÚs_
->
	`NewFeNumb”
();

1006 
Wr™abËFe
* 
lfe
 = 
NULL
;

1007 
s
 = 
’v_
->
	`NewWr™abËFe
(
	`LogFeName
(
dbÇme_
, 
Ãw_log_numb”
), &
lfe
);

1008 ià(!
s
.
	`ok
()) {

1011 
V”siÚEd™
 
ed™
;

1012 
ed™
.
	`S‘P»vLogNumb”
(
v”siÚs_
->
	`LogNumb”
());

1013 
ed™
.
	`S‘LogNumb”
(
Ãw_log_numb”
);

1014 
s
 = 
v”siÚs_
->
	`LogAndAµly
(&
ed™
, 
NULL
);

1015 ià(!
s
.
	`ok
()) {

1016 
d–‘e
 
lfe
;

1017 
’v_
->
	`D–‘eFe
(
	`LogFeName
(
dbÇme_
, 
Ãw_log_numb”
));

1020 
d–‘e
 
log_
;

1021 
d–‘e
 
logfe_
;

1022 
logfe_
 = 
lfe
;

1023 
log_
 = 
Ãw
 
log
::
	`Wr™”
(
lfe
);

1024 
imm_
 = 
mem_
;

1025 
has_imm_
.
	`R–—£_StÜe
(
imm_
);

1026 
mem_
 = 
Ãw
 
	`MemTabË
(
š‹º®_com·¿tÜ_
);

1027 
fÜû
 = 
çl£
;

1028 
	`MaybeScheduËCom·ùiÚ
();

1031  
s
;

1032 
	}
}

1034 
boŞ
 
	gDBIm¶
::
G‘Prİ”ty
(cÚ¡ 
Sliû
& 
´İ”ty
, 
¡d
::
¡ršg
* 
v®ue
) {

1035 
v®ue
->
ş—r
();

1037 
Mu‹xLock
 
l
(&
mu‹x_
);

1038 
Sliû
 
	gš
 = 
´İ”ty
;

1039 
Sliû
 
´efix
("leveldb.");

1040 ià(!
	gš
.
¡¬ts_w™h
(
´efix
)è 
	gçl£
;

1041 
	gš
.
»move_´efix
(
´efix
.
size
());

1043 ià(
	gš
.
¡¬ts_w™h
("num-files-at-level")) {

1044 
	gš
.
»move_´efix
(
¡¾’
("num-files-at-level"));

1045 
ušt64_t
 
	gËv–
;

1046 
boŞ
 
	gok
 = 
CÚsumeDecim®Numb”
(&
š
, &
Ëv–
è&& 
	gš
.
em±y
();

1047 ià(!
	gok
 || 
	gËv–
 < 0 ||†ev– >ğ
cÚfig
::
kNumLev–s
) {

1048  
çl£
;

1050 
	gbuf
[100];

1051 
¢´štf
(
buf
, (buf), "%d",

1052 
v”siÚs_
->
NumLev–Fes
(
¡©ic_ÿ¡
<>(
Ëv–
)));

1053 *
	gv®ue
 = 
buf
;

1054  
	gŒue
;

1056 } ià(
	gš
 == "stats") {

1057 
buf
[200];

1058 
¢´štf
(
buf
, (buf),

1063 
	gv®ue
->
­³nd
(
buf
);

1064 
	gËv–
 = 0;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

1065 
	gfes
 = 
v”siÚs_
->
NumLev–Fes
(
Ëv–
);

1066 ià(
	g¡©s_
[
Ëv–
].
	gmiüos
 > 0 || 
	gfes
 > 0) {

1067 
¢´štf
(

1068 
buf
, (buf),

1070 
Ëv–
,

1071 
fes
,

1072 
v”siÚs_
->
NumLev–By‹s
(
Ëv–
) / 1048576.0,

1073 
¡©s_
[
Ëv–
].
miüos
 / 1e6,

1074 
¡©s_
[
Ëv–
].
by‹s_»ad
 / 1048576.0,

1075 
¡©s_
[
Ëv–
].
by‹s_wr™‹n
 / 1048576.0);

1076 
	gv®ue
->
­³nd
(
buf
);

1079  
	gŒue
;

1082  
	gçl£
;

1085 
	gDBIm¶
::
	$G‘Aµroxim©eSizes
(

1086 cÚ¡ 
Rªge
* 
¿nge
, 
n
,

1087 
ušt64_t
* 
sizes
) {

1089 
V”siÚ
* 
v
;

1091 
Mu‹xLock
 
	`l
(&
mu‹x_
);

1092 
v”siÚs_
->
	`cu¼’t
()->
	`Ref
();

1093 
v
 = 
v”siÚs_
->
	`cu¼’t
();

1096 
i
 = 0; i < 
n
; i++) {

1098 
IÁ”ÇlKey
 
	`k1
(
¿nge
[
i
].
¡¬t
, 
kMaxSequ’ûNumb”
, 
kV®ueTy³FÜS“k
);

1099 
IÁ”ÇlKey
 
	`k2
(
¿nge
[
i
].
lim™
, 
kMaxSequ’ûNumb”
, 
kV®ueTy³FÜS“k
);

1100 
ušt64_t
 
¡¬t
 = 
v”siÚs_
->
	`Aµroxim©eOff£tOf
(
v
, 
k1
);

1101 
ušt64_t
 
lim™
 = 
v”siÚs_
->
	`Aµroxim©eOff£tOf
(
v
, 
k2
);

1102 
sizes
[
i
] = (
lim™
 >ğ
¡¬t
 ?†imit - start : 0);

1106 
Mu‹xLock
 
	`l
(&
mu‹x_
);

1107 
v
->
	`UÄef
();

1109 
	}
}

1113 
Stus
 
	gDB
::
	$Put
(cÚ¡ 
Wr™eO±iÚs
& 
İt
, cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
v®ue
) {

1114 
Wr™eB©ch
 
b©ch
;

1115 
b©ch
.
	`Put
(
key
, 
v®ue
);

1116  
	`Wr™e
(
İt
, &
b©ch
);

1117 
	}
}

1119 
Stus
 
	gDB
::
	$D–‘e
(cÚ¡ 
Wr™eO±iÚs
& 
İt
, cÚ¡ 
Sliû
& 
key
) {

1120 
Wr™eB©ch
 
b©ch
;

1121 
b©ch
.
	`D–‘e
(
key
);

1122  
	`Wr™e
(
İt
, &
b©ch
);

1123 
	}
}

1125 
	gDB
::~
	$DB
(è{ 
	}
}

1127 
Stus
 
DB
::
O³n
(cÚ¡ 
O±iÚs
& 
İtiÚs
, cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
,

1128 
DB
** 
db±r
) {

1129 *
	gdb±r
 = 
NULL
;

1131 
DBIm¶
* 
	gim¶
 = 
Ãw
 DBIm¶(
İtiÚs
, 
dbÇme
);

1132 
	gim¶
->
	gmu‹x_
.
Lock
();

1133 
V”siÚEd™
 
	ged™
;

1134 
Stus
 
	gs
 = 
im¶
->
Recov”
(&
ed™
);

1135 ià(
	gs
.
ok
()) {

1136 
ušt64_t
 
	gÃw_log_numb”
 = 
im¶
->
v”siÚs_
->
NewFeNumb”
();

1137 
Wr™abËFe
* 
	glfe
;

1138 
	gs
 = 
İtiÚs
.
’v
->
NewWr™abËFe
(
LogFeName
(
dbÇme
, 
Ãw_log_numb”
),

1139 &
lfe
);

1140 ià(
	gs
.
ok
()) {

1141 
	ged™
.
S‘LogNumb”
(
Ãw_log_numb”
);

1142 
	gim¶
->
	glogfe_
 = 
lfe
;

1143 
	gim¶
->
	glog_
 = 
Ãw
 
log
::
Wr™”
(
lfe
);

1144 
	gs
 = 
im¶
->
v”siÚs_
->
LogAndAµly
(&
ed™
, 
NULL
);

1146 ià(
	gs
.
ok
()) {

1147 
	gim¶
->
D–‘eObsŞ‘eFes
();

1150 
	gim¶
->
	gmu‹x_
.
UÆock
();

1151 ià(
	gs
.
ok
()) {

1152 *
	gdb±r
 = 
im¶
;

1154 
d–‘e
 
	gim¶
;

1156  
	gs
;

1159 
Stus
 
De¡royDB
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
, cÚ¡ 
O±iÚs
& 
İtiÚs
) {

1160 
Env
* 
	g’v
 = 
İtiÚs
.
’v
;

1161 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
f’ames
;

1163 
	g’v
->
G‘Chd»n
(
dbÇme
, &
f’ames
);

1164 ià(
	gf’ames
.
em±y
()) {

1165  
	gStus
::
OK
();

1168 
FeLock
* 
	glock
;

1169 
Stus
 
	g»suÉ
 = 
’v
->
LockFe
(
LockFeName
(
dbÇme
), &
lock
);

1170 ià(
	g»suÉ
.
ok
()) {

1171 
ušt64_t
 
	gnumb”
;

1172 
FeTy³
 
	gty³
;

1173 
size_t
 
	gi
 = 0; i < 
	gf’ames
.
size
(); i++) {

1174 ià(
P¬£FeName
(
f’ames
[
i
], &
numb”
, &
ty³
)) {

1175 
Stus
 
	gd–
 = 
’v
->
D–‘eFe
(
dbÇme
 + "/" + 
f’ames
[
i
]);

1176 ià(
	g»suÉ
.
ok
(è&& !
	gd–
.ok()) {

1177 
	g»suÉ
 = 
d–
;

1181 
	g’v
->
UÆockFe
(
lock
);

1182 
	g’v
->
D–‘eFe
(
LockFeName
(
dbÇme
));

1183 
	g’v
->
D–‘eDœ
(
dbÇme
);

1185  
	g»suÉ
;

	@db/db_impl.h

5 #iâdeà
STORAGE_LEVELDB_DB_DB_IMPL_H_


6 
	#STORAGE_LEVELDB_DB_DB_IMPL_H_


	)

8 
	~<£t
>

9 
	~"db/dbfÜm©.h
"

10 
	~"db/log_wr™”.h
"

11 
	~"db/¢­shÙ.h
"

12 
	~"Ëv–db/db.h
"

13 
	~"Ëv–db/’v.h
"

14 
	~"pÜt/pÜt.h
"

16 
Çme¥aû
 
	gËv–db
 {

18 
şass
 
	gMemTabË
;

19 
şass
 
	gTabËCache
;

20 
şass
 
	gV”siÚ
;

21 
şass
 
	gV”siÚEd™
;

22 
şass
 
	gV”siÚS‘
;

24 şas 
	cDBIm¶
 : 
public
 
DB
 {

25 
public
:

26 
DBIm¶
(cÚ¡ 
O±iÚs
& 
İtiÚs
, cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
);

27 
	gvœtu®
 ~
DBIm¶
();

30 
vœtu®
 
Stus
 
Put
(cÚ¡ 
Wr™eO±iÚs
&, cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
v®ue
);

31 
vœtu®
 
Stus
 
D–‘e
(cÚ¡ 
Wr™eO±iÚs
&, cÚ¡ 
Sliû
& 
key
);

32 
vœtu®
 
Stus
 
Wr™e
(cÚ¡ 
Wr™eO±iÚs
& 
İtiÚs
, 
Wr™eB©ch
* 
upd©es
);

33 
vœtu®
 
Stus
 
G‘
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
,

34 cÚ¡ 
Sliû
& 
key
,

35 
¡d
::
¡ršg
* 
v®ue
);

36 
vœtu®
 
I‹¿tÜ
* 
NewI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
&);

37 
vœtu®
 cÚ¡ 
SÇpshÙ
* 
G‘SÇpshÙ
();

38 
vœtu®
 
R–—£SÇpshÙ
(cÚ¡ 
SÇpshÙ
* 
¢­shÙ
);

39 
vœtu®
 
boŞ
 
G‘Prİ”ty
(cÚ¡ 
Sliû
& 
´İ”ty
, 
¡d
::
¡ršg
* 
v®ue
);

40 
vœtu®
 
G‘Aµroxim©eSizes
(cÚ¡ 
Rªge
* 
¿nge
, 
n
, 
ušt64_t
* 
sizes
);

45 
TEST_Com·ùRªge
(

46 
Ëv–
,

47 cÚ¡ 
¡d
::
¡ršg
& 
begš
,

48 cÚ¡ 
¡d
::
¡ršg
& 
’d
);

51 
Stus
 
TEST_Com·ùMemTabË
();

56 
I‹¿tÜ
* 
TEST_NewIÁ”ÇlI‹¿tÜ
();

60 
št64_t
 
TEST_MaxNextLev–Ov”ÏµšgBy‹s
();

62 
	g´iv©e
:

63 
ä›nd
 
şass
 
DB
;

65 
I‹¿tÜ
* 
NewIÁ”ÇlI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
&,

66 
Sequ’ûNumb”
* 
Ï‹¡_¢­shÙ
);

68 
Stus
 
NewDB
();

73 
Stus
 
Recov”
(
V”siÚEd™
* 
ed™
);

75 
MaybeIgnÜeE¼Ü
(
Stus
* 
s
) const;

78 
D–‘eObsŞ‘eFes
();

82 
UÄef
(* 
¬g1
, * 
¬g2
);

86 
Stus
 
Com·ùMemTabË
();

88 
Stus
 
Recov”LogFe
(
ušt64_t
 
log_numb”
,

89 
V”siÚEd™
* 
ed™
,

90 
Sequ’ûNumb”
* 
max_£qu’û
);

92 
Stus
 
Wr™eLev–0TabË
(
MemTabË
* 
mem
, 
V”siÚEd™
* 
ed™
);

94 
Stus
 
MakeRoomFÜWr™e
(
boŞ
 
fÜû
 );

96 
	gCom·ùiÚS‹
;

98 
MaybeScheduËCom·ùiÚ
();

99 
BGWÜk
(* 
db
);

100 
BackgroundC®l
();

101 
BackgroundCom·ùiÚ
();

102 
CËªupCom·ùiÚ
(
Com·ùiÚS‹
* 
com·ù
);

103 
Stus
 
DoCom·ùiÚWÜk
(
Com·ùiÚS‹
* 
com·ù
);

105 
Stus
 
O³nCom·ùiÚOuutFe
(
Com·ùiÚS‹
* 
com·ù
);

106 
Stus
 
FšishCom·ùiÚOuutFe
(
Com·ùiÚS‹
* 
com·ù
, 
I‹¿tÜ
* 
šput
);

107 
Stus
 
In¡®lCom·ùiÚResuÉs
(
Com·ùiÚS‹
* 
com·ù
);

110 
Env
* cÚ¡ 
	g’v_
;

111 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
 
	gš‹º®_com·¿tÜ_
;

112 cÚ¡ 
O±iÚs
 
	gİtiÚs_
;

113 
boŞ
 
	gowns_šfo_log_
;

114 
boŞ
 
	gowns_ÿche_
;

115 cÚ¡ 
	g¡d
::
¡ršg
 
dbÇme_
;

118 
TabËCache
* 
	gbË_ÿche_
;

121 
FeLock
* 
	gdb_lock_
;

124 
	gpÜt
::
Mu‹x
 
mu‹x_
;

125 
	gpÜt
::
AtomicPoš‹r
 
shu‰šg_down_
;

126 
	gpÜt
::
CÚdV¬
 
bg_cv_
;

127 
	gpÜt
::
CÚdV¬
 
com·ùšg_cv_
;

128 
MemTabË
* 
	gmem_
;

129 
MemTabË
* 
	gimm_
;

130 
	gpÜt
::
AtomicPoš‹r
 
has_imm_
;

131 
Wr™abËFe
* 
	glogfe_
;

132 
	glog
::
Wr™”
* 
log_
;

133 
SÇpshÙLi¡
 
	g¢­shÙs_
;

137 
	g¡d
::
£t
<
ušt64_t
> 
³ndšg_ouuts_
;

140 
boŞ
 
	gbg_com·ùiÚ_scheduËd_
;

143 
boŞ
 
	gcom·ùšg_
;

145 
V”siÚS‘
* 
	gv”siÚs_
;

148 
Stus
 
	gbg_”rÜ_
;

152 
	sCom·ùiÚSts
 {

153 
št64_t
 
	gmiüos
;

154 
št64_t
 
	gby‹s_»ad
;

155 
št64_t
 
	gby‹s_wr™‹n
;

157 
Com·ùiÚSts
(è: 
miüos
(0), 
by‹s_»ad
(0), 
by‹s_wr™‹n
(0) { }

159 
Add
(cÚ¡ 
Com·ùiÚSts
& 
c
) {

160 
	gthis
->
	gmiüos
 +ğ
c
.
miüos
;

161 
	gthis
->
	gby‹s_»ad
 +ğ
c
.
by‹s_»ad
;

162 
	gthis
->
	gby‹s_wr™‹n
 +ğ
c
.
by‹s_wr™‹n
;

165 
Com·ùiÚSts
 
	g¡©s_
[
cÚfig
::
kNumLev–s
];

168 
DBIm¶
(const DBImpl&);

169 
	gİ”©Ü
=(cÚ¡ 
DBIm¶
&);

171 cÚ¡ 
Com·¿tÜ
* 
u£r_com·¿tÜ
() const {

172  
	gš‹º®_com·¿tÜ_
.
u£r_com·¿tÜ
();

178 
O±iÚs
 
Sª™izeO±iÚs
(cÚ¡ 
¡d
::
¡ršg
& 
db
,

179 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
* 
icmp
,

180 cÚ¡ 
O±iÚs
& 
¤c
);

	@db/db_iter.cc

5 
	~"db/db_™”.h
"

7 
	~"db/f’ame.h
"

8 
	~"db/dbfÜm©.h
"

9 
	~"Ëv–db/’v.h
"

10 
	~"Ëv–db/™”©Ü.h
"

11 
	~"pÜt/pÜt.h
"

12 
	~"ut/loggšg.h
"

13 
	~"ut/mu‹xlock.h
"

15 
Çme¥aû
 
	gËv–db
 {

18 
DumpIÁ”ÇlI‹r
(
I‹¿tÜ
* 
™”
) {

19 
	g™”
->
S“kToFœ¡
(); i‹r->
V®id
(); i‹r->
Next
()) {

20 
P¬£dIÁ”ÇlKey
 
	gk
;

21 ià(!
P¬£IÁ”ÇlKey
(
™”
->
key
(), &
k
)) {

22 
årštf
(
¡d”r
, "CÜru± '%s'\n", 
Esÿ³SŒšg
(
™”
->
key
()).
c_¡r
());

24 
årštf
(
¡d”r
, "@ '%s'\n", 
k
.
DebugSŒšg
().
c_¡r
());

30 
	gÇme¥aû
 {

37 şas 
	cDBI‹r
: 
public
 
I‹¿tÜ
 {

38 
public
:

44 
	eDœeùiÚ
 {

45 
kFÜw¬d
,

46 
	gkRev”£


49 
DBI‹r
(cÚ¡ 
¡d
::
¡ršg
* 
dbÇme
, 
Env
* 
’v
,

50 cÚ¡ 
Com·¿tÜ
* 
cmp
, 
I‹¿tÜ
* 
™”
, 
Sequ’ûNumb”
 
s
)

51 : 
dbÇme_
(
dbÇme
),

52 
’v_
(
’v
),

53 
u£r_com·¿tÜ_
(
cmp
),

54 
™”_
(
™”
),

55 
£qu’û_
(
s
),

56 
dœeùiÚ_
(
kFÜw¬d
),

57 
v®id_
(
çl£
) {

59 
	gvœtu®
 ~
DBI‹r
() {

60 
d–‘e
 
	g™”_
;

62 
vœtu®
 
boŞ
 
V®id
(ècÚ¡ {  
	gv®id_
; }

63 
vœtu®
 
Sliû
 
key
() const {

64 
as£¹
(
v®id_
);

65  (
	gdœeùiÚ_
 =ğ
kFÜw¬d
è? 
ExŒaùU£rKey
(
™”_
->
key
()è: 
§ved_key_
;

67 
vœtu®
 
Sliû
 
v®ue
() const {

68 
as£¹
(
v®id_
);

69  (
	gdœeùiÚ_
 =ğ
kFÜw¬d
è? 
™”_
->
v®ue
(è: 
§ved_v®ue_
;

71 
vœtu®
 
Stus
 
¡©us
() const {

72 ià(
	g¡©us_
.
ok
()) {

73  
	g™”_
->
¡©us
();

75  
	g¡©us_
;

79 
vœtu®
 
Next
();

80 
vœtu®
 
P»v
();

81 
vœtu®
 
S“k
(cÚ¡ 
Sliû
& 
rg‘
);

82 
vœtu®
 
S“kToFœ¡
();

83 
vœtu®
 
S“kToLa¡
();

85 
	g´iv©e
:

86 
FšdNextU£rEÁry
(
boŞ
 
skpšg
, 
¡d
::
¡ršg
* 
sk
);

87 
FšdP»vU£rEÁry
();

88 
boŞ
 
P¬£Key
(
P¬£dIÁ”ÇlKey
* 
key
);

90 
šlše
 
SaveKey
(cÚ¡ 
Sliû
& 
k
, 
¡d
::
¡ršg
* 
d¡
) {

91 
d¡
->
assign
(
k
.
d©a
(), k.
size
());

94 
šlše
 
CË¬SavedV®ue
() {

95 ià(
	g§ved_v®ue_
.
ÿ·c™y
() > 1048576) {

96 
	g¡d
::
¡ršg
 
em±y
;

97 
sw­
(
em±y
, 
§ved_v®ue_
);

99 
	g§ved_v®ue_
.
ş—r
();

103 cÚ¡ 
	g¡d
::
¡ršg
* cÚ¡ 
dbÇme_
;

104 
Env
* cÚ¡ 
	g’v_
;

105 cÚ¡ 
Com·¿tÜ
* cÚ¡ 
	gu£r_com·¿tÜ_
;

106 
I‹¿tÜ
* cÚ¡ 
	g™”_
;

107 
Sequ’ûNumb”
 cÚ¡ 
	g£qu’û_
;

109 
Stus
 
	g¡©us_
;

110 
	g¡d
::
¡ršg
 
§ved_key_
;

111 
	g¡d
::
¡ršg
 
§ved_v®ue_
;

112 
DœeùiÚ
 
	gdœeùiÚ_
;

113 
boŞ
 
	gv®id_
;

116 
DBI‹r
(const DBIter&);

117 
	gİ”©Ü
=(cÚ¡ 
DBI‹r
&);

120 
šlše
 
boŞ
 
	gDBI‹r
::
P¬£Key
(
P¬£dIÁ”ÇlKey
* 
ikey
) {

121 ià(!
P¬£IÁ”ÇlKey
(
™”_
->
key
(), 
ikey
)) {

122 
	g¡©us_
 = 
Stus
::
CÜru±iÚ
("corrupted internal key in DBIter");

123  
	gçl£
;

125  
	gŒue
;

129 
	gDBI‹r
::
Next
() {

130 
as£¹
(
v®id_
);

132 ià(
	gdœeùiÚ_
 =ğ
kRev”£
) {

133 
dœeùiÚ_
 = 
kFÜw¬d
;

137 ià(!
	g™”_
->
V®id
()) {

138 
	g™”_
->
S“kToFœ¡
();

140 
	g™”_
->
Next
();

142 ià(!
	g™”_
->
V®id
()) {

143 
	gv®id_
 = 
çl£
;

144 
	g§ved_key_
.
ş—r
();

150 
	g¡d
::
¡ršg
* 
sk
 = &
§ved_key_
;

151 
SaveKey
(
ExŒaùU£rKey
(
™”_
->
key
()), 
sk
);

152 
FšdNextU£rEÁry
(
Œue
, 
sk
);

155 
	gDBI‹r
::
FšdNextU£rEÁry
(
boŞ
 
skpšg
, 
¡d
::
¡ršg
* 
sk
) {

157 
as£¹
(
™”_
->
V®id
());

158 
as£¹
(
dœeùiÚ_
 =ğ
kFÜw¬d
);

160 
P¬£dIÁ”ÇlKey
 
	gikey
;

161 ià(
P¬£Key
(&
ikey
è&& 
	gikey
.
	g£qu’û
 <ğ
£qu’û_
) {

162 
ikey
.
ty³
) {

163 
kTy³D–‘iÚ
:

166 
SaveKey
(
ikey
.
u£r_key
, 
sk
);

167 
	gskpšg
 = 
Œue
;

169 
	gkTy³V®ue
:

170 ià(
skpšg
 &&

171 
u£r_com·¿tÜ_
->
Com·»
(
ikey
.
u£r_key
, *
sk
) <= 0) {

174 
v®id_
 = 
Œue
;

175 
	g§ved_key_
.
ş—r
();

181 
	g™”_
->
Next
();

182 } 
	g™”_
->
V®id
());

183 
	g§ved_key_
.
ş—r
();

184 
	gv®id_
 = 
çl£
;

187 
	gDBI‹r
::
P»v
() {

188 
as£¹
(
v®id_
);

190 ià(
	gdœeùiÚ_
 =ğ
kFÜw¬d
) {

193 
as£¹
(
™”_
->
V®id
());

194 
SaveKey
(
ExŒaùU£rKey
(
™”_
->
key
()), &
§ved_key_
);

195 
	gŒue
) {

196 
	g™”_
->
P»v
();

197 ià(!
	g™”_
->
V®id
()) {

198 
	gv®id_
 = 
çl£
;

199 
	g§ved_key_
.
ş—r
();

200 
CË¬SavedV®ue
();

203 ià(
	gu£r_com·¿tÜ_
->
Com·»
(
ExŒaùU£rKey
(
™”_
->
key
()),

204 
§ved_key_
) < 0) {

208 
	gdœeùiÚ_
 = 
kRev”£
;

211 
FšdP»vU£rEÁry
();

214 
	gDBI‹r
::
FšdP»vU£rEÁry
() {

215 
as£¹
(
dœeùiÚ_
 =ğ
kRev”£
);

217 
V®ueTy³
 
	gv®ue_ty³
 = 
kTy³D–‘iÚ
;

218 ià(
	g™”_
->
V®id
()) {

219 
SaveKey
(
ExŒaùU£rKey
(
™”_
->
key
()), &
§ved_key_
);

221 
P¬£dIÁ”ÇlKey
 
	gikey
;

222 ià(
P¬£Key
(&
ikey
è&& 
	gikey
.
	g£qu’û
 <ğ
£qu’û_
) {

223 ià((
v®ue_ty³
 !ğ
kTy³D–‘iÚ
) &&

224 
u£r_com·¿tÜ_
->
Com·»
(
ikey
.
u£r_key
, 
§ved_key_
) < 0) {

228 
	gv®ue_ty³
 = 
ikey
.
ty³
;

229 ià(
	gv®ue_ty³
 =ğ
kTy³D–‘iÚ
) {

230 
CË¬SavedV®ue
();

232 
Sliû
 
	g¿w_v®ue
 = 
™”_
->
v®ue
();

233 ià(
	g§ved_v®ue_
.
ÿ·c™y
(è> 
	g¿w_v®ue
.
size
() + 1048576) {

234 
	g¡d
::
¡ršg
 
em±y
;

235 
sw­
(
em±y
, 
§ved_v®ue_
);

237 
	g§ved_v®ue_
.
assign
(
¿w_v®ue
.
d©a
(),„aw_v®ue.
size
());

240 
	g™”_
->
P»v
();

241 } 
	g™”_
->
V®id
());

244 ià(
	gv®ue_ty³
 =ğ
kTy³D–‘iÚ
) {

246 
v®id_
 = 
çl£
;

247 
	g§ved_key_
.
ş—r
();

248 
CË¬SavedV®ue
();

249 
	gdœeùiÚ_
 = 
kFÜw¬d
;

251 
	gv®id_
 = 
Œue
;

255 
	gDBI‹r
::
S“k
(cÚ¡ 
Sliû
& 
rg‘
) {

256 
dœeùiÚ_
 = 
kFÜw¬d
;

257 
CË¬SavedV®ue
();

258 
	g§ved_key_
.
ş—r
();

259 
Aµ’dIÁ”ÇlKey
(

260 &
§ved_key_
, 
P¬£dIÁ”ÇlKey
(
rg‘
, 
£qu’û_
, 
kV®ueTy³FÜS“k
));

261 
	g™”_
->
S“k
(
§ved_key_
);

262 ià(
	g™”_
->
V®id
()) {

263 
FšdNextU£rEÁry
(
çl£
, &
§ved_key_
 );

265 
	gv®id_
 = 
çl£
;

269 
	gDBI‹r
::
S“kToFœ¡
() {

270 
dœeùiÚ_
 = 
kFÜw¬d
;

271 
CË¬SavedV®ue
();

272 
	g™”_
->
S“kToFœ¡
();

273 ià(
	g™”_
->
V®id
()) {

274 
FšdNextU£rEÁry
(
çl£
, &
§ved_key_
 );

276 
	gv®id_
 = 
çl£
;

280 
	gDBI‹r
::
S“kToLa¡
() {

281 
dœeùiÚ_
 = 
kRev”£
;

282 
CË¬SavedV®ue
();

283 
	g™”_
->
S“kToLa¡
();

284 
FšdP»vU£rEÁry
();

289 
I‹¿tÜ
* 
NewDBI‹¿tÜ
(

290 cÚ¡ 
¡d
::
¡ršg
* 
dbÇme
,

291 
Env
* 
’v
,

292 cÚ¡ 
Com·¿tÜ
* 
u£r_key_com·¿tÜ
,

293 
I‹¿tÜ
* 
š‹º®_™”
,

294 cÚ¡ 
Sequ’ûNumb”
& 
£qu’û
) {

295  
Ãw
 
DBI‹r
(
dbÇme
, 
’v
, 
u£r_key_com·¿tÜ
, 
š‹º®_™”
, 
£qu’û
);

	@db/db_iter.h

5 #iâdeà
STORAGE_LEVELDB_DB_DB_ITER_H_


6 
	#STORAGE_LEVELDB_DB_DB_ITER_H_


	)

8 
	~<¡dšt.h
>

9 
	~"Ëv–db/db.h
"

10 
	~"db/dbfÜm©.h
"

12 
Çme¥aû
 
	gËv–db
 {

17 
I‹¿tÜ
* 
NewDBI‹¿tÜ
(

18 cÚ¡ 
¡d
::
¡ršg
* 
dbÇme
,

19 
Env
* 
’v
,

20 cÚ¡ 
Com·¿tÜ
* 
u£r_key_com·¿tÜ
,

21 
I‹¿tÜ
* 
š‹º®_™”
,

22 cÚ¡ 
Sequ’ûNumb”
& 
£qu’û
);

	@db/db_test.cc

5 
	~"Ëv–db/db.h
"

7 
	~"db/db_im¶.h
"

8 
	~"db/f’ame.h
"

9 
	~"db/v”siÚ_£t.h
"

10 
	~"db/wr™e_b©ch_š‹º®.h
"

11 
	~"Ëv–db/’v.h
"

12 
	~"Ëv–db/bË.h
"

13 
	~"ut/loggšg.h
"

14 
	~"ut/‹¡h¬Ãss.h
"

15 
	~"ut/‹¡ut.h
"

17 
Çme¥aû
 
	gËv–db
 {

19 
	g¡d
::
¡ršg
 
RªdomSŒšg
(
Rªdom
* 
ºd
, 
Ën
) {

20 
	g¡d
::
¡ršg
 
r
;

21 
	g‹¡
::
RªdomSŒšg
(
ºd
, 
Ën
, &
r
);

22  
	gr
;

25 şas 
	cDBTe¡
 {

26 
	gpublic
:

27 
¡d
::
¡ršg
 
dbÇme_
;

28 
Env
* 
	g’v_
;

29 
DB
* 
	gdb_
;

31 
O±iÚs
 
	gÏ¡_İtiÚs_
;

33 
DBTe¡
(è: 
’v_
(
Env
::
DeçuÉ
()) {

34 
dbÇme_
 = 
‹¡
::
TmpDœ
() + "/db_test";

35 
De¡royDB
(
dbÇme_
, 
O±iÚs
());

36 
	gdb_
 = 
NULL
;

37 
Reİ’
();

40 ~
DBTe¡
() {

41 
d–‘e
 
	gdb_
;

42 
De¡royDB
(
dbÇme_
, 
O±iÚs
());

45 
DBIm¶
* 
dbfuÎ
() {

46  
	g»š‹½»t_ÿ¡
<
	gDBIm¶
*>(
	gdb_
);

49 
Reİ’
(
O±iÚs
* 
İtiÚs
 = 
NULL
) {

50 
ASSERT_OK
(
TryReİ’
(
İtiÚs
));

53 
De¡royAndReİ’
(
O±iÚs
* 
İtiÚs
 = 
NULL
) {

54 
d–‘e
 
db_
;

55 
	gdb_
 = 
NULL
;

56 
De¡royDB
(
dbÇme_
, 
O±iÚs
());

57 
ASSERT_OK
(
TryReİ’
(
İtiÚs
));

60 
Stus
 
TryReİ’
(
O±iÚs
* 
İtiÚs
) {

61 
d–‘e
 
	gdb_
;

62 
	gdb_
 = 
NULL
;

63 
O±iÚs
 
	gİts
;

64 ià(
	gİtiÚs
 !ğ
NULL
) {

65 
İts
 = *
İtiÚs
;

67 
	gİts
.
	gü—‹_if_missšg
 = 
Œue
;

69 
	gÏ¡_İtiÚs_
 = 
İts
;

71  
	gDB
::
O³n
(
İts
, 
dbÇme_
, &
db_
);

74 
Stus
 
Put
(cÚ¡ 
¡d
::
¡ršg
& 
k
, cÚ¡ std::¡ršg& 
v
) {

75  
db_
->
Put
(
Wr™eO±iÚs
(), 
k
, 
v
);

78 
Stus
 
D–‘e
(cÚ¡ 
¡d
::
¡ršg
& 
k
) {

79  
db_
->
D–‘e
(
Wr™eO±iÚs
(), 
k
);

82 
	g¡d
::
¡ršg
 
G‘
(cÚ¡ 
¡d
::¡ršg& 
k
, cÚ¡ 
SÇpshÙ
* 
¢­shÙ
 = 
NULL
) {

83 
R—dO±iÚs
 
İtiÚs
;

84 
	gİtiÚs
.
	g¢­shÙ
 = 
¢­shÙ
;

85 
	g¡d
::
¡ršg
 
»suÉ
;

86 
Stus
 
	gs
 = 
db_
->
G‘
(
İtiÚs
, 
k
, &
»suÉ
);

87 ià(
	gs
.
IsNÙFound
()) {

88 
	g»suÉ
 = "NOT_FOUND";

89 } ià(!
	gs
.
ok
()) {

90 
	g»suÉ
 = 
s
.
ToSŒšg
();

92  
	g»suÉ
;

95 
	g¡d
::
¡ršg
 
AÎEÁr›sFÜ
(cÚ¡ 
Sliû
& 
u£r_key
) {

96 
I‹¿tÜ
* 
™”
 = 
dbfuÎ
()->
TEST_NewIÁ”ÇlI‹¿tÜ
();

97 
IÁ”ÇlKey
 
rg‘
(
u£r_key
, 
kMaxSequ’ûNumb”
, 
kTy³V®ue
);

98 
	g™”
->
S“k
(
rg‘
.
Encode
());

99 
	g¡d
::
¡ršg
 
»suÉ
;

100 ià(!
	g™”
->
¡©us
().
ok
()) {

101 
	g»suÉ
 = 
™”
->
¡©us
().
ToSŒšg
();

103 
	g»suÉ
 = "[ ";

104 
boŞ
 
	gfœ¡
 = 
Œue
;

105 
	g™”
->
V®id
()) {

106 
P¬£dIÁ”ÇlKey
 
	gikey
;

107 ià(!
P¬£IÁ”ÇlKey
(
™”
->
key
(), &
ikey
)) {

108 
	g»suÉ
 += "CORRUPTED";

110 ià(
	gÏ¡_İtiÚs_
.
	gcom·¿tÜ
->
Com·»
(

111 
ikey
.
u£r_key
, user_key) != 0) {

114 ià(!
	gfœ¡
) {

115 
	g»suÉ
 += ", ";

117 
	gfœ¡
 = 
çl£
;

118 
	gikey
.
	gty³
) {

119 
	gkTy³V®ue
:

120 
»suÉ
 +ğ
™”
->
v®ue
().
ToSŒšg
();

122 
	gkTy³D–‘iÚ
:

123 
»suÉ
 += "DEL";

127 
	g™”
->
Next
();

129 ià(!
	gfœ¡
) {

130 
	g»suÉ
 += " ";

132 
	g»suÉ
 += "]";

134 
d–‘e
 
	g™”
;

135  
	g»suÉ
;

138 
NumTabËFesAtLev–
(
Ëv–
) {

139 
	g¡d
::
¡ršg
 
´İ”ty
;

140 
ASSERT_TRUE
(

141 
db_
->
G‘Prİ”ty
("Ëv–db.num-fes-©-Ëv–" + 
Numb”ToSŒšg
(
Ëv–
),

142 &
´İ”ty
));

143  
©oi
(
´İ”ty
.
c_¡r
());

146 
ušt64_t
 
Size
(cÚ¡ 
Sliû
& 
¡¬t
, cÚ¡ Sliû& 
lim™
) {

147 
Rªge
 
r
(
¡¬t
, 
lim™
);

148 
ušt64_t
 
	gsize
;

149 
	gdb_
->
G‘Aµroxim©eSizes
(&
r
, 1, &
size
);

150  
	gsize
;

153 
Com·ù
(cÚ¡ 
Sliû
& 
¡¬t
, cÚ¡ Sliû& 
lim™
) {

154 
dbfuÎ
()->
TEST_Com·ùMemTabË
();

155 
	gmax_Ëv–_w™h_fes
 = 1;

156 
	gËv–
 = 1;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

157 ià(
NumTabËFesAtLev–
(
Ëv–
) > 0) {

158 
	gmax_Ëv–_w™h_fes
 = 
Ëv–
;

161 
	gËv–
 = 0;†ev– < 
	gmax_Ëv–_w™h_fes
;†evel++) {

162 
dbfuÎ
()->
TEST_Com·ùRªge
(
Ëv–
, "", "~");

166 
DumpFeCouÁs
(cÚ¡ * 
Ïb–
) {

167 
årštf
(
¡d”r
, "---\n%s:\n", 
Ïb–
);

168 
årštf
(
¡d”r
, "maxoverlap: %lld\n",

169 
¡©ic_ÿ¡
<>(

170 
dbfuÎ
()->
TEST_MaxNextLev–Ov”ÏµšgBy‹s
()));

171 
	gËv–
 = 0;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

172 
	gnum
 = 
NumTabËFesAtLev–
(
Ëv–
);

173 ià(
	gnum
 > 0) {

174 
årštf
(
¡d”r
, "†ev– %3d : %d fes\n", 
Ëv–
, 
num
);

179 
	g¡d
::
¡ršg
 
I‹rStus
(
I‹¿tÜ
* 
™”
) {

180 
¡d
::
¡ršg
 
»suÉ
;

181 ià(
	g™”
->
V®id
()) {

182 
	g»suÉ
 = 
™”
->
key
().
ToSŒšg
(è+ "->" + i‹r->
v®ue
().ToString();

184 
	g»suÉ
 = "(invalid)";

186  
	g»suÉ
;

190 
	$TEST
(
DBTe¡
, 
Em±y
) {

191 
	`ASSERT_TRUE
(
db_
 !ğ
NULL
);

192 
	`ASSERT_EQ
("NOT_FOUND", 
	`G‘
("foo"));

193 
	}
}

195 
	$TEST
(
DBTe¡
, 
R—dWr™e
) {

196 
	`ASSERT_OK
(
	`Put
("foo", "v1"));

197 
	`ASSERT_EQ
("v1", 
	`G‘
("foo"));

198 
	`ASSERT_OK
(
	`Put
("bar", "v2"));

199 
	`ASSERT_OK
(
	`Put
("foo", "v3"));

200 
	`ASSERT_EQ
("v3", 
	`G‘
("foo"));

201 
	`ASSERT_EQ
("v2", 
	`G‘
("bar"));

202 
	}
}

204 
	$TEST
(
DBTe¡
, 
PutD–‘eG‘
) {

205 
	`ASSERT_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), "foo", "v1"));

206 
	`ASSERT_EQ
("v1", 
	`G‘
("foo"));

207 
	`ASSERT_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), "foo", "v2"));

208 
	`ASSERT_EQ
("v2", 
	`G‘
("foo"));

209 
	`ASSERT_OK
(
db_
->
	`D–‘e
(
	`Wr™eO±iÚs
(), "foo"));

210 
	`ASSERT_EQ
("NOT_FOUND", 
	`G‘
("foo"));

211 
	}
}

213 
	$TEST
(
DBTe¡
, 
I‹rEm±y
) {

214 
I‹¿tÜ
* 
™”
 = 
db_
->
	`NewI‹¿tÜ
(
	`R—dO±iÚs
());

216 
™”
->
	`S“kToFœ¡
();

217 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

219 
™”
->
	`S“kToLa¡
();

220 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

222 
™”
->
	`S“k
("foo");

223 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

225 
d–‘e
 
™”
;

226 
	}
}

228 
	$TEST
(
DBTe¡
, 
I‹rSšgË
) {

229 
	`ASSERT_OK
(
	`Put
("a", "va"));

230 
I‹¿tÜ
* 
™”
 = 
db_
->
	`NewI‹¿tÜ
(
	`R—dO±iÚs
());

232 
™”
->
	`S“kToFœ¡
();

233 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

234 
™”
->
	`Next
();

235 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

236 
™”
->
	`S“kToFœ¡
();

237 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

238 
™”
->
	`P»v
();

239 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

241 
™”
->
	`S“kToLa¡
();

242 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

243 
™”
->
	`Next
();

244 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

245 
™”
->
	`S“kToLa¡
();

246 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

247 
™”
->
	`P»v
();

248 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

250 
™”
->
	`S“k
("");

251 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

252 
™”
->
	`Next
();

253 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

255 
™”
->
	`S“k
("a");

256 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

257 
™”
->
	`Next
();

258 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

260 
™”
->
	`S“k
("b");

261 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

263 
d–‘e
 
™”
;

264 
	}
}

266 
	$TEST
(
DBTe¡
, 
I‹rMuÉi
) {

267 
	`ASSERT_OK
(
	`Put
("a", "va"));

268 
	`ASSERT_OK
(
	`Put
("b", "vb"));

269 
	`ASSERT_OK
(
	`Put
("c", "vc"));

270 
I‹¿tÜ
* 
™”
 = 
db_
->
	`NewI‹¿tÜ
(
	`R—dO±iÚs
());

272 
™”
->
	`S“kToFœ¡
();

273 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

274 
™”
->
	`Next
();

275 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->vb");

276 
™”
->
	`Next
();

277 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "c->vc");

278 
™”
->
	`Next
();

279 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

280 
™”
->
	`S“kToFœ¡
();

281 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

282 
™”
->
	`P»v
();

283 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

285 
™”
->
	`S“kToLa¡
();

286 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "c->vc");

287 
™”
->
	`P»v
();

288 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->vb");

289 
™”
->
	`P»v
();

290 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

291 
™”
->
	`P»v
();

292 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

293 
™”
->
	`S“kToLa¡
();

294 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "c->vc");

295 
™”
->
	`Next
();

296 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

298 
™”
->
	`S“k
("");

299 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

300 
™”
->
	`S“k
("a");

301 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

302 
™”
->
	`S“k
("ax");

303 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->vb");

304 
™”
->
	`S“k
("b");

305 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->vb");

306 
™”
->
	`S“k
("z");

307 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

310 
™”
->
	`S“kToLa¡
();

311 
™”
->
	`P»v
();

312 
™”
->
	`P»v
();

313 
™”
->
	`Next
();

314 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->vb");

317 
™”
->
	`S“kToFœ¡
();

318 
™”
->
	`Next
();

319 
™”
->
	`Next
();

320 
™”
->
	`P»v
();

321 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->vb");

324 
	`ASSERT_OK
(
	`Put
("a", "va2"));

325 
	`ASSERT_OK
(
	`Put
("a2", "va3"));

326 
	`ASSERT_OK
(
	`Put
("b", "vb2"));

327 
	`ASSERT_OK
(
	`Put
("c", "vc2"));

328 
	`ASSERT_OK
(
	`D–‘e
("b"));

329 
™”
->
	`S“kToFœ¡
();

330 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

331 
™”
->
	`Next
();

332 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->vb");

333 
™”
->
	`Next
();

334 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "c->vc");

335 
™”
->
	`Next
();

336 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

337 
™”
->
	`S“kToLa¡
();

338 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "c->vc");

339 
™”
->
	`P»v
();

340 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->vb");

341 
™”
->
	`P»v
();

342 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

343 
™”
->
	`P»v
();

344 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

346 
d–‘e
 
™”
;

347 
	}
}

349 
	$TEST
(
DBTe¡
, 
I‹rSm®lAndL¬geMix
) {

350 
	`ASSERT_OK
(
	`Put
("a", "va"));

351 
	`ASSERT_OK
(
	`Put
("b", 
¡d
::
	`¡ršg
(100000, 'b')));

352 
	`ASSERT_OK
(
	`Put
("c", "vc"));

353 
	`ASSERT_OK
(
	`Put
("d", 
¡d
::
	`¡ršg
(100000, 'd')));

354 
	`ASSERT_OK
(
	`Put
("e", 
¡d
::
	`¡ršg
(100000, 'e')));

356 
I‹¿tÜ
* 
™”
 = 
db_
->
	`NewI‹¿tÜ
(
	`R—dO±iÚs
());

358 
™”
->
	`S“kToFœ¡
();

359 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

360 
™”
->
	`Next
();

361 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->" + 
¡d
::
	`¡ršg
(100000, 'b'));

362 
™”
->
	`Next
();

363 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "c->vc");

364 
™”
->
	`Next
();

365 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "d->" + 
¡d
::
	`¡ršg
(100000, 'd'));

366 
™”
->
	`Next
();

367 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "e->" + 
¡d
::
	`¡ršg
(100000, 'e'));

368 
™”
->
	`Next
();

369 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

371 
™”
->
	`S“kToLa¡
();

372 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "e->" + 
¡d
::
	`¡ršg
(100000, 'e'));

373 
™”
->
	`P»v
();

374 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "d->" + 
¡d
::
	`¡ršg
(100000, 'd'));

375 
™”
->
	`P»v
();

376 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "c->vc");

377 
™”
->
	`P»v
();

378 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "b->" + 
¡d
::
	`¡ršg
(100000, 'b'));

379 
™”
->
	`P»v
();

380 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "a->va");

381 
™”
->
	`P»v
();

382 
	`ASSERT_EQ
(
	`I‹rStus
(
™”
), "(invalid)");

384 
d–‘e
 
™”
;

385 
	}
}

387 
	$TEST
(
DBTe¡
, 
Recov”
) {

388 
	`ASSERT_OK
(
	`Put
("foo", "v1"));

389 
	`ASSERT_OK
(
	`Put
("baz", "v5"));

391 
	`Reİ’
();

392 
	`ASSERT_EQ
("v1", 
	`G‘
("foo"));

394 
	`ASSERT_EQ
("v1", 
	`G‘
("foo"));

395 
	`ASSERT_EQ
("v5", 
	`G‘
("baz"));

396 
	`ASSERT_OK
(
	`Put
("bar", "v2"));

397 
	`ASSERT_OK
(
	`Put
("foo", "v3"));

399 
	`Reİ’
();

400 
	`ASSERT_EQ
("v3", 
	`G‘
("foo"));

401 
	`ASSERT_OK
(
	`Put
("foo", "v4"));

402 
	`ASSERT_EQ
("v4", 
	`G‘
("foo"));

403 
	`ASSERT_EQ
("v2", 
	`G‘
("bar"));

404 
	`ASSERT_EQ
("v5", 
	`G‘
("baz"));

405 
	}
}

407 
	$TEST
(
DBTe¡
, 
Recov”yW™hEm±yLog
) {

408 
	`ASSERT_OK
(
	`Put
("foo", "v1"));

409 
	`ASSERT_OK
(
	`Put
("foo", "v2"));

410 
	`Reİ’
();

411 
	`Reİ’
();

412 
	`ASSERT_OK
(
	`Put
("foo", "v3"));

413 
	`Reİ’
();

414 
	`ASSERT_EQ
("v3", 
	`G‘
("foo"));

415 
	}
}

417 
	g¡d
::
¡ršg
 
	$Key
(
i
) {

418 
buf
[100];

419 
	`¢´štf
(
buf
, (buf), "key%06d", 
i
);

420  
¡d
::
	`¡ršg
(
buf
);

421 
	}
}

423 
	$TEST
(
DBTe¡
, 
MšÜCom·ùiÚsH­³n
) {

424 
O±iÚs
 
İtiÚs
;

425 
İtiÚs
.
wr™e_bufãr_size
 = 10000;

426 
	`Reİ’
(&
İtiÚs
);

428 cÚ¡ 
N
 = 500;

430 
¡¬tšg_num_bËs
 = 
	`NumTabËFesAtLev–
(0);

431 
i
 = 0; i < 
N
; i++) {

432 
	`ASSERT_OK
(
	`Put
(
	`Key
(
i
), Key(iè+ 
¡d
::
	`¡ršg
(1000, 'v')));

434 
’dšg_num_bËs
 = 
	`NumTabËFesAtLev–
(0);

435 
	`ASSERT_GT
(
’dšg_num_bËs
, 
¡¬tšg_num_bËs
);

437 
i
 = 0; i < 
N
; i++) {

438 
	`ASSERT_EQ
(
	`Key
(
i
è+ 
¡d
::
	`¡ršg
(1000, 'v'), 
	`G‘
(Key(i)));

441 
	`Reİ’
();

443 
i
 = 0; i < 
N
; i++) {

444 
	`ASSERT_EQ
(
	`Key
(
i
è+ 
¡d
::
	`¡ršg
(1000, 'v'), 
	`G‘
(Key(i)));

446 
	}
}

448 
	$TEST
(
DBTe¡
, 
Recov”W™hL¬geLog
) {

450 
O±iÚs
 
İtiÚs
;

451 
	`Reİ’
(&
İtiÚs
);

452 
	`ASSERT_OK
(
	`Put
("big1", 
¡d
::
	`¡ršg
(200000, '1')));

453 
	`ASSERT_OK
(
	`Put
("big2", 
¡d
::
	`¡ršg
(200000, '2')));

454 
	`ASSERT_OK
(
	`Put
("sm®l3", 
¡d
::
	`¡ršg
(10, '3')));

455 
	`ASSERT_OK
(
	`Put
("sm®l4", 
¡d
::
	`¡ršg
(10, '4')));

456 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(0), 0);

461 
O±iÚs
 
İtiÚs
;

462 
İtiÚs
.
wr™e_bufãr_size
 = 100000;

463 
	`Reİ’
(&
İtiÚs
);

464 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(0), 3);

465 
	`ASSERT_EQ
(
¡d
::
	`¡ršg
(200000, '1'), 
	`G‘
("big1"));

466 
	`ASSERT_EQ
(
¡d
::
	`¡ršg
(200000, '2'), 
	`G‘
("big2"));

467 
	`ASSERT_EQ
(
¡d
::
	`¡ršg
(10, '3'), 
	`G‘
("small3"));

468 
	`ASSERT_EQ
(
¡d
::
	`¡ršg
(10, '4'), 
	`G‘
("small4"));

469 
	`ASSERT_GT
(
	`NumTabËFesAtLev–
(0), 1);

470 
	}
}

472 
	$TEST
(
DBTe¡
, 
Com·ùiÚsG’”©eMuÉËFes
) {

473 
O±iÚs
 
İtiÚs
;

474 
İtiÚs
.
wr™e_bufãr_size
 = 100000000;

475 
	`Reİ’
(&
İtiÚs
);

477 
Rªdom
 
	`ºd
(301);

480 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(0), 0);

481 
¡d
::
veùÜ
<¡d::
¡ršg
> 
v®ues
;

482 
i
 = 0; i < 80; i++) {

483 
v®ues
.
	`push_back
(
	`RªdomSŒšg
(&
ºd
, 100000));

484 
	`ASSERT_OK
(
	`Put
(
	`Key
(
i
), 
v®ues
[i]));

488 
	`Reİ’
(&
İtiÚs
);

489 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(0, "", 
	`Key
(100000));

491 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(0), 0);

492 
	`ASSERT_GT
(
	`NumTabËFesAtLev–
(1), 1);

493 
i
 = 0; i < 80; i++) {

494 
	`ASSERT_EQ
(
	`G‘
(
	`Key
(
i
)), 
v®ues
[i]);

496 
	}
}

498 
	$TEST
(
DBTe¡
, 
S·r£M”ge
) {

499 
O±iÚs
 
İtiÚs
;

500 
İtiÚs
.
com´essiÚ
 = 
kNoCom´essiÚ
;

501 
	`Reİ’
(&
İtiÚs
);

509 cÚ¡ 
¡d
::
¡ršg
 
	`v®ue
(1000, 'x');

510 
	`Put
("A", "va");

512 
i
 = 0; i < 100000; i++) {

513 
key
[100];

514 
	`¢´štf
(
key
, (key), "B%010d", 
i
);

515 
	`Put
(
key
, 
v®ue
);

517 
	`Put
("C", "vc");

518 
	`Com·ù
("", "z");

521 
	`Put
("A", "va2");

522 
	`Put
("B100", "bvalue2");

523 
	`Put
("C", "vc2");

524 
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
();

528 
	`ASSERT_LE
(
	`dbfuÎ
()->
	`TEST_MaxNextLev–Ov”ÏµšgBy‹s
(), 20*1048576);

529 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(0, "", "z");

530 
	`ASSERT_LE
(
	`dbfuÎ
()->
	`TEST_MaxNextLev–Ov”ÏµšgBy‹s
(), 20*1048576);

531 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(1, "", "z");

532 
	`ASSERT_LE
(
	`dbfuÎ
()->
	`TEST_MaxNextLev–Ov”ÏµšgBy‹s
(), 20*1048576);

533 
	}
}

535 
boŞ
 
	$B‘w“n
(
ušt64_t
 
v®
, ušt64_ˆ
low
, ušt64_ˆ
high
) {

536 
boŞ
 
»suÉ
 = (
v®
 >ğ
low
è&& (v® <ğ
high
);

537 ià(!
»suÉ
) {

538 
	`årštf
(
¡d”r
, "Value %llu is‚ot in„ange [%llu, %llu]\n",

539 ()(
v®
),

540 ()(
low
),

541 ()(
high
));

543  
»suÉ
;

544 
	}
}

546 
	$TEST
(
DBTe¡
, 
Aµroxim©eSizes
) {

547 
O±iÚs
 
İtiÚs
;

548 
İtiÚs
.
wr™e_bufãr_size
 = 100000000;

549 
İtiÚs
.
com´essiÚ
 = 
kNoCom´essiÚ
;

550 
	`De¡royAndReİ’
();

552 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", "xyz"), 0, 0));

553 
	`Reİ’
(&
İtiÚs
);

554 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", "xyz"), 0, 0));

557 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(0), 0);

558 cÚ¡ 
N
 = 80;

559 
Rªdom
 
	`ºd
(301);

560 
i
 = 0; i < 
N
; i++) {

561 
	`ASSERT_OK
(
	`Put
(
	`Key
(
i
), 
	`RªdomSŒšg
(&
ºd
, 100000)));

565 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(50)), 0, 0));

568 
run
 = 0;„un < 3;„un++) {

569 
	`Reİ’
(&
İtiÚs
);

571 
com·ù_¡¬t
 = 0; com·ù_¡¬ˆ< 
N
; compact_start += 10) {

572 
i
 = 0; i < 
N
; i += 10) {

573 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(
i
)), 100000*i, 100000*i + 10000));

574 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(
i
)+".suffix"),

575 100000 * (
i
+1), 100000 * (i+1) + 10000));

576 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
(
	`Key
(
i
), Key(i+10)),

579 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(50)), 5000000, 5010000));

580 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(50)+".suffix"), 5100000, 5110000));

582 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(0,

583 
	`Key
(
com·ù_¡¬t
),

584 
	`Key
(
com·ù_¡¬t
 + 9));

587 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(0), 0);

588 
	`ASSERT_GT
(
	`NumTabËFesAtLev–
(1), 0);

590 
	}
}

592 
	$TEST
(
DBTe¡
, 
Aµroxim©eSizes_MixOfSm®lAndL¬ge
) {

593 
O±iÚs
 
İtiÚs
;

594 
İtiÚs
.
com´essiÚ
 = 
kNoCom´essiÚ
;

595 
	`Reİ’
();

597 
Rªdom
 
	`ºd
(301);

598 
¡d
::
¡ršg
 
big1
 = 
	`RªdomSŒšg
(&
ºd
, 100000);

599 
	`ASSERT_OK
(
	`Put
(
	`Key
(0), 
	`RªdomSŒšg
(&
ºd
, 10000)));

600 
	`ASSERT_OK
(
	`Put
(
	`Key
(1), 
	`RªdomSŒšg
(&
ºd
, 10000)));

601 
	`ASSERT_OK
(
	`Put
(
	`Key
(2), 
big1
));

602 
	`ASSERT_OK
(
	`Put
(
	`Key
(3), 
	`RªdomSŒšg
(&
ºd
, 10000)));

603 
	`ASSERT_OK
(
	`Put
(
	`Key
(4), 
big1
));

604 
	`ASSERT_OK
(
	`Put
(
	`Key
(5), 
	`RªdomSŒšg
(&
ºd
, 10000)));

605 
	`ASSERT_OK
(
	`Put
(
	`Key
(6), 
	`RªdomSŒšg
(&
ºd
, 300000)));

606 
	`ASSERT_OK
(
	`Put
(
	`Key
(7), 
	`RªdomSŒšg
(&
ºd
, 10000)));

609 
run
 = 0;„un < 3;„un++) {

610 
	`Reİ’
(&
İtiÚs
);

612 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(0)), 0, 0));

613 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(1)), 10000, 11000));

614 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(2)), 20000, 21000));

615 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(3)), 120000, 121000));

616 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(4)), 130000, 131000));

617 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(5)), 230000, 231000));

618 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(6)), 240000, 241000));

619 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(7)), 540000, 541000));

620 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", 
	`Key
(8)), 550000, 551000));

622 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
(
	`Key
(3), Key(5)), 110000, 111000));

624 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(0, 
	`Key
(0), Key(100));

626 
	}
}

628 
	$TEST
(
DBTe¡
, 
I‹¿tÜPšsRef
) {

629 
	`Put
("foo", "hello");

632 
I‹¿tÜ
* 
™”
 = 
db_
->
	`NewI‹¿tÜ
(
	`R—dO±iÚs
());

635 
	`Put
("foo", "newvalue1");

636 
i
 = 0; i < 100; i++) {

637 
	`ASSERT_OK
(
	`Put
(
	`Key
(
i
), Key(iè+ 
¡d
::
	`¡ršg
(100000, 'v')));

639 
	`Put
("foo", "newvalue2");

641 
™”
->
	`S“kToFœ¡
();

642 
	`ASSERT_TRUE
(
™”
->
	`V®id
());

643 
	`ASSERT_EQ
("foo", 
™”
->
	`key
().
	`ToSŒšg
());

644 
	`ASSERT_EQ
("h–lo", 
™”
->
	`v®ue
().
	`ToSŒšg
());

645 
™”
->
	`Next
();

646 
	`ASSERT_TRUE
(!
™”
->
	`V®id
());

647 
d–‘e
 
™”
;

648 
	}
}

650 
	$TEST
(
DBTe¡
, 
SÇpshÙ
) {

651 
	`Put
("foo", "v1");

652 cÚ¡ 
SÇpshÙ
* 
s1
 = 
db_
->
	`G‘SÇpshÙ
();

653 
	`Put
("foo", "v2");

654 cÚ¡ 
SÇpshÙ
* 
s2
 = 
db_
->
	`G‘SÇpshÙ
();

655 
	`Put
("foo", "v3");

656 cÚ¡ 
SÇpshÙ
* 
s3
 = 
db_
->
	`G‘SÇpshÙ
();

658 
	`Put
("foo", "v4");

659 
	`ASSERT_EQ
("v1", 
	`G‘
("foo", 
s1
));

660 
	`ASSERT_EQ
("v2", 
	`G‘
("foo", 
s2
));

661 
	`ASSERT_EQ
("v3", 
	`G‘
("foo", 
s3
));

662 
	`ASSERT_EQ
("v4", 
	`G‘
("foo"));

664 
db_
->
	`R–—£SÇpshÙ
(
s3
);

665 
	`ASSERT_EQ
("v1", 
	`G‘
("foo", 
s1
));

666 
	`ASSERT_EQ
("v2", 
	`G‘
("foo", 
s2
));

667 
	`ASSERT_EQ
("v4", 
	`G‘
("foo"));

669 
db_
->
	`R–—£SÇpshÙ
(
s1
);

670 
	`ASSERT_EQ
("v2", 
	`G‘
("foo", 
s2
));

671 
	`ASSERT_EQ
("v4", 
	`G‘
("foo"));

673 
db_
->
	`R–—£SÇpshÙ
(
s2
);

674 
	`ASSERT_EQ
("v4", 
	`G‘
("foo"));

675 
	}
}

677 
	$TEST
(
DBTe¡
, 
Hidd’V®uesA»Removed
) {

678 
Rªdom
 
	`ºd
(301);

679 
¡d
::
¡ršg
 
big
 = 
	`RªdomSŒšg
(&
ºd
, 50000);

680 
	`Put
("foo", 
big
);

681 
	`Put
("pastfoo", "v");

682 cÚ¡ 
SÇpshÙ
* 
¢­shÙ
 = 
db_
->
	`G‘SÇpshÙ
();

683 
	`Put
("foo", "tiny");

684 
	`Put
("pastfoo2", "v2");

686 
	`ASSERT_OK
(
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
());

687 
	`ASSERT_GT
(
	`NumTabËFesAtLev–
(0), 0);

689 
	`ASSERT_EQ
(
big
, 
	`G‘
("foo", 
¢­shÙ
));

690 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", "pastfoo"), 50000, 60000));

691 
db_
->
	`R–—£SÇpshÙ
(
¢­shÙ
);

692 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[šy, " + 
big
 + " ]");

693 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(0, "", "x");

694 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[iny ]");

695 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(0), 0);

696 
	`ASSERT_GE
(
	`NumTabËFesAtLev–
(1), 1);

697 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(1, "", "x");

698 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[iny ]");

700 
	`ASSERT_TRUE
(
	`B‘w“n
(
	`Size
("", "pastfoo"), 0, 1000));

701 
	}
}

703 
	$TEST
(
DBTe¡
, 
D–‘iÚM¬k”s1
) {

704 
	`Put
("foo", "v1");

705 
	`ASSERT_OK
(
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
());

706 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(0, "", "z");

707 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(1, "", "z");

708 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(2), 1);

709 
	`D–‘e
("foo");

710 
	`Put
("foo", "v2");

711 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[ v2, DEL, v1 ]");

712 
	`ASSERT_OK
(
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
());

713 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[ v2, DEL, v1 ]");

714 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(0, "", "z");

717 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[ v2, v1 ]");

718 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(1, "", "z");

721 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[ v2 ]");

722 
	}
}

724 
	$TEST
(
DBTe¡
, 
D–‘iÚM¬k”s2
) {

725 
	`Put
("foo", "v1");

726 
	`ASSERT_OK
(
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
());

727 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(0, "", "z");

728 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(1, "", "z");

729 
	`ASSERT_EQ
(
	`NumTabËFesAtLev–
(2), 1);

730 
	`D–‘e
("foo");

731 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[ DEL, v1 ]");

732 
	`ASSERT_OK
(
	`dbfuÎ
()->
	`TEST_Com·ùMemTabË
());

733 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[ DEL, v1 ]");

734 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(0, "", "z");

736 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[ DEL, v1 ]");

737 
	`dbfuÎ
()->
	`TEST_Com·ùRªge
(1, "", "z");

740 
	`ASSERT_EQ
(
	`AÎEÁr›sFÜ
("foo"), "[ ]");

741 
	}
}

743 
	$TEST
(
DBTe¡
, 
Com·¿tÜCheck
) {

744 şas 
	cNewCom·¿tÜ
 : 
public
 
Com·¿tÜ
 {

745 
public
:

746 
vœtu®
 cÚ¡ * 
	`Name
() const {  "leveldb.NewComparator"; }

747 
vœtu®
 
	`Com·»
(cÚ¡ 
Sliû
& 
a
, cÚ¡ Sliû& 
b
) const {

748  
	`By‹wi£Com·¿tÜ
()->
	`Com·»
(
a
, 
b
);

750 
vœtu®
 
	`FšdShÜ‹¡S•¬©Ü
(
¡d
::
¡ršg
* 
s
, cÚ¡ 
Sliû
& 
l
) const {

751 
	`By‹wi£Com·¿tÜ
()->
	`FšdShÜ‹¡S•¬©Ü
(
s
, 
l
);

753 
vœtu®
 
	`FšdShÜtSucûssÜ
(
¡d
::
¡ršg
* 
key
) const {

754 
	`By‹wi£Com·¿tÜ
()->
	`FšdShÜtSucûssÜ
(
key
);

757 
NewCom·¿tÜ
 
cmp
;

758 
O±iÚs
 
Ãw_İtiÚs
;

759 
Ãw_İtiÚs
.
com·¿tÜ
 = &
cmp
;

760 
Stus
 
s
 = 
	`TryReİ’
(&
Ãw_İtiÚs
);

761 
	`ASSERT_TRUE
(!
s
.
	`ok
());

762 
	`ASSERT_TRUE
(
s
.
	`ToSŒšg
().
	`fšd
("com·¿tÜ"è!ğ
¡d
::
¡ršg
::
Åos
)

763 << 
s
.
	`ToSŒšg
();

764 
	}
}

766 
	$TEST
(
DBTe¡
, 
DBO³n_O±iÚs
) {

767 
¡d
::
¡ršg
 
dbÇme
 = 
‹¡
::
	`TmpDœ
() + "/db_options_test";

768 
	`De¡royDB
(
dbÇme
, 
	`O±iÚs
());

771 
DB
* 
db
 = 
NULL
;

772 
O±iÚs
 
İts
;

773 
İts
.
ü—‹_if_missšg
 = 
çl£
;

774 
Stus
 
s
 = 
DB
::
	`O³n
(
İts
, 
dbÇme
, &
db
);

775 
	`ASSERT_TRUE
(
	`¡r¡r
(
s
.
	`ToSŒšg
().
	`c_¡r
(), "dÛ nÙƒxi¡"è!ğ
NULL
);

776 
	`ASSERT_TRUE
(
db
 =ğ
NULL
);

779 
İts
.
ü—‹_if_missšg
 = 
Œue
;

780 
s
 = 
DB
::
	`O³n
(
İts
, 
dbÇme
, &
db
);

781 
	`ASSERT_OK
(
s
);

782 
	`ASSERT_TRUE
(
db
 !ğ
NULL
);

784 
d–‘e
 
db
;

785 
db
 = 
NULL
;

788 
İts
.
ü—‹_if_missšg
 = 
çl£
;

789 
İts
.
”rÜ_if_exi¡s
 = 
Œue
;

790 
s
 = 
DB
::
	`O³n
(
İts
, 
dbÇme
, &
db
);

791 
	`ASSERT_TRUE
(
	`¡r¡r
(
s
.
	`ToSŒšg
().
	`c_¡r
(), "exi¡s"è!ğ
NULL
);

792 
	`ASSERT_TRUE
(
db
 =ğ
NULL
);

795 
İts
.
ü—‹_if_missšg
 = 
Œue
;

796 
İts
.
”rÜ_if_exi¡s
 = 
çl£
;

797 
s
 = 
DB
::
	`O³n
(
İts
, 
dbÇme
, &
db
);

798 
	`ASSERT_OK
(
s
);

799 
	`ASSERT_TRUE
(
db
 !ğ
NULL
);

801 
d–‘e
 
db
;

802 
db
 = 
NULL
;

803 
	}
}

805 şas 
	cMod–DB
: 
public
 
DB
 {

806 
public
:

807 
ex¶ic™
 
Mod–DB
(cÚ¡ 
O±iÚs
& 
İtiÚs
): 
İtiÚs_
(options) { }

808 ~
Mod–DB
() { }

809 
vœtu®
 
Stus
 
Put
(cÚ¡ 
Wr™eO±iÚs
& 
o
, cÚ¡ 
Sliû
& 
k
, cÚ¡ Sliû& 
v
) {

810  
	gDB
::
Put
(
o
, 
k
, 
v
);

812 
vœtu®
 
Stus
 
D–‘e
(cÚ¡ 
Wr™eO±iÚs
& 
o
, cÚ¡ 
Sliû
& 
key
) {

813  
	gDB
::
D–‘e
(
o
, 
key
);

815 
vœtu®
 
Stus
 
G‘
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
,

816 cÚ¡ 
Sliû
& 
key
, 
¡d
::
¡ršg
* 
v®ue
) {

817 
as£¹
(
çl£
);

818  
	gStus
::
NÙFound
(
key
);

820 
vœtu®
 
I‹¿tÜ
* 
NewI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
) {

821 ià(
	gİtiÚs
.
	g¢­shÙ
 =ğ
NULL
) {

822 
KVM­
* 
§ved
 = 
Ãw
 KVMap;

823 *
	g§ved
 = 
m­_
;

824  
Ãw
 
Mod–I‹r
(
§ved
, 
Œue
);

826 cÚ¡ 
KVM­
* 
	g¢­shÙ_¡©e
 =

827 
»š‹½»t_ÿ¡
<cÚ¡ 
KVM­
*>(
İtiÚs
.
¢­shÙ
->
numb”_
);

828  
Ãw
 
Mod–I‹r
(
¢­shÙ_¡©e
, 
çl£
);

831 
vœtu®
 cÚ¡ 
SÇpshÙ
* 
G‘SÇpshÙ
() {

832 
KVM­
* 
	g§ved
 = 
Ãw
 KVMap;

833 *
	g§ved
 = 
m­_
;

834  
	g¢­shÙs_
.
New
(

835 
»š‹½»t_ÿ¡
<
Sequ’ûNumb”
>(
§ved
));

838 
vœtu®
 
R–—£SÇpshÙ
(cÚ¡ 
SÇpshÙ
* 
¢­shÙ
) {

839 cÚ¡ 
KVM­
* 
	g§ved
 = 
»š‹½»t_ÿ¡
<cÚ¡ KVM­*>(
¢­shÙ
->
numb”_
);

840 
d–‘e
 
	g§ved
;

841 
	g¢­shÙs_
.
D–‘e
(
¢­shÙ
);

843 
vœtu®
 
Stus
 
Wr™e
(cÚ¡ 
Wr™eO±iÚs
& 
İtiÚs
, 
Wr™eB©ch
* 
b©ch
) {

844 
as£¹
(
İtiÚs
.
po¡_wr™e_¢­shÙ
 =ğ
NULL
);

845 
	gWr™eB©chIÁ”Çl
::
I‹¿tÜ
 
™
(*
b©ch
); !
	g™
.
DÚe
(); it.
Next
()) {

846 
	g™
.
İ
()) {

847 
	gkTy³V®ue
:

848 
m­_
[
™
.
key
().
ToSŒšg
()] = it.
v®ue
().ToString();

850 
	gkTy³D–‘iÚ
:

851 
m­_
.
”a£
(
™
.
key
().
ToSŒšg
());

855  
	gStus
::
OK
();

858 
vœtu®
 
boŞ
 
G‘Prİ”ty
(cÚ¡ 
Sliû
& 
´İ”ty
, 
¡d
::
¡ršg
* 
v®ue
) {

859  
çl£
;

861 
vœtu®
 
G‘Aµroxim©eSizes
(cÚ¡ 
Rªge
* 
r
, 
n
, 
ušt64_t
* 
sizes
) {

862 
	gi
 = 0; i < 
	gn
; i++) {

863 
	gsizes
[
i
] = 0;

866 
	g´iv©e
:

867 
¡d
::
	tm­
<
	t¡d
::
	t¡ršg
, std::¡ršg> 
	tKVM­
;

868 şas 
	cMod–I‹r
: 
public
 
I‹¿tÜ
 {

869 
public
:

870 
Mod–I‹r
(cÚ¡ 
KVM­
* 
m­
, 
boŞ
 
owÃd
)

871 : 
m­_
(
m­
), 
owÃd_
(
owÃd
), 
™”_
(m­_->
’d
()) {

873 ~
Mod–I‹r
() {

874 ià(
	gowÃd_
è
d–‘e
 
	gm­_
;

876 
vœtu®
 
boŞ
 
V®id
(ècÚ¡ {  
	g™”_
 !ğ
m­_
->
’d
(); }

877 
vœtu®
 
S“kToFœ¡
(è{ 
	g™”_
 = 
m­_
->
begš
(); }

878 
vœtu®
 
S“kToLa¡
() {

879 ià(
	gm­_
->
em±y
()) {

880 
	g™”_
 = 
m­_
->
’d
();

882 
	g™”_
 = 
m­_
->
fšd
(m­_->
rbegš
()->
fœ¡
);

885 
vœtu®
 
S“k
(cÚ¡ 
Sliû
& 
k
) {

886 
	g™”_
 = 
m­_
->
low”_bound
(
k
.
ToSŒšg
());

888 
vœtu®
 
Next
(è{ ++
	g™”_
; }

889 
vœtu®
 
P»v
(è{ --
	g™”_
; }

890 
vœtu®
 
Sliû
 
key
(ècÚ¡ {  
	g™”_
->
	gfœ¡
; }

891 
vœtu®
 
Sliû
 
v®ue
(ècÚ¡ {  
	g™”_
->
	g£cÚd
; }

892 
vœtu®
 
Stus
 
¡©us
(ècÚ¡ {  
	gStus
::
OK
(); }

893 
	g´iv©e
:

894 cÚ¡ 
KVM­
* cÚ¡ 
m­_
;

895 cÚ¡ 
boŞ
 
	gowÃd_
;

896 
	gKVM­
::
cÚ¡_™”©Ü
 
™”_
;

898 cÚ¡ 
O±iÚs
 
	gİtiÚs_
;

899 
KVM­
 
	gm­_
;

900 
SÇpshÙLi¡
 
	g¢­shÙs_
;

903 
	g¡d
::
¡ršg
 
	$RªdomKey
(
Rªdom
* 
ºd
) {

904 
Ën
 = (
ºd
->
	`OÃIn
(3)

906 : (
ºd
->
	`OÃIn
(100è?„nd->
	`Skewed
(10è:„nd->
	`UnifÜm
(10)));

907  
‹¡
::
	`RªdomKey
(
ºd
, 
Ën
);

908 
	}
}

910 
boŞ
 
	$Com·»I‹¿tÜs
(
¡•
,

911 
DB
* 
mod–
,

912 
DB
* 
db
,

913 cÚ¡ 
SÇpshÙ
* 
mod–_¢­
,

914 cÚ¡ 
SÇpshÙ
* 
db_¢­
) {

915 
R—dO±iÚs
 
İtiÚs
;

916 
İtiÚs
.
¢­shÙ
 = 
mod–_¢­
;

917 
I‹¿tÜ
* 
m™”
 = 
mod–
->
	`NewI‹¿tÜ
(
İtiÚs
);

918 
İtiÚs
.
¢­shÙ
 = 
db_¢­
;

919 
I‹¿tÜ
* 
db™”
 = 
db
->
	`NewI‹¿tÜ
(
İtiÚs
);

920 
boŞ
 
ok
 = 
Œue
;

921 
couÁ
 = 0;

922 
m™”
->
	`S“kToFœ¡
(), 
db™”
->SeekToFirst();

923 
ok
 && 
m™”
->
	`V®id
(è&& 
db™”
->Valid();

924 
m™”
->
	`Next
(), 
db™”
->Next()) {

925 
couÁ
++;

926 ià(
m™”
->
	`key
().
	`com·»
(
db™”
->key()) != 0) {

927 
	`årštf
(
¡d”r
, "step %d: Key mismatch: '%s' vs. '%s'\n",

928 
¡•
,

929 
	`Esÿ³SŒšg
(
m™”
->
	`key
()).
	`c_¡r
(),

930 
	`Esÿ³SŒšg
(
db™”
->
	`key
()).
	`c_¡r
());

931 
ok
 = 
çl£
;

935 ià(
m™”
->
	`v®ue
().
	`com·»
(
db™”
->value()) != 0) {

936 
	`årštf
(
¡d”r
, "step %d: Value mismatch for key '%s': '%s' vs. '%s'\n",

937 
¡•
,

938 
	`Esÿ³SŒšg
(
m™”
->
	`key
()).
	`c_¡r
(),

939 
	`Esÿ³SŒšg
(
m™”
->
	`v®ue
()).
	`c_¡r
(),

940 
	`Esÿ³SŒšg
(
m™”
->
	`v®ue
()).
	`c_¡r
());

941 
ok
 = 
çl£
;

945 ià(
ok
) {

946 ià(
m™”
->
	`V®id
(è!ğ
db™”
->Valid()) {

947 
	`årštf
(
¡d”r
, "step %d: Mismatch‡tƒnd of iterators: %d vs. %d\n",

948 
¡•
, 
m™”
->
	`V®id
(), 
db™”
->Valid());

949 
ok
 = 
çl£
;

952 
	`årštf
(
¡d”r
, "%dƒÁr› com·»d: ok=%d\n", 
couÁ
, 
ok
);

953 
d–‘e
 
m™”
;

954 
d–‘e
 
db™”
;

955  
ok
;

956 
	}
}

958 
	$TEST
(
DBTe¡
, 
Rªdomized
) {

959 
Rªdom
 
	`ºd
(
‹¡
::
	`RªdomS“d
());

960 
Mod–DB
 
	`mod–
(
Ï¡_İtiÚs_
);

961 cÚ¡ 
N
 = 10000;

962 cÚ¡ 
SÇpshÙ
* 
mod–_¢­
 = 
NULL
;

963 cÚ¡ 
SÇpshÙ
* 
db_¢­
 = 
NULL
;

964 
¡d
::
¡ršg
 
k
, 
v
;

965 
¡•
 = 0; s‹°< 
N
; step++) {

966 ià(
¡•
 % 100 == 0) {

967 
	`årštf
(
¡d”r
, "S‹°%d oà%d\n", 
¡•
, 
N
);

969 
p
 = 
ºd
.
	`UnifÜm
(100);

970 ià(
p
 < 45) {

971 
k
 = 
	`RªdomKey
(&
ºd
);

972 
v
 = 
	`RªdomSŒšg
(&
ºd
,

973 
ºd
.
	`OÃIn
(20)

974 ? 100 + 
ºd
.
	`UnifÜm
(100)

975 : 
ºd
.
	`UnifÜm
(8));

976 
	`ASSERT_OK
(
mod–
.
	`Put
(
	`Wr™eO±iÚs
(), 
k
, 
v
));

977 
	`ASSERT_OK
(
db_
->
	`Put
(
	`Wr™eO±iÚs
(), 
k
, 
v
));

979 } ià(
p
 < 90) {

980 
k
 = 
	`RªdomKey
(&
ºd
);

981 
	`ASSERT_OK
(
mod–
.
	`D–‘e
(
	`Wr™eO±iÚs
(), 
k
));

982 
	`ASSERT_OK
(
db_
->
	`D–‘e
(
	`Wr™eO±iÚs
(), 
k
));

986 
Wr™eB©ch
 
b
;

987 cÚ¡ 
num
 = 
ºd
.
	`UnifÜm
(8);

988 
i
 = 0; i < 
num
; i++) {

989 ià(
i
 =ğ0 || !
ºd
.
	`OÃIn
(10)) {

990 
k
 = 
	`RªdomKey
(&
ºd
);

995 ià(
ºd
.
	`OÃIn
(2)) {

996 
v
 = 
	`RªdomSŒšg
(&
ºd
,„nd.
	`UnifÜm
(10));

997 
b
.
	`Put
(
k
, 
v
);

999 
b
.
	`D–‘e
(
k
);

1002 
	`ASSERT_OK
(
mod–
.
	`Wr™e
(
	`Wr™eO±iÚs
(), &
b
));

1003 
	`ASSERT_OK
(
db_
->
	`Wr™e
(
	`Wr™eO±iÚs
(), &
b
));

1006 ià((
¡•
 % 100) == 0) {

1007 
	`ASSERT_TRUE
(
	`Com·»I‹¿tÜs
(
¡•
, &
mod–
, 
db_
, 
NULL
, NULL));

1008 
	`ASSERT_TRUE
(
	`Com·»I‹¿tÜs
(
¡•
, &
mod–
, 
db_
, 
mod–_¢­
, 
db_¢­
));

1012 ià(
mod–_¢­
 !ğ
NULL
è
mod–
.
	`R–—£SÇpshÙ
(model_snap);

1013 ià(
db_¢­
 !ğ
NULL
è
db_
->
	`R–—£SÇpshÙ
(db_snap);

1015 
	`Reİ’
();

1016 
	`ASSERT_TRUE
(
	`Com·»I‹¿tÜs
(
¡•
, &
mod–
, 
db_
, 
NULL
, NULL));

1018 
mod–_¢­
 = 
mod–
.
	`G‘SÇpshÙ
();

1019 
db_¢­
 = 
db_
->
	`G‘SÇpshÙ
();

1022 ià(
mod–_¢­
 !ğ
NULL
è
mod–
.
	`R–—£SÇpshÙ
(model_snap);

1023 ià(
db_¢­
 !ğ
NULL
è
db_
->
	`R–—£SÇpshÙ
(db_snap);

1024 
	}
}

1028 
	$maš
(
¬gc
, ** 
¬gv
) {

1029  
Ëv–db
::
‹¡
::
	`RunAÎTe¡s
();

1030 
	}
}

	@db/dbformat.cc

5 
	~<¡dio.h
>

6 
	~"db/dbfÜm©.h
"

7 
	~"pÜt/pÜt.h
"

8 
	~"ut/codšg.h
"

10 
Çme¥aû
 
	gËv–db
 {

12 
ušt64_t
 
PackSequ’ûAndTy³
(ušt64_ˆ
£q
, 
V®ueTy³
 
t
) {

13 
as£¹
(
£q
 <ğ
kMaxSequ’ûNumb”
);

14 
as£¹
(
t
 <ğ
kV®ueTy³FÜS“k
);

15  (
	g£q
 << 8è| 
	gt
;

18 
Aµ’dIÁ”ÇlKey
(
¡d
::
¡ršg
* 
»suÉ
, cÚ¡ 
P¬£dIÁ”ÇlKey
& 
key
) {

19 
	g»suÉ
->
­³nd
(
key
.
u£r_key
.
d©a
(), key.u£r_key.
size
());

20 
PutFixed64
(
»suÉ
, 
PackSequ’ûAndTy³
(
key
.
£qu’û
, key.
ty³
));

23 
	g¡d
::
¡ršg
 
P¬£dIÁ”ÇlKey
::
DebugSŒšg
() const {

24 
buf
[50];

25 
¢´štf
(
buf
, (buf), "' @ %llu : %d",

26 (è
£qu’û
,

27 (
ty³
));

28 
	g¡d
::
¡ršg
 
»suÉ
 = "'";

29 
	g»suÉ
 +ğ
u£r_key
.
ToSŒšg
();

30 
	g»suÉ
 +ğ
buf
;

31  
	g»suÉ
;

34 cÚ¡ * 
	gIÁ”ÇlKeyCom·¿tÜ
::
Name
() const {

38 
	gIÁ”ÇlKeyCom·¿tÜ
::
Com·»
(cÚ¡ 
Sliû
& 
akey
, cÚ¡ Sliû& 
bkey
) const {

43 
	gr
 = 
u£r_com·¿tÜ_
->
Com·»
(
ExŒaùU£rKey
(
akey
), ExŒaùU£rKey(
bkey
));

44 ià(
	gr
 == 0) {

45 cÚ¡ 
ušt64_t
 
ªum
 = 
DecodeFixed64
(
akey
.
d©a
(è+‡key.
size
() - 8);

46 cÚ¡ 
ušt64_t
 
	gbnum
 = 
DecodeFixed64
(
bkey
.
d©a
(è+ bkey.
size
() - 8);

47 ià(
	gªum
 > 
	gbnum
) {

48 
	gr
 = -1;

49 } ià(
	gªum
 < 
	gbnum
) {

50 
	gr
 = +1;

53  
	gr
;

56 
	gIÁ”ÇlKeyCom·¿tÜ
::
FšdShÜ‹¡S•¬©Ü
(

57 
¡d
::
¡ršg
* 
¡¬t
,

58 cÚ¡ 
Sliû
& 
lim™
) const {

60 
Sliû
 
	gu£r_¡¬t
 = 
ExŒaùU£rKey
(*
¡¬t
);

61 
Sliû
 
	gu£r_lim™
 = 
ExŒaùU£rKey
(
lim™
);

62 
	g¡d
::
¡ršg
 
tmp
(
u£r_¡¬t
.
d©a
(), u£r_¡¬t.
size
());

63 
	gu£r_com·¿tÜ_
->
FšdShÜ‹¡S•¬©Ü
(&
tmp
, 
u£r_lim™
);

64 ià(
	gu£r_com·¿tÜ_
->
Com·»
(*
¡¬t
, 
tmp
) < 0) {

67 
PutFixed64
(&
tmp
, 
PackSequ’ûAndTy³
(
kMaxSequ’ûNumb”
,
kV®ueTy³FÜS“k
));

68 
as£¹
(
this
->
Com·»
(*
¡¬t
, 
tmp
) < 0);

69 
as£¹
(
this
->
Com·»
(
tmp
, 
lim™
) < 0);

70 
	g¡¬t
->
sw­
(
tmp
);

74 
	gIÁ”ÇlKeyCom·¿tÜ
::
FšdShÜtSucûssÜ
(
¡d
::
¡ršg
* 
key
) const {

75 
Sliû
 
u£r_key
 = 
ExŒaùU£rKey
(*
key
);

76 
	g¡d
::
¡ršg
 
tmp
(
u£r_key
.
d©a
(), u£r_key.
size
());

77 
	gu£r_com·¿tÜ_
->
FšdShÜtSucûssÜ
(&
tmp
);

78 ià(
	gu£r_com·¿tÜ_
->
Com·»
(
u£r_key
, 
tmp
) < 0) {

81 
PutFixed64
(&
tmp
, 
PackSequ’ûAndTy³
(
kMaxSequ’ûNumb”
,
kV®ueTy³FÜS“k
));

82 
as£¹
(
this
->
Com·»
(*
key
, 
tmp
) < 0);

83 
	gkey
->
sw­
(
tmp
);

	@db/dbformat.h

5 #iâdeà
STORAGE_LEVELDB_DB_FORMAT_H_


6 
	#STORAGE_LEVELDB_DB_FORMAT_H_


	)

8 
	~<¡dio.h
>

9 
	~"Ëv–db/com·¿tÜ.h
"

10 
	~"Ëv–db/db.h
"

11 
	~"Ëv–db/¦iû.h
"

12 
	~"Ëv–db/bË_bud”.h
"

13 
	~"ut/codšg.h
"

14 
	~"ut/loggšg.h
"

16 
Çme¥aû
 
	gËv–db
 {

20 
Çme¥aû
 
	gcÚfig
 {

21 cÚ¡ 
	gkNumLev–s
 = 7;

24 
şass
 
	gIÁ”ÇlKey
;

29 
	eV®ueTy³
 {

30 
	gkTy³D–‘iÚ
 = 0x0,

31 
	gkTy³V®ue
 = 0x1,

39 cÚ¡ 
V®ueTy³
 
	gkV®ueTy³FÜS“k
 = 
kTy³V®ue
;

41 
ušt64_t
 
	tSequ’ûNumb”
;

45 cÚ¡ 
Sequ’ûNumb”
 
	gkMaxSequ’ûNumb”
 =

48 
	sP¬£dIÁ”ÇlKey
 {

49 
Sliû
 
	gu£r_key
;

50 
Sequ’ûNumb”
 
	g£qu’û
;

51 
V®ueTy³
 
	gty³
;

53 
P¬£dIÁ”ÇlKey
() { }

54 
P¬£dIÁ”ÇlKey
(cÚ¡ 
Sliû
& 
u
, cÚ¡ 
Sequ’ûNumb”
& 
£q
, 
V®ueTy³
 
t
)

55 : 
u£r_key
(
u
), 
£qu’û
(
£q
), 
ty³
(
t
) { }

56 
	g¡d
::
¡ršg
 
DebugSŒšg
() const;

60 
šlše
 
size_t
 
IÁ”ÇlKeyEncodšgL’gth
(cÚ¡ 
P¬£dIÁ”ÇlKey
& 
key
) {

61  
	gkey
.
	gu£r_key
.
size
() + 8;

65 
Aµ’dIÁ”ÇlKey
(
¡d
::
¡ršg
* 
»suÉ
,

66 cÚ¡ 
P¬£dIÁ”ÇlKey
& 
key
);

72 
boŞ
 
P¬£IÁ”ÇlKey
(cÚ¡ 
Sliû
& 
š‹º®_key
,

73 
P¬£dIÁ”ÇlKey
* 
»suÉ
);

76 
šlše
 
Sliû
 
ExŒaùU£rKey
(cÚ¡ Sliû& 
š‹º®_key
) {

77 
as£¹
(
š‹º®_key
.
size
() >= 8);

78  
Sliû
(
š‹º®_key
.
d©a
(), iÁ”Çl_key.
size
() - 8);

81 
šlše
 
V®ueTy³
 
ExŒaùV®ueTy³
(cÚ¡ 
Sliû
& 
š‹º®_key
) {

82 
as£¹
(
š‹º®_key
.
size
() >= 8);

83 cÚ¡ 
size_t
 
	gn
 = 
š‹º®_key
.
size
();

84 
ušt64_t
 
	gnum
 = 
DecodeFixed64
(
š‹º®_key
.
d©a
(è+ 
n
 - 8);

85 
	gc
 = 
num
 & 0xff;

86  
	g¡©ic_ÿ¡
<
	gV®ueTy³
>(
	gc
);

91 şas 
	cIÁ”ÇlKeyCom·¿tÜ
 : 
public
 
Com·¿tÜ
 {

92 
´iv©e
:

93 cÚ¡ 
Com·¿tÜ
* 
u£r_com·¿tÜ_
;

94 
	gpublic
:

95 
ex¶ic™
 
IÁ”ÇlKeyCom·¿tÜ
(cÚ¡ 
Com·¿tÜ
* 
c
è: 
u£r_com·¿tÜ_
(c) { }

96 
vœtu®
 cÚ¡ * 
Name
() const;

97 
vœtu®
 
Com·»
(cÚ¡ 
Sliû
& 
a
, cÚ¡ Sliû& 
b
) const;

98 
vœtu®
 
FšdShÜ‹¡S•¬©Ü
(

99 
¡d
::
¡ršg
* 
¡¬t
,

100 cÚ¡ 
Sliû
& 
lim™
) const;

101 
vœtu®
 
FšdShÜtSucûssÜ
(
¡d
::
¡ršg
* 
key
) const;

103 cÚ¡ 
Com·¿tÜ
* 
u£r_com·¿tÜ
(ècÚ¡ {  
	gu£r_com·¿tÜ_
; }

105 
Com·»
(cÚ¡ 
IÁ”ÇlKey
& 
a
, cÚ¡ IÁ”ÇlKey& 
b
) const;

111 şas 
	cIÁ”ÇlKey
 {

112 
	g´iv©e
:

113 
¡d
::
¡ršg
 
»p_
;

114 
	gpublic
:

115 
IÁ”ÇlKey
() { }

116 
IÁ”ÇlKey
(cÚ¡ 
Sliû
& 
u£r_key
, 
Sequ’ûNumb”
 
s
, 
V®ueTy³
 
t
) {

117 
Aµ’dIÁ”ÇlKey
(&
»p_
, 
P¬£dIÁ”ÇlKey
(
u£r_key
, 
s
, 
t
));

120 
DecodeFrom
(cÚ¡ 
Sliû
& 
s
è{ 
	g»p_
.
assign
(s.
d©a
(), s.
size
()); }

121 
Sliû
 
Encode
() const {

122 
as£¹
(!
»p_
.
em±y
());

123  
	g»p_
;

126 
Sliû
 
u£r_key
(ècÚ¡ {  
ExŒaùU£rKey
(
»p_
); }

128 
S‘From
(cÚ¡ 
P¬£dIÁ”ÇlKey
& 
p
) {

129 
	g»p_
.
ş—r
();

130 
Aµ’dIÁ”ÇlKey
(&
»p_
, 
p
);

133 
CË¬
(è{ 
	g»p_
.
ş—r
(); }

136 
šlše
 
	gIÁ”ÇlKeyCom·¿tÜ
::
	$Com·»
(

137 cÚ¡ 
IÁ”ÇlKey
& 
a
, cÚ¡ IÁ”ÇlKey& 
b
) const {

138  
	`Com·»
(
a
.
	`Encode
(), 
b
.Encode());

139 
	}
}

141 
šlše
 
boŞ
 
	$P¬£IÁ”ÇlKey
(cÚ¡ 
Sliû
& 
š‹º®_key
,

142 
P¬£dIÁ”ÇlKey
* 
»suÉ
) {

143 cÚ¡ 
size_t
 
n
 = 
š‹º®_key
.
	`size
();

144 ià(
n
 < 8è 
çl£
;

145 
ušt64_t
 
num
 = 
	`DecodeFixed64
(
š‹º®_key
.
	`d©a
(è+ 
n
 - 8);

146 
c
 = 
num
 & 0xff;

147 
»suÉ
->
£qu’û
 = 
num
 >> 8;

148 
»suÉ
->
ty³
 = 
¡©ic_ÿ¡
<
V®ueTy³
>(
c
);

149 
»suÉ
->
u£r_key
 = 
	`Sliû
(
š‹º®_key
.
	`d©a
(), 
n
 - 8);

150  (
c
 <ğ
¡©ic_ÿ¡
<>(
kTy³V®ue
));

151 
	}
}

	@db/dbformat_test.cc

5 
	~"db/dbfÜm©.h
"

6 
	~"ut/loggšg.h
"

7 
	~"ut/‹¡h¬Ãss.h
"

9 
Çme¥aû
 
	gËv–db
 {

11 
	g¡d
::
¡ršg
 
IKey
(cÚ¡ 
¡d
::¡ršg& 
u£r_key
,

12 
ušt64_t
 
£q
,

13 
V®ueTy³
 
vt
) {

14 
	g¡d
::
¡ršg
 
’coded
;

15 
Aµ’dIÁ”ÇlKey
(&
’coded
, 
P¬£dIÁ”ÇlKey
(
u£r_key
, 
£q
, 
vt
));

16  
	g’coded
;

19 
	g¡d
::
¡ršg
 
ShÜ‹n
(cÚ¡ 
¡d
::¡ršg& 
s
, cÚ¡ std::¡ršg& 
l
) {

20 
¡d
::
¡ršg
 
»suÉ
 = 
s
;

21 
IÁ”ÇlKeyCom·¿tÜ
(
By‹wi£Com·¿tÜ
()).
FšdShÜ‹¡S•¬©Ü
(&
»suÉ
, 
l
);

22  
	g»suÉ
;

25 
	g¡d
::
¡ršg
 
ShÜtSucûssÜ
(cÚ¡ 
¡d
::¡ršg& 
s
) {

26 
¡d
::
¡ršg
 
»suÉ
 = 
s
;

27 
IÁ”ÇlKeyCom·¿tÜ
(
By‹wi£Com·¿tÜ
()).
FšdShÜtSucûssÜ
(&
»suÉ
);

28  
	g»suÉ
;

31 
Te¡Key
(cÚ¡ 
¡d
::
¡ršg
& 
key
,

32 
ušt64_t
 
£q
,

33 
V®ueTy³
 
vt
) {

34 
	g¡d
::
¡ršg
 
’coded
 = 
IKey
(
key
, 
£q
, 
vt
);

36 
Sliû
 
š
(
’coded
);

37 
P¬£dIÁ”ÇlKey
 
decoded
("", 0, 
kTy³V®ue
);

39 
ASSERT_TRUE
(
P¬£IÁ”ÇlKey
(
š
, &
decoded
));

40 
ASSERT_EQ
(
key
, 
decoded
.
u£r_key
.
ToSŒšg
());

41 
ASSERT_EQ
(
£q
, 
decoded
.
£qu’û
);

42 
ASSERT_EQ
(
vt
, 
decoded
.
ty³
);

44 
ASSERT_TRUE
(!
P¬£IÁ”ÇlKey
(
Sliû
("b¬"), &
decoded
));

47 şas 
	cFÜm©Te¡
 { };

49 
	$TEST
(
FÜm©Te¡
, 
IÁ”ÇlKey_EncodeDecode
) {

50 cÚ¡ * 
keys
[] = { "", "k", "hello", "longggggggggggggggggggggg" };

51 cÚ¡ 
ušt64_t
 
£q
[] = {

57 
k
 = 0; k < (
keys
) / (keys[0]); k++) {

58 
s
 = 0; s < (
£q
) / (seq[0]); s++) {

59 
	`Te¡Key
(
keys
[
k
], 
£q
[
s
], 
kTy³V®ue
);

60 
	`Te¡Key
("h–lo", 1, 
kTy³D–‘iÚ
);

63 
	}
}

65 
	$TEST
(
FÜm©Te¡
, 
IÁ”ÇlKeyShÜtS•¬©Ü
) {

67 
	`ASSERT_EQ
(
	`IKey
("foo", 100, 
kTy³V®ue
),

68 
	`ShÜ‹n
(
	`IKey
("foo", 100, 
kTy³V®ue
),

69 
	`IKey
("foo", 99, 
kTy³V®ue
)));

70 
	`ASSERT_EQ
(
	`IKey
("foo", 100, 
kTy³V®ue
),

71 
	`ShÜ‹n
(
	`IKey
("foo", 100, 
kTy³V®ue
),

72 
	`IKey
("foo", 101, 
kTy³V®ue
)));

73 
	`ASSERT_EQ
(
	`IKey
("foo", 100, 
kTy³V®ue
),

74 
	`ShÜ‹n
(
	`IKey
("foo", 100, 
kTy³V®ue
),

75 
	`IKey
("foo", 100, 
kTy³V®ue
)));

76 
	`ASSERT_EQ
(
	`IKey
("foo", 100, 
kTy³V®ue
),

77 
	`ShÜ‹n
(
	`IKey
("foo", 100, 
kTy³V®ue
),

78 
	`IKey
("foo", 100, 
kTy³D–‘iÚ
)));

81 
	`ASSERT_EQ
(
	`IKey
("foo", 100, 
kTy³V®ue
),

82 
	`ShÜ‹n
(
	`IKey
("foo", 100, 
kTy³V®ue
),

83 
	`IKey
("b¬", 99, 
kTy³V®ue
)));

86 
	`ASSERT_EQ
(
	`IKey
("g", 
kMaxSequ’ûNumb”
, 
kV®ueTy³FÜS“k
),

87 
	`ShÜ‹n
(
	`IKey
("foo", 100, 
kTy³V®ue
),

88 
	`IKey
("h–lo", 200, 
kTy³V®ue
)));

91 
	`ASSERT_EQ
(
	`IKey
("foo", 100, 
kTy³V®ue
),

92 
	`ShÜ‹n
(
	`IKey
("foo", 100, 
kTy³V®ue
),

93 
	`IKey
("foob¬", 200, 
kTy³V®ue
)));

96 
	`ASSERT_EQ
(
	`IKey
("foob¬", 100, 
kTy³V®ue
),

97 
	`ShÜ‹n
(
	`IKey
("foob¬", 100, 
kTy³V®ue
),

98 
	`IKey
("foo", 200, 
kTy³V®ue
)));

99 
	}
}

101 
	$TEST
(
FÜm©Te¡
, 
IÁ”ÇlKeyShÜ‹¡SucûssÜ
) {

102 
	`ASSERT_EQ
(
	`IKey
("g", 
kMaxSequ’ûNumb”
, 
kV®ueTy³FÜS“k
),

103 
	`ShÜtSucûssÜ
(
	`IKey
("foo", 100, 
kTy³V®ue
)));

104 
	`ASSERT_EQ
(
	`IKey
("\xff\xff", 100, 
kTy³V®ue
),

105 
	`ShÜtSucûssÜ
(
	`IKey
("\xff\xff", 100, 
kTy³V®ue
)));

106 
	}
}

110 
	$maš
(
¬gc
, ** 
¬gv
) {

111  
Ëv–db
::
‹¡
::
	`RunAÎTe¡s
();

112 
	}
}

	@db/filename.cc

5 
	~<ùy³.h
>

6 
	~<¡dio.h
>

7 
	~"db/f’ame.h
"

8 
	~"db/dbfÜm©.h
"

9 
	~"Ëv–db/’v.h
"

10 
	~"ut/loggšg.h
"

12 
Çme¥aû
 
	gËv–db
 {

14 
	g¡d
::
¡ršg
 
MakeFeName
(cÚ¡ 
¡d
::¡ršg& 
Çme
, 
ušt64_t
 
numb”
,

15 cÚ¡ * 
suffix
) {

16 
	gbuf
[100];

17 
¢´štf
(
buf
, (buf), "/%06llu.%s",

18 
¡©ic_ÿ¡
<>(
numb”
),

19 
suffix
);

20  
	gÇme
 + 
	gbuf
;

23 
	g¡d
::
¡ršg
 
LogFeName
(cÚ¡ 
¡d
::¡ršg& 
Çme
, 
ušt64_t
 
numb”
) {

24 
as£¹
(
numb”
 > 0);

25  
MakeFeName
(
Çme
, 
numb”
, "log");

28 
	g¡d
::
¡ršg
 
TabËFeName
(cÚ¡ 
¡d
::¡ršg& 
Çme
, 
ušt64_t
 
numb”
) {

29 
as£¹
(
numb”
 > 0);

30  
MakeFeName
(
Çme
, 
numb”
, "sst");

33 
	g¡d
::
¡ršg
 
DesütÜFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
, 
ušt64_t
 
numb”
) {

34 
as£¹
(
numb”
 > 0);

35 
	gbuf
[100];

36 
¢´štf
(
buf
, (buf), "/MANIFEST-%06llu",

37 
¡©ic_ÿ¡
<>(
numb”
));

38  
	gdbÇme
 + 
	gbuf
;

41 
	g¡d
::
¡ršg
 
Cu¼’tFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
) {

42  
dbÇme
 + "/CURRENT";

45 
	g¡d
::
¡ršg
 
LockFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
) {

46  
dbÇme
 + "/LOCK";

49 
	g¡d
::
¡ršg
 
TempFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
, 
ušt64_t
 
numb”
) {

50 
as£¹
(
numb”
 > 0);

51  
MakeFeName
(
dbÇme
, 
numb”
, "dbtmp");

54 
	g¡d
::
¡ršg
 
InfoLogFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
) {

55  
dbÇme
 + "/LOG";

59 
	g¡d
::
¡ršg
 
OldInfoLogFeName
(cÚ¡ 
¡d
::¡ršg& 
dbÇme
) {

60  
dbÇme
 + "/LOG.old";

71 
boŞ
 
P¬£FeName
(cÚ¡ 
¡d
::
¡ršg
& 
âame
,

72 
ušt64_t
* 
numb”
,

73 
FeTy³
* 
ty³
) {

74 
Sliû
 
»¡
(
âame
);

75 ià(
	g»¡
 == "CURRENT") {

76 *
numb”
 = 0;

77 *
	gty³
 = 
kCu¼’tFe
;

78 } ià(
	g»¡
 == "LOCK") {

79 *
numb”
 = 0;

80 *
	gty³
 = 
kDBLockFe
;

81 } ià(
	g»¡
 =ğ"LOG" || 
»¡
 == "LOG.old") {

82 *
numb”
 = 0;

83 *
	gty³
 = 
kInfoLogFe
;

84 } ià(
	g»¡
.
¡¬ts_w™h
("MANIFEST-")) {

85 
	g»¡
.
»move_´efix
(
¡¾’
("MANIFEST-"));

86 
ušt64_t
 
	gnum
;

87 ià(!
CÚsumeDecim®Numb”
(&
»¡
, &
num
)) {

88  
	gçl£
;

90 ià(!
	g»¡
.
em±y
()) {

91  
	gçl£
;

93 *
	gty³
 = 
kDesütÜFe
;

94 *
	gnumb”
 = 
num
;

98 
ušt64_t
 
	gnum
;

99 ià(!
CÚsumeDecim®Numb”
(&
»¡
, &
num
)) {

100  
	gçl£
;

102 
Sliû
 
	gsuffix
 = 
»¡
;

103 ià(
	gsuffix
 =ğ
Sliû
(".log")) {

104 *
ty³
 = 
kLogFe
;

105 } ià(
	gsuffix
 =ğ
Sliû
(".sst")) {

106 *
ty³
 = 
kTabËFe
;

107 } ià(
	gsuffix
 =ğ
Sliû
(".dbtmp")) {

108 *
ty³
 = 
kTempFe
;

110  
	gçl£
;

112 *
	gnumb”
 = 
num
;

114  
	gŒue
;

117 
Stus
 
S‘Cu¼’tFe
(
Env
* 
’v
, cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
,

118 
ušt64_t
 
desütÜ_numb”
) {

120 
	g¡d
::
¡ršg
 
mªiã¡
 = 
DesütÜFeName
(
dbÇme
, 
desütÜ_numb”
);

121 
Sliû
 
	gcÚ‹Ás
 = 
mªiã¡
;

122 
as£¹
(
cÚ‹Ás
.
¡¬ts_w™h
(
dbÇme
 + "/"));

123 
	gcÚ‹Ás
.
»move_´efix
(
dbÇme
.
size
() + 1);

124 
	g¡d
::
¡ršg
 
tmp
 = 
TempFeName
(
dbÇme
, 
desütÜ_numb”
);

125 
Stus
 
	gs
 = 
Wr™eSŒšgToFe
(
’v
, 
cÚ‹Ás
.
ToSŒšg
(è+ "\n", 
tmp
);

126 ià(
	gs
.
ok
()) {

127 
	gs
 = 
’v
->
R’ameFe
(
tmp
, 
Cu¼’tFeName
(
dbÇme
));

129 ià(!
	gs
.
ok
()) {

130 
	g’v
->
D–‘eFe
(
tmp
);

132  
	gs
;

	@db/filename.h

7 #iâdeà
STORAGE_LEVELDB_DB_FILENAME_H_


8 
	#STORAGE_LEVELDB_DB_FILENAME_H_


	)

10 
	~<¡dšt.h
>

11 
	~<¡ršg
>

12 
	~"Ëv–db/¦iû.h
"

13 
	~"Ëv–db/¡©us.h
"

14 
	~"pÜt/pÜt.h
"

16 
Çme¥aû
 
	gËv–db
 {

18 
şass
 
	gEnv
;

20 
	eFeTy³
 {

21 
	gkLogFe
,

22 
	gkDBLockFe
,

23 
	gkTabËFe
,

24 
	gkDesütÜFe
,

25 
	gkCu¼’tFe
,

26 
	gkTempFe
,

27 
	gkInfoLogFe
,

33 
¡d
::
¡ršg
 
LogFeName
(cÚ¡ std::¡ršg& 
dbÇme
, 
ušt64_t
 
numb”
);

38 
¡d
::
¡ršg
 
TabËFeName
(cÚ¡ std::¡ršg& 
dbÇme
, 
ušt64_t
 
numb”
);

43 
¡d
::
¡ršg
 
DesütÜFeName
(cÚ¡ std::¡ršg& 
dbÇme
,

44 
ušt64_t
 
numb”
);

49 
¡d
::
¡ršg
 
Cu¼’tFeName
(cÚ¡ std::¡ršg& 
dbÇme
);

53 
¡d
::
¡ršg
 
LockFeName
(cÚ¡ std::¡ršg& 
dbÇme
);

57 
¡d
::
¡ršg
 
TempFeName
(cÚ¡ std::¡ršg& 
dbÇme
, 
ušt64_t
 
numb”
);

60 
¡d
::
¡ršg
 
InfoLogFeName
(cÚ¡ std::¡ršg& 
dbÇme
);

63 
¡d
::
¡ršg
 
OldInfoLogFeName
(cÚ¡ std::¡ršg& 
dbÇme
);

68 
boŞ
 
P¬£FeName
(cÚ¡ 
¡d
::
¡ršg
& 
f’ame
,

69 
ušt64_t
* 
numb”
,

70 
FeTy³
* 
ty³
);

74 
Stus
 
S‘Cu¼’tFe
(
Env
* 
’v
, cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
,

75 
ušt64_t
 
desütÜ_numb”
);

	@db/filename_test.cc

5 
	~"db/f’ame.h
"

7 
	~"db/dbfÜm©.h
"

8 
	~"pÜt/pÜt.h
"

9 
	~"ut/loggšg.h
"

10 
	~"ut/‹¡h¬Ãss.h
"

12 
Çme¥aû
 
	gËv–db
 {

14 şas 
	cFeNameTe¡
 { };

16 
	$TEST
(
FeNameTe¡
, 
P¬£
) {

17 
Sliû
 
db
;

18 
FeTy³
 
ty³
;

19 
ušt64_t
 
numb”
;

23 cÚ¡ * 
âame
;

24 
ušt64_t
 
numb”
;

25 
FeTy³
 
ty³
;

26 } 
ÿ£s
[] = {

27 { "100.log", 100, 
kLogFe
 },

28 { "0.log", 0, 
kLogFe
 },

29 { "0.s¡", 0, 
kTabËFe
 },

30 { "CURRENT", 0, 
kCu¼’tFe
 },

31 { "LOCK", 0, 
kDBLockFe
 },

32 { "MANIFEST-2", 2, 
kDesütÜFe
 },

33 { "MANIFEST-7", 7, 
kDesütÜFe
 },

34 { "LOG", 0, 
kInfoLogFe
 },

35 { "LOG.Şd", 0, 
kInfoLogFe
 },

36 { "18446744073709551615.log", 18446744073709551615uÎ, 
kLogFe
 },

38 
i
 = 0; i < (
ÿ£s
) / (cases[0]); i++) {

39 
¡d
::
¡ršg
 
f
 = 
ÿ£s
[
i
].
âame
;

40 
	`ASSERT_TRUE
(
	`P¬£FeName
(
f
, &
numb”
, &
ty³
)) << f;

41 
	`ASSERT_EQ
(
ÿ£s
[
i
].
ty³
,y³è<< 
f
;

42 
	`ASSERT_EQ
(
ÿ£s
[
i
].
numb”
,‚umb”è<< 
f
;

46 cÚ¡ * 
”rÜs
[] = {

70 
i
 = 0; i < (
”rÜs
) / (errors[0]); i++) {

71 
¡d
::
¡ršg
 
f
 = 
”rÜs
[
i
];

72 
	`ASSERT_TRUE
(!
	`P¬£FeName
(
f
, &
numb”
, &
ty³
)) << f;

74 
	}
}

76 
	$TEST
(
FeNameTe¡
, 
CÚ¡ruùiÚ
) {

77 
ušt64_t
 
numb”
;

78 
FeTy³
 
ty³
;

79 
¡d
::
¡ršg
 
âame
;

81 
âame
 = 
	`Cu¼’tFeName
("foo");

82 
	`ASSERT_EQ
("foo/", 
¡d
::
	`¡ršg
(
âame
.
	`d©a
(), 4));

83 
	`ASSERT_TRUE
(
	`P¬£FeName
(
âame
.
	`c_¡r
(è+ 4, &
numb”
, &
ty³
));

84 
	`ASSERT_EQ
(0, 
numb”
);

85 
	`ASSERT_EQ
(
kCu¼’tFe
, 
ty³
);

87 
âame
 = 
	`LockFeName
("foo");

88 
	`ASSERT_EQ
("foo/", 
¡d
::
	`¡ršg
(
âame
.
	`d©a
(), 4));

89 
	`ASSERT_TRUE
(
	`P¬£FeName
(
âame
.
	`c_¡r
(è+ 4, &
numb”
, &
ty³
));

90 
	`ASSERT_EQ
(0, 
numb”
);

91 
	`ASSERT_EQ
(
kDBLockFe
, 
ty³
);

93 
âame
 = 
	`LogFeName
("foo", 192);

94 
	`ASSERT_EQ
("foo/", 
¡d
::
	`¡ršg
(
âame
.
	`d©a
(), 4));

95 
	`ASSERT_TRUE
(
	`P¬£FeName
(
âame
.
	`c_¡r
(è+ 4, &
numb”
, &
ty³
));

96 
	`ASSERT_EQ
(192, 
numb”
);

97 
	`ASSERT_EQ
(
kLogFe
, 
ty³
);

99 
âame
 = 
	`TabËFeName
("bar", 200);

100 
	`ASSERT_EQ
("b¬/", 
¡d
::
	`¡ršg
(
âame
.
	`d©a
(), 4));

101 
	`ASSERT_TRUE
(
	`P¬£FeName
(
âame
.
	`c_¡r
(è+ 4, &
numb”
, &
ty³
));

102 
	`ASSERT_EQ
(200, 
numb”
);

103 
	`ASSERT_EQ
(
kTabËFe
, 
ty³
);

105 
âame
 = 
	`DesütÜFeName
("bar", 100);

106 
	`ASSERT_EQ
("b¬/", 
¡d
::
	`¡ršg
(
âame
.
	`d©a
(), 4));

107 
	`ASSERT_TRUE
(
	`P¬£FeName
(
âame
.
	`c_¡r
(è+ 4, &
numb”
, &
ty³
));

108 
	`ASSERT_EQ
(100, 
numb”
);

109 
	`ASSERT_EQ
(
kDesütÜFe
, 
ty³
);

111 
âame
 = 
	`TempFeName
("tmp", 999);

112 
	`ASSERT_EQ
("tmp/", 
¡d
::
	`¡ršg
(
âame
.
	`d©a
(), 4));

113 
	`ASSERT_TRUE
(
	`P¬£FeName
(
âame
.
	`c_¡r
(è+ 4, &
numb”
, &
ty³
));

114 
	`ASSERT_EQ
(999, 
numb”
);

115 
	`ASSERT_EQ
(
kTempFe
, 
ty³
);

116 
	}
}

120 
	$maš
(
¬gc
, ** 
¬gv
) {

121  
Ëv–db
::
‹¡
::
	`RunAÎTe¡s
();

122 
	}
}

	@db/log_format.h

8 #iâdeà
STORAGE_LEVELDB_DB_LOG_FORMAT_H_


9 
	#STORAGE_LEVELDB_DB_LOG_FORMAT_H_


	)

11 
Çme¥aû
 
	gËv–db
 {

12 
Çme¥aû
 
	glog
 {

14 
	eRecÜdTy³
 {

16 
	gkZ”oTy³
 = 0,

18 
	gkFuÎTy³
 = 1,

21 
	gkFœ¡Ty³
 = 2,

22 
	gkMiddËTy³
 = 3,

23 
	gkLa¡Ty³
 = 4,

25 cÚ¡ 
	gkMaxRecÜdTy³
 = 
kLa¡Ty³
;

27 cÚ¡ 
	gkBlockSize
 = 32768;

30 cÚ¡ 
	gkH—d”Size
 = 4 + 1 + 2;

	@db/log_reader.cc

5 
	~"db/log_»ad”.h
"

7 
	~<¡dšt.h
>

8 
	~"Ëv–db/’v.h
"

9 
	~"ut/codšg.h
"

10 
	~"ut/üc32c.h
"

12 
Çme¥aû
 
	gËv–db
 {

13 
Çme¥aû
 
	glog
 {

15 
	gR—d”
::
R•Ü‹r
::~Reporter() {

18 
R—d”
::R—d”(
Sequ’tŸlFe
* 
fe
, 
R•Ü‹r
* 
»pÜ‹r
, 
boŞ
 
checksum
)

19 : 
fe_
(
fe
),

20 
»pÜ‹r_
(
»pÜ‹r
),

21 
checksum_
(
checksum
),

22 
backšg_¡Üe_
(
Ãw
 [
kBlockSize
]),

23 
bufãr_
(),

24 
eof_
(
çl£
) {

27 
	gR—d”
::~
R—d”
() {

28 
d–‘e
[] 
backšg_¡Üe_
;

31 
boŞ
 
	gR—d”
::
R—dRecÜd
(
Sliû
* 
»cÜd
, 
¡d
::
¡ršg
* 
sü©ch
) {

32 
sü©ch
->
ş—r
();

33 
	g»cÜd
->
ş—r
();

34 
boŞ
 
	gš_äagm’‹d_»cÜd
 = 
çl£
;

36 
Sliû
 
	gäagm’t
;

37 
	gŒue
) {

38 
R—dPhysiÿlRecÜd
(&
äagm’t
)) {

39 
	gkFuÎTy³
:

40 ià(
š_äagm’‹d_»cÜd
) {

41 
R•ÜtDrİ
(
sü©ch
->
size
(), "partial„ecord withoutƒnd");

43 
	gsü©ch
->
ş—r
();

44 *
	g»cÜd
 = 
äagm’t
;

45  
	gŒue
;

47 
	gkFœ¡Ty³
:

48 ià(
š_äagm’‹d_»cÜd
) {

49 
R•ÜtDrİ
(
sü©ch
->
size
(), "partial„ecord withoutƒnd");

51 
	gsü©ch
->
assign
(
äagm’t
.
d©a
(), f¿gm’t.
size
());

52 
	gš_äagm’‹d_»cÜd
 = 
Œue
;

55 
	gkMiddËTy³
:

56 ià(!
š_äagm’‹d_»cÜd
) {

57 
R•ÜtDrİ
(
äagm’t
.
size
(), "missing start of fragmented„ecord");

59 
	gsü©ch
->
­³nd
(
äagm’t
.
d©a
(), f¿gm’t.
size
());

63 
	gkLa¡Ty³
:

64 ià(!
š_äagm’‹d_»cÜd
) {

65 
R•ÜtDrİ
(
äagm’t
.
size
(), "missing start of fragmented„ecord");

67 
	gsü©ch
->
­³nd
(
äagm’t
.
d©a
(), f¿gm’t.
size
());

68 *
	g»cÜd
 = 
Sliû
(*
sü©ch
);

69  
	gŒue
;

73 
	gkEof
:

74 ià(
š_äagm’‹d_»cÜd
) {

75 
R•ÜtDrİ
(
sü©ch
->
size
(), "partial„ecord withoutƒnd");

76 
	gsü©ch
->
ş—r
();

78  
	gçl£
;

80 
	gkBadRecÜd
:

81 ià(
š_äagm’‹d_»cÜd
) {

82 
R•ÜtDrİ
(
sü©ch
->
size
(), "error in middle of„ecord");

83 
	gš_äagm’‹d_»cÜd
 = 
çl£
;

84 
	gsü©ch
->
ş—r
();

89 
R•ÜtDrİ
(

90 (
äagm’t
.
size
(è+ (
š_äagm’‹d_»cÜd
 ? 
sü©ch
->size() : 0)),

92 
	gš_äagm’‹d_»cÜd
 = 
çl£
;

93 
	gsü©ch
->
ş—r
();

97  
	gçl£
;

100 
	gR—d”
::
R•ÜtDrİ
(
size_t
 
by‹s
, cÚ¡ * 
»asÚ
) {

101 ià(
	g»pÜ‹r_
 !ğ
NULL
) {

102 
»pÜ‹r_
->
CÜru±iÚ
(
by‹s
, 
Stus
::CÜru±iÚ(
»asÚ
));

106 
	gR—d”
::
R—dPhysiÿlRecÜd
(
Sliû
* 
»suÉ
) {

107 
Œue
) {

108 ià(
bufãr_
.
size
(è< 
kH—d”Size
) {

109 ià(!
eof_
) {

111 
bufãr_
.
ş—r
();

112 
Stus
 
	g¡©us
 = 
fe_
->
R—d
(
kBlockSize
, &
bufãr_
, 
backšg_¡Üe_
);

113 ià(!
	g¡©us
.
ok
()) {

114 ià(
	g»pÜ‹r_
 !ğ
NULL
) {

115 
»pÜ‹r_
->
CÜru±iÚ
(
kBlockSize
, 
¡©us
);

117 
	gbufãr_
.
ş—r
();

118 
	geof_
 = 
Œue
;

119  
	gkEof
;

120 } ià(
	gbufãr_
.
size
(è< 
	gkBlockSize
) {

121 
	geof_
 = 
Œue
;

124 } ià(
	gbufãr_
.
size
() == 0) {

126  
kEof
;

128 
R•ÜtDrİ
(
bufãr_
.
size
(), "truncated„ecord‡tƒnd of file");

129 
	gbufãr_
.
ş—r
();

130  
	gkEof
;

135 cÚ¡ * 
	gh—d”
 = 
bufãr_
.
d©a
();

136 cÚ¡ 
ušt32_t
 
	ga
 = 
¡©ic_ÿ¡
<ušt32_t>(
h—d”
[4]) & 0xff;

137 cÚ¡ 
ušt32_t
 
	gb
 = 
¡©ic_ÿ¡
<ušt32_t>(
h—d”
[5]) & 0xff;

138 cÚ¡ 
	gty³
 = 
h—d”
[6];

139 cÚ¡ 
ušt32_t
 
	gËngth
 = 
a
 | (
b
 << 8);

140 ià(
	gkH—d”Size
 + 
	gËngth
 > 
	gbufãr_
.
size
()) {

141 
R•ÜtDrİ
(
bufãr_
.
size
(), "bad„ecord†ength");

142 
	gbufãr_
.
ş—r
();

143  
	gkBadRecÜd
;

147 ià(
	gchecksum_
) {

148 ià(
	gty³
 =ğ
kZ”oTy³
 && 
Ëngth
 == 0) {

152 
bufãr_
.
ş—r
();

153  
	gkBadRecÜd
;

156 
ušt32_t
 
	gex³ùed_üc
 = 
üc32c
::
Unmask
(
DecodeFixed32
(
h—d”
));

157 
ušt32_t
 
	gaùu®_üc
 = 
üc32c
::
V®ue
(
h—d”
 + 6, 1 + 
Ëngth
);

158 ià(
	gaùu®_üc
 !ğ
ex³ùed_üc
) {

163 
R•ÜtDrİ
(
bufãr_
.
size
(), "checksum mismatch");

164 
	gbufãr_
.
ş—r
();

165  
	gkBadRecÜd
;

169 
	gbufãr_
.
»move_´efix
(
kH—d”Size
 + 
Ëngth
);

170 *
	g»suÉ
 = 
Sliû
(
h—d”
 + 
kH—d”Size
, 
Ëngth
);

171  
	gty³
;

	@db/log_reader.h

5 #iâdeà
STORAGE_LEVELDB_DB_LOG_READER_H_


6 
	#STORAGE_LEVELDB_DB_LOG_READER_H_


	)

8 
	~"db/log_fÜm©.h
"

9 
	~"Ëv–db/¦iû.h
"

10 
	~"Ëv–db/¡©us.h
"

12 
Çme¥aû
 
	gËv–db
 {

14 
şass
 
	gSequ’tŸlFe
;

16 
Çme¥aû
 
	glog
 {

18 şas 
	cR—d”
 {

19 
	gpublic
:

21 şas 
	cR•Ü‹r
 {

22 
public
:

23 
vœtu®
 ~
R•Ü‹r
();

27 
vœtu®
 
CÜru±iÚ
(
size_t
 
by‹s
, cÚ¡ 
Stus
& 
¡©us
) = 0;

38 
R—d”
(
Sequ’tŸlFe
* 
fe
, 
R•Ü‹r
* 
»pÜ‹r
, 
boŞ
 
checksum
);

40 ~
R—d”
();

47 
boŞ
 
R—dRecÜd
(
Sliû
* 
»cÜd
, 
¡d
::
¡ršg
* 
sü©ch
);

49 
	g´iv©e
:

50 
Sequ’tŸlFe
* cÚ¡ 
fe_
;

51 
R•Ü‹r
* cÚ¡ 
	g»pÜ‹r_
;

52 
boŞ
 cÚ¡ 
	gchecksum_
;

53 * cÚ¡ 
	gbackšg_¡Üe_
;

54 
Sliû
 
	gbufãr_
;

55 
boŞ
 
	geof_
;

59 
	gkEof
 = 
kMaxRecÜdTy³
 + 1,

60 
	gkBadRecÜd
 = 
kMaxRecÜdTy³
 + 2

64 
R—dPhysiÿlRecÜd
(
Sliû
* 
»suÉ
);

65 
R•ÜtDrİ
(
size_t
 
by‹s
, cÚ¡ * 
»asÚ
);

68 
R—d”
(const Reader&);

69 
	gİ”©Ü
=(cÚ¡ 
R—d”
&);

	@db/log_test.cc

5 
	~"db/log_»ad”.h
"

6 
	~"db/log_wr™”.h
"

7 
	~"Ëv–db/’v.h
"

8 
	~"ut/codšg.h
"

9 
	~"ut/üc32c.h
"

10 
	~"ut/¿ndom.h
"

11 
	~"ut/‹¡h¬Ãss.h
"

13 
Çme¥aû
 
	gËv–db
 {

14 
Çme¥aû
 
	glog
 {

18 
	g¡d
::
¡ršg
 
BigSŒšg
(cÚ¡ 
¡d
::¡ršg& 
·¹Ÿl_¡ršg
, 
size_t
 
n
) {

19 
	g¡d
::
¡ršg
 
»suÉ
;

20 
	g»suÉ
.
size
(è< 
	gn
) {

21 
	g»suÉ
.
­³nd
(
·¹Ÿl_¡ršg
);

23 
	g»suÉ
.
»size
(
n
);

24  
	g»suÉ
;

28 
	g¡d
::
¡ršg
 
Numb”SŒšg
(
n
) {

29 
buf
[50];

30 
¢´štf
(
buf
, (buf), "%d.", 
n
);

31  
	g¡d
::
¡ršg
(
buf
);

35 
	g¡d
::
¡ršg
 
RªdomSkewedSŒšg
(
i
, 
Rªdom
* 
ºd
) {

36  
BigSŒšg
(
Numb”SŒšg
(
i
), 
ºd
->
Skewed
(17));

39 şas 
	cLogTe¡
 {

40 
	g´iv©e
:

41 şas 
	cSŒšgDe¡
 : 
public
 
Wr™abËFe
 {

42 
public
:

43 
¡d
::
¡ršg
 
cÚ‹Ás_
;

45 
vœtu®
 
Stus
 
Clo£
(è{  
	gStus
::
OK
(); }

46 
vœtu®
 
Stus
 
Flush
(è{  
	gStus
::
OK
(); }

47 
vœtu®
 
Stus
 
Sync
(è{  
	gStus
::
OK
(); }

48 
vœtu®
 
Stus
 
Aµ’d
(cÚ¡ 
Sliû
& 
¦iû
) {

49 
	gcÚ‹Ás_
.
­³nd
(
¦iû
.
d©a
(), sliû.
size
());

50  
	gStus
::
OK
();

54 şas 
	cSŒšgSourû
 : 
public
 
Sequ’tŸlFe
 {

55 
public
:

56 
Sliû
 
cÚ‹Ás_
;

57 
boŞ
 
	gfÜû_”rÜ_
;

58 
boŞ
 
	g»tuºed_·¹Ÿl_
;

59 
SŒšgSourû
(è: 
fÜû_”rÜ_
(
çl£
), 
»tuºed_·¹Ÿl_
(false) { }

61 
vœtu®
 
Stus
 
R—d
(
size_t
 
n
, 
Sliû
* 
»suÉ
, * 
sü©ch
) {

62 
ASSERT_TRUE
(!
»tuºed_·¹Ÿl_
) << "must‚ot Read()‡fterƒof/error";

63 
ASSERT_EQ
(
kBlockSize
, 
n
);

65 ià(
	gfÜû_”rÜ_
) {

66 
	gfÜû_”rÜ_
 = 
çl£
;

67 
	g»tuºed_·¹Ÿl_
 = 
Œue
;

68  
	gStus
::
CÜru±iÚ
("readƒrror");

71 ià(
	gcÚ‹Ás_
.
size
(è< 
	gn
) {

72 
	gn
 = 
cÚ‹Ás_
.
size
();

73 
	g»tuºed_·¹Ÿl_
 = 
Œue
;

75 *
	g»suÉ
 = 
Sliû
(
cÚ‹Ás_
.
d©a
(), 
n
);

76 
	gcÚ‹Ás_
.
»move_´efix
(
n
);

77  
	gStus
::
OK
();

81 şas 
	cR•ÜtCŞËùÜ
 : 
public
 
R—d”
::
R•Ü‹r
 {

82 
public
:

83 
size_t
 
drİ³d_by‹s_
;

84 
	g¡d
::
¡ršg
 
mes§ge_
;

86 
R•ÜtCŞËùÜ
(è: 
drİ³d_by‹s_
(0) { }

87 
vœtu®
 
CÜru±iÚ
(
size_t
 
by‹s
, cÚ¡ 
Stus
& 
¡©us
) {

88 
	gdrİ³d_by‹s_
 +ğ
by‹s
;

89 
	gmes§ge_
.
­³nd
(
¡©us
.
ToSŒšg
());

93 
SŒšgDe¡
 
	gde¡_
;

94 
SŒšgSourû
 
	gsourû_
;

95 
R•ÜtCŞËùÜ
 
	g»pÜt_
;

96 
boŞ
 
	g»adšg_
;

97 
Wr™”
 
	gwr™”_
;

98 
R—d”
 
	g»ad”_
;

100 
	gpublic
:

101 
LogTe¡
(è: 
»adšg_
(
çl£
),

102 
wr™”_
(&
de¡_
),

103 
»ad”_
(&
sourû_
, &
»pÜt_
, 
Œue
 ) {

106 
Wr™e
(cÚ¡ 
¡d
::
¡ršg
& 
msg
) {

107 
ASSERT_TRUE
(!
»adšg_
) << "Write()‡fter startingo„ead";

108 
	gwr™”_
.
AddRecÜd
(
Sliû
(
msg
));

111 
size_t
 
Wr™‹nBy‹s
() const {

112  
	gde¡_
.
	gcÚ‹Ás_
.
size
();

115 
	g¡d
::
¡ršg
 
R—d
() {

116 ià(!
»adšg_
) {

117 
»adšg_
 = 
Œue
;

118 
	gsourû_
.
	gcÚ‹Ás_
 = 
Sliû
(
de¡_
.
cÚ‹Ás_
);

120 
	g¡d
::
¡ršg
 
sü©ch
;

121 
Sliû
 
	g»cÜd
;

122 ià(
	g»ad”_
.
R—dRecÜd
(&
»cÜd
, &
sü©ch
)) {

123  
	g»cÜd
.
ToSŒšg
();

129 
Inüem’tBy‹
(
off£t
, 
d–
) {

130 
	gde¡_
.
	gcÚ‹Ás_
[
off£t
] +ğ
d–
;

133 
S‘By‹
(
off£t
, 
Ãw_by‹
) {

134 
	gde¡_
.
	gcÚ‹Ás_
[
off£t
] = 
Ãw_by‹
;

137 
ShrškSize
(
by‹s
) {

138 
	gde¡_
.
	gcÚ‹Ás_
.
»size
(
de¡_
.
cÚ‹Ás_
.
size
(è- 
by‹s
);

141 
FixChecksum
(
h—d”_off£t
, 
Ën
) {

143 
ušt32_t
 
	güc
 = 
üc32c
::
V®ue
(&
de¡_
.
cÚ‹Ás_
[
h—d”_off£t
+6], 1 + 
Ën
);

144 
	güc
 = 
üc32c
::
Mask
(
üc
);

145 
EncodeFixed32
(&
de¡_
.
cÚ‹Ás_
[
h—d”_off£t
], 
üc
);

148 
FÜûE¼Ü
() {

149 
	gsourû_
.
	gfÜû_”rÜ_
 = 
Œue
;

152 
size_t
 
Drİ³dBy‹s
() const {

153  
	g»pÜt_
.
	gdrİ³d_by‹s_
;

157 
	g¡d
::
¡ršg
 
M©chE¼Ü
(cÚ¡ 
¡d
::¡ršg& 
msg
) const {

158 ià(
»pÜt_
.
mes§ge_
.
fšd
(
msg
è=ğ
¡d
::
¡ršg
::
Åos
) {

159  
»pÜt_
.
mes§ge_
;

166 
TEST
(
LogTe¡
, 
Em±y
) {

167 
ASSERT_EQ
("EOF", 
R—d
());

170 
TEST
(
LogTe¡
, 
R—dWr™e
) {

171 
Wr™e
("foo");

172 
Wr™e
("bar");

173 
Wr™e
("");

174 
Wr™e
("xxxx");

175 
ASSERT_EQ
("foo", 
R—d
());

176 
ASSERT_EQ
("b¬", 
R—d
());

177 
ASSERT_EQ
("", 
R—d
());

178 
ASSERT_EQ
("xxxx", 
R—d
());

179 
ASSERT_EQ
("EOF", 
R—d
());

180 
ASSERT_EQ
("EOF", 
R—d
());

183 
TEST
(
LogTe¡
, 
MªyBlocks
) {

184 
	gi
 = 0; i < 100000; i++) {

185 
Wr™e
(
Numb”SŒšg
(
i
));

187 
	gi
 = 0; i < 100000; i++) {

188 
ASSERT_EQ
(
Numb”SŒšg
(
i
), 
R—d
());

190 
ASSERT_EQ
("EOF", 
R—d
());

193 
TEST
(
LogTe¡
, 
F¿gm’tiÚ
) {

194 
Wr™e
("small");

195 
Wr™e
(
BigSŒšg
("medium", 50000));

196 
Wr™e
(
BigSŒšg
("large", 100000));

197 
ASSERT_EQ
("sm®l", 
R—d
());

198 
ASSERT_EQ
(
BigSŒšg
("medium", 50000), 
R—d
());

199 
ASSERT_EQ
(
BigSŒšg
("Ïrge", 100000), 
R—d
());

200 
ASSERT_EQ
("EOF", 
R—d
());

203 
TEST
(
LogTe¡
, 
M¬gš®T¿”
) {

205 cÚ¡ 
	gn
 = 
kBlockSize
 - 2*
kH—d”Size
;

206 
Wr™e
(
BigSŒšg
("foo", 
n
));

207 
ASSERT_EQ
(
kBlockSize
 - 
kH—d”Size
, 
Wr™‹nBy‹s
());

208 
Wr™e
("");

209 
Wr™e
("bar");

210 
ASSERT_EQ
(
BigSŒšg
("foo", 
n
), 
R—d
());

211 
ASSERT_EQ
("", 
R—d
());

212 
ASSERT_EQ
("b¬", 
R—d
());

213 
ASSERT_EQ
("EOF", 
R—d
());

216 
TEST
(
LogTe¡
, 
ShÜtT¿”
) {

217 cÚ¡ 
	gn
 = 
kBlockSize
 - 2*
kH—d”Size
 + 4;

218 
Wr™e
(
BigSŒšg
("foo", 
n
));

219 
ASSERT_EQ
(
kBlockSize
 - 
kH—d”Size
 + 4, 
Wr™‹nBy‹s
());

220 
Wr™e
("");

221 
Wr™e
("bar");

222 
ASSERT_EQ
(
BigSŒšg
("foo", 
n
), 
R—d
());

223 
ASSERT_EQ
("", 
R—d
());

224 
ASSERT_EQ
("b¬", 
R—d
());

225 
ASSERT_EQ
("EOF", 
R—d
());

228 
TEST
(
LogTe¡
, 
AligÃdEof
) {

229 cÚ¡ 
	gn
 = 
kBlockSize
 - 2*
kH—d”Size
 + 4;

230 
Wr™e
(
BigSŒšg
("foo", 
n
));

231 
ASSERT_EQ
(
kBlockSize
 - 
kH—d”Size
 + 4, 
Wr™‹nBy‹s
());

232 
ASSERT_EQ
(
BigSŒšg
("foo", 
n
), 
R—d
());

233 
ASSERT_EQ
("EOF", 
R—d
());

236 
TEST
(
LogTe¡
, 
RªdomR—d
) {

237 cÚ¡ 
	gN
 = 500;

238 
Rªdom
 
wr™e_ºd
(301);

239 
	gi
 = 0; i < 
	gN
; i++) {

240 
Wr™e
(
RªdomSkewedSŒšg
(
i
, &
wr™e_ºd
));

242 
Rªdom
 
»ad_ºd
(301);

243 
	gi
 = 0; i < 
	gN
; i++) {

244 
ASSERT_EQ
(
RªdomSkewedSŒšg
(
i
, &
»ad_ºd
), 
R—d
());

246 
ASSERT_EQ
("EOF", 
R—d
());

251 
TEST
(
LogTe¡
, 
R—dE¼Ü
) {

252 
Wr™e
("foo");

253 
FÜûE¼Ü
();

254 
ASSERT_EQ
("EOF", 
R—d
());

255 
ASSERT_EQ
(
kBlockSize
, 
Drİ³dBy‹s
());

256 
ASSERT_EQ
("OK", 
M©chE¼Ü
("readƒrror"));

259 
TEST
(
LogTe¡
, 
BadRecÜdTy³
) {

260 
Wr™e
("foo");

262 
Inüem’tBy‹
(6, 100);

263 
FixChecksum
(0, 3);

264 
ASSERT_EQ
("EOF", 
R—d
());

265 
ASSERT_EQ
(3, 
Drİ³dBy‹s
());

266 
ASSERT_EQ
("OK", 
M©chE¼Ü
("unknown„ecordype"));

269 
TEST
(
LogTe¡
, 
Trunÿ‹dT¿šgRecÜd
) {

270 
Wr™e
("foo");

271 
ShrškSize
(4);

272 
ASSERT_EQ
("EOF", 
R—d
());

273 
ASSERT_EQ
(
kH—d”Size
 - 1, 
Drİ³dBy‹s
());

274 
ASSERT_EQ
("OK", 
M©chE¼Ü
("truncated„ecord‡tƒnd of file"));

277 
TEST
(
LogTe¡
, 
BadL’gth
) {

278 
Wr™e
("foo");

279 
ShrškSize
(1);

280 
ASSERT_EQ
("EOF", 
R—d
());

281 
ASSERT_EQ
(
kH—d”Size
 + 2, 
Drİ³dBy‹s
());

282 
ASSERT_EQ
("OK", 
M©chE¼Ü
("bad„ecord†ength"));

285 
TEST
(
LogTe¡
, 
ChecksumMism©ch
) {

286 
Wr™e
("foo");

287 
Inüem’tBy‹
(0, 10);

288 
ASSERT_EQ
("EOF", 
R—d
());

289 
ASSERT_EQ
(10, 
Drİ³dBy‹s
());

290 
ASSERT_EQ
("OK", 
M©chE¼Ü
("checksum mismatch"));

293 
TEST
(
LogTe¡
, 
UÃx³ùedMiddËTy³
) {

294 
Wr™e
("foo");

295 
S‘By‹
(6, 
kMiddËTy³
);

296 
FixChecksum
(0, 3);

297 
ASSERT_EQ
("EOF", 
R—d
());

298 
ASSERT_EQ
(3, 
Drİ³dBy‹s
());

299 
ASSERT_EQ
("OK", 
M©chE¼Ü
("missing start"));

302 
TEST
(
LogTe¡
, 
UÃx³ùedLa¡Ty³
) {

303 
Wr™e
("foo");

304 
S‘By‹
(6, 
kLa¡Ty³
);

305 
FixChecksum
(0, 3);

306 
ASSERT_EQ
("EOF", 
R—d
());

307 
ASSERT_EQ
(3, 
Drİ³dBy‹s
());

308 
ASSERT_EQ
("OK", 
M©chE¼Ü
("missing start"));

311 
TEST
(
LogTe¡
, 
UÃx³ùedFuÎTy³
) {

312 
Wr™e
("foo");

313 
Wr™e
("bar");

314 
S‘By‹
(6, 
kFœ¡Ty³
);

315 
FixChecksum
(0, 3);

316 
ASSERT_EQ
("b¬", 
R—d
());

317 
ASSERT_EQ
("EOF", 
R—d
());

318 
ASSERT_EQ
(3, 
Drİ³dBy‹s
());

319 
ASSERT_EQ
("OK", 
M©chE¼Ü
("partial„ecord withoutƒnd"));

322 
TEST
(
LogTe¡
, 
UÃx³ùedFœ¡Ty³
) {

323 
Wr™e
("foo");

324 
Wr™e
(
BigSŒšg
("bar", 100000));

325 
S‘By‹
(6, 
kFœ¡Ty³
);

326 
FixChecksum
(0, 3);

327 
ASSERT_EQ
(
BigSŒšg
("b¬", 100000), 
R—d
());

328 
ASSERT_EQ
("EOF", 
R—d
());

329 
ASSERT_EQ
(3, 
Drİ³dBy‹s
());

330 
ASSERT_EQ
("OK", 
M©chE¼Ü
("partial„ecord withoutƒnd"));

333 
TEST
(
LogTe¡
, 
E¼ÜJošsRecÜds
) {

340 
Wr™e
(
BigSŒšg
("foo", 
kBlockSize
));

341 
Wr™e
(
BigSŒšg
("b¬", 
kBlockSize
));

342 
Wr™e
("correct");

345 
	goff£t
 = 
kBlockSize
; off£ˆ< 2*
	gkBlockSize
; offset++) {

346 
S‘By‹
(
off£t
, 'x');

349 
ASSERT_EQ
("cÜ»ù", 
R—d
());

350 
ASSERT_EQ
("EOF", 
R—d
());

351 cÚ¡ 
	gdrİ³d
 = 
Drİ³dBy‹s
();

352 
ASSERT_LE
(
drİ³d
, 2*
kBlockSize
 + 100);

353 
ASSERT_GE
(
drİ³d
, 2*
kBlockSize
);

359 
	$maš
(
¬gc
, ** 
¬gv
) {

360  
Ëv–db
::
‹¡
::
	`RunAÎTe¡s
();

361 
	}
}

	@db/log_writer.cc

5 
	~"db/log_wr™”.h
"

7 
	~<¡dšt.h
>

8 
	~"Ëv–db/’v.h
"

9 
	~"ut/codšg.h
"

10 
	~"ut/üc32c.h
"

12 
Çme¥aû
 
	gËv–db
 {

13 
Çme¥aû
 
	glog
 {

15 
	gWr™”
::
Wr™”
(
Wr™abËFe
* 
de¡
)

16 : 
de¡_
(
de¡
),

17 
block_off£t_
(0) {

18 
	gi
 = 0; i <ğ
kMaxRecÜdTy³
; i++) {

19 
	gt
 = 
¡©ic_ÿ¡
<>(
i
);

20 
	gty³_üc_
[
i
] = 
üc32c
::
V®ue
(&
t
, 1);

24 
	gWr™”
::~
Wr™”
() {

27 
Stus
 
Wr™”
::
AddRecÜd
(cÚ¡ 
Sliû
& 
¦iû
) {

28 cÚ¡ * 
±r
 = 
¦iû
.
d©a
();

29 
size_t
 
	gËá
 = 
¦iû
.
size
();

34 
Stus
 
	gs
;

36 cÚ¡ 
	gËáov”
 = 
kBlockSize
 - 
block_off£t_
;

37 
as£¹
(
Ëáov”
 >= 0);

38 ià(
	gËáov”
 < 
	gkH—d”Size
) {

40 ià(
	gËáov”
 > 0) {

42 
as£¹
(
kH—d”Size
 == 7);

43 
	gde¡_
->
Aµ’d
(
Sliû
("\x00\x00\x00\x00\x00\x00", 
Ëáov”
));

45 
	gblock_off£t_
 = 0;

49 
as£¹
(
kBlockSize
 - 
block_off£t_
 - 
kH—d”Size
 >= 0);

51 cÚ¡ 
size_t
 
	gava
 = 
kBlockSize
 - 
block_off£t_
 - 
kH—d”Size
;

52 cÚ¡ 
size_t
 
	gäagm’t_Ëngth
 = (
Ëá
 < 
ava
) ?†eft :‡vail;

54 
RecÜdTy³
 
	gty³
;

55 cÚ¡ 
boŞ
 
	gbegš
 = (
±r
 =ğ
¦iû
.
d©a
());

56 cÚ¡ 
boŞ
 
	g’d
 = (
Ëá
 =ğ
äagm’t_Ëngth
);

57 ià(
	gbegš
 && 
	g’d
) {

58 
	gty³
 = 
kFuÎTy³
;

59 } ià(
	gbegš
) {

60 
	gty³
 = 
kFœ¡Ty³
;

61 } ià(
	g’d
) {

62 
	gty³
 = 
kLa¡Ty³
;

64 
	gty³
 = 
kMiddËTy³
;

67 
	gs
 = 
Em™PhysiÿlRecÜd
(
ty³
, 
±r
, 
äagm’t_Ëngth
);

68 
	g±r
 +ğ
äagm’t_Ëngth
;

69 
	gËá
 -ğ
äagm’t_Ëngth
;

70 } 
	gs
.
ok
(è&& 
	gËá
 > 0);

71  
	gs
;

74 
Stus
 
	gWr™”
::
Em™PhysiÿlRecÜd
(
RecÜdTy³
 
t
, cÚ¡ * 
±r
, 
size_t
 
n
) {

75 
as£¹
(
n
 <= 0xffff);

76 
as£¹
(
block_off£t_
 + 
kH—d”Size
 + 
n
 <ğ
kBlockSize
);

79 
	gbuf
[
kH—d”Size
];

80 
	gbuf
[4] = 
¡©ic_ÿ¡
<>(
n
 & 0xff);

81 
	gbuf
[5] = 
¡©ic_ÿ¡
<>(
n
 >> 8);

82 
	gbuf
[6] = 
¡©ic_ÿ¡
<>(
t
);

85 
ušt32_t
 
	güc
 = 
üc32c
::
Ex‹nd
(
ty³_üc_
[
t
], 
±r
, 
n
);

86 
	güc
 = 
üc32c
::
Mask
(
üc
);

87 
EncodeFixed32
(
buf
, 
üc
);

90 
Stus
 
	gs
 = 
de¡_
->
Aµ’d
(
Sliû
(
buf
, 
kH—d”Size
));

91 ià(
	gs
.
ok
()) {

92 
	gs
 = 
de¡_
->
Aµ’d
(
Sliû
(
±r
, 
n
));

93 ià(
	gs
.
ok
()) {

94 
	gs
 = 
de¡_
->
Flush
();

97 
	gblock_off£t_
 +ğ
kH—d”Size
 + 
n
;

98  
	gs
;

	@db/log_writer.h

5 #iâdeà
STORAGE_LEVELDB_DB_LOG_WRITER_H_


6 
	#STORAGE_LEVELDB_DB_LOG_WRITER_H_


	)

8 
	~<¡dšt.h
>

9 
	~"db/log_fÜm©.h
"

10 
	~"Ëv–db/¦iû.h
"

11 
	~"Ëv–db/¡©us.h
"

13 
Çme¥aû
 
	gËv–db
 {

15 
şass
 
	gWr™abËFe
;

17 
Çme¥aû
 
	glog
 {

19 şas 
	cWr™”
 {

20 
	gpublic
:

24 
ex¶ic™
 
Wr™”
(
Wr™abËFe
* 
de¡
);

25 ~
Wr™”
();

27 
Stus
 
AddRecÜd
(cÚ¡ 
Sliû
& 
¦iû
);

29 
	g´iv©e
:

30 
Wr™abËFe
* 
de¡_
;

31 
	gblock_off£t_
;

36 
ušt32_t
 
	gty³_üc_
[
kMaxRecÜdTy³
 + 1];

38 
Stus
 
Em™PhysiÿlRecÜd
(
RecÜdTy³
 
ty³
, cÚ¡ * 
±r
, 
size_t
 
Ëngth
);

41 
Wr™”
(const Writer&);

42 
	gİ”©Ü
=(cÚ¡ 
Wr™”
&);

	@db/memtable.cc

5 
	~"db/membË.h
"

6 
	~"db/dbfÜm©.h
"

7 
	~"Ëv–db/com·¿tÜ.h
"

8 
	~"Ëv–db/’v.h
"

9 
	~"Ëv–db/™”©Ü.h
"

10 
	~"ut/codšg.h
"

12 
Çme¥aû
 
	gËv–db
 {

14 
Sliû
 
G‘L’gthP»fixedSliû
(cÚ¡ * 
d©a
) {

15 
ušt32_t
 
	gËn
;

16 cÚ¡ * 
	gp
 = 
d©a
;

17 
	gp
 = 
G‘V¬št32PŒ
(
p
,… + 5, &
Ën
);

18  
Sliû
(
p
, 
Ën
);

21 
	gMemTabË
::
MemTabË
(cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
& 
cmp
)

22 : 
com·¿tÜ_
(
cmp
),

23 
bË_
(
com·¿tÜ_
, &
¬’a_
) {

26 
	gMemTabË
::~
MemTabË
() {

29 
size_t
 
MemTabË
::
Aµroxim©eMemÜyU§ge
(è{  
¬’a_
.
MemÜyU§ge
(); }

31 
	gMemTabË
::
KeyCom·¿tÜ
::
İ”©Ü
()(cÚ¡ * 
­Œ
, cÚ¡ * 
	gb±r
)

34 
Sliû
 
	ga
 = 
G‘L’gthP»fixedSliû
(
­Œ
);

35 
Sliû
 
	gb
 = 
G‘L’gthP»fixedSliû
(
b±r
);

36  
	gcom·¿tÜ
.
Com·»
(
a
, 
b
);

42 cÚ¡ * 
EncodeKey
(
¡d
::
¡ršg
* 
sü©ch
, cÚ¡ 
Sliû
& 
rg‘
) {

43 
	gsü©ch
->
ş—r
();

44 
PutV¬št32
(
sü©ch
, 
rg‘
.
size
());

45 
	gsü©ch
->
­³nd
(
rg‘
.
d©a
(),¬g‘.
size
());

46  
	gsü©ch
->
d©a
();

49 şas 
	cMemTabËI‹¿tÜ
: 
public
 
I‹¿tÜ
 {

50 
public
:

51 
ex¶ic™
 
MemTabËI‹¿tÜ
(
MemTabË
::
TabË
* 
bË
) {

52 
™”_
 = 
Ãw
 
MemTabË
::
TabË
::
I‹¿tÜ
(
bË
);

54 
	gvœtu®
 ~
MemTabËI‹¿tÜ
(è{ 
d–‘e
 
	g™”_
; }

56 
vœtu®
 
boŞ
 
V®id
(ècÚ¡ {  
	g™”_
->Valid(); }

57 
vœtu®
 
S“k
(cÚ¡ 
Sliû
& 
k
è{ 
	g™”_
->S“k(
EncodeKey
(&
tmp_
, k)); }

58 
vœtu®
 
S“kToFœ¡
(è{ 
	g™”_
->SeekToFirst(); }

59 
vœtu®
 
S“kToLa¡
(è{ 
	g™”_
->SeekToLast(); }

60 
vœtu®
 
Next
(è{ 
	g™”_
->Next(); }

61 
vœtu®
 
P»v
(è{ 
	g™”_
->Prev(); }

62 
vœtu®
 
Sliû
 
key
(ècÚ¡ {  
G‘L’gthP»fixedSliû
(
™”_
->key()); }

63 
vœtu®
 
Sliû
 
v®ue
() const {

64 
Sliû
 
	gkey_¦iû
 = 
G‘L’gthP»fixedSliû
(
™”_
->
key
());

65  
G‘L’gthP»fixedSliû
(
key_¦iû
.
d©a
(è+ key_¦iû.
size
());

68 
vœtu®
 
Stus
 
¡©us
(ècÚ¡ {  
	gStus
::
OK
(); }

70 
	g´iv©e
:

71 
MemTabË
::
TabË
::
I‹¿tÜ
* 
™”_
;

72 
	g¡d
::
¡ršg
 
tmp_
;

75 
MemTabËI‹¿tÜ
(const MemTableIterator&);

76 
	gİ”©Ü
=(cÚ¡ 
MemTabËI‹¿tÜ
&);

79 
I‹¿tÜ
* 
	gMemTabË
::
	$NewI‹¿tÜ
() {

80  
Ãw
 
	`MemTabËI‹¿tÜ
(&
bË_
);

81 
	}
}

83 
	gMemTabË
::
	$Add
(
Sequ’ûNumb”
 
s
, 
V®ueTy³
 
ty³
,

84 cÚ¡ 
Sliû
& 
key
,

85 cÚ¡ 
Sliû
& 
v®ue
) {

91 
size_t
 
key_size
 = 
key
.
	`size
();

92 
size_t
 
v®_size
 = 
v®ue
.
	`size
();

93 
size_t
 
š‹º®_key_size
 = 
key_size
 + 8;

94 cÚ¡ 
size_t
 
’coded_Ën
 =

95 
	`V¬štL’gth
(
š‹º®_key_size
) + internal_key_size +

96 
	`V¬štL’gth
(
v®_size
) + val_size;

97 * 
buf
 = 
¬’a_
.
	`AÎoÿ‹
(
’coded_Ën
);

98 * 
p
 = 
	`EncodeV¬št32
(
buf
, 
š‹º®_key_size
);

99 
	`memıy
(
p
, 
key
.
	`d©a
(), 
key_size
);

100 
p
 +ğ
key_size
;

101 
	`EncodeFixed64
(
p
, (
s
 << 8è| 
ty³
);

102 
p
 += 8;

103 
p
 = 
	`EncodeV¬št32
Õ, 
v®_size
);

104 
	`memıy
(
p
, 
v®ue
.
	`d©a
(), 
v®_size
);

105 
	`as£¹
((
p
 + 
v®_size
è- 
buf
 =ğ
’coded_Ën
);

106 
bË_
.
	`In£¹
(
buf
);

107 
	}
}

	@db/memtable.h

5 #iâdeà
STORAGE_LEVELDB_DB_MEMTABLE_H_


6 
	#STORAGE_LEVELDB_DB_MEMTABLE_H_


	)

8 
	~<¡ršg
>

9 
	~"Ëv–db/db.h
"

10 
	~"db/dbfÜm©.h
"

11 
	~"db/skli¡.h
"

12 
	~"ut/¬’a.h
"

14 
Çme¥aû
 
	gËv–db
 {

16 
şass
 
	gIÁ”ÇlKeyCom·¿tÜ
;

17 
şass
 
	gMu‹x
;

18 
şass
 
	gMemTabËI‹¿tÜ
;

20 şas 
	cMemTabË
 {

21 
	gpublic
:

22 
ex¶ic™
 
MemTabË
(cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
& 
com·¿tÜ
);

23 ~
MemTabË
();

30 
size_t
 
Aµroxim©eMemÜyU§ge
();

38 
I‹¿tÜ
* 
NewI‹¿tÜ
();

43 
Add
(
Sequ’ûNumb”
 
£q
, 
V®ueTy³
 
ty³
,

44 cÚ¡ 
Sliû
& 
key
,

45 cÚ¡ 
Sliû
& 
v®ue
);

47 
	g´iv©e
:

48 
	sKeyCom·¿tÜ
 {

49 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
 
com·¿tÜ
;

50 
ex¶ic™
 
KeyCom·¿tÜ
(cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
& 
c
è: 
com·¿tÜ
(c) { }

51 
İ”©Ü
()(cÚ¡ * 
a
, cÚ¡ * 
	gb
) const;

53 
ä›nd
 
şass
 
	gMemTabËI‹¿tÜ
;

54 
ä›nd
 
şass
 
	gMemTabËBackw¬dI‹¿tÜ
;

56 
	gSkLi¡
<cÚ¡ *, 
	tKeyCom·¿tÜ
> 
	tTabË
;

58 
KeyCom·¿tÜ
 
	gcom·¿tÜ_
;

59 
A»Ç
 
	g¬’a_
;

60 
TabË
 
	gbË_
;

63 
MemTabË
(const MemTable&);

64 
	gİ”©Ü
=(cÚ¡ 
MemTabË
&);

	@db/repair.cc

27 
	~"db/bud”.h
"

28 
	~"db/db_im¶.h
"

29 
	~"db/dbfÜm©.h
"

30 
	~"db/f’ame.h
"

31 
	~"db/log_»ad”.h
"

32 
	~"db/log_wr™”.h
"

33 
	~"db/membË.h
"

34 
	~"db/bË_ÿche.h
"

35 
	~"db/v”siÚ_ed™.h
"

36 
	~"db/wr™e_b©ch_š‹º®.h
"

37 
	~"Ëv–db/com·¿tÜ.h
"

38 
	~"Ëv–db/db.h
"

39 
	~"Ëv–db/’v.h
"

41 
Çme¥aû
 
	gËv–db
 {

43 
	gÇme¥aû
 {

45 şas 
	cR•aœ”
 {

46 
	gpublic
:

47 
R•aœ”
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
, cÚ¡ 
O±iÚs
& 
İtiÚs
)

48 : 
dbÇme_
(
dbÇme
),

49 
’v_
(
İtiÚs
.
’v
),

50 
icmp_
(
İtiÚs
.
com·¿tÜ
),

51 
İtiÚs_
(
Sª™izeO±iÚs
(
dbÇme
, &
icmp_
, 
İtiÚs
)),

52 
owns_šfo_log_
(
İtiÚs_
.
šfo_log
 !ğ
İtiÚs
.info_log),

53 
Ãxt_fe_numb”_
(1) {

55 
	gbË_ÿche_
 = 
Ãw
 
TabËCache
(
dbÇme_
, &
İtiÚs_
, 10);

58 ~
R•aœ”
() {

59 
d–‘e
 
	gbË_ÿche_
;

60 ià(
	gowns_šfo_log_
) {

61 
d–‘e
 
	gİtiÚs_
.
	gšfo_log
;

65 
Stus
 
Run
() {

66 
Stus
 
	g¡©us
 = 
FšdFes
();

67 ià(
	g¡©us
.
ok
()) {

68 
CÚv”tLogFesToTabËs
();

69 
ExŒaùM‘aD©a
();

70 
	g¡©us
 = 
Wr™eDesütÜ
();

72 ià(
	g¡©us
.
ok
()) {

73 
	gby‹s
 = 0;

74 
size_t
 
	gi
 = 0; i < 
	gbËs_
.
size
(); i++) {

75 
	gby‹s
 +ğ
bËs_
[
i
].
m‘a
.
fe_size
;

77 
Log
(
’v_
, 
İtiÚs_
.
šfo_log
,

82 
dbÇme_
.
c_¡r
(),

83 
¡©ic_ÿ¡
<>(
bËs_
.
size
()),

84 
by‹s
);

86  
	g¡©us
;

89 
	g´iv©e
:

90 
	sTabËInfo
 {

91 
FeM‘aD©a
 
m‘a
;

92 
Sequ’ûNumb”
 
	gmax_£qu’û
;

95 
	g¡d
::
¡ršg
 cÚ¡ 
dbÇme_
;

96 
Env
* cÚ¡ 
	g’v_
;

97 
IÁ”ÇlKeyCom·¿tÜ
 cÚ¡ 
	gicmp_
;

98 
O±iÚs
 cÚ¡ 
	gİtiÚs_
;

99 
boŞ
 
	gowns_šfo_log_
;

100 
TabËCache
* 
	gbË_ÿche_
;

101 
V”siÚEd™
 
	ged™_
;

103 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
mªiã¡s_
;

104 
	g¡d
::
veùÜ
<
ušt64_t
> 
bË_numb”s_
;

105 
	g¡d
::
veùÜ
<
ušt64_t
> 
logs_
;

106 
	g¡d
::
veùÜ
<
TabËInfo
> 
bËs_
;

107 
ušt64_t
 
	gÃxt_fe_numb”_
;

109 
Stus
 
FšdFes
() {

110 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
f’ames
;

111 
Stus
 
	g¡©us
 = 
’v_
->
G‘Chd»n
(
dbÇme_
, &
f’ames
);

112 ià(!
	g¡©us
.
ok
()) {

113  
	g¡©us
;

115 ià(
	gf’ames
.
em±y
()) {

116  
	gStus
::
IOE¼Ü
(
dbÇme_
, "repair found‚o files");

119 
ušt64_t
 
	gnumb”
;

120 
FeTy³
 
	gty³
;

121 
size_t
 
	gi
 = 0; i < 
	gf’ames
.
size
(); i++) {

122 ià(
P¬£FeName
(
f’ames
[
i
], &
numb”
, &
ty³
)) {

123 ià(
	gty³
 =ğ
kDesütÜFe
) {

124 
mªiã¡s_
.
push_back
(
f’ames
[
i
]);

126 ià(
	gnumb”
 + 1 > 
	gÃxt_fe_numb”_
) {

127 
	gÃxt_fe_numb”_
 = 
numb”
 + 1;

129 ià(
	gty³
 =ğ
kLogFe
) {

130 
logs_
.
push_back
(
numb”
);

131 } ià(
	gty³
 =ğ
kTabËFe
) {

132 
bË_numb”s_
.
push_back
(
numb”
);

139  
	g¡©us
;

142 
CÚv”tLogFesToTabËs
() {

143 
size_t
 
	gi
 = 0; i < 
	glogs_
.
size
(); i++) {

144 
	g¡d
::
¡ršg
 
logÇme
 = 
LogFeName
(
dbÇme_
, 
logs_
[
i
]);

145 
Stus
 
	g¡©us
 = 
CÚv”tLogToTabË
(
logs_
[
i
]);

146 ià(!
	g¡©us
.
ok
()) {

147 
Log
(
’v_
, 
İtiÚs_
.
šfo_log
, "Log #%llu: ignoring conversionƒrror: %s",

148 (è
logs_
[
i
],

149 
¡©us
.
ToSŒšg
().
c_¡r
());

151 
ArchiveFe
(
logÇme
);

155 
Stus
 
CÚv”tLogToTabË
(
ušt64_t
 
log
) {

156 
	gLogR•Ü‹r
 : 
public
 
log
::
R—d”
::
R•Ü‹r
 {

157 
Env
* 
’v
;

158 
Wr™abËFe
* 
	gšfo_log
;

159 
ušt64_t
 
	glognum
;

160 
vœtu®
 
CÜru±iÚ
(
size_t
 
by‹s
, cÚ¡ 
Stus
& 
s
) {

162 
Log
(
’v
, 
šfo_log
, "Log #%llu: dropping %d bytes; %s",

163 (è
lognum
,

164 
¡©ic_ÿ¡
<>(
by‹s
),

165 
s
.
ToSŒšg
().
c_¡r
());

170 
	g¡d
::
¡ršg
 
logÇme
 = 
LogFeName
(
dbÇme_
, 
log
);

171 
Sequ’tŸlFe
* 
	glfe
;

172 
Stus
 
	g¡©us
 = 
’v_
->
NewSequ’tŸlFe
(
logÇme
, &
lfe
);

173 ià(!
	g¡©us
.
ok
()) {

174  
	g¡©us
;

178 
LogR•Ü‹r
 
	g»pÜ‹r
;

179 
	g»pÜ‹r
.
	g’v
 = 
’v_
;

180 
	g»pÜ‹r
.
	gšfo_log
 = 
İtiÚs_
.
šfo_log
;

181 
	g»pÜ‹r
.
	glognum
 = 
log
;

186 
	glog
::
R—d”
 
»ad”
(
lfe
, &
»pÜ‹r
, 
çl£
 );

189 
	g¡d
::
¡ršg
 
sü©ch
;

190 
Sliû
 
	g»cÜd
;

191 
Wr™eB©ch
 
	gb©ch
;

192 
MemTabË
 
mem
(
icmp_
);

193 
	gcouÁ”
 = 0;

194 
	g»ad”
.
R—dRecÜd
(&
»cÜd
, &
sü©ch
)) {

195 ià(
	g»cÜd
.
size
() < 12) {

196 
	g»pÜ‹r
.
CÜru±iÚ
(

197 
»cÜd
.
size
(), 
Stus
::
CÜru±iÚ
("log„ecordoo small"));

200 
	gWr™eB©chIÁ”Çl
::
S‘CÚ‹Ás
(&
b©ch
, 
»cÜd
);

201 
	g¡©us
 = 
Wr™eB©chIÁ”Çl
::
In£¹IÁo
(&
b©ch
, &
mem
);

202 ià(
	g¡©us
.
ok
()) {

203 
	gcouÁ”
 +ğ
Wr™eB©chIÁ”Çl
::
CouÁ
(&
b©ch
);

205 
Log
(
’v_
, 
İtiÚs_
.
šfo_log
, "Log #%llu: ignoring %s",

206 (è
log
,

207 
¡©us
.
ToSŒšg
().
c_¡r
());

208 
	g¡©us
 = 
Stus
::
OK
();

211 
d–‘e
 
	glfe
;

215 
V”siÚEd™
 
	gsk³d
;

216 
FeM‘aD©a
 
	gm‘a
;

217 
	gm‘a
.
	gnumb”
 = 
Ãxt_fe_numb”_
++;

218 
I‹¿tÜ
* 
	g™”
 = 
mem
.
NewI‹¿tÜ
();

219 
	g¡©us
 = 
BudTabË
(
dbÇme_
, 
’v_
, 
İtiÚs_
, 
bË_ÿche_
, 
™”
,

220 &
m‘a
, &
sk³d
);

221 
d–‘e
 
	g™”
;

222 ià(
	g¡©us
.
ok
()) {

223 ià(
	gm‘a
.
	gfe_size
 > 0) {

224 
	gbË_numb”s_
.
push_back
(
m‘a
.
numb”
);

227 
Log
(
’v_
, 
İtiÚs_
.
šfo_log
, "Log #%llu: %d ops savedo Table #%llu %s",

228 (è
log
,

229 
couÁ”
,

230 (è
m‘a
.
numb”
,

231 
¡©us
.
ToSŒšg
().
c_¡r
());

232  
	g¡©us
;

235 
ExŒaùM‘aD©a
() {

236 
	g¡d
::
veùÜ
<
TabËInfo
> 
k•t
;

237 
size_t
 
	gi
 = 0; i < 
	gbË_numb”s_
.
size
(); i++) {

238 
TabËInfo
 
	gt
;

239 
	gt
.
	gm‘a
.
	gnumb”
 = 
bË_numb”s_
[
i
];

240 
Stus
 
	g¡©us
 = 
SÿnTabË
(&
t
);

241 ià(!
	g¡©us
.
ok
()) {

242 
	g¡d
::
¡ršg
 
âame
 = 
TabËFeName
(
dbÇme_
, 
bË_numb”s_
[
i
]);

243 
Log
(
’v_
, 
İtiÚs_
.
šfo_log
, "Table #%llu: ignoring %s",

244 (è
bË_numb”s_
[
i
],

245 
¡©us
.
ToSŒšg
().
c_¡r
());

246 
ArchiveFe
(
âame
);

248 
	gbËs_
.
push_back
(
t
);

253 
Stus
 
SÿnTabË
(
TabËInfo
* 
t
) {

254 
	g¡d
::
¡ršg
 
âame
 = 
TabËFeName
(
dbÇme_
, 
t
->
m‘a
.
numb”
);

255 
	gcouÁ”
 = 0;

256 
Stus
 
	g¡©us
 = 
’v_
->
G‘FeSize
(
âame
, &
t
->
m‘a
.
fe_size
);

257 ià(
	g¡©us
.
ok
()) {

258 
I‹¿tÜ
* 
	g™”
 = 
bË_ÿche_
->
NewI‹¿tÜ
(

259 
R—dO±iÚs
(), 
t
->
m‘a
.
numb”
,->m‘a.
fe_size
);

260 
boŞ
 
	gem±y
 = 
Œue
;

261 
P¬£dIÁ”ÇlKey
 
	g·r£d
;

262 
	gt
->
	gmax_£qu’û
 = 0;

263 
	g™”
->
S“kToFœ¡
(); i‹r->
V®id
(); i‹r->
Next
()) {

264 
Sliû
 
	gkey
 = 
™”
->
key
();

265 ià(!
P¬£IÁ”ÇlKey
(
key
, &
·r£d
)) {

266 
Log
(
’v_
, 
İtiÚs_
.
šfo_log
, "Table #%llu: unparsable key %s",

267 (è
t
->
m‘a
.
numb”
,

268 
Esÿ³SŒšg
(
key
).
c_¡r
());

272 
	gcouÁ”
++;

273 ià(
	gem±y
) {

274 
	gem±y
 = 
çl£
;

275 
	gt
->
	gm‘a
.
	gsm®Ë¡
.
DecodeFrom
(
key
);

277 
	gt
->
	gm‘a
.
	gÏrge¡
.
DecodeFrom
(
key
);

278 ià(
	g·r£d
.
	g£qu’û
 > 
	gt
->
	gmax_£qu’û
) {

279 
	gt
->
	gmax_£qu’û
 = 
·r£d
.
£qu’û
;

282 ià(!
	g™”
->
¡©us
().
ok
()) {

283 
	g¡©us
 = 
™”
->
¡©us
();

285 
d–‘e
 
	g™”
;

287 
Log
(
’v_
, 
İtiÚs_
.
šfo_log
, "Table #%llu: %dƒntries %s",

288 (è
t
->
m‘a
.
numb”
,

289 
couÁ”
,

290 
¡©us
.
ToSŒšg
().
c_¡r
());

291  
	g¡©us
;

294 
Stus
 
Wr™eDesütÜ
() {

295 
	g¡d
::
¡ršg
 
tmp
 = 
TempFeName
(
dbÇme_
, 1);

296 
Wr™abËFe
* 
	gfe
;

297 
Stus
 
	g¡©us
 = 
’v_
->
NewWr™abËFe
(
tmp
, &
fe
);

298 ià(!
	g¡©us
.
ok
()) {

299  
	g¡©us
;

302 
Sequ’ûNumb”
 
	gmax_£qu’û
 = 0;

303 
size_t
 
	gi
 = 0; i < 
	gbËs_
.
size
(); i++) {

304 ià(
	gmax_£qu’û
 < 
	gbËs_
[
i
].max_sequence) {

305 
	gmax_£qu’û
 = 
bËs_
[
i
].
max_£qu’û
;

309 
	ged™_
.
S‘Com·¿tÜName
(
icmp_
.
u£r_com·¿tÜ
()->
Name
());

310 
	ged™_
.
S‘LogNumb”
(0);

311 
	ged™_
.
S‘NextFe
(
Ãxt_fe_numb”_
);

312 
	ged™_
.
S‘La¡Sequ’û
(
max_£qu’û
);

314 
size_t
 
	gi
 = 0; i < 
	gbËs_
.
size
(); i++) {

316 cÚ¡ 
	gTabËInfo
& 
	gt
 = 
bËs_
[
i
];

317 
	ged™_
.
AddFe
(0, 
t
.
m‘a
.
numb”
,.m‘a.
fe_size
,

318 
t
.
m‘a
.
sm®Ë¡
,.m‘a.
Ïrge¡
);

323 
	glog
::
Wr™”
 
log
(
fe
);

324 
	g¡d
::
¡ršg
 
»cÜd
;

325 
	ged™_
.
EncodeTo
(&
»cÜd
);

326 
	g¡©us
 = 
log
.
AddRecÜd
(
»cÜd
);

328 ià(
	g¡©us
.
ok
()) {

329 
	g¡©us
 = 
fe
->
Clo£
();

331 
d–‘e
 
	gfe
;

332 
	gfe
 = 
NULL
;

334 ià(!
	g¡©us
.
ok
()) {

335 
	g’v_
->
D–‘eFe
(
tmp
);

338 
size_t
 
	gi
 = 0; i < 
	gmªiã¡s_
.
size
(); i++) {

339 
ArchiveFe
(
dbÇme_
 + "/" + 
mªiã¡s_
[
i
]);

343 
	g¡©us
 = 
’v_
->
R’ameFe
(
tmp
, 
DesütÜFeName
(
dbÇme_
, 1));

344 ià(
	g¡©us
.
ok
()) {

345 
	g¡©us
 = 
S‘Cu¼’tFe
(
’v_
, 
dbÇme_
, 1);

347 
	g’v_
->
D–‘eFe
(
tmp
);

350  
	g¡©us
;

353 
ArchiveFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
) {

358 cÚ¡ * 
¦ash
 = 
¡¼chr
(
âame
.
c_¡r
(), '/');

359 
	g¡d
::
¡ršg
 
Ãw_dœ
;

360 ià(
	g¦ash
 !ğ
NULL
) {

361 
Ãw_dœ
.
assign
(
âame
.
d©a
(), 
¦ash
 - fname.data());

363 
	gÃw_dœ
.
­³nd
("/lost");

364 
	g’v_
->
C»©eDœ
(
Ãw_dœ
);

365 
	g¡d
::
¡ršg
 
Ãw_fe
 = 
Ãw_dœ
;

366 
	gÃw_fe
.
­³nd
("/");

367 
	gÃw_fe
.
­³nd
((
¦ash
 =ğ
NULL
è? 
âame
.
c_¡r
() : slash + 1);

368 
Stus
 
	gs
 = 
’v_
->
R’ameFe
(
âame
, 
Ãw_fe
);

369 
Log
(
’v_
, 
İtiÚs_
.
šfo_log
, "Archiving %s: %s\n",

370 
âame
.
c_¡r
(), 
s
.
ToSŒšg
().c_str());

375 
Stus
 
R•aœDB
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
, cÚ¡ 
O±iÚs
& 
İtiÚs
) {

376 
R•aœ”
 
»·œ”
(
dbÇme
, 
İtiÚs
);

377  
	g»·œ”
.
Run
();

	@db/skiplist.h

27 
	~<as£¹.h
>

28 
	~<¡dlib.h
>

29 
	~"pÜt/pÜt.h
"

30 
	~"ut/¬’a.h
"

31 
	~"ut/¿ndom.h
"

33 
Çme¥aû
 
	gËv–db
 {

35 
şass
 
	gA»Ç
;

37 
	g‹m¶©e
<
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

38 şas 
	cSkLi¡
 {

39 
	g´iv©e
:

40 
Node
;

42 
	gpublic
:

46 
ex¶ic™
 
SkLi¡
(
Com·¿tÜ
 
cmp
, 
A»Ç
* 
¬’a
);

50 
In£¹
(cÚ¡ 
Key
& 
key
);

53 
boŞ
 
CÚšs
(cÚ¡ 
Key
& 
key
) const;

56 şas 
	cI‹¿tÜ
 {

57 
	gpublic
:

60 
ex¶ic™
 
I‹¿tÜ
(cÚ¡ 
SkLi¡
* 
li¡
);

63 
boŞ
 
V®id
() const;

67 cÚ¡ 
	gKey
& 
key
() const;

71 
Next
();

75 
P»v
();

78 
S“k
(cÚ¡ 
Key
& 
rg‘
);

82 
S“kToFœ¡
();

86 
S“kToLa¡
();

88 
	g´iv©e
:

89 cÚ¡ 
SkLi¡
* 
li¡_
;

90 
Node
* 
	gnode_
;

94 
	g´iv©e
:

95 ’um { 
kMaxHeight
 = 12 };

98 
Com·¿tÜ
 cÚ¡ 
	gcom·»_
;

99 
A»Ç
* cÚ¡ 
	g¬’a_
;

101 
Node
* cÚ¡ 
	gh—d_
;

105 
	gpÜt
::
AtomicPoš‹r
 
max_height_
;

107 
šlše
 
G‘MaxHeight
() const {

108  
	g»š‹½»t_ÿ¡
<
	gšŒ_t
>(
	gmax_height_
.
NoB¬r›r_Lßd
());

112 
Rªdom
 
	gºd_
;

114 
Node
* 
NewNode
(cÚ¡ 
Key
& 
key
, 
height
);

115 
RªdomHeight
();

116 
boŞ
 
Equ®
(cÚ¡ 
Key
& 
a
, cÚ¡ Key& 
b
ècÚ¡ {  (
com·»_
(a, b) == 0); }

119 
boŞ
 
KeyIsAá”Node
(cÚ¡ 
Key
& 
key
, 
Node
* 
n
) const;

126 
Node
* 
FšdG»©”OrEqu®
(cÚ¡ 
Key
& 
key
, Node** 
´ev
) const;

130 
Node
* 
FšdLessThª
(cÚ¡ 
Key
& 
key
) const;

134 
Node
* 
FšdLa¡
() const;

137 
SkLi¡
(const SkipList&);

138 
	gİ”©Ü
=(cÚ¡ 
SkLi¡
&);

142 
	g‹m¶©e
<
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

143 
	gSkLi¡
<
	gKey
,
	gCom·¿tÜ
>::
Node
 {

144 
ex¶ic™
 
Node
(cÚ¡ 
Key
& 
k
è: 
key
(k) { }

146 
Key
 cÚ¡ 
key
;

150 
Node
* 
Next
(
n
) {

151 
as£¹
(
n
 >= 0);

154  
	g»š‹½»t_ÿ¡
<
	gNode
*>(
	gÃxt_
[
n
].
Acquœe_Lßd
());

156 
S‘Next
(
n
, 
Node
* 
x
) {

157 
as£¹
(
n
 >= 0);

160 
	gÃxt_
[
n
].
R–—£_StÜe
(
x
);

164 
Node
* 
NoB¬r›r_Next
(
n
) {

165 
as£¹
(
n
 >= 0);

166  
	g»š‹½»t_ÿ¡
<
	gNode
*>(
	gÃxt_
[
n
].
NoB¬r›r_Lßd
());

168 
NoB¬r›r_S‘Next
(
n
, 
Node
* 
x
) {

169 
as£¹
(
n
 >= 0);

170 
	gÃxt_
[
n
].
NoB¬r›r_StÜe
(
x
);

173 
	g´iv©e
:

175 
pÜt
::
AtomicPoš‹r
 
Ãxt_
[1];

178 
	g‹m¶©e
<
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

179 
ty³Çme
 
	gSkLi¡
<
	gKey
,
	gCom·¿tÜ
>::
Node
*

180 
SkLi¡
<
Key
,
	gCom·¿tÜ
>::
	$NewNode
(cÚ¡ 
Key
& 
key
, 
height
) {

181 * 
mem
 = 
¬’a_
->
	`AÎoÿ‹AligÃd
(

182 (
Node
è+ (
pÜt
::
AtomicPoš‹r
è* (
height
 - 1));

183  
	`Ãw
 (
mem
è
	`Node
(
key
);

184 
	}
}

186 
	g‹m¶©e
<
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

187 
šlše
 
	gSkLi¡
<
	gKey
,
	gCom·¿tÜ
>::
I‹¿tÜ
::
	$I‹¿tÜ
(cÚ¡ 
SkLi¡
* 
li¡
) {

188 
li¡_
 = 
li¡
;

189 
node_
 = 
NULL
;

190 
	}
}

192 
	g‹m¶©e
<
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

193 
šlše
 
boŞ
 
	gSkLi¡
<
	gKey
,
	gCom·¿tÜ
>::
I‹¿tÜ
::
	$V®id
() const {

194  
node_
 !ğ
NULL
;

195 
	}
}

197 
	g‹m¶©e
<
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

198 
šlše
 cÚ¡ 
	gKey
& 
	gSkLi¡
<Key,
	gCom·¿tÜ
>::
I‹¿tÜ
::
	$key
() const {

199 
	`as£¹
(
	`V®id
());

200  
node_
->
key
;

201 
	}
}

203 
	g‹m¶©e
<
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

204 
šlše
 
	gSkLi¡
<
	gKey
,
	gCom·¿tÜ
>::
I‹¿tÜ
::
	$Next
() {

205 
	`as£¹
(
	`V®id
());

206 
node_
 =‚ode_->
	`Next
(0);

207 
	}
}

209 
	g‹m¶©e
<
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

210 
šlše
 
	gSkLi¡
<
	gKey
,
	gCom·¿tÜ
>::
I‹¿tÜ
::
	$P»v
() {

213 
	`as£¹
(
	`V®id
());

214 
node_
 = 
li¡_
->
	`FšdLessThª
Òode_->
key
);

215 ià(
node_
 =ğ
li¡_
->
h—d_
) {

216 
node_
 = 
NULL
;

218 
	}
}

220 
	g‹m¶©e
<
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

221 
šlše
 
	gSkLi¡
<
	gKey
,
	gCom·¿tÜ
>::
I‹¿tÜ
::
	$S“k
(cÚ¡ 
Key
& 
rg‘
) {

222 
node_
 = 
li¡_
->
	`FšdG»©”OrEqu®
(
rg‘
, 
NULL
);

223 
	}
}

225 
	g‹m¶©e
<
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

226 
šlše
 
	gSkLi¡
<
	gKey
,
	gCom·¿tÜ
>::
I‹¿tÜ
::
	$S“kToFœ¡
() {

227 
node_
 = 
li¡_
->
h—d_
->
	`Next
(0);

228 
	}
}

230 
	g‹m¶©e
<
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

231 
šlše
 
	gSkLi¡
<
	gKey
,
	gCom·¿tÜ
>::
I‹¿tÜ
::
	$S“kToLa¡
() {

232 
node_
 = 
li¡_
->
	`FšdLa¡
();

233 ià(
node_
 =ğ
li¡_
->
h—d_
) {

234 
node_
 = 
NULL
;

236 
	}
}

238 
	g‹m¶©e
<
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

239 
	gSkLi¡
<
	gKey
,
	gCom·¿tÜ
>::
	$RªdomHeight
() {

241 cÚ¡ 
kB¿nchšg
 = 4;

242 
height
 = 1;

243 
height
 < 
kMaxHeight
 && ((
ºd_
.
	`Next
(è% 
kB¿nchšg
) == 0)) {

244 
height
++;

246 
	`as£¹
(
height
 > 0);

247 
	`as£¹
(
height
 <ğ
kMaxHeight
);

248  
height
;

249 
	}
}

251 
	g‹m¶©e
<
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

252 
boŞ
 
	gSkLi¡
<
	gKey
,
	gCom·¿tÜ
>::
	$KeyIsAá”Node
(cÚ¡ 
Key
& 
key
, 
Node
* 
n
) const {

254  (
n
 !ğ
NULL
è&& (
	`com·»_
Ò->
key
, key) < 0);

255 
	}
}

257 
	g‹m¶©e
<
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

258 
ty³Çme
 
	gSkLi¡
<
	gKey
,
	gCom·¿tÜ
>::
Node
* 
SkLi¡
<
Key
,Com·¿tÜ>::
	$FšdG»©”OrEqu®
(cÚ¡ 
Key
& 
key
, 
Node
** 
´ev
)

260 
Node
* 
x
 = 
h—d_
;

261 
Ëv–
 = 
	`G‘MaxHeight
() - 1;

262 
Œue
) {

263 
Node
* 
Ãxt
 = 
x
->
	`Next
(
Ëv–
);

264 ià(
	`KeyIsAá”Node
(
key
, 
Ãxt
)) {

266 
x
 = 
Ãxt
;

268 ià(
´ev
 !ğ
NULL
è´ev[
Ëv–
] = 
x
;

269 ià(
Ëv–
 == 0) {

270  
Ãxt
;

273 
Ëv–
--;

277 
	}
}

279 
	g‹m¶©e
<
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

280 
ty³Çme
 
	gSkLi¡
<
	gKey
,
	gCom·¿tÜ
>::
Node
*

281 
SkLi¡
<
Key
,
	gCom·¿tÜ
>::
	$FšdLessThª
(cÚ¡ 
Key
& 
key
) const {

282 
Node
* 
x
 = 
h—d_
;

283 
Ëv–
 = 
	`G‘MaxHeight
() - 1;

284 
Œue
) {

285 
	`as£¹
(
x
 =ğ
h—d_
 || 
	`com·»_
(x->
key
, key) < 0);

286 
Node
* 
Ãxt
 = 
x
->
	`Next
(
Ëv–
);

287 ià(
Ãxt
 =ğ
NULL
 || 
	`com·»_
Òext->
key
, key) >= 0) {

288 ià(
Ëv–
 == 0) {

289  
x
;

292 
Ëv–
--;

295 
x
 = 
Ãxt
;

298 
	}
}

300 
	g‹m¶©e
<
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

301 
ty³Çme
 
	gSkLi¡
<
	gKey
,
	gCom·¿tÜ
>::
Node
* 
SkLi¡
<
Key
,Com·¿tÜ>::
	$FšdLa¡
()

303 
Node
* 
x
 = 
h—d_
;

304 
Ëv–
 = 
	`G‘MaxHeight
() - 1;

305 
Œue
) {

306 
Node
* 
Ãxt
 = 
x
->
	`Next
(
Ëv–
);

307 ià(
Ãxt
 =ğ
NULL
) {

308 ià(
Ëv–
 == 0) {

309  
x
;

312 
Ëv–
--;

315 
x
 = 
Ãxt
;

318 
	}
}

320 
	g‹m¶©e
<
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

321 
	gSkLi¡
<
	gKey
,
	gCom·¿tÜ
>::
	$SkLi¡
(
Com·¿tÜ
 
cmp
, 
A»Ç
* 
¬’a
)

322 : 
	`com·»_
(
cmp
),

323 
	`¬’a_
(
¬’a
),

324 
	`h—d_
(
	`NewNode
(0 , 
kMaxHeight
)),

325 
	`max_height_
(
»š‹½»t_ÿ¡
<*>(1)),

326 
	$ºd_
(0xdeadbeef) {

327 
i
 = 0; i < 
kMaxHeight
; i++) {

328 
h—d_
->
	`S‘Next
(
i
, 
NULL
);

330 
	}
}

332 
	g‹m¶©e
<
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

333 
	gSkLi¡
<
	gKey
,
	gCom·¿tÜ
>::
	$In£¹
(cÚ¡ 
Key
& 
key
) {

336 
Node
* 
´ev
[
kMaxHeight
];

337 
Node
* 
x
 = 
	`FšdG»©”OrEqu®
(
key
, 
´ev
);

340 
	`as£¹
(
x
 =ğ
NULL
 || !
	`Equ®
(
key
, x->key));

342 
height
 = 
	`RªdomHeight
();

343 ià(
height
 > 
	`G‘MaxHeight
()) {

344 
i
 = 
	`G‘MaxHeight
(); i < 
height
; i++) {

345 
´ev
[
i
] = 
h—d_
;

356 
max_height_
.
	`NoB¬r›r_StÜe
(
»š‹½»t_ÿ¡
<*>(
height
));

359 
x
 = 
	`NewNode
(
key
, 
height
);

360 
i
 = 0; i < 
height
; i++) {

363 
x
->
	`NoB¬r›r_S‘Next
(
i
, 
´ev
[i]->
	`NoB¬r›r_Next
(i));

364 
´ev
[
i
]->
	`S‘Next
(i, 
x
);

366 
	}
}

368 
	g‹m¶©e
<
ty³Çme
 
	gKey
, 
şass
 
	gCom·¿tÜ
>

369 
boŞ
 
	gSkLi¡
<
	gKey
,
	gCom·¿tÜ
>::
	$CÚšs
(cÚ¡ 
Key
& 
key
) const {

370 
Node
* 
x
 = 
	`FšdG»©”OrEqu®
(
key
, 
NULL
);

371 ià(
x
 !ğ
NULL
 && 
	`Equ®
(
key
, x->key)) {

372  
Œue
;

374  
çl£
;

376 
	}
}

	@db/skiplist_test.cc

5 
	~"db/skli¡.h
"

6 
	~<£t
>

7 
	~"Ëv–db/’v.h
"

8 
	~"ut/¬’a.h
"

9 
	~"ut/hash.h
"

10 
	~"ut/¿ndom.h
"

11 
	~"ut/‹¡h¬Ãss.h
"

13 
Çme¥aû
 
	gËv–db
 {

15 
ušt64_t
 
	tKey
;

17 
	sCom·¿tÜ
 {

18 
İ”©Ü
()(cÚ¡ 
	gKey
& 
	ga
, cÚ¡ Key& 
	gb
) const {

19 ià(
	ga
 < 
	gb
) {

21 } ià(
	ga
 > 
	gb
) {

29 şas 
	cSkTe¡
 { };

31 
	$TEST
(
SkTe¡
, 
Em±y
) {

32 
A»Ç
 
¬’a
;

33 
Com·¿tÜ
 
cmp
;

34 
SkLi¡
<
Key
, 
Com·¿tÜ
> 
	`li¡
(
cmp
, &
¬’a
);

35 
	`ASSERT_TRUE
(!
li¡
.
	`CÚšs
(10));

37 
SkLi¡
<
Key
, 
Com·¿tÜ
>::
I‹¿tÜ
 
	`™”
(&
li¡
);

38 
	`ASSERT_TRUE
(!
™”
.
	`V®id
());

39 
™”
.
	`S“kToFœ¡
();

40 
	`ASSERT_TRUE
(!
™”
.
	`V®id
());

41 
™”
.
	`S“k
(100);

42 
	`ASSERT_TRUE
(!
™”
.
	`V®id
());

43 
™”
.
	`S“kToLa¡
();

44 
	`ASSERT_TRUE
(!
™”
.
	`V®id
());

45 
	}
}

47 
	$TEST
(
SkTe¡
, 
In£¹AndLookup
) {

48 cÚ¡ 
N
 = 2000;

49 cÚ¡ 
R
 = 5000;

50 
Rªdom
 
	`ºd
(1000);

51 
¡d
::
£t
<
Key
> 
keys
;

52 
A»Ç
 
¬’a
;

53 
Com·¿tÜ
 
cmp
;

54 
SkLi¡
<
Key
, 
Com·¿tÜ
> 
	`li¡
(
cmp
, &
¬’a
);

55 
i
 = 0; i < 
N
; i++) {

56 
Key
 
key
 = 
ºd
.
	`Next
(è% 
R
;

57 ià(
keys
.
	`š£¹
(
key
).
£cÚd
) {

58 
li¡
.
	`In£¹
(
key
);

62 
i
 = 0; i < 
R
; i++) {

63 ià(
li¡
.
	`CÚšs
(
i
)) {

64 
	`ASSERT_EQ
(
keys
.
	`couÁ
(
i
), 1);

66 
	`ASSERT_EQ
(
keys
.
	`couÁ
(
i
), 0);

72 
SkLi¡
<
Key
, 
Com·¿tÜ
>::
I‹¿tÜ
 
	`™”
(&
li¡
);

73 
	`ASSERT_TRUE
(!
™”
.
	`V®id
());

75 
™”
.
	`S“k
(0);

76 
	`ASSERT_TRUE
(
™”
.
	`V®id
());

77 
	`ASSERT_EQ
(*(
keys
.
	`begš
()), 
™”
.
	`key
());

79 
™”
.
	`S“kToFœ¡
();

80 
	`ASSERT_TRUE
(
™”
.
	`V®id
());

81 
	`ASSERT_EQ
(*(
keys
.
	`begš
()), 
™”
.
	`key
());

83 
™”
.
	`S“kToLa¡
();

84 
	`ASSERT_TRUE
(
™”
.
	`V®id
());

85 
	`ASSERT_EQ
(*(
keys
.
	`rbegš
()), 
™”
.
	`key
());

89 
i
 = 0; i < 
R
; i++) {

90 
SkLi¡
<
Key
, 
Com·¿tÜ
>::
I‹¿tÜ
 
	`™”
(&
li¡
);

91 
™”
.
	`S“k
(
i
);

94 
¡d
::
£t
<
Key
>::
™”©Ü
 
mod–_™”
 = 
keys
.
	`low”_bound
(
i
);

95 
j
 = 0; j < 3; j++) {

96 ià(
mod–_™”
 =ğ
keys
.
	`’d
()) {

97 
	`ASSERT_TRUE
(!
™”
.
	`V®id
());

100 
	`ASSERT_TRUE
(
™”
.
	`V®id
());

101 
	`ASSERT_EQ
(*
mod–_™”
, 
™”
.
	`key
());

102 ++
mod–_™”
;

103 
™”
.
	`Next
();

110 
SkLi¡
<
Key
, 
Com·¿tÜ
>::
I‹¿tÜ
 
	`™”
(&
li¡
);

111 
™”
.
	`S“kToLa¡
();

114 
¡d
::
£t
<
Key
>::
»v”£_™”©Ü
 
mod–_™”
 = 
keys
.
	`rbegš
();

115 
mod–_™”
 !ğ
keys
.
	`»nd
();

116 ++
mod–_™”
) {

117 
	`ASSERT_TRUE
(
™”
.
	`V®id
());

118 
	`ASSERT_EQ
(*
mod–_™”
, 
™”
.
	`key
());

119 
™”
.
	`P»v
();

121 
	`ASSERT_TRUE
(!
™”
.
	`V®id
());

123 
	}
}

149 şas 
	cCÚcu¼’tTe¡
 {

150 
	g´iv©e
:

151 cÚ¡ 
ušt32_t
 
K
 = 4;

153 
ušt64_t
 
key
(
Key
 keyè{  (
	gkey
 >> 40); }

154 
ušt64_t
 
g’
(
Key
 
key
è{  (
	gkey
 >> 8) & 0xffffffffu; }

155 
ušt64_t
 
hash
(
Key
 
key
è{  
	gkey
 & 0xff; }

157 
ušt64_t
 
HashNumb”s
(ušt64_ˆ
k
, ušt64_ˆ
g
) {

158 
ušt64_t
 
	gd©a
[2] = { 
k
, 
g
 };

159  
Hash
(
»š‹½»t_ÿ¡
<*>(
d©a
), (data), 0);

162 
Key
 
MakeKey
(
ušt64_t
 
k
, ušt64_ˆ
g
) {

163 
as£¹
((
Key
è=ğ(
ušt64_t
));

164 
as£¹
(
k
 <ğ
K
);

165 
as£¹
(
g
 <= 0xffffffffu);

166  ((
	gk
 << 40è| (
	gg
 << 8è| (
HashNumb”s
(
k
, 
g
) & 0xff));

169 
boŞ
 
IsV®idKey
(
Key
 
k
) {

170  
hash
(
k
è=ğ(
HashNumb”s
(
key
(k), 
g’
(k)) & 0xff);

173 
Key
 
RªdomT¬g‘
(
Rªdom
* 
ºd
) {

174 
	gºd
->
Next
() % 10) {

177  
MakeKey
(0, 0);

180  
MakeKey
(
K
, 0);

183  
MakeKey
(
ºd
->
Next
(è% 
K
, 0);

188 
	sS‹
 {

189 
	gpÜt
::
AtomicPoš‹r
 
g’”©iÚ
[
K
];

190 
S‘
(
k
, 
šŒ_t
 
v
) {

191 
	gg’”©iÚ
[
k
].
R–—£_StÜe
(
»š‹½»t_ÿ¡
<*>(
v
));

193 
šŒ_t
 
G‘
(
k
) {

194  
	g»š‹½»t_ÿ¡
<
	gšŒ_t
>(
	gg’”©iÚ
[
k
].
Acquœe_Lßd
());

197 
S‹
() {

198 
	gk
 = 0; k < 
	gK
; k++) {

199 
S‘
(
k
, 0);

205 
S‹
 
	gcu¼’t_
;

207 
A»Ç
 
	g¬’a_
;

211 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
> 
	gli¡_
;

213 
	gpublic
:

214 
CÚcu¼’tTe¡
(è: 
li¡_
(
Com·¿tÜ
(), &
¬’a_
) { }

217 
Wr™eS‹p
(
Rªdom
* 
ºd
) {

218 cÚ¡ 
ušt32_t
 
	gk
 = 
ºd
->
Next
(è% 
K
;

219 cÚ¡ 
šŒ_t
 
	gg
 = 
cu¼’t_
.
G‘
(
k
) + 1;

220 cÚ¡ 
Key
 
	gkey
 = 
MakeKey
(
k
, 
g
);

221 
	gli¡_
.
In£¹
(
key
);

222 
	gcu¼’t_
.
S‘
(
k
, 
g
);

225 
R—dS‹p
(
Rªdom
* 
ºd
) {

227 
S‹
 
	gš™Ÿl_¡©e
;

228 
	gk
 = 0; k < 
	gK
; k++) {

229 
	gš™Ÿl_¡©e
.
S‘
(
k
, 
cu¼’t_
.
G‘
(k));

232 
Key
 
	gpos
 = 
RªdomT¬g‘
(
ºd
);

233 
	gSkLi¡
<
	gKey
, 
	gCom·¿tÜ
>::
I‹¿tÜ
 
™”
(&
li¡_
);

234 
	g™”
.
S“k
(
pos
);

235 
	gŒue
) {

236 
Key
 
	gcu¼’t
;

237 ià(!
	g™”
.
V®id
()) {

238 
	gcu¼’t
 = 
MakeKey
(
K
, 0);

240 
	gcu¼’t
 = 
™”
.
key
();

241 
ASSERT_TRUE
(
IsV®idKey
(
cu¼’t
)è<< 
	g¡d
::
hex
 << current;

243 
ASSERT_LE
(
pos
, 
cu¼’t
) << "should‚ot go backwards";

247 
	gpos
 < 
	gcu¼’t
) {

248 
ASSERT_LT
(
key
(
pos
), 
K
è<< 
	g¡d
::
hex
 <<…os;

252 
ASSERT_TRUE
((
g’
(
pos
) == 0) ||

253 (
g’
(
pos
è> 
š™Ÿl_¡©e
.
G‘
(
key
(pos)))

254 è<< "key: " << 
key
(
pos
)

255 << "; g’: " << 
g’
(
pos
)

257 << 
š™Ÿl_¡©e
.
G‘
(
key
(
pos
));

260 ià(
key
(
pos
è< key(
cu¼’t
)) {

261 
	gpos
 = 
MakeKey
(
key
(
pos
) + 1, 0);

263 
	gpos
 = 
MakeKey
(
key
(
pos
), 
g’
(pos) + 1);

267 ià(!
	g™”
.
V®id
()) {

271 ià(
	gºd
->
Next
() % 2) {

272 
	g™”
.
Next
();

273 
	gpos
 = 
MakeKey
(
key
(
pos
), 
g’
(pos) + 1);

275 
Key
 
	gÃw_rg‘
 = 
RªdomT¬g‘
(
ºd
);

276 ià(
	gÃw_rg‘
 > 
	gpos
) {

277 
	gpos
 = 
Ãw_rg‘
;

278 
	g™”
.
S“k
(
Ãw_rg‘
);

284 cÚ¡ 
ušt32_t
 
	gCÚcu¼’tTe¡
::
K
;

288 
	$TEST
(
SkTe¡
, 
CÚcu¼’tW™houtTh»ads
) {

289 
CÚcu¼’tTe¡
 
‹¡
;

290 
Rªdom
 
	`ºd
(
‹¡
::
	`RªdomS“d
());

291 
i
 = 0; i < 10000; i++) {

292 
‹¡
.
	`R—dS‹p
(&
ºd
);

293 
‹¡
.
	`Wr™eS‹p
(&
ºd
);

295 
	}
}

297 şas 
	cTe¡S‹
 {

298 
	gpublic
:

299 
CÚcu¼’tTe¡
 
t_
;

300 
	g£ed_
;

301 
	gpÜt
::
AtomicPoš‹r
 
qu™_æag_
;

303 
	eR—d”S‹
 {

304 
	gSTARTING
,

305 
	gRUNNING
,

306 
	gDONE


309 
ex¶ic™
 
Te¡S‹
(
s
)

310 : 
£ed_
(
s
),

311 
qu™_æag_
(
NULL
),

312 
¡©e_
(
STARTING
),

313 
¡©e_cv_
(&
mu_
) {}

315 
Wa™
(
R—d”S‹
 
s
) {

316 
	gmu_
.
Lock
();

317 
	g¡©e_
 !ğ
s
) {

318 
¡©e_cv_
.
Wa™
();

320 
	gmu_
.
UÆock
();

323 
Chªge
(
R—d”S‹
 
s
) {

324 
	gmu_
.
Lock
();

325 
	g¡©e_
 = 
s
;

326 
	g¡©e_cv_
.
SigÇl
();

327 
	gmu_
.
UÆock
();

330 
	g´iv©e
:

331 
pÜt
::
Mu‹x
 
mu_
;

332 
R—d”S‹
 
	g¡©e_
;

333 
	gpÜt
::
CÚdV¬
 
¡©e_cv_
;

336 
	$CÚcu¼’tR—d”
(* 
¬g
) {

337 
Te¡S‹
* 
¡©e
 = 
»š‹½»t_ÿ¡
<Te¡S‹*>(
¬g
);

338 
Rªdom
 
	`ºd
(
¡©e
->
£ed_
);

339 
št64_t
 
»ads
 = 0;

340 
¡©e
->
	`Chªge
(
Te¡S‹
::
RUNNING
);

341 !
¡©e
->
qu™_æag_
.
	`Acquœe_Lßd
()) {

342 
¡©e
->
t_
.
	`R—dS‹p
(&
ºd
);

343 ++
»ads
;

345 
¡©e
->
	`Chªge
(
Te¡S‹
::
DONE
);

346 
	}
}

348 
	$RunCÚcu¼’t
(
run
) {

349 cÚ¡ 
£ed
 = 
‹¡
::
	`RªdomS“d
(è+ (
run
 * 100);

350 
Rªdom
 
	`ºd
(
£ed
);

351 cÚ¡ 
N
 = 1000;

352 cÚ¡ 
kSize
 = 1000;

353 
i
 = 0; i < 
N
; i++) {

354 ià((
i
 % 100) == 0) {

355 
	`årštf
(
¡d”r
, "RuÀ%d oà%d\n", 
i
, 
N
);

357 
Te¡S‹
 
	`¡©e
(
£ed
 + 1);

358 
Env
::
	`DeçuÉ
()->
	`ScheduË
(
CÚcu¼’tR—d”
, &
¡©e
);

359 
¡©e
.
	`Wa™
(
Te¡S‹
::
RUNNING
);

360 
i
 = 0; i < 
kSize
; i++) {

361 
¡©e
.
t_
.
	`Wr™eS‹p
(&
ºd
);

363 
¡©e
.
qu™_æag_
.
	`R–—£_StÜe
(&state);

364 
¡©e
.
	`Wa™
(
Te¡S‹
::
DONE
);

366 
	}
}

368 
	$TEST
(
SkTe¡
, 
CÚcu¼’t1
è{ 
	`RunCÚcu¼’t
(1); 
	}
}

369 
	$TEST
(
SkTe¡
, 
CÚcu¼’t2
è{ 
	`RunCÚcu¼’t
(2); 
	}
}

370 
	$TEST
(
SkTe¡
, 
CÚcu¼’t3
è{ 
	`RunCÚcu¼’t
(3); 
	}
}

371 
	$TEST
(
SkTe¡
, 
CÚcu¼’t4
è{ 
	`RunCÚcu¼’t
(4); 
	}
}

372 
	$TEST
(
SkTe¡
, 
CÚcu¼’t5
è{ 
	`RunCÚcu¼’t
(5); 
	}
}

376 
	$maš
(
¬gc
, ** 
¬gv
) {

377  
Ëv–db
::
‹¡
::
	`RunAÎTe¡s
();

378 
	}
}

	@db/snapshot.h

5 #iâdeà
STORAGE_LEVELDB_DB_SNAPSHOT_H_


6 
	#STORAGE_LEVELDB_DB_SNAPSHOT_H_


	)

8 
	~"Ëv–db/db.h
"

10 
Çme¥aû
 
	gËv–db
 {

12 
şass
 
	gSÇpshÙLi¡
;

16 şas 
	cSÇpshÙ
 {

17 
	gpublic
:

18 
Sequ’ûNumb”
 
numb”_
;

20 
	g´iv©e
:

21 
ä›nd
 
şass
 
SÇpshÙLi¡
;

24 
SÇpshÙ
* 
	g´ev_
;

25 
SÇpshÙ
* 
	gÃxt_
;

27 
SÇpshÙLi¡
* 
	gli¡_
;

30 şas 
	cSÇpshÙLi¡
 {

31 
	gpublic
:

32 
SÇpshÙLi¡
() {

33 
li¡_
.
´ev_
 = &list_;

34 
	gli¡_
.
	gÃxt_
 = &
li¡_
;

37 
boŞ
 
em±y
(ècÚ¡ {  
	gli¡_
.
	gÃxt_
 =ğ&
li¡_
; }

38 
SÇpshÙ
* 
Şde¡
(ècÚ¡ { 
as£¹
(!
em±y
());  
	gli¡_
.
	gÃxt_
; }

39 
SÇpshÙ
* 
Ãwe¡
(ècÚ¡ { 
as£¹
(!
em±y
());  
	gli¡_
.
	g´ev_
; }

41 cÚ¡ 
SÇpshÙ
* 
New
(
Sequ’ûNumb”
 
£q
) {

42 
SÇpshÙ
* 
	gs
 = 
Ãw
 Snapshot;

43 
	gs
->
	gnumb”_
 = 
£q
;

44 
	gs
->
	gli¡_
 = 
this
;

45 
	gs
->
	gÃxt_
 = &
li¡_
;

46 
	gs
->
	g´ev_
 = 
li¡_
.
´ev_
;

47 
	gs
->
	g´ev_
->
	gÃxt_
 = 
s
;

48 
	gs
->
	gÃxt_
->
	g´ev_
 = 
s
;

49  
	gs
;

52 
D–‘e
(cÚ¡ 
SÇpshÙ
* 
s
) {

53 
as£¹
(
s
->
li¡_
 =ğ
this
);

54 
	gs
->
	g´ev_
->
	gÃxt_
 = 
s
->
Ãxt_
;

55 
	gs
->
	gÃxt_
->
	g´ev_
 = 
s
->
´ev_
;

56 
d–‘e
 
	gs
;

59 
	g´iv©e
:

61 
SÇpshÙ
 
li¡_
;

	@db/table_cache.cc

5 
	~"db/bË_ÿche.h
"

7 
	~"db/f’ame.h
"

8 
	~"Ëv–db/’v.h
"

9 
	~"Ëv–db/bË.h
"

10 
	~"ut/codšg.h
"

12 
Çme¥aû
 
	gËv–db
 {

14 
	sTabËAndFe
 {

15 
RªdomAcûssFe
* 
	gfe
;

16 
TabË
* 
	gbË
;

19 
D–‘eEÁry
(cÚ¡ 
Sliû
& 
key
, * 
v®ue
) {

20 
TabËAndFe
* 
	gtf
 = 
»š‹½»t_ÿ¡
<TabËAndFe*>(
v®ue
);

21 
d–‘e
 
	gtf
->
	gbË
;

22 
d–‘e
 
	gtf
->
	gfe
;

23 
d–‘e
 
	gtf
;

26 
UÄefEÁry
(* 
¬g1
, * 
¬g2
) {

27 
Cache
* 
	gÿche
 = 
»š‹½»t_ÿ¡
<Cache*>(
¬g1
);

28 
	gCache
::
HªdË
* 
h
 = 
»š‹½»t_ÿ¡
<
Cache
::HªdË*>(
¬g2
);

29 
	gÿche
->
R–—£
(
h
);

32 
	gTabËCache
::
TabËCache
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
,

33 cÚ¡ 
O±iÚs
* 
İtiÚs
,

34 
’Œ›s
)

35 : 
’v_
(
İtiÚs
->
’v
),

36 
dbÇme_
(
dbÇme
),

37 
İtiÚs_
(
İtiÚs
),

38 
ÿche_
(
NewLRUCache
(
’Œ›s
)) {

41 
	gTabËCache
::~
TabËCache
() {

42 
d–‘e
 
ÿche_
;

45 
I‹¿tÜ
* 
	gTabËCache
::
NewI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
,

46 
ušt64_t
 
fe_numb”
,

47 
ušt64_t
 
fe_size
,

48 
TabË
** 
bË±r
) {

49 ià(
	gbË±r
 !ğ
NULL
) {

50 *
bË±r
 = 
NULL
;

53 
	gbuf
[(
fe_numb”
)];

54 
EncodeFixed64
(
buf
, 
fe_numb”
);

55 
Sliû
 
key
(
buf
, (buf));

56 
	gCache
::
HªdË
* 
hªdË
 = 
ÿche_
->
Lookup
(
key
);

57 ià(
	ghªdË
 =ğ
NULL
) {

58 
¡d
::
¡ršg
 
âame
 = 
TabËFeName
(
dbÇme_
, 
fe_numb”
);

59 
RªdomAcûssFe
* 
	gfe
 = 
NULL
;

60 
TabË
* 
	gbË
 = 
NULL
;

61 
Stus
 
	gs
 = 
’v_
->
NewRªdomAcûssFe
(
âame
, &
fe
);

62 ià(
	gs
.
ok
()) {

63 
	gs
 = 
TabË
::
O³n
(*
İtiÚs_
, 
fe
, 
fe_size
, &
bË
);

66 ià(!
	gs
.
ok
()) {

67 
as£¹
(
bË
 =ğ
NULL
);

68 
d–‘e
 
	gfe
;

71  
NewE¼ÜI‹¿tÜ
(
s
);

74 
TabËAndFe
* 
	gtf
 = 
Ãw
 TableAndFile;

75 
	gtf
->
	gfe
 = 
fe
;

76 
	gtf
->
	gbË
 = 
bË
;

77 
	ghªdË
 = 
ÿche_
->
In£¹
(
key
, 
tf
, 1, &
D–‘eEÁry
);

80 
TabË
* 
	gbË
 = 
»š‹½»t_ÿ¡
<
TabËAndFe
*>(
ÿche_
->
V®ue
(
hªdË
))->
bË
;

81 
I‹¿tÜ
* 
	g»suÉ
 = 
bË
->
NewI‹¿tÜ
(
İtiÚs
);

82 
	g»suÉ
->
Regi¡”CËªup
(&
UÄefEÁry
, 
ÿche_
, 
hªdË
);

83 ià(
	gbË±r
 !ğ
NULL
) {

84 *
bË±r
 = 
bË
;

86  
	g»suÉ
;

89 
	gTabËCache
::
Eviù
(
ušt64_t
 
fe_numb”
) {

90 
buf
[(
fe_numb”
)];

91 
EncodeFixed64
(
buf
, 
fe_numb”
);

92 
	gÿche_
->
E¿£
(
Sliû
(
buf
, (buf)));

	@db/table_cache.h

7 #iâdeà
STORAGE_LEVELDB_DB_TABLE_CACHE_H_


8 
	#STORAGE_LEVELDB_DB_TABLE_CACHE_H_


	)

10 
	~<¡ršg
>

11 
	~<¡dšt.h
>

12 
	~"db/dbfÜm©.h
"

13 
	~"Ëv–db/ÿche.h
"

14 
	~"Ëv–db/bË.h
"

15 
	~"pÜt/pÜt.h
"

17 
Çme¥aû
 
	gËv–db
 {

19 
şass
 
	gEnv
;

21 şas 
	cTabËCache
 {

22 
	gpublic
:

23 
TabËCache
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
, cÚ¡ 
O±iÚs
* 
İtiÚs
, 
’Œ›s
);

24 ~
TabËCache
();

33 
I‹¿tÜ
* 
NewI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
,

34 
ušt64_t
 
fe_numb”
,

35 
ušt64_t
 
fe_size
,

36 
TabË
** 
bË±r
 = 
NULL
);

39 
Eviù
(
ušt64_t
 
fe_numb”
);

41 
	g´iv©e
:

42 
Env
* cÚ¡ 
’v_
;

43 cÚ¡ 
	g¡d
::
¡ršg
 
dbÇme_
;

44 cÚ¡ 
O±iÚs
* 
	gİtiÚs_
;

45 
Cache
* 
	gÿche_
;

	@db/version_edit.cc

5 
	~"db/v”siÚ_ed™.h
"

7 
	~"db/v”siÚ_£t.h
"

8 
	~"ut/codšg.h
"

10 
Çme¥aû
 
	gËv–db
 {

14 
	eTag
 {

15 
	gkCom·¿tÜ
 = 1,

16 
	gkLogNumb”
 = 2,

17 
	gkNextFeNumb”
 = 3,

18 
	gkLa¡Sequ’û
 = 4,

19 
	gkCom·ùPoš‹r
 = 5,

20 
	gkD–‘edFe
 = 6,

21 
	gkNewFe
 = 7,

23 
	gkP»vLogNumb”
 = 9,

26 
	gV”siÚEd™
::
CË¬
() {

27 
com·¿tÜ_
.
ş—r
();

28 
	glog_numb”_
 = 0;

29 
	g´ev_log_numb”_
 = 0;

30 
	gÏ¡_£qu’û_
 = 0;

31 
	gÃxt_fe_numb”_
 = 0;

32 
	ghas_com·¿tÜ_
 = 
çl£
;

33 
	ghas_log_numb”_
 = 
çl£
;

34 
	ghas_´ev_log_numb”_
 = 
çl£
;

35 
	ghas_Ãxt_fe_numb”_
 = 
çl£
;

36 
	ghas_Ï¡_£qu’û_
 = 
çl£
;

37 
	gd–‘ed_fes_
.
ş—r
();

38 
	gÃw_fes_
.
ş—r
();

41 
	gV”siÚEd™
::
EncodeTo
(
¡d
::
¡ršg
* 
d¡
) const {

42 ià(
has_com·¿tÜ_
) {

43 
PutV¬št32
(
d¡
, 
kCom·¿tÜ
);

44 
PutL’gthP»fixedSliû
(
d¡
, 
com·¿tÜ_
);

46 ià(
	ghas_log_numb”_
) {

47 
PutV¬št32
(
d¡
, 
kLogNumb”
);

48 
PutV¬št64
(
d¡
, 
log_numb”_
);

50 ià(
	ghas_´ev_log_numb”_
) {

51 
PutV¬št32
(
d¡
, 
kP»vLogNumb”
);

52 
PutV¬št64
(
d¡
, 
´ev_log_numb”_
);

54 ià(
	ghas_Ãxt_fe_numb”_
) {

55 
PutV¬št32
(
d¡
, 
kNextFeNumb”
);

56 
PutV¬št64
(
d¡
, 
Ãxt_fe_numb”_
);

58 ià(
	ghas_Ï¡_£qu’û_
) {

59 
PutV¬št32
(
d¡
, 
kLa¡Sequ’û
);

60 
PutV¬št64
(
d¡
, 
Ï¡_£qu’û_
);

63 
size_t
 
	gi
 = 0; i < 
	gcom·ù_poš‹rs_
.
size
(); i++) {

64 
PutV¬št32
(
d¡
, 
kCom·ùPoš‹r
);

65 
PutV¬št32
(
d¡
, 
com·ù_poš‹rs_
[
i
].
fœ¡
);

66 
PutL’gthP»fixedSliû
(
d¡
, 
com·ù_poš‹rs_
[
i
].
£cÚd
.
Encode
());

69 
	gD–‘edFeS‘
::
cÚ¡_™”©Ü
 
™”
 = 
d–‘ed_fes_
.
begš
();

70 
	g™”
 !ğ
d–‘ed_fes_
.
’d
();

71 ++
	g™”
) {

72 
PutV¬št32
(
d¡
, 
kD–‘edFe
);

73 
PutV¬št32
(
d¡
, 
™”
->
fœ¡
);

74 
PutV¬št64
(
d¡
, 
™”
->
£cÚd
);

77 
size_t
 
	gi
 = 0; i < 
	gÃw_fes_
.
size
(); i++) {

78 cÚ¡ 
	gFeM‘aD©a
& 
	gf
 = 
Ãw_fes_
[
i
].
£cÚd
;

79 
PutV¬št32
(
d¡
, 
kNewFe
);

80 
PutV¬št32
(
d¡
, 
Ãw_fes_
[
i
].
fœ¡
);

81 
PutV¬št64
(
d¡
, 
f
.
numb”
);

82 
PutV¬št64
(
d¡
, 
f
.
fe_size
);

83 
PutL’gthP»fixedSliû
(
d¡
, 
f
.
sm®Ë¡
.
Encode
());

84 
PutL’gthP»fixedSliû
(
d¡
, 
f
.
Ïrge¡
.
Encode
());

88 
boŞ
 
G‘IÁ”ÇlKey
(
Sliû
* 
šput
, 
IÁ”ÇlKey
* 
d¡
) {

89 
Sliû
 
	g¡r
;

90 ià(
G‘L’gthP»fixedSliû
(
šput
, &
¡r
)) {

91 
	gd¡
->
DecodeFrom
(
¡r
);

92  
	gŒue
;

94  
	gçl£
;

98 
boŞ
 
G‘Lev–
(
Sliû
* 
šput
, * 
Ëv–
) {

99 
ušt32_t
 
	gv
;

100 ià(
G‘V¬št32
(
šput
, &
v
) &&

101 
	gv
 < 
	gcÚfig
::
kNumLev–s
) {

102 *
Ëv–
 = 
v
;

103  
	gŒue
;

105  
	gçl£
;

109 
Stus
 
	gV”siÚEd™
::
DecodeFrom
(cÚ¡ 
Sliû
& 
¤c
) {

110 
CË¬
();

111 
Sliû
 
	gšput
 = 
¤c
;

112 cÚ¡ * 
	gmsg
 = 
NULL
;

113 
ušt32_t
 
	gg
;

116 
	gËv–
;

117 
ušt64_t
 
	gnumb”
;

118 
FeM‘aD©a
 
	gf
;

119 
Sliû
 
	g¡r
;

120 
IÁ”ÇlKey
 
	gkey
;

122 
	gmsg
 =ğ
NULL
 && 
G‘V¬št32
(&
šput
, &
g
)) {

123 
	gg
) {

124 
	gkCom·¿tÜ
:

125 ià(
G‘L’gthP»fixedSliû
(&
šput
, &
¡r
)) {

126 
	gcom·¿tÜ_
 = 
¡r
.
ToSŒšg
();

127 
	ghas_com·¿tÜ_
 = 
Œue
;

129 
	gmsg
 = "comparator‚ame";

133 
	gkLogNumb”
:

134 ià(
G‘V¬št64
(&
šput
, &
log_numb”_
)) {

135 
	ghas_log_numb”_
 = 
Œue
;

137 
	gmsg
 = "log‚umber";

141 
	gkP»vLogNumb”
:

142 ià(
G‘V¬št64
(&
šput
, &
´ev_log_numb”_
)) {

143 
	ghas_´ev_log_numb”_
 = 
Œue
;

145 
	gmsg
 = "previous†og‚umber";

149 
	gkNextFeNumb”
:

150 ià(
G‘V¬št64
(&
šput
, &
Ãxt_fe_numb”_
)) {

151 
	ghas_Ãxt_fe_numb”_
 = 
Œue
;

153 
	gmsg
 = "next file‚umber";

157 
	gkLa¡Sequ’û
:

158 ià(
G‘V¬št64
(&
šput
, &
Ï¡_£qu’û_
)) {

159 
	ghas_Ï¡_£qu’û_
 = 
Œue
;

161 
	gmsg
 = "last sequence‚umber";

165 
	gkCom·ùPoš‹r
:

166 ià(
G‘Lev–
(&
šput
, &
Ëv–
) &&

167 
G‘IÁ”ÇlKey
(&
šput
, &
key
)) {

168 
	gcom·ù_poš‹rs_
.
push_back
(
¡d
::
make_·œ
(
Ëv–
, 
key
));

170 
	gmsg
 = "compaction…ointer";

174 
	gkD–‘edFe
:

175 ià(
G‘Lev–
(&
šput
, &
Ëv–
) &&

176 
G‘V¬št64
(&
šput
, &
numb”
)) {

177 
	gd–‘ed_fes_
.
š£¹
(
¡d
::
make_·œ
(
Ëv–
, 
numb”
));

179 
	gmsg
 = "deleted file";

183 
	gkNewFe
:

184 ià(
G‘Lev–
(&
šput
, &
Ëv–
) &&

185 
G‘V¬št64
(&
šput
, &
f
.
numb”
) &&

186 
G‘V¬št64
(&
šput
, &
f
.
fe_size
) &&

187 
G‘IÁ”ÇlKey
(&
šput
, &
f
.
sm®Ë¡
) &&

188 
G‘IÁ”ÇlKey
(&
šput
, &
f
.
Ïrge¡
)) {

189 
	gÃw_fes_
.
push_back
(
¡d
::
make_·œ
(
Ëv–
, 
f
));

191 
	gmsg
 = "new-fileƒntry";

196 
msg
 = "unknownag";

201 ià(
	gmsg
 =ğ
NULL
 && !
šput
.
em±y
()) {

202 
msg
 = "invalidag";

205 
Stus
 
	g»suÉ
;

206 ià(
	gmsg
 !ğ
NULL
) {

207 
»suÉ
 = 
Stus
::
CÜru±iÚ
("V”siÚEd™", 
msg
);

209  
	g»suÉ
;

212 
	g¡d
::
¡ršg
 
V”siÚEd™
::
DebugSŒšg
() const {

213 
¡d
::
¡ršg
 
r
;

214 
	gr
.
­³nd
("VersionEdit {");

215 ià(
	ghas_com·¿tÜ_
) {

216 
	gr
.
­³nd
("\n Comparator: ");

217 
	gr
.
­³nd
(
com·¿tÜ_
);

219 ià(
	ghas_log_numb”_
) {

220 
	gr
.
­³nd
("\n LogNumber: ");

221 
Aµ’dNumb”To
(&
r
, 
log_numb”_
);

223 ià(
	ghas_´ev_log_numb”_
) {

224 
	gr
.
­³nd
("\n PrevLogNumber: ");

225 
Aµ’dNumb”To
(&
r
, 
´ev_log_numb”_
);

227 ià(
	ghas_Ãxt_fe_numb”_
) {

228 
	gr
.
­³nd
("\n NextFile: ");

229 
Aµ’dNumb”To
(&
r
, 
Ãxt_fe_numb”_
);

231 ià(
	ghas_Ï¡_£qu’û_
) {

232 
	gr
.
­³nd
("\n LastSeq: ");

233 
Aµ’dNumb”To
(&
r
, 
Ï¡_£qu’û_
);

235 
size_t
 
	gi
 = 0; i < 
	gcom·ù_poš‹rs_
.
size
(); i++) {

236 
	gr
.
­³nd
("\n CompactPointer: ");

237 
Aµ’dNumb”To
(&
r
, 
com·ù_poš‹rs_
[
i
].
fœ¡
);

238 
	gr
.
­³nd
(" '");

239 
Aµ’dEsÿ³dSŒšgTo
(&
r
, 
com·ù_poš‹rs_
[
i
].
£cÚd
.
Encode
());

240 
	gr
.
­³nd
("'");

242 
	gD–‘edFeS‘
::
cÚ¡_™”©Ü
 
™”
 = 
d–‘ed_fes_
.
begš
();

243 
	g™”
 !ğ
d–‘ed_fes_
.
’d
();

244 ++
	g™”
) {

245 
	gr
.
­³nd
("\n DeleteFile: ");

246 
Aµ’dNumb”To
(&
r
, 
™”
->
fœ¡
);

247 
	gr
.
­³nd
(" ");

248 
Aµ’dNumb”To
(&
r
, 
™”
->
£cÚd
);

250 
size_t
 
	gi
 = 0; i < 
	gÃw_fes_
.
size
(); i++) {

251 cÚ¡ 
	gFeM‘aD©a
& 
	gf
 = 
Ãw_fes_
[
i
].
£cÚd
;

252 
	gr
.
­³nd
("\n AddFile: ");

253 
Aµ’dNumb”To
(&
r
, 
Ãw_fes_
[
i
].
fœ¡
);

254 
	gr
.
­³nd
(" ");

255 
Aµ’dNumb”To
(&
r
, 
f
.
numb”
);

256 
	gr
.
­³nd
(" ");

257 
Aµ’dNumb”To
(&
r
, 
f
.
fe_size
);

258 
	gr
.
­³nd
(" '");

259 
Aµ’dEsÿ³dSŒšgTo
(&
r
, 
f
.
sm®Ë¡
.
Encode
());

260 
	gr
.
­³nd
("' .. '");

261 
Aµ’dEsÿ³dSŒšgTo
(&
r
, 
f
.
Ïrge¡
.
Encode
());

262 
	gr
.
­³nd
("'");

264 
	gr
.
­³nd
("\n}\n");

265  
	gr
;

	@db/version_edit.h

5 #iâdeà
STORAGE_LEVELDB_DB_VERSION_EDIT_H_


6 
	#STORAGE_LEVELDB_DB_VERSION_EDIT_H_


	)

8 
	~<£t
>

9 
	~<ut™y
>

10 
	~<veùÜ
>

11 
	~"db/dbfÜm©.h
"

13 
Çme¥aû
 
	gËv–db
 {

15 
şass
 
	gV”siÚS‘
;

17 
	sFeM‘aD©a
 {

18 
	g»fs
;

19 
ušt64_t
 
	gnumb”
;

20 
ušt64_t
 
	gfe_size
;

21 
IÁ”ÇlKey
 
	gsm®Ë¡
;

22 
IÁ”ÇlKey
 
	gÏrge¡
;

24 
FeM‘aD©a
(è: 
»fs
(0), 
fe_size
(0) { }

27 şas 
	cV”siÚEd™
 {

28 
	gpublic
:

29 
V”siÚEd™
(è{ 
CË¬
(); }

30 ~
V”siÚEd™
() { }

32 
CË¬
();

34 
S‘Com·¿tÜName
(cÚ¡ 
Sliû
& 
Çme
) {

35 
	ghas_com·¿tÜ_
 = 
Œue
;

36 
	gcom·¿tÜ_
 = 
Çme
.
ToSŒšg
();

38 
S‘LogNumb”
(
ušt64_t
 
num
) {

39 
	ghas_log_numb”_
 = 
Œue
;

40 
	glog_numb”_
 = 
num
;

42 
S‘P»vLogNumb”
(
ušt64_t
 
num
) {

43 
	ghas_´ev_log_numb”_
 = 
Œue
;

44 
	g´ev_log_numb”_
 = 
num
;

46 
S‘NextFe
(
ušt64_t
 
num
) {

47 
	ghas_Ãxt_fe_numb”_
 = 
Œue
;

48 
	gÃxt_fe_numb”_
 = 
num
;

50 
S‘La¡Sequ’û
(
Sequ’ûNumb”
 
£q
) {

51 
	ghas_Ï¡_£qu’û_
 = 
Œue
;

52 
	gÏ¡_£qu’û_
 = 
£q
;

54 
S‘Com·ùPoš‹r
(
Ëv–
, cÚ¡ 
IÁ”ÇlKey
& 
key
) {

55 
	gcom·ù_poš‹rs_
.
push_back
(
¡d
::
make_·œ
(
Ëv–
, 
key
));

61 
AddFe
(
Ëv–
, 
ušt64_t
 
fe
,

62 
ušt64_t
 
fe_size
,

63 cÚ¡ 
IÁ”ÇlKey
& 
sm®Ë¡
,

64 cÚ¡ 
IÁ”ÇlKey
& 
Ïrge¡
) {

65 
FeM‘aD©a
 
	gf
;

66 
	gf
.
	gnumb”
 = 
fe
;

67 
	gf
.
	gfe_size
 = 
fe_size
;

68 
	gf
.
	gsm®Ë¡
 = 
sm®Ë¡
;

69 
	gf
.
	gÏrge¡
 = 
Ïrge¡
;

70 
	gÃw_fes_
.
push_back
(
¡d
::
make_·œ
(
Ëv–
, 
f
));

74 
D–‘eFe
(
Ëv–
, 
ušt64_t
 
fe
) {

75 
	gd–‘ed_fes_
.
š£¹
(
¡d
::
make_·œ
(
Ëv–
, 
fe
));

78 
EncodeTo
(
¡d
::
¡ršg
* 
d¡
) const;

79 
Stus
 
DecodeFrom
(cÚ¡ 
Sliû
& 
¤c
);

81 
	g¡d
::
¡ršg
 
DebugSŒšg
() const;

83 
	g´iv©e
:

84 
ä›nd
 
şass
 
V”siÚS‘
;

86 
	g¡d
::
	t£t
< 
	t¡d
::
	t·œ
<, 
	tušt64_t
> > 
	tD–‘edFeS‘
;

88 
	g¡d
::
¡ršg
 
com·¿tÜ_
;

89 
ušt64_t
 
	glog_numb”_
;

90 
ušt64_t
 
	g´ev_log_numb”_
;

91 
ušt64_t
 
	gÃxt_fe_numb”_
;

92 
Sequ’ûNumb”
 
	gÏ¡_£qu’û_
;

93 
boŞ
 
	ghas_com·¿tÜ_
;

94 
boŞ
 
	ghas_log_numb”_
;

95 
boŞ
 
	ghas_´ev_log_numb”_
;

96 
boŞ
 
	ghas_Ãxt_fe_numb”_
;

97 
boŞ
 
	ghas_Ï¡_£qu’û_
;

99 
	g¡d
::
veùÜ
< 
¡d
::
·œ
<, 
	gIÁ”ÇlKey
> > 
	gcom·ù_poš‹rs_
;

100 
D–‘edFeS‘
 
	gd–‘ed_fes_
;

101 
	g¡d
::
veùÜ
< 
¡d
::
·œ
<, 
	gFeM‘aD©a
> > 
	gÃw_fes_
;

	@db/version_edit_test.cc

5 
	~"db/v”siÚ_ed™.h
"

6 
	~"ut/‹¡h¬Ãss.h
"

8 
Çme¥aû
 
	gËv–db
 {

10 
Te¡EncodeDecode
(cÚ¡ 
V”siÚEd™
& 
ed™
) {

11 
	g¡d
::
¡ršg
 
’coded
, 
	g’coded2
;

12 
	ged™
.
EncodeTo
(&
’coded
);

13 
V”siÚEd™
 
	g·r£d
;

14 
Stus
 
	gs
 = 
·r£d
.
DecodeFrom
(
’coded
);

15 
ASSERT_TRUE
(
s
.
ok
()è<< 
	gs
.
ToSŒšg
();

16 
	g·r£d
.
EncodeTo
(&
’coded2
);

17 
ASSERT_EQ
(
’coded
, 
’coded2
);

20 şas 
	cV”siÚEd™Te¡
 { };

22 
	$TEST
(
V”siÚEd™Te¡
, 
EncodeDecode
) {

23 cÚ¡ 
ušt64_t
 
kBig
 = 1ull << 50;

25 
V”siÚEd™
 
ed™
;

26 
i
 = 0; i < 4; i++) {

27 
	`Te¡EncodeDecode
(
ed™
);

28 
ed™
.
	`AddFe
(3, 
kBig
 + 300 + 
i
, kBig + 400 + i,

29 
	`IÁ”ÇlKey
("foo", 
kBig
 + 500 + 
i
, 
kTy³V®ue
),

30 
	`IÁ”ÇlKey
("zoo", 
kBig
 + 600 + 
i
, 
kTy³D–‘iÚ
));

31 
ed™
.
	`D–‘eFe
(4, 
kBig
 + 700 + 
i
);

32 
ed™
.
	`S‘Com·ùPoš‹r
(
i
, 
	`IÁ”ÇlKey
("x", 
kBig
 + 900 + i, 
kTy³V®ue
));

35 
ed™
.
	`S‘Com·¿tÜName
("foo");

36 
ed™
.
	`S‘LogNumb”
(
kBig
 + 100);

37 
ed™
.
	`S‘NextFe
(
kBig
 + 200);

38 
ed™
.
	`S‘La¡Sequ’û
(
kBig
 + 1000);

39 
	`Te¡EncodeDecode
(
ed™
);

40 
	}
}

44 
	$maš
(
¬gc
, ** 
¬gv
) {

45  
Ëv–db
::
‹¡
::
	`RunAÎTe¡s
();

46 
	}
}

	@db/version_set.cc

5 
	~"db/v”siÚ_£t.h
"

7 
	~<®gÜ™hm
>

8 
	~<¡dio.h
>

9 
	~"db/f’ame.h
"

10 
	~"db/log_»ad”.h
"

11 
	~"db/log_wr™”.h
"

12 
	~"db/membË.h
"

13 
	~"db/bË_ÿche.h
"

14 
	~"Ëv–db/’v.h
"

15 
	~"Ëv–db/bË_bud”.h
"

16 
	~"bË/m”g”.h
"

17 
	~"bË/two_Ëv–_™”©Ü.h
"

18 
	~"ut/codšg.h
"

19 
	~"ut/loggšg.h
"

21 
Çme¥aû
 
	gËv–db
 {

23 cÚ¡ 
	gkT¬g‘FeSize
 = 2 * 1048576;

27 cÚ¡ 
št64_t
 
	gkMaxG¿ndP¬’tOv”ÏpBy‹s
 = 10 * 
kT¬g‘FeSize
;

29 
MaxBy‹sFÜLev–
(
Ëv–
) {

32 
	g»suÉ
 = 10 * 1048576.0;

33 
	gËv–
 > 1) {

34 
	g»suÉ
 *= 10;

35 
	gËv–
--;

37  
	g»suÉ
;

40 
ušt64_t
 
MaxFeSizeFÜLev–
(
Ëv–
) {

41  
	gkT¬g‘FeSize
;

44 
	gÇme¥aû
 {

45 
	g¡d
::
¡ršg
 
IÁS‘ToSŒšg
(cÚ¡ 
¡d
::
£t
<
ušt64_t
>& 
s
) {

46 
¡d
::
¡ršg
 
»suÉ
 = "{";

47 
	g¡d
::
£t
<
ušt64_t
>::
cÚ¡_™”©Ü
 
™
 = 
s
.
begš
();

48 
	g™
 !ğ
s
.
’d
();

49 ++
	g™
) {

50 
	g»suÉ
 +ğ(
»suÉ
.
size
() > 1) ? "," : "";

51 
	g»suÉ
 +ğ
Numb”ToSŒšg
(*
™
);

53 
	g»suÉ
 += "}";

54  
	g»suÉ
;

58 
	gV”siÚ
::~
V”siÚ
() {

59 
as£¹
(
»fs_
 == 0);

60 
	gËv–
 = 0;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

61 
size_t
 
	gi
 = 0; i < 
	gfes_
[
Ëv–
].
size
(); i++) {

62 
FeM‘aD©a
* 
	gf
 = 
fes_
[
Ëv–
][
i
];

63 
as£¹
(
f
->
»fs
 >= 0);

64 
	gf
->
	g»fs
--;

65 ià(
	gf
->
	g»fs
 <= 0) {

66 
d–‘e
 
f
;

70 
d–‘e
 
	gş—nup_mem_
;

78 şas 
	cV”siÚ
::
Lev–FeNumI‹¿tÜ
 : 
public
 
I‹¿tÜ
 {

79 
public
:

80 
Lev–FeNumI‹¿tÜ
(cÚ¡ 
V”siÚ
* 
v”siÚ
,

81 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>* 
æi¡
)

82 : 
icmp_
(
v”siÚ
->
v£t_
->icmp_.
u£r_com·¿tÜ
()),

83 
æi¡_
(
æi¡
),

84 
šdex_
(
æi¡
->
size
()) {

86 
vœtu®
 
boŞ
 
V®id
() const {

87  
	gšdex_
 < 
	gæi¡_
->
size
();

89 
vœtu®
 
S“k
(cÚ¡ 
Sliû
& 
rg‘
) {

90 
ušt32_t
 
	gËá
 = 0;

91 
ušt32_t
 
	gright
 = 
æi¡_
->
size
() - 1;

92 
	gËá
 < 
	gright
) {

93 
ušt32_t
 
	gmid
 = (
Ëá
 + 
right
) / 2;

94 
	gcmp
 = 
icmp_
.
Com·»
((*
æi¡_
)[
mid
]->
Ïrge¡
.
Encode
(), 
rg‘
);

95 ià(
	gcmp
 < 0) {

98 
	gËá
 = 
mid
 + 1;

102 
	gright
 = 
mid
;

105 
	gšdex_
 = 
Ëá
;

107 
vœtu®
 
S“kToFœ¡
(è{ 
	gšdex_
 = 0; }

108 
vœtu®
 
S“kToLa¡
() {

109 
	gšdex_
 = 
æi¡_
->
em±y
(è? 0 : fli¡_->
size
() - 1;

111 
vœtu®
 
Next
() {

112 
as£¹
(
V®id
());

113 
	gšdex_
++;

115 
vœtu®
 
P»v
() {

116 
as£¹
(
V®id
());

117 ià(
	gšdex_
 == 0) {

118 
šdex_
 = 
æi¡_
->
size
();

120 
	gšdex_
--;

123 
Sliû
 
key
() const {

124 
as£¹
(
V®id
());

125  (*
	gæi¡_
)[
šdex_
]->
	gÏrge¡
.
Encode
();

127 
Sliû
 
v®ue
() const {

128 
as£¹
(
V®id
());

129 
EncodeFixed64
(
v®ue_buf_
, (*
æi¡_
)[
šdex_
]->
numb”
);

130 
EncodeFixed64
(
v®ue_buf_
+8, (*
æi¡_
)[
šdex_
]->
fe_size
);

131  
Sliû
(
v®ue_buf_
, (value_buf_));

133 
vœtu®
 
Stus
 
¡©us
(ècÚ¡ {  
	gStus
::
OK
(); }

134 
	g´iv©e
:

135 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
 
icmp_
;

136 cÚ¡ 
	g¡d
::
veùÜ
<
FeM‘aD©a
*>* cÚ¡ 
æi¡_
;

137 
ušt32_t
 
	gšdex_
;

140 
mubË
 
	gv®ue_buf_
[16];

143 
I‹¿tÜ
* 
	$G‘FeI‹¿tÜ
(* 
¬g
,

144 cÚ¡ 
R—dO±iÚs
& 
İtiÚs
,

145 cÚ¡ 
Sliû
& 
fe_v®ue
) {

146 
TabËCache
* 
ÿche
 = 
»š‹½»t_ÿ¡
<TabËCache*>(
¬g
);

147 ià(
fe_v®ue
.
	`size
() != 16) {

148  
	`NewE¼ÜI‹¿tÜ
(

149 
Stus
::
	`CÜru±iÚ
("FileReader invoked with unexpected value"));

151  
ÿche
->
	`NewI‹¿tÜ
(
İtiÚs
,

152 
	`DecodeFixed64
(
fe_v®ue
.
	`d©a
()),

153 
	`DecodeFixed64
(
fe_v®ue
.
	`d©a
() + 8));

155 
	}
}

157 
I‹¿tÜ
* 
	gV”siÚ
::
	$NewCÚÿ‹ÇtšgI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
,

158 
Ëv–
) const {

159  
	`NewTwoLev–I‹¿tÜ
(

160 
Ãw
 
	`Lev–FeNumI‹¿tÜ
(
this
, &
fes_
[
Ëv–
]),

161 &
G‘FeI‹¿tÜ
, 
v£t_
->
bË_ÿche_
, 
İtiÚs
);

162 
	}
}

164 
	gV”siÚ
::
AddI‹¿tÜs
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
,

165 
¡d
::
veùÜ
<
I‹¿tÜ
*>* 
™”s
) {

167 
size_t
 
i
 = 0; 
	gi
 < 
	gfes_
[0].
size
(); i++) {

168 
	g™”s
->
push_back
(

169 
v£t_
->
bË_ÿche_
->
NewI‹¿tÜ
(

170 
İtiÚs
, 
fes_
[0][
i
]->
numb”
, fes_[0][i]->
fe_size
));

176 
	gËv–
 = 1;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

177 ià(!
	gfes_
[
Ëv–
].
em±y
()) {

178 
	g™”s
->
push_back
(
NewCÚÿ‹ÇtšgI‹¿tÜ
(
İtiÚs
, 
Ëv–
));

183 
	gV”siÚ
::
	$Ref
() {

184 ++
»fs_
;

185 
	}
}

187 
	gV”siÚ
::
	$UÄef
() {

188 
	`as£¹
(
»fs_
 >= 1);

189 --
»fs_
;

190 ià(
»fs_
 == 0) {

191 
v£t_
->
	`MaybeD–‘eOldV”siÚs
();

194 
	}
}

196 
	g¡d
::
¡ršg
 
V”siÚ
::
	$DebugSŒšg
() const {

197 
¡d
::
¡ršg
 
r
;

198 
Ëv–
 = 0;†ev– < 
cÚfig
::
kNumLev–s
;†evel++) {

200 
r
.
	`­³nd
("level ");

201 
	`Aµ’dNumb”To
(&
r
, 
Ëv–
);

202 
r
.
	`push_back
(':');

203 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
 = 
fes_
[
Ëv–
];

204 
size_t
 
i
 = 0; i < 
fes
.
	`size
(); i++) {

205 
r
.
	`push_back
(' ');

206 
	`Aµ’dNumb”To
(&
r
, 
fes
[
i
]->
numb”
);

207 
r
.
	`push_back
(':');

208 
	`Aµ’dNumb”To
(&
r
, 
fes
[
i
]->
fe_size
);

209 
r
.
	`­³nd
("['");

210 
	`Aµ’dEsÿ³dSŒšgTo
(&
r
, 
fes
[
i
]->
sm®Ë¡
.
	`Encode
());

211 
r
.
	`­³nd
("' .. '");

212 
	`Aµ’dEsÿ³dSŒšgTo
(&
r
, 
fes
[
i
]->
Ïrge¡
.
	`Encode
());

213 
r
.
	`­³nd
("']");

215 
r
.
	`push_back
('\n');

217  
r
;

218 
	}
}

223 şas 
	cV”siÚS‘
::
Bud”
 {

224 
´iv©e
:

225 
¡d
::
	tm­
<
	tušt64_t
, 
	tFeM‘aD©a
*> 
	tFeM­
;

226 
V”siÚS‘
* 
	gv£t_
;

227 
FeM­
 
	gfes_
[
cÚfig
::
kNumLev–s
];

229 
	gpublic
:

231 
Bud”
(
V”siÚS‘
* 
v£t
, 
V”siÚ
* 
ba£
)

232 : 
v£t_
(
v£t
) {

233 
Ëv–
 = 0; 
	gËv–
 < 
	gcÚfig
::
kNumLev–s
;†evel++) {

234 cÚ¡ 
	g¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
 = 
ba£
->
fes_
[
Ëv–
];

235 
size_t
 
	gi
 = 0; i < 
	gfes
.
size
(); i++) {

236 
FeM‘aD©a
* 
	gf
 = 
fes
[
i
];

237 
	gf
->
	g»fs
++;

238 
	gfes_
[
Ëv–
].
š£¹
(
¡d
::
make_·œ
(
f
->
numb”
, f));

243 ~
Bud”
() {

244 
	gËv–
 = 0;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

245 cÚ¡ 
	gFeM­
& 
	gfm­
 = 
fes_
[
Ëv–
];

246 
	gFeM­
::
cÚ¡_™”©Ü
 
™”
 = 
fm­
.
begš
();

247 
	g™”
 !ğ
fm­
.
’d
();

248 ++
	g™”
) {

249 
FeM‘aD©a
* 
	gf
 = 
™”
->
£cÚd
;

250 
	gf
->
	g»fs
--;

251 ià(
	gf
->
	g»fs
 <= 0) {

252 
d–‘e
 
f
;

259 
Aµly
(
V”siÚEd™
* 
ed™
) {

261 
size_t
 
	gi
 = 0; i < 
	ged™
->
	gcom·ù_poš‹rs_
.
size
(); i++) {

262 cÚ¡ 
	gËv–
 = 
ed™
->
com·ù_poš‹rs_
[
i
].
fœ¡
;

263 
	gv£t_
->
	gcom·ù_poš‹r_
[
Ëv–
] =

264 
ed™
->
com·ù_poš‹rs_
[
i
].
£cÚd
.
Encode
().
ToSŒšg
();

268 cÚ¡ 
	gV”siÚEd™
::
D–‘edFeS‘
& 
d–
 = 
ed™
->
d–‘ed_fes_
;

269 
	gV”siÚEd™
::
D–‘edFeS‘
::
cÚ¡_™”©Ü
 
™”
 = 
d–
.
begš
();

270 
	g™”
 !ğ
d–
.
’d
();

271 ++
	g™”
) {

272 cÚ¡ 
	gËv–
 = 
™”
->
fœ¡
;

273 cÚ¡ 
ušt64_t
 
	gnumb”
 = 
™”
->
£cÚd
;

274 
	gFeM­
::
™”©Ü
 
f™”
 = 
fes_
[
Ëv–
].
fšd
(
numb”
);

275 
as£¹
(
f™”
 !ğ
fes_
[
Ëv–
].
’d
());

276 ià(
	gf™”
 !ğ
fes_
[
Ëv–
].
’d
()) {

277 
FeM‘aD©a
* 
f
 = 
f™”
->
£cÚd
;

278 
	gf
->
	g»fs
--;

279 ià(
	gf
->
	g»fs
 <= 0) {

280 
d–‘e
 
f
;

282 
	gfes_
[
Ëv–
].
”a£
(
f™”
);

287 
size_t
 
	gi
 = 0; i < 
	ged™
->
	gÃw_fes_
.
size
(); i++) {

288 cÚ¡ 
	gËv–
 = 
ed™
->
Ãw_fes_
[
i
].
fœ¡
;

289 
FeM‘aD©a
* 
	gf
 = 
Ãw
 FeM‘aD©a(
ed™
->
Ãw_fes_
[
i
].
£cÚd
);

290 
	gf
->
	g»fs
 = 1;

291 
as£¹
(
fes_
[
Ëv–
].
couÁ
(
f
->
numb”
) == 0);

292 
	gfes_
[
Ëv–
].
š£¹
(
¡d
::
make_·œ
(
f
->
numb”
, f));

297 
SaveTo
(
V”siÚ
* 
v
) {

298 
	gËv–
 = 0;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

299 cÚ¡ 
	gFeM­
& 
	gfm­
 = 
fes_
[
Ëv–
];

300 
	gFeM­
::
cÚ¡_™”©Ü
 
™”
 = 
fm­
.
begš
();

301 
	g™”
 !ğ
fm­
.
’d
();

302 ++
	g™”
) {

303 
FeM‘aD©a
* 
	gf
 = 
™”
->
£cÚd
;

304 
	gf
->
	g»fs
++;

305 
	gv
->
	gfes_
[
Ëv–
].
push_back
(
f
);

311 
	gV”siÚS‘
::
V”siÚS‘
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
,

312 cÚ¡ 
O±iÚs
* 
İtiÚs
,

313 
TabËCache
* 
bË_ÿche
,

314 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
* 
cmp
)

315 : 
’v_
(
İtiÚs
->
’v
),

316 
dbÇme_
(
dbÇme
),

317 
İtiÚs_
(
İtiÚs
),

318 
bË_ÿche_
(
bË_ÿche
),

319 
icmp_
(*
cmp
),

320 
Ãxt_fe_numb”_
(2),

321 
mªiã¡_fe_numb”_
(0),

322 
Ï¡_£qu’û_
(0),

323 
log_numb”_
(0),

324 
´ev_log_numb”_
(0),

325 
desütÜ_fe_
(
NULL
),

326 
desütÜ_log_
(
NULL
),

327 
cu¼’t_
(
Ãw
 
V”siÚ
(
this
)),

328 
	$Şde¡_
(
cu¼’t_
) {

329 
	}
}

331 
	gV”siÚS‘
::~
	$V”siÚS‘
() {

332 
V”siÚ
* 
v
 = 
Şde¡_
; v !ğ
NULL
; ) {

333 
V”siÚ
* 
Ãxt
 = 
v
->
Ãxt_
;

334 
	`as£¹
(
v
->
»fs_
 == 0);

335 
d–‘e
 
v
;

336 
v
 = 
Ãxt
;

338 
d–‘e
 
desütÜ_log_
;

339 
d–‘e
 
desütÜ_fe_
;

340 
	}
}

342 
Stus
 
	gV”siÚS‘
::
	$LogAndAµly
(
V”siÚEd™
* 
ed™
, 
MemTabË
* 
ş—nup_mem
) {

343 ià(
ed™
->
has_log_numb”_
) {

344 
	`as£¹
(
ed™
->
log_numb”_
 >=†og_number_);

345 
	`as£¹
(
ed™
->
log_numb”_
 < 
Ãxt_fe_numb”_
);

347 
ed™
->
	`S‘LogNumb”
(
log_numb”_
);

350 ià(!
ed™
->
has_´ev_log_numb”_
) {

351 
ed™
->
	`S‘P»vLogNumb”
(
´ev_log_numb”_
);

354 
ed™
->
	`S‘NextFe
(
Ãxt_fe_numb”_
);

355 
ed™
->
	`S‘La¡Sequ’û
(
Ï¡_£qu’û_
);

357 
V”siÚ
* 
v
 = 
Ãw
 
	`V”siÚ
(
this
);

359 
Bud”
 
	`bud”
(
this
, 
cu¼’t_
);

360 
bud”
.
	`Aµly
(
ed™
);

361 
bud”
.
	`SaveTo
(
v
);

364 
¡d
::
¡ršg
 
Ãw_mªiã¡_fe
;

365 
Stus
 
s
 = 
	`Fš®ize
(
v
);

369 ià(
s
.
	`ok
()) {

370 ià(
desütÜ_log_
 =ğ
NULL
) {

371 
	`as£¹
(
desütÜ_fe_
 =ğ
NULL
);

372 
Ãw_mªiã¡_fe
 = 
	`DesütÜFeName
(
dbÇme_
, 
mªiã¡_fe_numb”_
);

373 
ed™
->
	`S‘NextFe
(
Ãxt_fe_numb”_
);

374 
s
 = 
’v_
->
	`NewWr™abËFe
(
Ãw_mªiã¡_fe
, &
desütÜ_fe_
);

375 ià(
s
.
	`ok
()) {

376 
desütÜ_log_
 = 
Ãw
 
log
::
	`Wr™”
(
desütÜ_fe_
);

377 
s
 = 
	`Wr™eSÇpshÙ
(
desütÜ_log_
);

383 ià(
s
.
	`ok
()) {

384 
¡d
::
¡ršg
 
»cÜd
;

385 
ed™
->
	`EncodeTo
(&
»cÜd
);

386 
s
 = 
desütÜ_log_
->
	`AddRecÜd
(
»cÜd
);

387 ià(
s
.
	`ok
()) {

388 
s
 = 
desütÜ_fe_
->
	`Sync
();

394 ià(
s
.
	`ok
(è&& !
Ãw_mªiã¡_fe
.
	`em±y
()) {

395 
s
 = 
	`S‘Cu¼’tFe
(
’v_
, 
dbÇme_
, 
mªiã¡_fe_numb”_
);

399 ià(
s
.
	`ok
()) {

400 
	`as£¹
(
cu¼’t_
->
Ãxt_
 =ğ
NULL
);

401 
	`as£¹
(
cu¼’t_
->
ş—nup_mem_
 =ğ
NULL
);

402 
cu¼’t_
->
ş—nup_mem_
 = 
ş—nup_mem
;

403 
v
->
Ãxt_
 = 
NULL
;

404 
cu¼’t_
->
Ãxt_
 = 
v
;

405 
cu¼’t_
 = 
v
;

406 
log_numb”_
 = 
ed™
->log_number_;

407 
´ev_log_numb”_
 = 
ed™
->prev_log_number_;

409 
d–‘e
 
v
;

410 ià(!
Ãw_mªiã¡_fe
.
	`em±y
()) {

411 
d–‘e
 
desütÜ_log_
;

412 
d–‘e
 
desütÜ_fe_
;

413 
desütÜ_log_
 = 
NULL
;

414 
desütÜ_fe_
 = 
NULL
;

415 
’v_
->
	`D–‘eFe
(
Ãw_mªiã¡_fe
);

419  
s
;

420 
	}
}

422 
Stus
 
	gV”siÚS‘
::
	$Recov”
() {

423 
LogR•Ü‹r
 : 
public
 
log
::
R—d”
::
R•Ü‹r
 {

424 
Stus
* 
¡©us
;

425 
vœtu®
 
	`CÜru±iÚ
(
size_t
 
by‹s
, cÚ¡ 
Stus
& 
s
) {

426 ià(
this
->
¡©us
->
	`ok
()è*this->¡©u ğ
s
;

431 
¡d
::
¡ršg
 
cu¼’t
;

432 
Stus
 
s
 = 
	`R—dFeToSŒšg
(
’v_
, 
	`Cu¼’tFeName
(
dbÇme_
), &
cu¼’t
);

433 ià(!
s
.
	`ok
()) {

434  
s
;

436 ià(
cu¼’t
.
	`em±y
(è|| cu¼’t[cu¼’t.
	`size
()-1] != '\n') {

437  
Stus
::
	`CÜru±iÚ
("CURRENT file does‚otƒnd with‚ewline");

439 
cu¼’t
.
	`»size
(cu¼’t.
	`size
() - 1);

441 
¡d
::
¡ršg
 
dsúame
 = 
dbÇme_
 + "/" + 
cu¼’t
;

442 
Sequ’tŸlFe
* 
fe
;

443 
s
 = 
’v_
->
	`NewSequ’tŸlFe
(
dsúame
, &
fe
);

444 ià(!
s
.
	`ok
()) {

445  
s
;

448 
boŞ
 
have_log_numb”
 = 
çl£
;

449 
boŞ
 
have_´ev_log_numb”
 = 
çl£
;

450 
boŞ
 
have_Ãxt_fe
 = 
çl£
;

451 
boŞ
 
have_Ï¡_£qu’û
 = 
çl£
;

452 
ušt64_t
 
Ãxt_fe
 = 0;

453 
ušt64_t
 
Ï¡_£qu’û
 = 0;

454 
ušt64_t
 
log_numb”
 = 0;

455 
ušt64_t
 
´ev_log_numb”
 = 0;

456 
Bud”
 
	`bud”
(
this
, 
cu¼’t_
);

459 
LogR•Ü‹r
 
»pÜ‹r
;

460 
»pÜ‹r
.
¡©us
 = &
s
;

461 
log
::
R—d”
 
	`»ad”
(
fe
, &
»pÜ‹r
, 
Œue
 );

462 
Sliû
 
»cÜd
;

463 
¡d
::
¡ršg
 
sü©ch
;

464 
»ad”
.
	`R—dRecÜd
(&
»cÜd
, &
sü©ch
è&& 
s
.
	`ok
()) {

465 
V”siÚEd™
 
ed™
;

466 
s
 = 
ed™
.
	`DecodeFrom
(
»cÜd
);

467 ià(
s
.
	`ok
()) {

468 ià(
ed™
.
has_com·¿tÜ_
 &&

469 
ed™
.
com·¿tÜ_
 !ğ
icmp_
.
	`u£r_com·¿tÜ
()->
	`Name
()) {

470 
s
 = 
Stus
::
	`Inv®idArgum’t
(

471 
ed™
.
com·¿tÜ_
 + "does‚ot matchƒxisting comparator ",

472 
icmp_
.
	`u£r_com·¿tÜ
()->
	`Name
());

476 ià(
s
.
	`ok
()) {

477 
bud”
.
	`Aµly
(&
ed™
);

480 ià(
ed™
.
has_log_numb”_
) {

481 
log_numb”
 = 
ed™
.
log_numb”_
;

482 
have_log_numb”
 = 
Œue
;

485 ià(
ed™
.
has_´ev_log_numb”_
) {

486 
´ev_log_numb”
 = 
ed™
.
´ev_log_numb”_
;

487 
have_´ev_log_numb”
 = 
Œue
;

490 ià(
ed™
.
has_Ãxt_fe_numb”_
) {

491 
Ãxt_fe
 = 
ed™
.
Ãxt_fe_numb”_
;

492 
have_Ãxt_fe
 = 
Œue
;

495 ià(
ed™
.
has_Ï¡_£qu’û_
) {

496 
Ï¡_£qu’û
 = 
ed™
.
Ï¡_£qu’û_
;

497 
have_Ï¡_£qu’û
 = 
Œue
;

501 
d–‘e
 
fe
;

502 
fe
 = 
NULL
;

504 ià(
s
.
	`ok
()) {

505 ià(!
have_Ãxt_fe
) {

506 
s
 = 
Stus
::
	`CÜru±iÚ
("no meta-nextfileƒntry in descriptor");

507 } ià(!
have_log_numb”
) {

508 
s
 = 
Stus
::
	`CÜru±iÚ
("no meta-lognumberƒntry in descriptor");

509 } ià(!
have_Ï¡_£qu’û
) {

510 
s
 = 
Stus
::
	`CÜru±iÚ
("no†ast-sequence-numberƒntry in descriptor");

513 ià(!
have_´ev_log_numb”
) {

514 
´ev_log_numb”
 = 0;

518 ià(
s
.
	`ok
()) {

519 
V”siÚ
* 
v
 = 
Ãw
 
	`V”siÚ
(
this
);

520 
bud”
.
	`SaveTo
(
v
);

521 
s
 = 
	`Fš®ize
(
v
);

522 ià(!
s
.
	`ok
()) {

523 
d–‘e
 
v
;

526 
v
->
Ãxt_
 = 
NULL
;

527 
cu¼’t_
->
Ãxt_
 = 
v
;

528 
cu¼’t_
 = 
v
;

529 
mªiã¡_fe_numb”_
 = 
Ãxt_fe
;

530 
Ãxt_fe_numb”_
 = 
Ãxt_fe
 + 1;

531 
Ï¡_£qu’û_
 = 
Ï¡_£qu’û
;

532 
log_numb”_
 = 
log_numb”
;

533 
´ev_log_numb”_
 = 
´ev_log_numb”
;

537  
s
;

538 
	}
}

540 
št64_t
 
TÙ®FeSize
(cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
) {

541 
št64_t
 
sum
 = 0;

542 
size_t
 
	gi
 = 0; i < 
	gfes
.
size
(); i++) {

543 
	gsum
 +ğ
fes
[
i
]->
fe_size
;

545  
	gsum
;

548 
Stus
 
	gV”siÚS‘
::
	$Fš®ize
(
V”siÚ
* 
v
) {

550 
be¡_Ëv–
 = -1;

551 
be¡_scÜe
 = -1;

553 
Stus
 
s
;

554 
Ëv–
 = 0; 
s
.
	`ok
(è&&†ev– < 
cÚfig
::
kNumLev–s
-1;†evel++) {

555 
s
 = 
	`SÜtLev–
(
v
, 
Ëv–
);

557 
scÜe
;

558 ià(
Ëv–
 == 0) {

570 
scÜe
 = 
v
->
fes_
[
Ëv–
].
	`size
() / 4.0;

573 cÚ¡ 
ušt64_t
 
Ëv–_by‹s
 = 
	`TÙ®FeSize
(
v
->
fes_
[
Ëv–
]);

574 
scÜe
 = 
¡©ic_ÿ¡
<>(
Ëv–_by‹s
è/ 
	`MaxBy‹sFÜLev–
(
Ëv–
);

577 ià(
scÜe
 > 
be¡_scÜe
) {

578 
be¡_Ëv–
 = 
Ëv–
;

579 
be¡_scÜe
 = 
scÜe
;

583 
v
->
com·ùiÚ_Ëv–_
 = 
be¡_Ëv–
;

584 
v
->
com·ùiÚ_scÜe_
 = 
be¡_scÜe
;

585  
s
;

586 
	}
}

588 
Stus
 
	gV”siÚS‘
::
Wr™eSÇpshÙ
(
log
::
Wr™”
*†og) {

592 
V”siÚEd™
 
ed™
;

593 
	ged™
.
S‘Com·¿tÜName
(
icmp_
.
u£r_com·¿tÜ
()->
Name
());

596 
	gËv–
 = 0;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

597 ià(!
	gcom·ù_poš‹r_
[
Ëv–
].
em±y
()) {

598 
IÁ”ÇlKey
 
	gkey
;

599 
	gkey
.
DecodeFrom
(
com·ù_poš‹r_
[
Ëv–
]);

600 
	ged™
.
S‘Com·ùPoš‹r
(
Ëv–
, 
key
);

605 
	gËv–
 = 0;†ev– < 
	gcÚfig
::
kNumLev–s
;†evel++) {

606 cÚ¡ 
	g¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
 = 
cu¼’t_
->
fes_
[
Ëv–
];

607 
size_t
 
	gi
 = 0; i < 
	gfes
.
size
(); i++) {

608 cÚ¡ 
FeM‘aD©a
* 
	gf
 = 
fes
[
i
];

609 
	ged™
.
AddFe
(
Ëv–
, 
f
->
numb”
, f->
fe_size
, f->
sm®Ë¡
, f->
Ïrge¡
);

613 
	g¡d
::
¡ršg
 
»cÜd
;

614 
	ged™
.
EncodeTo
(&
»cÜd
);

615  
	glog
->
AddRecÜd
(
»cÜd
);

619 
	gV”siÚS‘
::
BySm®Ë¡Key
 {

620 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
* 
š‹º®_com·¿tÜ
;

622 
boŞ
 
İ”©Ü
()(
FeM‘aD©a
* 
	gf1
, FeM‘aD©a* 
	gf2
) const {

623  
	gš‹º®_com·¿tÜ
->
Com·»
(
f1
->
sm®Ë¡
, 
f2
->smallest) < 0;

627 
Stus
 
	gV”siÚS‘
::
	$SÜtLev–
(
V”siÚ
* 
v
, 
ušt64_t
 
Ëv–
) {

628 
Stus
 
»suÉ
;

629 
BySm®Ë¡Key
 
cmp
;

630 
cmp
.
š‹º®_com·¿tÜ
 = &
icmp_
;

631 
¡d
::
	`sÜt
(
v
->
fes_
[
Ëv–
].
	`begš
(), v->fes_[Ëv–].
	`’d
(), 
cmp
);

633 ià(
»suÉ
.
	`ok
(è&& 
Ëv–
 > 0) {

635 
size_t
 
i
 = 1; i < 
v
->
fes_
[
Ëv–
].
	`size
(); i++) {

636 cÚ¡ 
IÁ”ÇlKey
& 
´ev_’d
 = 
v
->
fes_
[
Ëv–
][
i
-1]->
Ïrge¡
;

637 cÚ¡ 
IÁ”ÇlKey
& 
this_begš
 = 
v
->
fes_
[
Ëv–
][
i
]->
sm®Ë¡
;

638 ià(
icmp_
.
	`Com·»
(
´ev_’d
, 
this_begš
) >= 0) {

639 
»suÉ
 = 
Stus
::
	`CÜru±iÚ
(

641 (
	`Esÿ³SŒšg
(
´ev_’d
.
	`Encode
()) + " vs. " +

642 
	`Esÿ³SŒšg
(
this_begš
.
	`Encode
())));

647  
»suÉ
;

648 
	}
}

650 
	gV”siÚS‘
::
	$NumLev–Fes
(
Ëv–
) const {

651 
	`as£¹
(
Ëv–
 >= 0);

652 
	`as£¹
(
Ëv–
 < 
cÚfig
::
kNumLev–s
);

653  
cu¼’t_
->
fes_
[
Ëv–
].
	`size
();

654 
	}
}

656 
ušt64_t
 
	gV”siÚS‘
::
	$Aµroxim©eOff£tOf
(
V”siÚ
* 
v
, cÚ¡ 
IÁ”ÇlKey
& 
ikey
) {

657 
ušt64_t
 
»suÉ
 = 0;

658 
Ëv–
 = 0;†ev– < 
cÚfig
::
kNumLev–s
;†evel++) {

659 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
 = 
v
->
fes_
[
Ëv–
];

660 
size_t
 
i
 = 0; i < 
fes
.
	`size
(); i++) {

661 ià(
icmp_
.
	`Com·»
(
fes
[
i
]->
Ïrge¡
, 
ikey
) <= 0) {

663 
»suÉ
 +ğ
fes
[
i
]->
fe_size
;

664 } ià(
icmp_
.
	`Com·»
(
fes
[
i
]->
sm®Ë¡
, 
ikey
) > 0) {

666 ià(
Ëv–
 > 0) {

675 
TabË
* 
bË±r
;

676 
I‹¿tÜ
* 
™”
 = 
bË_ÿche_
->
	`NewI‹¿tÜ
(

677 
	`R—dO±iÚs
(), 
fes
[
i
]->
numb”
, fes[i]->
fe_size
, &
bË±r
);

678 ià(
bË±r
 !ğ
NULL
) {

679 
»suÉ
 +ğ
bË±r
->
	`Aµroxim©eOff£tOf
(
ikey
.
	`Encode
());

681 
d–‘e
 
™”
;

685  
»suÉ
;

686 
	}
}

688 
	gV”siÚS‘
::
	$MaybeD–‘eOldV”siÚs
() {

692 
Şde¡_
 !ğ
cu¼’t_
 && olde¡_->
»fs_
 == 0) {

693 
V”siÚ
* 
Ãxt
 = 
Şde¡_
->
Ãxt_
;

694 
d–‘e
 
Şde¡_
;

695 
Şde¡_
 = 
Ãxt
;

697 
	}
}

699 
	gV”siÚS‘
::
AddLiveFes
(
¡d
::
£t
<
ušt64_t
>* 
live
) {

700 
V”siÚ
* 
v
 = 
Şde¡_
; 
	gv
 !ğ
NULL
; v = v->
Ãxt_
) {

701 
Ëv–
 = 0; 
	gËv–
 < 
	gcÚfig
::
kNumLev–s
;†evel++) {

702 cÚ¡ 
	g¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
 = 
v
->
fes_
[
Ëv–
];

703 
size_t
 
	gi
 = 0; i < 
	gfes
.
size
(); i++) {

704 
	glive
->
š£¹
(
fes
[
i
]->
numb”
);

710 
št64_t
 
	gV”siÚS‘
::
	$NumLev–By‹s
(
Ëv–
) const {

711 
	`as£¹
(
Ëv–
 >= 0);

712 
	`as£¹
(
Ëv–
 < 
cÚfig
::
kNumLev–s
);

713  
	`TÙ®FeSize
(
cu¼’t_
->
fes_
[
Ëv–
]);

714 
	}
}

716 
št64_t
 
	gV”siÚS‘
::
	$MaxNextLev–Ov”ÏµšgBy‹s
() {

717 
št64_t
 
»suÉ
 = 0;

718 
¡d
::
veùÜ
<
FeM‘aD©a
*> 
ov”Ïps
;

719 
Ëv–
 = 0;†ev– < 
cÚfig
::
kNumLev–s
 - 1;†evel++) {

720 
size_t
 
i
 = 0; i < 
cu¼’t_
->
fes_
[
Ëv–
].
	`size
(); i++) {

721 cÚ¡ 
FeM‘aD©a
* 
f
 = 
cu¼’t_
->
fes_
[
Ëv–
][
i
];

722 
	`G‘Ov”ÏµšgIÅuts
(
Ëv–
+1, 
f
->
sm®Ë¡
, f->
Ïrge¡
, &
ov”Ïps
);

723 cÚ¡ 
št64_t
 
sum
 = 
	`TÙ®FeSize
(
ov”Ïps
);

724 ià(
sum
 > 
»suÉ
) {

725 
»suÉ
 = 
sum
;

729  
»suÉ
;

730 
	}
}

733 
	gV”siÚS‘
::
G‘Ov”ÏµšgIÅuts
(

734 
Ëv–
,

735 cÚ¡ 
IÁ”ÇlKey
& 
begš
,

736 cÚ¡ 
IÁ”ÇlKey
& 
’d
,

737 
¡d
::
veùÜ
<
FeM‘aD©a
*>* 
šputs
) {

738 
šputs
->
ş—r
();

739 
Sliû
 
	gu£r_begš
 = 
begš
.
u£r_key
();

740 
Sliû
 
	gu£r_’d
 = 
’d
.
u£r_key
();

741 cÚ¡ 
Com·¿tÜ
* 
	gu£r_cmp
 = 
icmp_
.
u£r_com·¿tÜ
();

742 
size_t
 
	gi
 = 0; i < 
	gcu¼’t_
->
	gfes_
[
Ëv–
].
size
(); i++) {

743 
FeM‘aD©a
* 
	gf
 = 
cu¼’t_
->
fes_
[
Ëv–
][
i
];

744 ià(
	gu£r_cmp
->
Com·»
(
f
->
Ïrge¡
.
u£r_key
(), 
u£r_begš
) < 0 ||

745 
	gu£r_cmp
->
Com·»
(
f
->
sm®Ë¡
.
u£r_key
(), 
u£r_’d
) > 0) {

748 
	gšputs
->
push_back
(
f
);

756 
	gV”siÚS‘
::
G‘Rªge
(cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
šputs
,

757 
IÁ”ÇlKey
* 
sm®Ë¡
,

758 
IÁ”ÇlKey
* 
Ïrge¡
) {

759 
as£¹
(!
šputs
.
em±y
());

760 
	gsm®Ë¡
->
CË¬
();

761 
	gÏrge¡
->
CË¬
();

762 
size_t
 
	gi
 = 0; i < 
	gšputs
.
size
(); i++) {

763 
FeM‘aD©a
* 
	gf
 = 
šputs
[
i
];

764 ià(
	gi
 == 0) {

765 *
sm®Ë¡
 = 
f
->smallest;

766 *
	gÏrge¡
 = 
f
->
Ïrge¡
;

768 ià(
	gicmp_
.
Com·»
(
f
->
sm®Ë¡
, *smallest) < 0) {

769 *
	gsm®Ë¡
 = 
f
->
sm®Ë¡
;

771 ià(
	gicmp_
.
Com·»
(
f
->
Ïrge¡
, *largest) > 0) {

772 *
	gÏrge¡
 = 
f
->
Ïrge¡
;

781 
	gV”siÚS‘
::
G‘Rªge2
(cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
šputs1
,

782 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
šputs2
,

783 
IÁ”ÇlKey
* 
sm®Ë¡
,

784 
IÁ”ÇlKey
* 
Ïrge¡
) {

785 
	g¡d
::
veùÜ
<
FeM‘aD©a
*> 
®l
 = 
šputs1
;

786 
	g®l
.
š£¹
(
®l
.
’d
(), 
šputs2
.
begš
(), inputs2.end());

787 
G‘Rªge
(
®l
, 
sm®Ë¡
, 
Ïrge¡
);

790 
I‹¿tÜ
* 
	gV”siÚS‘
::
	$MakeIÅutI‹¿tÜ
(
Com·ùiÚ
* 
c
) {

791 
R—dO±iÚs
 
İtiÚs
;

792 
İtiÚs
.
v”ify_checksums
 = 
İtiÚs_
->
·¿noid_checks
;

793 
İtiÚs
.
fl_ÿche
 = 
çl£
;

798 cÚ¡ 
¥aû
 = (
c
->
	`Ëv–
(è=ğ0 ? c->
šputs_
[0].
	`size
() + 1 : 2);

799 
I‹¿tÜ
** 
li¡
 = 
Ãw
 I‹¿tÜ*[
¥aû
];

800 
num
 = 0;

801 
which
 = 0; which < 2; which++) {

802 ià(!
c
->
šputs_
[
which
].
	`em±y
()) {

803 ià(
c
->
	`Ëv–
(è+ 
which
 == 0) {

804 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
 = 
c
->
šputs_
[
which
];

805 
size_t
 
i
 = 0; i < 
fes
.
	`size
(); i++) {

806 
li¡
[
num
++] = 
bË_ÿche_
->
	`NewI‹¿tÜ
(

807 
İtiÚs
, 
fes
[
i
]->
numb”
, fes[i]->
fe_size
);

811 
li¡
[
num
++] = 
	`NewTwoLev–I‹¿tÜ
(

812 
Ãw
 
V”siÚ
::
	`Lev–FeNumI‹¿tÜ
(

813 
c
->
šput_v”siÚ_
, &c->
šputs_
[
which
]),

814 &
G‘FeI‹¿tÜ
, 
bË_ÿche_
, 
İtiÚs
);

818 
	`as£¹
(
num
 <ğ
¥aû
);

819 
I‹¿tÜ
* 
»suÉ
 = 
	`NewM”gšgI‹¿tÜ
(&
icmp_
, 
li¡
, 
num
);

820 
d–‘e
[] 
li¡
;

821  
»suÉ
;

822 
	}
}

824 
Com·ùiÚ
* 
	gV”siÚS‘
::
	$PickCom·ùiÚ
() {

825 ià(!
	`N“dsCom·ùiÚ
()) {

826  
NULL
;

828 cÚ¡ 
Ëv–
 = 
cu¼’t_
->
com·ùiÚ_Ëv–_
;

829 
	`as£¹
(
Ëv–
 >= 0);

830 
	`as£¹
(
Ëv–
+1 < 
cÚfig
::
kNumLev–s
);

832 
Com·ùiÚ
* 
c
 = 
Ãw
 
	`Com·ùiÚ
(
Ëv–
);

833 
c
->
šput_v”siÚ_
 = 
cu¼’t_
;

834 
c
->
šput_v”siÚ_
->
	`Ref
();

837 
size_t
 
i
 = 0; i < 
cu¼’t_
->
fes_
[
Ëv–
].
	`size
(); i++) {

838 
FeM‘aD©a
* 
f
 = 
cu¼’t_
->
fes_
[
Ëv–
][
i
];

839 ià(
com·ù_poš‹r_
[
Ëv–
].
	`em±y
() ||

840 
icmp_
.
	`Com·»
(
f
->
Ïrge¡
.
	`Encode
(), 
com·ù_poš‹r_
[
Ëv–
]) > 0) {

841 
c
->
šputs_
[0].
	`push_back
(
f
);

845 ià(
c
->
šputs_
[0].
	`em±y
()) {

847 
c
->
šputs_
[0].
	`push_back
(
cu¼’t_
->
fes_
[
Ëv–
][0]);

851 ià(
Ëv–
 == 0) {

852 
IÁ”ÇlKey
 
sm®Ë¡
, 
Ïrge¡
;

853 
	`G‘Rªge
(
c
->
šputs_
[0], &
sm®Ë¡
, &
Ïrge¡
);

857 
	`G‘Ov”ÏµšgIÅuts
(0, 
sm®Ë¡
, 
Ïrge¡
, &
c
->
šputs_
[0]);

858 
	`as£¹
(!
c
->
šputs_
[0].
	`em±y
());

861 
	`S‘upOth”IÅuts
(
c
);

863  
c
;

864 
	}
}

866 
	gV”siÚS‘
::
	$S‘upOth”IÅuts
(
Com·ùiÚ
* 
c
) {

867 cÚ¡ 
Ëv–
 = 
c
->
	`Ëv–
();

868 
IÁ”ÇlKey
 
sm®Ë¡
, 
Ïrge¡
;

869 
	`G‘Rªge
(
c
->
šputs_
[0], &
sm®Ë¡
, &
Ïrge¡
);

871 
	`G‘Ov”ÏµšgIÅuts
(
Ëv–
+1, 
sm®Ë¡
, 
Ïrge¡
, &
c
->
šputs_
[1]);

874 
IÁ”ÇlKey
 
®l_¡¬t
, 
®l_lim™
;

875 
	`G‘Rªge2
(
c
->
šputs_
[0], c->šputs_[1], &
®l_¡¬t
, &
®l_lim™
);

879 ià(!
c
->
šputs_
[1].
	`em±y
()) {

880 
¡d
::
veùÜ
<
FeM‘aD©a
*> 
ex·nded0
;

881 
	`G‘Ov”ÏµšgIÅuts
(
Ëv–
, 
®l_¡¬t
, 
®l_lim™
, &
ex·nded0
);

882 ià(
ex·nded0
.
	`size
(è> 
c
->
šputs_
[0].size()) {

883 
IÁ”ÇlKey
 
Ãw_¡¬t
, 
Ãw_lim™
;

884 
	`G‘Rªge
(
ex·nded0
, &
Ãw_¡¬t
, &
Ãw_lim™
);

885 
¡d
::
veùÜ
<
FeM‘aD©a
*> 
ex·nded1
;

886 
	`G‘Ov”ÏµšgIÅuts
(
Ëv–
+1, 
Ãw_¡¬t
, 
Ãw_lim™
, &
ex·nded1
);

887 ià(
ex·nded1
.
	`size
(è=ğ
c
->
šputs_
[1].size()) {

888 
	`Log
(
’v_
, 
İtiÚs_
->
šfo_log
,

890 
Ëv–
,

891 (
c
->
šputs_
[0].
	`size
()),

892 (
c
->
šputs_
[1].
	`size
()),

893 (
ex·nded0
.
	`size
()),

894 (
ex·nded1
.
	`size
()));

895 
sm®Ë¡
 = 
Ãw_¡¬t
;

896 
Ïrge¡
 = 
Ãw_lim™
;

897 
c
->
šputs_
[0] = 
ex·nded0
;

898 
c
->
šputs_
[1] = 
ex·nded1
;

899 
	`G‘Rªge2
(
c
->
šputs_
[0], c->šputs_[1], &
®l_¡¬t
, &
®l_lim™
);

906 ià(
Ëv–
 + 2 < 
cÚfig
::
kNumLev–s
) {

907 
	`G‘Ov”ÏµšgIÅuts
(
Ëv–
 + 2, 
®l_¡¬t
, 
®l_lim™
, &
c
->
g¿nd·»Ás_
);

910 ià(
çl£
) {

911 
	`Log
(
’v_
, 
İtiÚs_
->
šfo_log
, "Compacting %d '%s' .. '%s'",

912 
Ëv–
,

913 
	`Esÿ³SŒšg
(
sm®Ë¡
.
	`Encode
()).
	`c_¡r
(),

914 
	`Esÿ³SŒšg
(
Ïrge¡
.
	`Encode
()).
	`c_¡r
());

921 
com·ù_poš‹r_
[
Ëv–
] = 
Ïrge¡
.
	`Encode
().
	`ToSŒšg
();

922 
c
->
ed™_
.
	`S‘Com·ùPoš‹r
(
Ëv–
, 
Ïrge¡
);

923 
	}
}

925 
Com·ùiÚ
* 
	gV”siÚS‘
::
	$Com·ùRªge
(

926 
Ëv–
,

927 cÚ¡ 
IÁ”ÇlKey
& 
begš
,

928 cÚ¡ 
IÁ”ÇlKey
& 
’d
) {

929 
¡d
::
veùÜ
<
FeM‘aD©a
*> 
šputs
;

930 
	`G‘Ov”ÏµšgIÅuts
(
Ëv–
, 
begš
, 
’d
, &
šputs
);

931 ià(
šputs
.
	`em±y
()) {

932  
NULL
;

935 
Com·ùiÚ
* 
c
 = 
Ãw
 
	`Com·ùiÚ
(
Ëv–
);

936 
c
->
šput_v”siÚ_
 = 
cu¼’t_
;

937 
c
->
šput_v”siÚ_
->
	`Ref
();

938 
c
->
šputs_
[0] = 
šputs
;

939 
	`S‘upOth”IÅuts
(
c
);

940  
c
;

941 
	}
}

943 
	gCom·ùiÚ
::
	$Com·ùiÚ
(
Ëv–
)

944 : 
	`Ëv–_
(
Ëv–
),

945 
	`max_ouut_fe_size_
(
	`MaxFeSizeFÜLev–
(
Ëv–
)),

946 
	`šput_v”siÚ_
(
NULL
),

947 
	`g¿nd·»Á_šdex_
(0),

948 
	`£’_key_
(
çl£
),

949 
	$ov”Ïµed_by‹s_
(0) {

950 
i
 = 0; i < 
cÚfig
::
kNumLev–s
; i++) {

951 
Ëv–_±rs_
[
i
] = 0;

953 
	}
}

955 
	gCom·ùiÚ
::~
	$Com·ùiÚ
() {

956 ià(
šput_v”siÚ_
 !ğ
NULL
) {

957 
šput_v”siÚ_
->
	`UÄef
();

959 
	}
}

961 
boŞ
 
	gCom·ùiÚ
::
	$IsTrivŸlMove
() const {

965  (
	`num_šput_fes
(0) == 1 &&

966 
	`num_šput_fes
(1) == 0 &&

967 
	`TÙ®FeSize
(
g¿nd·»Ás_
è<ğ
kMaxG¿ndP¬’tOv”ÏpBy‹s
);

968 
	}
}

970 
	gCom·ùiÚ
::
	$AddIÅutD–‘iÚs
(
V”siÚEd™
* 
ed™
) {

971 
which
 = 0; which < 2; which++) {

972 
size_t
 
i
 = 0; i < 
šputs_
[
which
].
	`size
(); i++) {

973 
ed™
->
	`D–‘eFe
(
Ëv–_
 + 
which
, 
šputs_
[which][
i
]->
numb”
);

976 
	}
}

978 
boŞ
 
	gCom·ùiÚ
::
	$IsBa£Lev–FÜKey
(cÚ¡ 
Sliû
& 
u£r_key
) {

980 cÚ¡ 
Com·¿tÜ
* 
u£r_cmp
 = 
šput_v”siÚ_
->
v£t_
->
icmp_
.
	`u£r_com·¿tÜ
();

981 
lvl
 = 
Ëv–_
 + 2;†vÈ< 
cÚfig
::
kNumLev–s
;†vl++) {

982 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
fes
 = 
šput_v”siÚ_
->
fes_
[
lvl
];

983 ; 
Ëv–_±rs_
[
lvl
] < 
fes
.
	`size
(); ) {

984 
FeM‘aD©a
* 
f
 = 
fes
[
Ëv–_±rs_
[
lvl
]];

985 ià(
u£r_cmp
->
	`Com·»
(
u£r_key
, 
f
->
Ïrge¡
.
	`u£r_key
()) <= 0) {

987 ià(
u£r_cmp
->
	`Com·»
(
u£r_key
, 
f
->
sm®Ë¡
.
	`u£r_key
()) >= 0) {

989  
çl£
;

993 
Ëv–_±rs_
[
lvl
]++;

996  
Œue
;

997 
	}
}

999 
boŞ
 
	gCom·ùiÚ
::
	$ShouldStİBefÜe
(cÚ¡ 
IÁ”ÇlKey
& 
key
) {

1001 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
* 
icmp
 = &
šput_v”siÚ_
->
v£t_
->
icmp_
;

1002 
g¿nd·»Á_šdex_
 < 
g¿nd·»Ás_
.
	`size
() &&

1003 
icmp
->
	`Com·»
(
key
, 
g¿nd·»Ás_
[
g¿nd·»Á_šdex_
]->
Ïrge¡
) > 0) {

1004 ià(
£’_key_
) {

1005 
ov”Ïµed_by‹s_
 +ğ
g¿nd·»Ás_
[
g¿nd·»Á_šdex_
]->
fe_size
;

1007 
g¿nd·»Á_šdex_
++;

1009 
£’_key_
 = 
Œue
;

1011 ià(
ov”Ïµed_by‹s_
 > 
kMaxG¿ndP¬’tOv”ÏpBy‹s
) {

1013 
ov”Ïµed_by‹s_
 = 0;

1014  
Œue
;

1016  
çl£
;

1018 
	}
}

1020 
	gCom·ùiÚ
::
	$R–—£IÅuts
() {

1021 ià(
šput_v”siÚ_
 !ğ
NULL
) {

1022 
šput_v”siÚ_
->
	`UÄef
();

1023 
šput_v”siÚ_
 = 
NULL
;

1025 
	}
}

	@db/version_set.h

15 #iâdeà
STORAGE_LEVELDB_DB_VERSION_SET_H_


16 
	#STORAGE_LEVELDB_DB_VERSION_SET_H_


	)

18 
	~<m­
>

19 
	~<£t
>

20 
	~<veùÜ
>

21 
	~"db/dbfÜm©.h
"

22 
	~"db/v”siÚ_ed™.h
"

23 
	~"pÜt/pÜt.h
"

25 
Çme¥aû
 
	gËv–db
 {

27 
Çme¥aû
 
	glog
 { 
şass
 
	gWr™”
; }

29 
şass
 
	gCom·ùiÚ
;

30 
şass
 
	gI‹¿tÜ
;

31 
şass
 
	gMemTabË
;

32 
şass
 
	gTabËBud”
;

33 
şass
 
	gTabËCache
;

34 
şass
 
	gV”siÚ
;

35 
şass
 
	gV”siÚS‘
;

36 
şass
 
	gWr™abËFe
;

38 şas 
	cV”siÚ
 {

39 
	gpublic
:

43 
AddI‹¿tÜs
(cÚ¡ 
R—dO±iÚs
&, 
¡d
::
veùÜ
<
I‹¿tÜ
*>* 
™”s
);

47 
Ref
();

48 
UÄef
();

51 
	g¡d
::
¡ršg
 
DebugSŒšg
() const;

53 
	g´iv©e
:

54 
ä›nd
 
şass
 
Com·ùiÚ
;

55 
ä›nd
 
şass
 
	gV”siÚS‘
;

57 
şass
 
	gLev–FeNumI‹¿tÜ
;

58 
I‹¿tÜ
* 
NewCÚÿ‹ÇtšgI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
&, 
Ëv–
) const;

60 
V”siÚS‘
* 
	gv£t_
;

61 
V”siÚ
* 
	gÃxt_
;

62 
	g»fs_
;

63 
MemTabË
* 
	gş—nup_mem_
;

66 
	g¡d
::
veùÜ
<
FeM‘aD©a
*> 
fes_
[
cÚfig
::
kNumLev–s
];

71 
	gcom·ùiÚ_scÜe_
;

72 
	gcom·ùiÚ_Ëv–_
;

74 
ex¶ic™
 
V”siÚ
(
V”siÚS‘
* 
v£t
)

75 : 
v£t_
(
v£t
), 
Ãxt_
(
NULL
), 
»fs_
(0),

76 
ş—nup_mem_
(
NULL
),

77 
com·ùiÚ_scÜe_
(-1),

78 
com·ùiÚ_Ëv–_
(-1) {

81 ~
V”siÚ
();

84 
V”siÚ
(const Version&);

85 
	gİ”©Ü
=(cÚ¡ 
V”siÚ
&);

88 şas 
	cV”siÚS‘
 {

89 
	gpublic
:

90 
V”siÚS‘
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
,

91 cÚ¡ 
O±iÚs
* 
İtiÚs
,

92 
TabËCache
* 
bË_ÿche
,

93 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
*);

94 ~
V”siÚS‘
();

101 
Stus
 
LogAndAµly
(
V”siÚEd™
* 
ed™
, 
MemTabË
* 
ş—nup_mem
);

104 
Stus
 
Recov”
();

107 
Stus
 
Wr™eSÇpshÙ
(
log
::
Wr™”
*†og);

110 
V”siÚ
* 
cu¼’t
(ècÚ¡ {  
	gcu¼’t_
; }

113 
ušt64_t
 
Mªiã¡FeNumb”
(ècÚ¡ {  
	gmªiã¡_fe_numb”_
; }

116 
ušt64_t
 
NewFeNumb”
(è{  
	gÃxt_fe_numb”_
++; }

119 
NumLev–Fes
(
Ëv–
) const;

122 
št64_t
 
NumLev–By‹s
(
Ëv–
) const;

125 
ušt64_t
 
La¡Sequ’û
(ècÚ¡ {  
	gÏ¡_£qu’û_
; }

128 
S‘La¡Sequ’û
(
ušt64_t
 
s
) {

129 
as£¹
(
s
 >ğ
Ï¡_£qu’û_
);

130 
	gÏ¡_£qu’û_
 = 
s
;

134 
ušt64_t
 
LogNumb”
(ècÚ¡ {  
	glog_numb”_
; }

138 
ušt64_t
 
P»vLogNumb”
(ècÚ¡ {  
	g´ev_log_numb”_
; }

144 
Com·ùiÚ
* 
PickCom·ùiÚ
();

150 
Com·ùiÚ
* 
Com·ùRªge
(

151 
Ëv–
,

152 cÚ¡ 
IÁ”ÇlKey
& 
begš
,

153 cÚ¡ 
IÁ”ÇlKey
& 
’d
);

157 
št64_t
 
MaxNextLev–Ov”ÏµšgBy‹s
();

161 
I‹¿tÜ
* 
MakeIÅutI‹¿tÜ
(
Com·ùiÚ
* 
c
);

164 
boŞ
 
N“dsCom·ùiÚ
(ècÚ¡ {  
	gcu¼’t_
->
	gcom·ùiÚ_scÜe_
 >= 1; }

168 
AddLiveFes
(
¡d
::
£t
<
ušt64_t
>* 
live
);

172 
ušt64_t
 
Aµroxim©eOff£tOf
(
V”siÚ
* 
v
, cÚ¡ 
IÁ”ÇlKey
& 
key
);

174 
	g´iv©e
:

175 
şass
 
Bud”
;

177 
ä›nd
 
şass
 
	gCom·ùiÚ
;

178 
ä›nd
 
şass
 
	gV”siÚ
;

180 
Stus
 
Fš®ize
(
V”siÚ
* 
v
);

183 
MaybeD–‘eOldV”siÚs
();

185 
	gBySm®Ë¡Key
;

186 
Stus
 
SÜtLev–
(
V”siÚ
* 
v
, 
ušt64_t
 
Ëv–
);

188 
G‘Ov”ÏµšgIÅuts
(

189 
Ëv–
,

190 cÚ¡ 
IÁ”ÇlKey
& 
begš
,

191 cÚ¡ 
IÁ”ÇlKey
& 
’d
,

192 
¡d
::
veùÜ
<
FeM‘aD©a
*>* 
šputs
);

194 
G‘Rªge
(cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
šputs
,

195 
IÁ”ÇlKey
* 
sm®Ë¡
,

196 
IÁ”ÇlKey
* 
Ïrge¡
);

198 
G‘Rªge2
(cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
šputs1
,

199 cÚ¡ 
¡d
::
veùÜ
<
FeM‘aD©a
*>& 
šputs2
,

200 
IÁ”ÇlKey
* 
sm®Ë¡
,

201 
IÁ”ÇlKey
* 
Ïrge¡
);

203 
S‘upOth”IÅuts
(
Com·ùiÚ
* 
c
);

205 
Env
* cÚ¡ 
	g’v_
;

206 cÚ¡ 
	g¡d
::
¡ršg
 
dbÇme_
;

207 cÚ¡ 
O±iÚs
* cÚ¡ 
	gİtiÚs_
;

208 
TabËCache
* cÚ¡ 
	gbË_ÿche_
;

209 cÚ¡ 
IÁ”ÇlKeyCom·¿tÜ
 
	gicmp_
;

210 
ušt64_t
 
	gÃxt_fe_numb”_
;

211 
ušt64_t
 
	gmªiã¡_fe_numb”_
;

212 
ušt64_t
 
	gÏ¡_£qu’û_
;

213 
ušt64_t
 
	glog_numb”_
;

214 
ušt64_t
 
	g´ev_log_numb”_
;

217 
Wr™abËFe
* 
	gdesütÜ_fe_
;

218 
	glog
::
Wr™”
* 
desütÜ_log_
;

221 
V”siÚ
* 
	gcu¼’t_
;

222 
V”siÚ
* 
	gŞde¡_
;

226 
	g¡d
::
¡ršg
 
com·ù_poš‹r_
[
cÚfig
::
kNumLev–s
];

229 
V”siÚS‘
(const VersionSet&);

230 
	gİ”©Ü
=(cÚ¡ 
V”siÚS‘
&);

234 şas 
	cCom·ùiÚ
 {

235 
	gpublic
:

236 ~
Com·ùiÚ
();

240 
Ëv–
(ècÚ¡ {  
	gËv–_
; }

244 
V”siÚEd™
* 
ed™
(è{  &
	ged™_
; }

247 
num_šput_fes
(
which
ècÚ¡ {  
	gšputs_
[which].
size
(); }

250 
FeM‘aD©a
* 
šput
(
which
, 
i
ècÚ¡ {  
	gšputs_
[which][i]; }

253 
ušt64_t
 
MaxOuutFeSize
(ècÚ¡ {  
	gmax_ouut_fe_size_
; }

257 
boŞ
 
IsTrivŸlMove
() const;

260 
AddIÅutD–‘iÚs
(
V”siÚEd™
* 
ed™
);

265 
boŞ
 
IsBa£Lev–FÜKey
(cÚ¡ 
Sliû
& 
u£r_key
);

269 
boŞ
 
ShouldStİBefÜe
(cÚ¡ 
IÁ”ÇlKey
& 
key
);

273 
R–—£IÅuts
();

275 
	g´iv©e
:

276 
ä›nd
 
şass
 
V”siÚ
;

277 
ä›nd
 
şass
 
	gV”siÚS‘
;

279 
ex¶ic™
 
Com·ùiÚ
(
Ëv–
);

281 
	gËv–_
;

282 
ušt64_t
 
	gmax_ouut_fe_size_
;

283 
V”siÚ
* 
	gšput_v”siÚ_
;

284 
V”siÚEd™
 
	ged™_
;

287 
	g¡d
::
veùÜ
<
FeM‘aD©a
*> 
šputs_
[2];

291 
	g¡d
::
veùÜ
<
FeM‘aD©a
*> 
g¿nd·»Ás_
;

292 
size_t
 
	gg¿nd·»Á_šdex_
;

293 
boŞ
 
	g£’_key_
;

294 
št64_t
 
	gov”Ïµed_by‹s_
;

303 
size_t
 
	gËv–_±rs_
[
cÚfig
::
kNumLev–s
];

	@db/write_batch.cc

16 
	~"Ëv–db/wr™e_b©ch.h
"

18 
	~"Ëv–db/db.h
"

19 
	~"db/dbfÜm©.h
"

20 
	~"db/membË.h
"

21 
	~"db/wr™e_b©ch_š‹º®.h
"

22 
	~"ut/codšg.h
"

24 
Çme¥aû
 
	gËv–db
 {

26 
	gWr™eB©ch
::
Wr™eB©ch
() {

27 
CË¬
();

30 
	gWr™eB©ch
::~
Wr™eB©ch
() { }

32 
Wr™eB©ch
::
CË¬
() {

33 
»p_
.
ş—r
();

34 
	g»p_
.
»size
(12);

37 
	gWr™eB©chIÁ”Çl
::
CouÁ
(cÚ¡ 
Wr™eB©ch
* 
b
) {

38  
DecodeFixed32
(
b
->
»p_
.
d©a
() + 8);

41 
	gWr™eB©chIÁ”Çl
::
S‘CouÁ
(
Wr™eB©ch
* 
b
, 
n
) {

42 
EncodeFixed32
(&
b
->
»p_
[8], 
n
);

45 
Sequ’ûNumb”
 
	gWr™eB©chIÁ”Çl
::
Sequ’û
(cÚ¡ 
Wr™eB©ch
* 
b
) {

46  
Sequ’ûNumb”
(
DecodeFixed64
(
b
->
»p_
.
d©a
()));

49 
	gWr™eB©chIÁ”Çl
::
S‘Sequ’û
(
Wr™eB©ch
* 
b
, 
Sequ’ûNumb”
 
£q
) {

50 
EncodeFixed64
(&
b
->
»p_
[0], 
£q
);

53 
	gWr™eB©ch
::
Put
(cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
v®ue
) {

54 
	gWr™eB©chIÁ”Çl
::
S‘CouÁ
(
this
, 
Wr™eB©chIÁ”Çl
::
CouÁ
(this) + 1);

55 
	g»p_
.
push_back
(
¡©ic_ÿ¡
<>(
kTy³V®ue
));

56 
PutL’gthP»fixedSliû
(&
»p_
, 
key
);

57 
PutL’gthP»fixedSliû
(&
»p_
, 
v®ue
);

60 
	gWr™eB©ch
::
D–‘e
(cÚ¡ 
Sliû
& 
key
) {

61 
Wr™eB©chIÁ”Çl
::
S‘CouÁ
(
this
, Wr™eB©chIÁ”Çl::
CouÁ
(this) + 1);

62 
	g»p_
.
push_back
(
¡©ic_ÿ¡
<>(
kTy³D–‘iÚ
));

63 
PutL’gthP»fixedSliû
(&
»p_
, 
key
);

66 
Stus
 
	gWr™eB©chIÁ”Çl
::
In£¹IÁo
(cÚ¡ 
Wr™eB©ch
* 
b
,

67 
MemTabË
* 
membË
) {

68 cÚ¡ 
	gcouÁ
 = 
Wr™eB©chIÁ”Çl
::
CouÁ
(
b
);

69 
	gfound
 = 0;

70 
I‹¿tÜ
 
™
(*
b
);

71 ; !
	g™
.
DÚe
(); it.
Next
()) {

72 
	g™
.
İ
()) {

73 
	gkTy³D–‘iÚ
:

74 
membË
->
Add
(
™
.
£qu’û_numb”
(), 
kTy³D–‘iÚ
, it.
key
(), 
Sliû
());

76 
	gkTy³V®ue
:

77 
membË
->
Add
(
™
.
£qu’û_numb”
(), 
kTy³V®ue
, it.
key
(), it.
v®ue
());

80 
	gfound
++;

82 ià(!
	g™
.
¡©us
().
ok
()) {

83  
	g™
.
¡©us
();

84 } ià(
	gfound
 !ğ
couÁ
) {

85  
Stus
::
CÜru±iÚ
("wrong count in WriteBatch");

87  
	gStus
::
OK
();

90 
	gWr™eB©chIÁ”Çl
::
S‘CÚ‹Ás
(
Wr™eB©ch
* 
b
, cÚ¡ 
Sliû
& 
cÚ‹Ás
) {

91 
as£¹
(
cÚ‹Ás
.
size
() >= 12);

92 
	gb
->
	g»p_
.
assign
(
cÚ‹Ás
.
d©a
(), cÚ‹Ás.
size
());

95 
	gWr™eB©chIÁ”Çl
::
I‹¿tÜ
::I‹¿tÜ(cÚ¡ 
Wr™eB©ch
& 
b©ch
)

96 : 
šput_
(
Wr™eB©chIÁ”Çl
::
CÚ‹Ás
(&
b©ch
)),

97 
dÚe_
(
çl£
) {

98 ià(
	gšput_
.
size
() < 12) {

99 
	gdÚe_
 = 
Œue
;

101 
	g£q_
 = 
Wr™eB©chIÁ”Çl
::
Sequ’û
(&
b©ch
),

102 
	gšput_
.
»move_´efix
(12);

103 
G‘NextEÁry
();

107 
	gWr™eB©chIÁ”Çl
::
I‹¿tÜ
::
Next
() {

108 
as£¹
(!
dÚe_
);

109 
	g£q_
++;

110 
G‘NextEÁry
();

113 
	gWr™eB©chIÁ”Çl
::
I‹¿tÜ
::
G‘NextEÁry
() {

114 ià(
šput_
.
em±y
()) {

115 
dÚe_
 = 
Œue
;

118 
	gg
 = 
šput_
[0];

119 
	gšput_
.
»move_´efix
(1);

120 
	gg
) {

121 
	gkTy³V®ue
:

122 ià(
G‘L’gthP»fixedSliû
(&
šput_
, &
key_
) &&

123 
G‘L’gthP»fixedSliû
(&
šput_
, &
v®ue_
)) {

124 
	gİ_
 = 
¡©ic_ÿ¡
<
V®ueTy³
>(
g
);

126 
	g¡©us_
 = 
Stus
::
CÜru±iÚ
("bad WriteBatch Put");

127 
	gdÚe_
 = 
Œue
;

128 
	gšput_
.
ş—r
();

131 
	gkTy³D–‘iÚ
:

132 ià(
G‘L’gthP»fixedSliû
(&
šput_
, &
key_
)) {

133 
	gİ_
 = 
kTy³D–‘iÚ
;

135 
	g¡©us_
 = 
Stus
::
CÜru±iÚ
("bad WriteBatch Delete");

136 
	gdÚe_
 = 
Œue
;

137 
	gšput_
.
ş—r
();

141 
¡©us_
 = 
Stus
::
CÜru±iÚ
("unknown WriteBatchag");

142 
	gdÚe_
 = 
Œue
;

143 
	gšput_
.
ş—r
();

	@db/write_batch_internal.h

5 #iâdeà
STORAGE_LEVELDB_DB_WRITE_BATCH_INTERNAL_H_


6 
	#STORAGE_LEVELDB_DB_WRITE_BATCH_INTERNAL_H_


	)

8 
	~"Ëv–db/wr™e_b©ch.h
"

10 
Çme¥aû
 
	gËv–db
 {

14 şas 
	cWr™eB©chIÁ”Çl
 {

15 
	gpublic
:

17 
CouÁ
(cÚ¡ 
Wr™eB©ch
* 
b©ch
);

20 
S‘CouÁ
(
Wr™eB©ch
* 
b©ch
, 
n
);

23 
Sequ’ûNumb”
 
Sequ’û
(cÚ¡ 
Wr™eB©ch
* 
b©ch
);

27 
S‘Sequ’û
(
Wr™eB©ch
* 
b©ch
, 
Sequ’ûNumb”
 
£q
);

29 
Sliû
 
CÚ‹Ás
(cÚ¡ 
Wr™eB©ch
* 
b©ch
) {

30  
Sliû
(
b©ch
->
»p_
);

33 
size_t
 
By‹Size
(cÚ¡ 
Wr™eB©ch
* 
b©ch
) {

34  
	gb©ch
->
	g»p_
.
size
();

37 
S‘CÚ‹Ás
(
Wr™eB©ch
* 
b©ch
, cÚ¡ 
Sliû
& 
cÚ‹Ás
);

39 
Stus
 
In£¹IÁo
(cÚ¡ 
Wr™eB©ch
* 
b©ch
, 
MemTabË
* 
membË
);

42 şas 
	cI‹¿tÜ
 {

43 
	gpublic
:

44 
ex¶ic™
 
I‹¿tÜ
(cÚ¡ 
Wr™eB©ch
& 
b©ch
);

45 
boŞ
 
DÚe
(ècÚ¡ {  
	gdÚe_
; }

46 
Next
();

47 
V®ueTy³
 
İ
(ècÚ¡ {  
	gİ_
; }

48 cÚ¡ 
	gSliû
& 
key
(ècÚ¡ {  
	gkey_
; }

49 cÚ¡ 
	gSliû
& 
v®ue
(ècÚ¡ {  
	gv®ue_
; }

50 
Sequ’ûNumb”
 
£qu’û_numb”
(ècÚ¡ {  
	g£q_
; }

51 
Stus
 
¡©us
(ècÚ¡ {  
	g¡©us_
; }

53 
	g´iv©e
:

54 
G‘NextEÁry
();

56 
Sliû
 
	gšput_
;

57 
boŞ
 
	gdÚe_
;

58 
V®ueTy³
 
	gİ_
;

59 
Sliû
 
	gkey_
;

60 
Sliû
 
	gv®ue_
;

61 
Sequ’ûNumb”
 
	g£q_
;

62 
Stus
 
	g¡©us_
;

	@db/write_batch_test.cc

5 
	~"Ëv–db/db.h
"

7 
	~"db/membË.h
"

8 
	~"db/wr™e_b©ch_š‹º®.h
"

9 
	~"Ëv–db/’v.h
"

10 
	~"ut/loggšg.h
"

11 
	~"ut/‹¡h¬Ãss.h
"

13 
Çme¥aû
 
	gËv–db
 {

15 
	g¡d
::
¡ršg
 
PrštCÚ‹Ás
(
Wr™eB©ch
* 
b
) {

16 
IÁ”ÇlKeyCom·¿tÜ
 
cmp
(
By‹wi£Com·¿tÜ
());

17 
MemTabË
 
mem
(
cmp
);

18 
	g¡d
::
¡ršg
 
¡©e
;

19 
Stus
 
	gs
 = 
Wr™eB©chIÁ”Çl
::
In£¹IÁo
(
b
, &
mem
);

20 
I‹¿tÜ
* 
	g™”
 = 
mem
.
NewI‹¿tÜ
();

21 
	g™”
->
S“kToFœ¡
(); i‹r->
V®id
(); i‹r->
Next
()) {

22 
P¬£dIÁ”ÇlKey
 
	gikey
;

23 
ASSERT_TRUE
(
P¬£IÁ”ÇlKey
(
™”
->
key
(), &
ikey
));

24 
	gikey
.
	gty³
) {

25 
	gkTy³V®ue
:

26 
¡©e
.
­³nd
("Put(");

27 
	g¡©e
.
­³nd
(
ikey
.
u£r_key
.
ToSŒšg
());

28 
	g¡©e
.
­³nd
(", ");

29 
	g¡©e
.
­³nd
(
™”
->
v®ue
().
ToSŒšg
());

30 
	g¡©e
.
­³nd
(")");

32 
	gkTy³D–‘iÚ
:

33 
¡©e
.
­³nd
("Delete(");

34 
	g¡©e
.
­³nd
(
ikey
.
u£r_key
.
ToSŒšg
());

35 
	g¡©e
.
­³nd
(")");

38 
	g¡©e
.
­³nd
("@");

39 
	g¡©e
.
­³nd
(
Numb”ToSŒšg
(
ikey
.
£qu’û
));

41 
d–‘e
 
	g™”
;

42 ià(!
	gs
.
ok
()) {

43 
	g¡©e
.
­³nd
("ParseError()");

45  
	g¡©e
;

48 şas 
	cWr™eB©chTe¡
 { };

50 
	$TEST
(
Wr™eB©chTe¡
, 
Em±y
) {

51 
Wr™eB©ch
 
b©ch
;

52 
	`ASSERT_EQ
("", 
	`PrštCÚ‹Ás
(&
b©ch
));

53 
	`ASSERT_EQ
(0, 
Wr™eB©chIÁ”Çl
::
	`CouÁ
(&
b©ch
));

54 
	}
}

56 
	$TEST
(
Wr™eB©chTe¡
, 
MuÉË
) {

57 
Wr™eB©ch
 
b©ch
;

58 
b©ch
.
	`Put
(
	`Sliû
("foo"), Slice("bar"));

59 
b©ch
.
	`D–‘e
(
	`Sliû
("box"));

60 
b©ch
.
	`Put
(
	`Sliû
("baz"), Slice("boo"));

61 
Wr™eB©chIÁ”Çl
::
	`S‘Sequ’û
(&
b©ch
, 100);

62 
	`ASSERT_EQ
(100, 
Wr™eB©chIÁ”Çl
::
	`Sequ’û
(&
b©ch
));

63 
	`ASSERT_EQ
(3, 
Wr™eB©chIÁ”Çl
::
	`CouÁ
(&
b©ch
));

64 
	`ASSERT_EQ
("Put(baz, boo)@102"

67 
	`PrštCÚ‹Ás
(&
b©ch
));

68 
	}
}

70 
	$TEST
(
Wr™eB©chTe¡
, 
CÜru±iÚ
) {

71 
Wr™eB©ch
 
b©ch
;

72 
b©ch
.
	`Put
(
	`Sliû
("foo"), Slice("bar"));

73 
b©ch
.
	`D–‘e
(
	`Sliû
("box"));

74 
Wr™eB©chIÁ”Çl
::
	`S‘Sequ’û
(&
b©ch
, 200);

75 
Sliû
 
cÚ‹Ás
 = 
Wr™eB©chIÁ”Çl
::
	`CÚ‹Ás
(&
b©ch
);

76 
Wr™eB©chIÁ”Çl
::
	`S‘CÚ‹Ás
(&
b©ch
,

77 
	`Sliû
(
cÚ‹Ás
.
	`d©a
(),cÚ‹Ás.
	`size
()-1));

78 
	`ASSERT_EQ
("Put(foo, bar)@200"

80 
	`PrštCÚ‹Ás
(&
b©ch
));

81 
	}
}

85 
	$maš
(
¬gc
, ** 
¬gv
) {

86  
Ëv–db
::
‹¡
::
	`RunAÎTe¡s
();

87 
	}
}

	@include/leveldb/cache.h

18 #iâdeà
STORAGE_LEVELDB_INCLUDE_CACHE_H_


19 
	#STORAGE_LEVELDB_INCLUDE_CACHE_H_


	)

21 
	~<¡dšt.h
>

22 
	~"Ëv–db/¦iû.h
"

24 
Çme¥aû
 
	gËv–db
 {

26 
şass
 
	gCache
;

30 
Cache
* 
NewLRUCache
(
size_t
 
ÿ·c™y
);

32 şas 
	cCache
 {

33 
	gpublic
:

34 
Cache
() { }

38 
vœtu®
 ~
Cache
();

41 
	sHªdË
 { };

52 
vœtu®
 
HªdË
* 
In£¹
(cÚ¡ 
Sliû
& 
key
, * 
v®ue
, 
size_t
 
ch¬ge
,

53 (*
d–‘”
)(cÚ¡ 
Sliû
& 
key
, * 
v®ue
)) = 0;

60 
vœtu®
 
HªdË
* 
Lookup
(cÚ¡ 
Sliû
& 
key
) = 0;

65 
vœtu®
 
R–—£
(
HªdË
* 
hªdË
) = 0;

71 
vœtu®
 * 
V®ue
(
HªdË
* 
hªdË
) = 0;

76 
vœtu®
 
E¿£
(cÚ¡ 
Sliû
& 
key
) = 0;

82 
vœtu®
 
ušt64_t
 
NewId
() = 0;

84 
	g´iv©e
:

85 
LRU_Remove
(
HªdË
* 
e
);

86 
LRU_Aµ’d
(
HªdË
* 
e
);

87 
UÄef
(
HªdË
* 
e
);

89 
	gR•
;

90 
R•
* 
	g»p_
;

93 
Cache
(const Cache&);

94 
	gİ”©Ü
=(cÚ¡ 
Cache
&);

	@include/leveldb/comparator.h

5 #iâdeà
STORAGE_LEVELDB_INCLUDE_COMPARATOR_H_


6 
	#STORAGE_LEVELDB_INCLUDE_COMPARATOR_H_


	)

8 
	~<¡ršg
>

10 
Çme¥aû
 
	gËv–db
 {

12 
şass
 
	gSliû
;

16 şas 
	cCom·¿tÜ
 {

17 
	gpublic
:

18 
vœtu®
 ~
Com·¿tÜ
();

24 
vœtu®
 
Com·»
(cÚ¡ 
Sliû
& 
a
, cÚ¡ Sliû& 
b
) const = 0;

36 
vœtu®
 cÚ¡ * 
Name
() const = 0;

44 
vœtu®
 
FšdShÜ‹¡S•¬©Ü
(

45 
¡d
::
¡ršg
* 
¡¬t
,

46 cÚ¡ 
Sliû
& 
lim™
) const = 0;

51 
vœtu®
 
FšdShÜtSucûssÜ
(
¡d
::
¡ršg
* 
key
) const = 0;

57 cÚ¡ 
Com·¿tÜ
* 
By‹wi£Com·¿tÜ
();

	@include/leveldb/db.h

5 #iâdeà
STORAGE_LEVELDB_INCLUDE_DB_H_


6 
	#STORAGE_LEVELDB_INCLUDE_DB_H_


	)

8 
	~<¡dšt.h
>

9 
	~<¡dio.h
>

10 
	~"Ëv–db/™”©Ü.h
"

11 
	~"Ëv–db/İtiÚs.h
"

13 
Çme¥aû
 
	gËv–db
 {

15 cÚ¡ 
	gkMajÜV”siÚ
 = 1;

16 cÚ¡ 
	gkMšÜV”siÚ
 = 1;

18 
	gO±iÚs
;

19 
	gR—dO±iÚs
;

20 
	gWr™eO±iÚs
;

22 
şass
 
	gSÇpshÙ
;

23 
şass
 
	gWr™eB©ch
;

26 
şass
 
	gWr™eB©chIÁ”Çl
;

28 
	sRªge
 {

29 
Sliû
 
	g¡¬t
;

30 
Sliû
 
	glim™
;

32 
Rªge
(cÚ¡ 
Sliû
& 
s
, cÚ¡ Sliû& 
l
è: 
¡¬t
(s), 
lim™
(l) { }

36 şas 
	cDB
 {

37 
	gpublic
:

43 
Stus
 
O³n
(cÚ¡ 
O±iÚs
& 
İtiÚs
,

44 cÚ¡ 
¡d
::
¡ršg
& 
Çme
,

45 
DB
** 
db±r
);

47 
DB
() { }

48 
	gvœtu®
 ~
DB
();

53 
vœtu®
 
Stus
 
Put
(cÚ¡ 
Wr™eO±iÚs
& 
İtiÚs
,

54 cÚ¡ 
Sliû
& 
key
,

55 cÚ¡ 
Sliû
& 
v®ue
) = 0;

61 
vœtu®
 
Stus
 
D–‘e
(cÚ¡ 
Wr™eO±iÚs
& 
İtiÚs
, cÚ¡ 
Sliû
& 
key
) = 0;

66 
vœtu®
 
Stus
 
Wr™e
(cÚ¡ 
Wr™eO±iÚs
& 
İtiÚs
, 
Wr™eB©ch
* 
upd©es
) = 0;

75 
vœtu®
 
Stus
 
G‘
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
,

76 cÚ¡ 
Sliû
& 
key
, 
¡d
::
¡ršg
* 
v®ue
) = 0;

84 
vœtu®
 
I‹¿tÜ
* 
NewI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
) = 0;

90 
vœtu®
 cÚ¡ 
SÇpshÙ
* 
G‘SÇpshÙ
() = 0;

94 
vœtu®
 
R–—£SÇpshÙ
(cÚ¡ 
SÇpshÙ
* 
¢­shÙ
) = 0;

108 
vœtu®
 
boŞ
 
G‘Prİ”ty
(cÚ¡ 
Sliû
& 
´İ”ty
, 
¡d
::
¡ršg
* 
v®ue
) = 0;

118 
vœtu®
 
G‘Aµroxim©eSizes
(cÚ¡ 
Rªge
* 
¿nge
, 
n
,

119 
ušt64_t
* 
sizes
) = 0;

124 
	g´iv©e
:

126 
DB
(const DB&);

127 
	gİ”©Ü
=(cÚ¡ 
DB
&);

132 
Stus
 
De¡royDB
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, cÚ¡ 
O±iÚs
& 
İtiÚs
);

138 
Stus
 
R•aœDB
(cÚ¡ 
¡d
::
¡ršg
& 
dbÇme
, cÚ¡ 
O±iÚs
& 
İtiÚs
);

	@include/leveldb/env.h

10 #iâdeà
STORAGE_LEVELDB_INCLUDE_ENV_H_


11 
	#STORAGE_LEVELDB_INCLUDE_ENV_H_


	)

13 
	~<c¡d¬g
>

14 
	~<¡ršg
>

15 
	~<veùÜ
>

16 
	~<¡dšt.h
>

17 
	~"Ëv–db/¡©us.h
"

19 
Çme¥aû
 
	gËv–db
 {

21 
şass
 
	gFeLock
;

22 
şass
 
	gRªdomAcûssFe
;

23 
şass
 
	gSequ’tŸlFe
;

24 
şass
 
	gSliû
;

25 
şass
 
	gWr™abËFe
;

27 şas 
	cEnv
 {

28 
	gpublic
:

29 
Env
() { }

30 
vœtu®
 ~
Env
();

37 
Env
* 
DeçuÉ
();

45 
vœtu®
 
Stus
 
NewSequ’tŸlFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
,

46 
Sequ’tŸlFe
** 
»suÉ
) = 0;

55 
vœtu®
 
Stus
 
NewRªdomAcûssFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
,

56 
RªdomAcûssFe
** 
»suÉ
) = 0;

65 
vœtu®
 
Stus
 
NewWr™abËFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
,

66 
Wr™abËFe
** 
»suÉ
) = 0;

69 
vœtu®
 
boŞ
 
FeExi¡s
(cÚ¡ 
¡d
::
¡ršg
& 
âame
) = 0;

74 
vœtu®
 
Stus
 
G‘Chd»n
(cÚ¡ 
¡d
::
¡ršg
& 
dœ
,

75 
¡d
::
veùÜ
<¡d::
¡ršg
>* 
»suÉ
) = 0;

78 
vœtu®
 
Stus
 
D–‘eFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
) = 0;

81 
vœtu®
 
Stus
 
C»©eDœ
(cÚ¡ 
¡d
::
¡ršg
& 
dœÇme
) = 0;

84 
vœtu®
 
Stus
 
D–‘eDœ
(cÚ¡ 
¡d
::
¡ršg
& 
dœÇme
) = 0;

87 
vœtu®
 
Stus
 
G‘FeSize
(cÚ¡ 
¡d
::
¡ršg
& 
âame
, 
ušt64_t
* 
fe_size
) = 0;

90 
vœtu®
 
Stus
 
R’ameFe
(cÚ¡ 
¡d
::
¡ršg
& 
¤c
,

91 cÚ¡ 
¡d
::
¡ršg
& 
rg‘
) = 0;

107 
vœtu®
 
Stus
 
LockFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
, 
FeLock
** 
lock
) = 0;

112 
vœtu®
 
Stus
 
UÆockFe
(
FeLock
* 
lock
) = 0;

120 
vœtu®
 
ScheduË
(

121 (*
funùiÚ
)(* 
¬g
),

122 * 
¬g
) = 0;

126 
vœtu®
 
S¹Th»ad
((*
funùiÚ
)(* 
¬g
), *‡rg) = 0;

132 
vœtu®
 
Stus
 
G‘Te¡DœeùÜy
(
¡d
::
¡ršg
* 
·th
) = 0;

135 
vœtu®
 
Logv
(
Wr™abËFe
* 
log
, cÚ¡ * 
fÜm©
, 
va_li¡
 
­
) = 0;

139 
vœtu®
 
ušt64_t
 
NowMiüos
() = 0;

142 
vœtu®
 
SË•FÜMiüo£cÚds
(
miüos
) = 0;

144 
	g´iv©e
:

146 
Env
(const Env&);

147 
	gİ”©Ü
=(cÚ¡ 
Env
&);

151 şas 
	cSequ’tŸlFe
 {

152 
	gpublic
:

153 
Sequ’tŸlFe
() { }

154 
vœtu®
 ~
Sequ’tŸlFe
();

162 
vœtu®
 
Stus
 
R—d
(
size_t
 
n
, 
Sliû
* 
»suÉ
, * 
sü©ch
) = 0;

166 şas 
	cRªdomAcûssFe
 {

167 
	gpublic
:

168 
RªdomAcûssFe
() { }

169 
vœtu®
 ~
RªdomAcûssFe
();

178 
vœtu®
 
Stus
 
R—d
(
ušt64_t
 
off£t
, 
size_t
 
n
, 
Sliû
* 
»suÉ
,

179 * 
sü©ch
) const = 0;

185 şas 
	cWr™abËFe
 {

186 
	gpublic
:

187 
Wr™abËFe
() { }

188 
vœtu®
 ~
Wr™abËFe
();

190 
vœtu®
 
Stus
 
Aµ’d
(cÚ¡ 
Sliû
& 
d©a
) = 0;

191 
vœtu®
 
Stus
 
Clo£
() = 0;

192 
vœtu®
 
Stus
 
Flush
() = 0;

193 
vœtu®
 
Stus
 
Sync
() = 0;

195 
	g´iv©e
:

197 
Wr™abËFe
(const WritableFile&);

198 
	gİ”©Ü
=(cÚ¡ 
Wr™abËFe
&);

202 şas 
	cFeLock
 {

203 
	gpublic
:

204 
FeLock
() { }

205 
vœtu®
 ~
FeLock
();

206 
	g´iv©e
:

208 
FeLock
(const FileLock&);

209 
	gİ”©Ü
=(cÚ¡ 
FeLock
&);

213 
	$Log
(
Env
* 
’v
, 
Wr™abËFe
* 
šfo_log
, cÚ¡ * 
fÜm©
, ...)

214 #ià
	`defšed
(
__GNUC__
è|| 
	$defšed
(
__şªg__
)

215 
	`__©Œibu‹__
((
	$__fÜm©__
 (
__´štf__
, 3, 4)))

220 
Stus
 
	`Wr™eSŒšgToFe
(
Env
* 
’v
, cÚ¡ 
Sliû
& 
d©a
,

221 cÚ¡ 
¡d
::
¡ršg
& 
âame
);

224 
Stus
 
	`R—dFeToSŒšg
(
Env
* 
’v
, cÚ¡ 
¡d
::
¡ršg
& 
âame
,

225 
¡d
::
¡ršg
* 
d©a
);

230 şas 
	cEnvW¿µ”
 : 
public
 
Env
 {

231 
public
:

233 
ex¶ic™
 
	`EnvW¿µ”
(
Env
* 
rg‘
è: 
	`rg‘_
(target) { }

234 
vœtu®
 ~
	`EnvW¿µ”
();

237 
Env
* 
	`rg‘
(ècÚ¡ {  
rg‘_
; }

240 
Stus
 
	`NewSequ’tŸlFe
(cÚ¡ 
¡d
::
¡ršg
& 
f
, 
Sequ’tŸlFe
** 
r
) {

241  
rg‘_
->
	`NewSequ’tŸlFe
(
f
, 
r
);

243 
Stus
 
	`NewRªdomAcûssFe
(cÚ¡ 
¡d
::
¡ršg
& 
f
, 
RªdomAcûssFe
** 
r
) {

244  
rg‘_
->
	`NewRªdomAcûssFe
(
f
, 
r
);

246 
Stus
 
	`NewWr™abËFe
(cÚ¡ 
¡d
::
¡ršg
& 
f
, 
Wr™abËFe
** 
r
) {

247  
rg‘_
->
	`NewWr™abËFe
(
f
, 
r
);

249 
boŞ
 
	`FeExi¡s
(cÚ¡ 
¡d
::
¡ršg
& 
f
è{  
rg‘_
->FileExists(f); }

250 
Stus
 
	`G‘Chd»n
(cÚ¡ 
¡d
::
¡ršg
& 
dœ
, std::
veùÜ
<¡d::¡ršg>* 
r
) {

251  
rg‘_
->
	`G‘Chd»n
(
dœ
, 
r
);

253 
Stus
 
	`D–‘eFe
(cÚ¡ 
¡d
::
¡ršg
& 
f
è{  
rg‘_
->DeleteFile(f); }

254 
Stus
 
	`C»©eDœ
(cÚ¡ 
¡d
::
¡ršg
& 
d
è{  
rg‘_
->CreateDir(d); }

255 
Stus
 
	`D–‘eDœ
(cÚ¡ 
¡d
::
¡ršg
& 
d
è{  
rg‘_
->DeleteDir(d); }

256 
Stus
 
	`G‘FeSize
(cÚ¡ 
¡d
::
¡ršg
& 
f
, 
ušt64_t
* 
s
) {

257  
rg‘_
->
	`G‘FeSize
(
f
, 
s
);

259 
Stus
 
	`R’ameFe
(cÚ¡ 
¡d
::
¡ršg
& 
s
, cÚ¡ std::¡ršg& 
t
) {

260  
rg‘_
->
	`R’ameFe
(
s
, 
t
);

262 
Stus
 
	`LockFe
(cÚ¡ 
¡d
::
¡ršg
& 
f
, 
FeLock
** 
l
) {

263  
rg‘_
->
	`LockFe
(
f
, 
l
);

265 
Stus
 
	`UÆockFe
(
FeLock
* 
l
è{  
rg‘_
->UnlockFile(l); }

266 
	`ScheduË
((*
f
)(*), * 
a
) {

267  
rg‘_
->
	`ScheduË
(
f
, 
a
);

269 
	`S¹Th»ad
((*
f
)(*), * 
a
) {

270  
rg‘_
->
	`S¹Th»ad
(
f
, 
a
);

272 
vœtu®
 
Stus
 
	`G‘Te¡DœeùÜy
(
¡d
::
¡ršg
* 
·th
) {

273  
rg‘_
->
	`G‘Te¡DœeùÜy
(
·th
);

275 
vœtu®
 
	`Logv
(
Wr™abËFe
* 
log
, cÚ¡ * 
fÜm©
, 
va_li¡
 
­
) {

276  
rg‘_
->
	`Logv
(
log
, 
fÜm©
, 
­
);

278 
ušt64_t
 
	`NowMiüos
() {

279  
rg‘_
->
	`NowMiüos
();

281 
	`SË•FÜMiüo£cÚds
(
miüos
) {

282 
rg‘_
->
	`SË•FÜMiüo£cÚds
(
miüos
);

284 
´iv©e
:

285 
Env
* 
rg‘_
;

286 
	}
};

	@include/leveldb/iterator.h

10 #iâdeà
STORAGE_LEVELDB_INCLUDE_ITERATOR_H_


11 
	#STORAGE_LEVELDB_INCLUDE_ITERATOR_H_


	)

13 
	~"Ëv–db/¦iû.h
"

14 
	~"Ëv–db/¡©us.h
"

16 
Çme¥aû
 
	gËv–db
 {

18 şas 
	cI‹¿tÜ
 {

19 
	gpublic
:

20 
I‹¿tÜ
();

21 
	gvœtu®
 ~
I‹¿tÜ
();

25 
vœtu®
 
boŞ
 
V®id
() const = 0;

29 
vœtu®
 
S“kToFœ¡
() = 0;

33 
vœtu®
 
S“kToLa¡
() = 0;

38 
vœtu®
 
S“k
(cÚ¡ 
Sliû
& 
rg‘
) = 0;

43 
vœtu®
 
Next
() = 0;

48 
vœtu®
 
P»v
() = 0;

54 
vœtu®
 
Sliû
 
key
() const = 0;

60 
vœtu®
 
Sliû
 
v®ue
() const = 0;

63 
vœtu®
 
Stus
 
¡©us
() const = 0;

70 (*
	gCËªupFunùiÚ
)(* 
	t¬g1
, * 
	t¬g2
);

71 
Regi¡”CËªup
(
CËªupFunùiÚ
 
funùiÚ
, * 
¬g1
, * 
¬g2
);

73 
	g´iv©e
:

74 
	sCËªup
 {

75 
CËªupFunùiÚ
 
funùiÚ
;

76 * 
	g¬g1
;

77 * 
	g¬g2
;

78 
CËªup
* 
	gÃxt
;

80 
CËªup
 
	gş—nup_
;

83 
I‹¿tÜ
(const Iterator&);

84 
	gİ”©Ü
=(cÚ¡ 
I‹¿tÜ
&);

88 
I‹¿tÜ
* 
NewEm±yI‹¿tÜ
();

91 
I‹¿tÜ
* 
NewE¼ÜI‹¿tÜ
(cÚ¡ 
Stus
& 
¡©us
);

	@include/leveldb/options.h

5 #iâdeà
STORAGE_LEVELDB_INCLUDE_OPTIONS_H_


6 
	#STORAGE_LEVELDB_INCLUDE_OPTIONS_H_


	)

8 
	~<¡ddef.h
>

10 
Çme¥aû
 
	gËv–db
 {

12 
şass
 
	gCache
;

13 
şass
 
	gCom·¿tÜ
;

14 
şass
 
	gEnv
;

15 
şass
 
	gSÇpshÙ
;

16 
şass
 
	gWr™abËFe
;

22 
	eCom´essiÚTy³
 {

25 
	gkNoCom´essiÚ
 = 0x0,

26 
	gkSÇµyCom´essiÚ
 = 0x1,

30 
	sO±iÚs
 {

40 cÚ¡ 
Com·¿tÜ
* 
	gcom·¿tÜ
;

44 
boŞ
 
	gü—‹_if_missšg
;

48 
boŞ
 
	g”rÜ_if_exi¡s
;

56 
boŞ
 
	g·¿noid_checks
;

61 
Env
* 
	g’v
;

67 
Wr™abËFe
* 
	gšfo_log
;

80 
size_t
 
	gwr™e_bufãr_size
;

87 
	gmax_İ’_fes
;

95 
Cache
* 
	gblock_ÿche
;

103 
size_t
 
	gblock_size
;

110 
	gblock_»¡¬t_š‹rv®
;

126 
Com´essiÚTy³
 
	gcom´essiÚ
;

129 
O±iÚs
();

133 
	sR—dO±iÚs
 {

137 
boŞ
 
	gv”ify_checksums
;

142 
boŞ
 
	gfl_ÿche
;

149 cÚ¡ 
SÇpshÙ
* 
	g¢­shÙ
;

151 
R—dO±iÚs
()

152 : 
v”ify_checksums
(
çl£
),

153 
fl_ÿche
(
Œue
),

154 
¢­shÙ
(
NULL
) {

159 
	sWr™eO±iÚs
 {

176 
boŞ
 
	gsync
;

188 cÚ¡ 
SÇpshÙ
** 
	gpo¡_wr™e_¢­shÙ
;

190 
Wr™eO±iÚs
()

191 : 
sync
(
çl£
),

192 
po¡_wr™e_¢­shÙ
(
NULL
) {

	@include/leveldb/slice.h

10 #iâdeà
STORAGE_LEVELDB_INCLUDE_SLICE_H_


11 
	#STORAGE_LEVELDB_INCLUDE_SLICE_H_


	)

13 
	~<as£¹.h
>

14 
	~<¡ddef.h
>

15 
	~<¡ršg.h
>

16 
	~<¡ršg
>

18 
Çme¥aû
 
	gËv–db
 {

20 şas 
	cSliû
 {

21 
	gpublic
:

23 
Sliû
(è: 
d©a_
(""), 
size_
(0) { }

26 
Sliû
(cÚ¡ * 
d©a
, 
size_t
 
n
è: 
d©a_
(d©a), 
size_
(n) { }

29 
Sliû
(cÚ¡ 
¡d
::
¡ršg
& 
s
è: 
d©a_
(s.
d©a
()), 
size_
(s.
size
()) { }

32 
Sliû
(cÚ¡ * 
s
è: 
d©a_
(s), 
size_
(
¡¾’
(s)) { }

35 cÚ¡ * 
d©a
(ècÚ¡ {  
	gd©a_
; }

38 
size_t
 
size
(ècÚ¡ {  
	gsize_
; }

41 
boŞ
 
em±y
(ècÚ¡ {  
	gsize_
 == 0; }

45 
	gİ”©Ü
[](
size_t
 
	gn
) const {

46 
as£¹
(
n
 < 
size
());

47  
	gd©a_
[
n
];

51 
ş—r
(è{ 
	gd©a_
 = ""; 
	gsize_
 = 0; }

54 
»move_´efix
(
size_t
 
n
) {

55 
as£¹
(
n
 <ğ
size
());

56 
	gd©a_
 +ğ
n
;

57 
	gsize_
 -ğ
n
;

61 
	g¡d
::
¡ršg
 
ToSŒšg
(ècÚ¡ {  
¡d
::¡ršg(
d©a_
, 
size_
); }

67 
com·»
(cÚ¡ 
Sliû
& 
b
) const;

70 
boŞ
 
¡¬ts_w™h
(cÚ¡ 
Sliû
& 
x
) const {

71  ((
	gsize_
 >ğ
x
.
size_
) &&

72 (
memcmp
(
d©a_
, 
x
.d©a_, x.
size_
) == 0));

75 
	g´iv©e
:

76 cÚ¡ * 
d©a_
;

77 
size_t
 
	gsize_
;

82 
šlše
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
Sliû
& 
x
, cÚ¡ 
	gSliû
& 
	gy
) {

83  ((
	gx
.
size
(è=ğ
y
.size()) &&

84 (
memcmp
(
x
.
d©a
(), 
y
.d©a(), x.
size
()) == 0));

87 
šlše
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
Sliû
& 
x
, cÚ¡ 
	gSliû
& 
	gy
) {

88  !(
	gx
 =ğ
y
);

91 
šlše
 
	gSliû
::
	$com·»
(cÚ¡ 
Sliû
& 
b
) const {

92 cÚ¡ 
mš_Ën
 = (
size_
 < 
b
.size_) ? size_ : b.size_;

93 
r
 = 
	`memcmp
(
d©a_
, 
b
.d©a_, 
mš_Ën
);

94 ià(
r
 == 0) {

95 ià(
size_
 < 
b
.size_è
r
 = -1;

96 ià(
size_
 > 
b
.size_è
r
 = +1;

98  
r
;

99 
	}
}

	@include/leveldb/status.h

8 #iâdeà
STORAGE_LEVELDB_INCLUDE_STATUS_H_


9 
	#STORAGE_LEVELDB_INCLUDE_STATUS_H_


	)

11 
	~<¡ršg
>

12 
	~<ut™y
>

13 
	~"Ëv–db/¦iû.h
"

15 
Çme¥aû
 
	gËv–db
 {

17 şas 
	cStus
 {

18 
	gpublic
:

20 
Stus
(è: 
¡©e_
(
NULL
) { }

21 ~
Stus
(è{ 
d–‘e
 
¡©e_
; }

24 
Stus
(cÚ¡ Stus& 
s
);

25 
	gİ”©Ü
=(cÚ¡ 
Stus
& 
s
);

28 
Stus
 
OK
() {  Status(); }

31 
Stus
 
NÙFound
(cÚ¡ 
Sliû
& 
msg
, cÚ¡ Sliû& 
msg2
 = Slice()) {

32  
Stus
(
kNÙFound
, 
msg
, 
Sliû
());

34 
Stus
 
CÜru±iÚ
(cÚ¡ 
Sliû
& 
msg
, cÚ¡ Sliû& 
msg2
 = Slice()) {

35  
Stus
(
kCÜru±iÚ
, 
msg
, 
msg2
);

37 
Stus
 
NÙSuµÜ‹d
(cÚ¡ 
Sliû
& 
msg
, cÚ¡ Sliû& 
msg2
 = Slice()) {

38  
Stus
(
kNÙSuµÜ‹d
, 
msg
, 
msg2
);

40 
Stus
 
Inv®idArgum’t
(cÚ¡ 
Sliû
& 
msg
, cÚ¡ Sliû& 
msg2
 = Slice()) {

41  
Stus
(
kInv®idArgum’t
, 
msg
, 
msg2
);

43 
Stus
 
IOE¼Ü
(cÚ¡ 
Sliû
& 
msg
, cÚ¡ Sliû& 
msg2
 = Slice()) {

44  
Stus
(
kIOE¼Ü
, 
msg
, 
msg2
);

48 
boŞ
 
ok
(ècÚ¡ {  (
	g¡©e_
 =ğ
NULL
); }

51 
boŞ
 
IsNÙFound
(ècÚ¡ {  
code
(è=ğ
kNÙFound
; }

55 
	g¡d
::
¡ršg
 
ToSŒšg
() const;

57 
	g´iv©e
:

58 
	eCode
 {

59 
kOk
 = 0,

60 
	gkNÙFound
 = 1,

61 
	gkCÜru±iÚ
 = 2,

62 
	gkNÙSuµÜ‹d
 = 3,

63 
	gkInv®idArgum’t
 = 4,

64 
	gkIOE¼Ü
 = 5,

66 
Code
 
code
(ècÚ¡ {  (
	g¡©e_
 =ğ
NULL
è? 
kOk
 : 
¡©e_
->
fœ¡
; }

68 
Stus
(
Code
 
code
, cÚ¡ 
Sliû
& 
msg
, cÚ¡ Sliû& 
msg2
);

70 
	g¡d
::
	t·œ
<
	tCode
, 
	t¡d
::
	t¡ršg
> 
	tS‹
;

71 
S‹
* 
	g¡©e_
;

74 
šlše
 
	gStus
::
	$Stus
(cÚ¡ 
Stus
& 
s
) {

75 
¡©e_
 = (
s
.¡©e_ =ğ
NULL
è? NULL : 
Ãw
 
	`S‹
(*s.state_);

76 
	}
}

77 
šlše
 
	gStus
::
İ”©Ü
=(cÚ¡ 
Stus
& 
s
) {

78 ià(
this
 !ğ&
s
) {

79 
d–‘e
 
¡©e_
;

80 
	g¡©e_
 = (
s
.
¡©e_
 =ğ
NULL
è? NULL : 
Ãw
 
S‹
(*s.state_);

	@include/leveldb/table.h

5 #iâdeà
STORAGE_LEVELDB_INCLUDE_TABLE_H_


6 
	#STORAGE_LEVELDB_INCLUDE_TABLE_H_


	)

8 
	~<¡dšt.h
>

9 
	~"Ëv–db/™”©Ü.h
"

11 
Çme¥aû
 
	gËv–db
 {

13 
şass
 
	gBlock
;

14 
şass
 
	gBlockHªdË
;

15 
	gO±iÚs
;

16 
şass
 
	gRªdomAcûssFe
;

17 
	gR—dO±iÚs
;

21 şas 
	cTabË
 {

22 
	gpublic
:

35 
Stus
 
O³n
(cÚ¡ 
O±iÚs
& 
İtiÚs
,

36 
RªdomAcûssFe
* 
fe
,

37 
ušt64_t
 
fe_size
,

38 
TabË
** 
bË
);

40 ~
TabË
();

45 
I‹¿tÜ
* 
NewI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
&) const;

53 
ušt64_t
 
Aµroxim©eOff£tOf
(cÚ¡ 
Sliû
& 
key
) const;

55 
	g´iv©e
:

56 
R•
;

57 
R•
* 
	g»p_
;

59 
ex¶ic™
 
TabË
(
R•
* 
»p
è{ 
	g»p_
 =„ep; }

60 
I‹¿tÜ
* 
BlockR—d”
(*, cÚ¡ 
R—dO±iÚs
&, cÚ¡ 
Sliû
&);

63 
TabË
(const Table&);

64 
	gİ”©Ü
=(cÚ¡ 
TabË
&);

	@include/leveldb/table_builder.h

8 #iâdeà
STORAGE_LEVELDB_INCLUDE_TABLE_BUILDER_H_


9 
	#STORAGE_LEVELDB_INCLUDE_TABLE_BUILDER_H_


	)

11 
	~<¡dšt.h
>

12 
	~"Ëv–db/İtiÚs.h
"

13 
	~"Ëv–db/¡©us.h
"

15 
Çme¥aû
 
	gËv–db
 {

17 
şass
 
	gBlockBud”
;

18 
şass
 
	gBlockHªdË
;

19 
şass
 
	gWr™abËFe
;

21 şas 
	cTabËBud”
 {

22 
	gpublic
:

26 
TabËBud”
(cÚ¡ 
O±iÚs
& 
İtiÚs
, 
Wr™abËFe
* 
fe
);

29 ~
TabËBud”
();

37 
Stus
 
ChªgeO±iÚs
(cÚ¡ 
O±iÚs
& 
İtiÚs
);

42 
Add
(cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
v®ue
);

48 
Flush
();

51 
Stus
 
¡©us
() const;

56 
Stus
 
Fšish
();

63 
AbªdÚ
();

66 
ušt64_t
 
NumEÁr›s
() const;

70 
ušt64_t
 
FeSize
() const;

72 
	g´iv©e
:

73 
boŞ
 
ok
(ècÚ¡ {  
¡©us
().ok(); }

74 
Wr™eBlock
(
BlockBud”
* 
block
, 
BlockHªdË
* 
hªdË
);

76 
	gR•
;

77 
R•
* 
	g»p_
;

80 
TabËBud”
(const TableBuilder&);

81 
	gİ”©Ü
=(cÚ¡ 
TabËBud”
&);

	@include/leveldb/write_batch.h

16 #iâdeà
STORAGE_LEVELDB_INCLUDE_WRITE_BATCH_H_


17 
	#STORAGE_LEVELDB_INCLUDE_WRITE_BATCH_H_


	)

19 
	~<¡ršg
>

21 
Çme¥aû
 
	gËv–db
 {

23 
şass
 
	gSliû
;

25 şas 
	cWr™eB©ch
 {

26 
	gpublic
:

27 
Wr™eB©ch
();

28 ~
Wr™eB©ch
();

31 
Put
(cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
v®ue
);

34 
D–‘e
(cÚ¡ 
Sliû
& 
key
);

37 
CË¬
();

39 
	g´iv©e
:

40 
ä›nd
 
şass
 
Wr™eB©chIÁ”Çl
;

42 
	g¡d
::
¡ršg
 
»p_
;

	@port/port.h

5 #iâdeà
STORAGE_LEVELDB_PORT_PORT_H_


6 
	#STORAGE_LEVELDB_PORT_PORT_H_


	)

8 
	~<¡ršg.h
>

13 #ià
defšed
(
LEVELDB_PLATFORM_POSIX
)

14 
	~"pÜt/pÜt_posix.h
"

15 #–ià
defšed
(
LEVELDB_PLATFORM_CHROMIUM
)

16 
	~"pÜt/pÜt_chromium.h
"

17 #–ià
defšed
(
LEVELDB_PLATFORM_ANDROID
)

18 
	~"pÜt/pÜt_ªdroid.h
"

	@port/port_android.cc

5 
	~"pÜt/pÜt_ªdroid.h
"

7 
	~<c¡dlib
>

10 
size_t
 
ä—d_uÆocked
(*
a
, size_ˆ
b
, size_ˆ
c
, 
FILE
 *
d
) {

11  
ä—d
(
a
, 
b
, 
c
, 
d
);

14 
size_t
 
fwr™e_uÆocked
(cÚ¡ *
a
, size_ˆ
b
, size_ˆ
c
, 
FILE
 *
d
) {

15  
fwr™e
(
a
, 
b
, 
c
, 
d
);

18 
fæush_uÆocked
(
FILE
 *
f
) {

19  
fæush
(
f
);

22 
fd©async
(
fd
) {

23  
fsync
(
fd
);

27 
Çme¥aû
 
Ëv–db
 {

28 
Çme¥aû
 
pÜt
 {

30 
Pth»adC®l
(cÚ¡ * 
Ïb–
, 
»suÉ
) {

31 ià(
»suÉ
 != 0) {

32 
årštf
(
¡d”r
, "±h»ad %s: %s\n", 
Ïb–
, 
¡»¼Ü
(
»suÉ
));

33 
abÜt
();

37 
Mu‹x
::Mu‹x(è{ 
Pth»adC®l
("š™ mu‹x", 
±h»ad_mu‹x_š™
(&
mu_
, 
NULL
)); }

38 
Mu‹x
::~Mu‹x(è{ 
Pth»adC®l
("de¡roy mu‹x", 
±h»ad_mu‹x_de¡roy
(&
mu_
)); }

39 
Mu‹x
::
Lock
(è{ 
Pth»adC®l
("lock", 
±h»ad_mu‹x_lock
(&
mu_
)); }

40 
Mu‹x
::
UÆock
(è{ 
Pth»adC®l
("uÆock", 
±h»ad_mu‹x_uÆock
(&
mu_
)); }

42 
CÚdV¬
::CÚdV¬(
Mu‹x
* 
mu
)

43 : 
mu_
(
mu
) {

44 
Pth»adC®l
("š™ cv", 
±h»ad_cÚd_š™
(&
cv_
, 
NULL
));

47 
CÚdV¬
::~CondVar() {

48 
Pth»adC®l
("de¡roy cv", 
±h»ad_cÚd_de¡roy
(&
cv_
));

51 
CÚdV¬
::
Wa™
() {

52 
Pth»adC®l
("wa™", 
±h»ad_cÚd_wa™
(&
cv_
, &
mu_
->mu_));

55 
CÚdV¬
::
SigÇl
(){

56 
Pth»adC®l
("sigÇl", 
±h»ad_cÚd_sigÇl
(&
cv_
));

59 
CÚdV¬
::
SigÇlAÎ
() {

60 
Pth»adC®l
("brßdÿ¡", 
±h»ad_cÚd_brßdÿ¡
(&
cv_
));

	@port/port_android.h

7 #iâdeà
STORAGE_LEVELDB_PORT_PORT_ANDROID_H_


8 
	#STORAGE_LEVELDB_PORT_PORT_ANDROID_H_


	)

10 
	~<’dŸn.h
>

11 
	~<±h»ad.h
>

12 
	~<¡dšt.h
>

13 
	~<c¡d©omic
>

14 
	~<¡ršg
>

15 
	~<cùy³
>

19 #ià
defšed
(
__ARM_ARCH_6__
) || \

20 
defšed
(
__ARM_ARCH_6J__
) || \

21 
defšed
(
__ARM_ARCH_6K__
) || \

22 
defšed
(
__ARM_ARCH_6Z__
) || \

23 
defšed
(
__ARM_ARCH_6T2__
) || \

24 
defšed
(
__ARM_ARCH_6ZK__
) || \

25 
defšed
(
__ARM_ARCH_7__
) || \

26 
defšed
(
__ARM_ARCH_7R__
) || \

27 
	$defšed
(
__ARM_ARCH_7A__
)

28 
	#ARMV6_OR_7
 1

	)

32 
size_t
 
	`ä—d_uÆocked
(*
a
, size_ˆ
b
, size_ˆ
c
, 
FILE
 *
d
);

33 
size_t
 
	`fwr™e_uÆocked
(cÚ¡ *
a
, size_ˆ
b
, size_ˆ
c
, 
FILE
 *
d
);

34 
	`fæush_uÆocked
(
FILE
 *
f
);

35 
	`fd©async
 (
fd
);

36 
	}
}

38 
Çme¥aû
 
Ëv–db
 {

39 
Çme¥aû
 
pÜt
 {

41 cÚ¡ 
boŞ
 
kL™eEndŸn
 = 
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN
;

43 
şass
 
CÚdV¬
;

45 şas 
	cMu‹x
 {

46 
public
:

47 
Mu‹x
();

48 ~
Mu‹x
();

50 
Lock
();

51 
UÆock
();

52 
As£¹H–d
() {

56 
´iv©e
:

57 
ä›nd
 
şass
 
CÚdV¬
;

58 
±h»ad_mu‹x_t
 
mu_
;

61 
Mu‹x
(const Mutex&);

62 
İ”©Ü
=(cÚ¡ 
Mu‹x
&);

65 şas 
	cCÚdV¬
 {

66 
public
:

67 
ex¶ic™
 
CÚdV¬
(
Mu‹x
* 
mu
);

68 ~
CÚdV¬
();

69 
Wa™
();

70 
SigÇl
();

71 
SigÇlAÎ
();

72 
´iv©e
:

73 
Mu‹x
* 
mu_
;

74 
±h»ad_cÚd_t
 
cv_
;

77 #iâdeà
ARMV6_OR_7


80 (*
LšuxK”ÃlMemÜyB¬r›rFunc
)();

81 
LšuxK”ÃlMemÜyB¬r›rFunc
 
pLšuxK”ÃlMemÜyB¬r›r
 
ATTRIBUTE_WEAK
 =

82 (
LšuxK”ÃlMemÜyB¬r›rFunc
) 0xffff0fa0;

86 şas 
	cAtomicPoš‹r
 {

87 
´iv©e
:

88 * 
»p_
;

90 
šlše
 
MemÜyB¬r›r
() const {

92 #ifdeà
ARMV6_OR_7


93 
__asm__
 
__vŞ©e__
("dmb" : : : "memory");

95 
pLšuxK”ÃlMemÜyB¬r›r
();

99 
public
:

100 
AtomicPoš‹r
() { }

101 
ex¶ic™
 
AtomicPoš‹r
(* 
v
è: 
»p_
(v) { }

102 
šlše
 * 
Acquœe_Lßd
() const {

103 * 
r
 = 
»p_
;

104 
MemÜyB¬r›r
();

105  
r
;

107 
šlše
 
R–—£_StÜe
(* 
v
) {

108 
MemÜyB¬r›r
();

109 
»p_
 = 
v
;

111 
šlše
 * 
NoB¬r›r_Lßd
() const {

112 * 
r
 = 
»p_
;

113  
r
;

115 
šlše
 
NoB¬r›r_StÜe
(* 
v
) {

116 
»p_
 = 
v
;

121 
šlše
 
boŞ
 
SÇµy_Com´ess
(

122 cÚ¡ * 
šput
,

123 
size_t
 
šput_Ëngth
,

124 
¡d
::
¡ršg
* 
ouut
) {

125  
çl£
;

129 
šlše
 
boŞ
 
SÇµy_Uncom´ess
(

130 cÚ¡ * 
šput_d©a
,

131 
size_t
 
šput_Ëngth
,

132 
¡d
::
¡ršg
* 
ouut
) {

133  
çl£
;

136 
šlše
 
ušt64_t
 
Th»adId’tif›r
() {

137 
±h»ad_t
 
tid
 = 
±h»ad_£lf
();

138 
ušt64_t
 
r
 = 0;

139 
memıy
(&
r
, &
tid
, (r) < (tid) ? (r) : (tid));

140  
r
;

143 
šlše
 
boŞ
 
G‘H—pProfe
((*
func
)(*, cÚ¡ *, ), * 
¬g
) {

144  
çl£
;

	@port/port_chromium.cc

5 
	~"pÜt/pÜt_chromium.h
"

7 
	~"ut/loggšg.h
"

9 #ià
defšed
(
USE_SNAPPY
)

10 
	~"thœd_·¹y/¢­py/¤c/¢­py.h
"

13 
Çme¥aû
 
	gËv–db
 {

14 
Çme¥aû
 
	gpÜt
 {

16 
	gMu‹x
::
Mu‹x
() {

19 
Mu‹x
::~Mutex() {

22 
Mu‹x
::
Lock
() {

23 
mu_
.
Acquœe
();

26 
	gMu‹x
::
UÆock
() {

27 
mu_
.
R–—£
();

30 
	gMu‹x
::
As£¹H–d
() {

31 
mu_
.
As£¹Acquœed
();

34 
	gCÚdV¬
::
CÚdV¬
(
Mu‹x
* 
mu
)

35 : 
cv_
(&
mu
->
mu_
) {

38 
CÚdV¬
::~CondVar() { }

40 
CÚdV¬
::
Wa™
() {

41 
cv_
.
Wa™
();

44 
	gCÚdV¬
::
SigÇl
(){

45 
cv_
.
SigÇl
();

48 
	gCÚdV¬
::
SigÇlAÎ
() {

49 
cv_
.
Brßdÿ¡
();

52 
boŞ
 
SÇµy_Com´ess
(cÚ¡ * 
šput
, 
size_t
 
šput_Ëngth
,

53 
¡d
::
¡ršg
* 
ouut
) {

54 #ià
defšed
(
USE_SNAPPY
)

55 
ouut
->
»size
(
¢­py
::
MaxCom´es£dL’gth
(
šput_Ëngth
));

56 
size_t
 
	gou’
;

57 
	g¢­py
::
RawCom´ess
(
šput
, 
šput_Ëngth
, &(*
ouut
)[0], &
ou’
);

58 
	gouut
->
»size
(
ou’
);

59  
	gŒue
;

61  
	gçl£
;

65 
boŞ
 
SÇµy_Uncom´ess
(cÚ¡ * 
šput_d©a
, 
size_t
 
šput_Ëngth
,

66 
¡d
::
¡ršg
* 
ouut
) {

67 #ià
defšed
(
USE_SNAPPY
)

68 
size_t
 
uËngth
;

69 ià(!
	g¢­py
::
G‘Uncom´es£dL’gth
(
šput_d©a
, 
šput_Ëngth
, &
uËngth
)) {

70  
	gçl£
;

72 
	gouut
->
»size
(
uËngth
);

73  
	g¢­py
::
RawUncom´ess
(
šput_d©a
, 
šput_Ëngth
, &(*
ouut
)[0]);

75  
	gçl£
;

	@port/port_chromium.h

7 #iâdeà
STORAGE_LEVELDB_PORT_PORT_CHROMIUM_H_


8 
	#STORAGE_LEVELDB_PORT_PORT_CHROMIUM_H_


	)

10 
	~<¡dšt.h
>

11 
	~<¡ršg
>

12 
	~<c¡ršg
>

13 
	~"ba£/©omicİs.h
"

14 
	~"ba£/basiùy³s.h
"

15 
	~"ba£/loggšg.h
"

16 
	~"ba£/synchrÚiz©iÚ/cÚd™iÚ_v¬ŸbË.h
"

17 
	~"ba£/synchrÚiz©iÚ/lock.h
"

20 #ià
defšed
(
OS_LINUX
)

21 
	~<lšux/uni¡d.h
>

24 #ià
defšed
(
OS_WIN
)

25 
	#¢´štf
 
_¢´štf


	)

26 
	#va_cİy
(
a
, 
b
èdØ{ (aèğ(b); } 0)

	)

29 
Çme¥aû
 
	gËv–db
 {

30 
Çme¥aû
 
	gpÜt
 {

33 cÚ¡ 
boŞ
 
	gkL™eEndŸn
 = 
Œue
;

35 şas 
	cMu‹x
 {

36 
	gpublic
:

37 
Mu‹x
();

38 ~
Mu‹x
();

39 
Lock
();

40 
UÆock
();

41 
As£¹H–d
();

43 
	g´iv©e
:

44 
ba£
::
Lock
 
mu_
;

46 
ä›nd
 
şass
 
	gCÚdV¬
;

47 
DISALLOW_COPY_AND_ASSIGN
(
Mu‹x
);

50 şas 
	cCÚdV¬
 {

51 
	gpublic
:

52 
ex¶ic™
 
CÚdV¬
(
Mu‹x
* 
mu
);

53 ~
CÚdV¬
();

54 
Wa™
();

55 
SigÇl
();

56 
SigÇlAÎ
();

58 
	g´iv©e
:

59 
ba£
::
CÚd™iÚV¬ŸbË
 
cv_
;

61 
DISALLOW_COPY_AND_ASSIGN
(
CÚdV¬
);

64 şas 
	cAtomicPoš‹r
 {

65 
	g´iv©e
:

66 
ba£
::
	tsube
::
	tAtomicWÜd
 
	tR•
;

67 
R•
 
	g»p_
;

68 
	gpublic
:

69 
AtomicPoš‹r
() { }

70 
ex¶ic™
 
AtomicPoš‹r
(* 
p
è: 
»p_
(
»š‹½»t_ÿ¡
<
R•
>(p)) {}

71 
šlše
 * 
Acquœe_Lßd
() const {

72  
»š‹½»t_ÿ¡
<*>(::
ba£
::
sube
::
Acquœe_Lßd
(&
»p_
));

74 
šlše
 
R–—£_StÜe
(* 
v
) {

75 ::
ba£
::
sube
::
R–—£_StÜe
(&
»p_
, 
»š‹½»t_ÿ¡
<
R•
>(
v
));

77 
šlše
 * 
NoB¬r›r_Lßd
() const {

78  
	g»š‹½»t_ÿ¡
<*>(::
ba£
::
sube
::
NoB¬r›r_Lßd
(&
»p_
));

80 
šlše
 
NoB¬r›r_StÜe
(* 
v
) {

81 ::
ba£
::
sube
::
NoB¬r›r_StÜe
(&
»p_
, 
»š‹½»t_ÿ¡
<
R•
>(
v
));

85 
boŞ
 
SÇµy_Com´ess
(cÚ¡ * 
šput
, 
size_t
 
šput_Ëngth
,

86 
¡d
::
¡ršg
* 
ouut
);

87 
boŞ
 
SÇµy_Uncom´ess
(cÚ¡ * 
šput_d©a
, 
size_t
 
šput_Ëngth
,

88 
¡d
::
¡ršg
* 
ouut
);

90 
šlše
 
boŞ
 
G‘H—pProfe
((*
func
)(*, cÚ¡ *, ), * 
¬g
) {

91  
	gçl£
;

	@port/port_example.h

10 #iâdeà
STORAGE_LEVELDB_PORT_PORT_EXAMPLE_H_


11 
	#STORAGE_LEVELDB_PORT_PORT_EXAMPLE_H_


	)

13 
Çme¥aû
 
	gËv–db
 {

14 
Çme¥aû
 
	gpÜt
 {

21 cÚ¡ 
boŞ
 
	gkL™eEndŸn
 = 
Œue
 ;

26 şas 
	cMu‹x
 {

27 
	gpublic
:

28 
Mu‹x
();

29 ~
Mu‹x
();

33 
Lock
();

37 
UÆock
();

42 
As£¹H–d
();

45 şas 
	cCÚdV¬
 {

46 
	gpublic
:

47 
ex¶ic™
 
CÚdV¬
(
Mu‹x
* 
mu
);

48 ~
CÚdV¬
();

54 
Wa™
();

57 
SigÇl
();

60 
SigÇÎAÎ
();

65 şas 
	cAtomicPoš‹r
 {

66 
	g´iv©e
:

67 
šŒ_t
 
»p_
;

68 
	gpublic
:

70 
AtomicPoš‹r
();

73 
ex¶ic™
 
AtomicPoš‹r
(* 
v
è: 
»p_
(v) { }

78 * 
Acquœe_Lßd
() const;

83 
R–—£_StÜe
(* 
v
);

86 * 
NoB¬r›r_Lßd
() const;

89 
NoB¬r›r_StÜe
(* 
v
);

96 
boŞ
 
SÇµy_Com´ess
(cÚ¡ * 
šput
, 
size_t
 
šput_Ëngth
,

97 
¡d
::
¡ršg
* 
ouut
);

102 
boŞ
 
SÇµy_Uncom´ess
(cÚ¡ * 
šput_d©a
, 
size_t
 
šput_Ëngth
,

103 
¡d
::
¡ršg
* 
ouut
);

110 
boŞ
 
G‘H—pProfe
((*
func
)(*, cÚ¡ *, ), * 
¬g
);

	@port/port_posix.cc

5 
	~"pÜt/pÜt_posix.h
"

7 
	~<c¡dlib
>

8 
	~<¡dio.h
>

9 
	~<¡ršg.h
>

10 
	~"ut/loggšg.h
"

12 
Çme¥aû
 
	gËv–db
 {

13 
Çme¥aû
 
	gpÜt
 {

15 
Pth»adC®l
(cÚ¡ * 
Ïb–
, 
»suÉ
) {

16 ià(
	g»suÉ
 != 0) {

17 
årštf
(
¡d”r
, "±h»ad %s: %s\n", 
Ïb–
, 
¡»¼Ü
(
»suÉ
));

18 
abÜt
();

22 
	gMu‹x
::
Mu‹x
(è{ 
Pth»adC®l
("š™ mu‹x", 
±h»ad_mu‹x_š™
(&
mu_
, 
NULL
)); }

24 
	gMu‹x
::~
Mu‹x
(è{ 
Pth»adC®l
("de¡roy mu‹x", 
±h»ad_mu‹x_de¡roy
(&
mu_
)); }

26 
	gMu‹x
::
Lock
(è{ 
Pth»adC®l
("lock", 
±h»ad_mu‹x_lock
(&
mu_
)); }

28 
	gMu‹x
::
UÆock
(è{ 
Pth»adC®l
("uÆock", 
±h»ad_mu‹x_uÆock
(&
mu_
)); }

30 
	gCÚdV¬
::
CÚdV¬
(
Mu‹x
* 
mu
)

31 : 
mu_
(
mu
) {

32 
Pth»adC®l
("š™ cv", 
±h»ad_cÚd_š™
(&
cv_
, 
NULL
));

35 
	gCÚdV¬
::~
CÚdV¬
(è{ 
Pth»adC®l
("de¡roy cv", 
±h»ad_cÚd_de¡roy
(&
cv_
)); }

37 
	gCÚdV¬
::
Wa™
() {

38 
Pth»adC®l
("wa™", 
±h»ad_cÚd_wa™
(&
cv_
, &
mu_
->mu_));

41 
	gCÚdV¬
::
SigÇl
() {

42 
Pth»adC®l
("sigÇl", 
±h»ad_cÚd_sigÇl
(&
cv_
));

45 
	gCÚdV¬
::
SigÇlAÎ
() {

46 
Pth»adC®l
("brßdÿ¡", 
±h»ad_cÚd_brßdÿ¡
(&
cv_
));

	@port/port_posix.h

7 #iâdeà
STORAGE_LEVELDB_PORT_PORT_POSIX_H_


8 
	#STORAGE_LEVELDB_PORT_PORT_POSIX_H_


	)

10 
	~<’dŸn.h
>

11 
	~<±h»ad.h
>

12 
	~<¡dšt.h
>

13 
	~<¡ršg
>

14 
	~<©omic
>

15 
	~<c¡ršg
>

17 
Çme¥aû
 
	gËv–db
 {

18 
Çme¥aû
 
	gpÜt
 {

20 cÚ¡ 
boŞ
 
	gkL™eEndŸn
 = (
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN
);

22 
şass
 
	gCÚdV¬
;

24 şas 
	cMu‹x
 {

25 
	gpublic
:

26 
Mu‹x
();

27 ~
Mu‹x
();

29 
Lock
();

30 
UÆock
();

31 
As£¹H–d
() { }

33 
	g´iv©e
:

34 
ä›nd
 
şass
 
CÚdV¬
;

35 
±h»ad_mu‹x_t
 
	gmu_
;

38 
Mu‹x
(const Mutex&);

39 
	gİ”©Ü
=(cÚ¡ 
Mu‹x
&);

42 şas 
	cCÚdV¬
 {

43 
	gpublic
:

44 
ex¶ic™
 
CÚdV¬
(
Mu‹x
* 
mu
);

45 ~
CÚdV¬
();

46 
Wa™
();

47 
SigÇl
();

48 
SigÇlAÎ
();

49 
	g´iv©e
:

50 
±h»ad_cÚd_t
 
cv_
;

51 
Mu‹x
* 
	gmu_
;

55 şas 
	cAtomicPoš‹r
 {

56 
	g´iv©e
:

57 
¡d
::
©omic
<*> 
»p_
;

58 
	gpublic
:

59 
AtomicPoš‹r
() { }

60 
ex¶ic™
 
AtomicPoš‹r
(* 
v
è: 
»p_
(v) { }

61 
šlše
 * 
Acquœe_Lßd
() const {

62  
»p_
.
lßd
(
¡d
::
memÜy_Üd”_acquœe
);

64 
šlše
 
R–—£_StÜe
(* 
v
) {

65 
	g»p_
.
¡Üe
(
v
, 
¡d
::
memÜy_Üd”_»Ëa£
);

67 
šlše
 * 
NoB¬r›r_Lßd
() const {

68  
	g»p_
.
lßd
(
¡d
::
memÜy_Üd”_»Ïxed
);

70 
šlše
 
NoB¬r›r_StÜe
(* 
v
) {

71 
	g»p_
.
¡Üe
(
v
, 
¡d
::
memÜy_Üd”_»Ïxed
);

76 
šlše
 
boŞ
 
SÇµy_Com´ess
(cÚ¡ * 
šput
, 
size_t
 
šput_Ëngth
,

77 
¡d
::
¡ršg
* 
ouut
) {

78  
çl£
;

82 
šlše
 
boŞ
 
SÇµy_Uncom´ess
(cÚ¡ * 
šput_d©a
, 
size_t
 
šput_Ëngth
,

83 
¡d
::
¡ršg
* 
ouut
) {

84  
çl£
;

87 
šlše
 
boŞ
 
G‘H—pProfe
((*
func
)(*, cÚ¡ *, ), * 
¬g
) {

88  
	gçl£
;

	@port/sha1_portable.cc

29 
	~"pÜt/sha1_pÜbË.h
"

30 
	~<¡dio.h
>

31 
	~<¡dlib.h
>

32 
	~<¡dšt.h
>

34 
Çme¥aû
 
	gËv–db
 {

35 
Çme¥aû
 
	gpÜt
 {

47 
	sSHA1CÚ‹xt
 {

48 
	gMes§ge_Dige¡
[5];

50 
	gL’gth_Low
;

51 
	gL’gth_High
;

53 
	gMes§ge_Block
[64];

54 
	gMes§ge_Block_Index
;

56 
boŞ
 
	gCompu‹d
;

57 
boŞ
 
	gCÜru±ed
;

58 } 
	tSHA1CÚ‹xt
;

74 
	#SHA1CœcuÏrShiá
(
b™s
,
wÜd
) \

75 ((((
wÜd
è<< (
b™s
)) & 0xFFFFFFFF) | \

76 ((
wÜd
è>> (32-(
b™s
))))

	)

79 
SHA1ProûssMes§geBlock
(
SHA1CÚ‹xt
 *);

80 
SHA1PadMes§ge
(
SHA1CÚ‹xt
 *);

84 
SHA1Re£t
(
SHA1CÚ‹xt
* 
cÚ‹xt
) {

85 
	gcÚ‹xt
->
	gL’gth_Low
 = 0;

86 
	gcÚ‹xt
->
	gL’gth_High
 = 0;

87 
	gcÚ‹xt
->
	gMes§ge_Block_Index
 = 0;

89 
	gcÚ‹xt
->
	gMes§ge_Dige¡
[0] = 0x67452301;

90 
	gcÚ‹xt
->
	gMes§ge_Dige¡
[1] = 0xEFCDAB89;

91 
	gcÚ‹xt
->
	gMes§ge_Dige¡
[2] = 0x98BADCFE;

92 
	gcÚ‹xt
->
	gMes§ge_Dige¡
[3] = 0x10325476;

93 
	gcÚ‹xt
->
	gMes§ge_Dige¡
[4] = 0xC3D2E1F0;

95 
	gcÚ‹xt
->
	gCompu‹d
 = 
çl£
;

96 
	gcÚ‹xt
->
	gCÜru±ed
 = 
çl£
;

101 
boŞ
 
SHA1ResuÉ
(
SHA1CÚ‹xt
 *
cÚ‹xt
) {

102 ià(
	gcÚ‹xt
->
	gCÜru±ed
) {

103  
	gçl£
;

106 ià(!
	gcÚ‹xt
->
	gCompu‹d
) {

107 
SHA1PadMes§ge
(
cÚ‹xt
);

108 
	gcÚ‹xt
->
	gCompu‹d
 = 
Œue
;

110  
	gŒue
;

115 
SHA1IÅut
(
SHA1CÚ‹xt
 *
cÚ‹xt
,

116 cÚ¡ *
mes§ge_¬¿y
,

117 
Ëngth
) {

118 ià(!
	gËngth
) ;

120 ià(
	gcÚ‹xt
->
	gCompu‹d
 || cÚ‹xt->
	gCÜru±ed
) {

121 
	gcÚ‹xt
->
	gCÜru±ed
 = 
Œue
;

125 
	gËngth
-- && !
	gcÚ‹xt
->
	gCÜru±ed
) {

126 
	gcÚ‹xt
->
	gMes§ge_Block
[
cÚ‹xt
->
Mes§ge_Block_Index
++] =

127 (*
mes§ge_¬¿y
 & 0xFF);

129 
	gcÚ‹xt
->
	gL’gth_Low
 += 8;

131 
	gcÚ‹xt
->
	gL’gth_Low
 &= 0xFFFFFFFF;

132 ià(
	gcÚ‹xt
->
	gL’gth_Low
 == 0) {

133 
cÚ‹xt
->
L’gth_High
++;

135 
	gcÚ‹xt
->
	gL’gth_High
 &= 0xFFFFFFFF;

136 ià(
	gcÚ‹xt
->
	gL’gth_High
 == 0)

139 
cÚ‹xt
->
CÜru±ed
 = 
Œue
;

143 ià(
	gcÚ‹xt
->
	gMes§ge_Block_Index
 == 64)

145 
SHA1ProûssMes§geBlock
(
cÚ‹xt
);

148 
	gmes§ge_¬¿y
++;

154 
SHA1ProûssMes§geBlock
(
SHA1CÚ‹xt
 *
cÚ‹xt
) {

155 cÚ¡ 
	gK
[] =

162 
	gt
;

163 
	g‹mp
;

164 
	gW
[80];

165 
	gA
, 
	gB
, 
	gC
, 
	gD
, 
	gE
;

168 
	gt
 = 0; < 16;++) {

169 
	gW
[
t
] = ((è
cÚ‹xt
->
Mes§ge_Block
[t * 4]) << 24;

170 
	gW
[
t
] |ğ((è
cÚ‹xt
->
Mes§ge_Block
[t * 4 + 1]) << 16;

171 
	gW
[
t
] |ğ((è
cÚ‹xt
->
Mes§ge_Block
[t * 4 + 2]) << 8;

172 
	gW
[
t
] |ğ((è
cÚ‹xt
->
Mes§ge_Block
[t * 4 + 3]);

175 
	gt
 = 16; < 80;++) {

176 
	gW
[
t
] = 
SHA1CœcuÏrShiá
(1,
W
[t-3] ^ W[t-8] ^ W[t-14] ^ W[t-16]);

179 
	gA
 = 
cÚ‹xt
->
Mes§ge_Dige¡
[0];

180 
	gB
 = 
cÚ‹xt
->
Mes§ge_Dige¡
[1];

181 
	gC
 = 
cÚ‹xt
->
Mes§ge_Dige¡
[2];

182 
	gD
 = 
cÚ‹xt
->
Mes§ge_Dige¡
[3];

183 
	gE
 = 
cÚ‹xt
->
Mes§ge_Dige¡
[4];

185 
	gt
 = 0; < 20;++) {

186 
	g‹mp
 = 
SHA1CœcuÏrShiá
(5,
A
) +

187 ((
	gB
 & 
	gC
è| ((~Bè& 
	gD
)è+ 
	gE
 + 
	gW
[
t
] + 
	gK
[0];

188 
	g‹mp
 &= 0xFFFFFFFF;

189 
	gE
 = 
D
;

190 
	gD
 = 
C
;

191 
	gC
 = 
SHA1CœcuÏrShiá
(30,
B
);

192 
	gB
 = 
A
;

193 
	gA
 = 
‹mp
;

196 
	gt
 = 20; < 40;++) {

197 
	g‹mp
 = 
SHA1CœcuÏrShiá
(5,
A
è+ (
	gB
 ^ 
	gC
 ^ 
	gD
è+ 
	gE
 + 
	gW
[
t
] + 
	gK
[1];

198 
	g‹mp
 &= 0xFFFFFFFF;

199 
	gE
 = 
D
;

200 
	gD
 = 
C
;

201 
	gC
 = 
SHA1CœcuÏrShiá
(30,
B
);

202 
	gB
 = 
A
;

203 
	gA
 = 
‹mp
;

206 
	gt
 = 40; < 60;++) {

207 
	g‹mp
 = 
SHA1CœcuÏrShiá
(5,
A
) +

208 ((
	gB
 & 
	gC
è| (B & 
	gD
è| (C & D)è+ 
	gE
 + 
	gW
[
t
] + 
	gK
[2];

209 
	g‹mp
 &= 0xFFFFFFFF;

210 
	gE
 = 
D
;

211 
	gD
 = 
C
;

212 
	gC
 = 
SHA1CœcuÏrShiá
(30,
B
);

213 
	gB
 = 
A
;

214 
	gA
 = 
‹mp
;

217 
	gt
 = 60; < 80;++) {

218 
	g‹mp
 = 
SHA1CœcuÏrShiá
(5,
A
è+ (
	gB
 ^ 
	gC
 ^ 
	gD
è+ 
	gE
 + 
	gW
[
t
] + 
	gK
[3];

219 
	g‹mp
 &= 0xFFFFFFFF;

220 
	gE
 = 
D
;

221 
	gD
 = 
C
;

222 
	gC
 = 
SHA1CœcuÏrShiá
(30,
B
);

223 
	gB
 = 
A
;

224 
	gA
 = 
‹mp
;

227 
	gcÚ‹xt
->
	gMes§ge_Dige¡
[0] = (
cÚ‹xt
->
Mes§ge_Dige¡
[0] + 
A
) & 0xFFFFFFFF;

228 
	gcÚ‹xt
->
	gMes§ge_Dige¡
[1] = (
cÚ‹xt
->
Mes§ge_Dige¡
[1] + 
B
) & 0xFFFFFFFF;

229 
	gcÚ‹xt
->
	gMes§ge_Dige¡
[2] = (
cÚ‹xt
->
Mes§ge_Dige¡
[2] + 
C
) & 0xFFFFFFFF;

230 
	gcÚ‹xt
->
	gMes§ge_Dige¡
[3] = (
cÚ‹xt
->
Mes§ge_Dige¡
[3] + 
D
) & 0xFFFFFFFF;

231 
	gcÚ‹xt
->
	gMes§ge_Dige¡
[4] = (
cÚ‹xt
->
Mes§ge_Dige¡
[4] + 
E
) & 0xFFFFFFFF;

233 
	gcÚ‹xt
->
	gMes§ge_Block_Index
 = 0;

243 
SHA1PadMes§ge
(
SHA1CÚ‹xt
 *
cÚ‹xt
) {

247 ià(
	gcÚ‹xt
->
	gMes§ge_Block_Index
 > 55) {

248 
	gcÚ‹xt
->
	gMes§ge_Block
[
cÚ‹xt
->
Mes§ge_Block_Index
++] = 0x80;

249 
	gcÚ‹xt
->
	gMes§ge_Block_Index
 < 64) {

250 
	gcÚ‹xt
->
	gMes§ge_Block
[
cÚ‹xt
->
Mes§ge_Block_Index
++] = 0;

253 
SHA1ProûssMes§geBlock
(
cÚ‹xt
);

255 
	gcÚ‹xt
->
	gMes§ge_Block_Index
 < 56) {

256 
	gcÚ‹xt
->
	gMes§ge_Block
[
cÚ‹xt
->
Mes§ge_Block_Index
++] = 0;

259 
	gcÚ‹xt
->
	gMes§ge_Block
[
cÚ‹xt
->
Mes§ge_Block_Index
++] = 0x80;

260 
	gcÚ‹xt
->
	gMes§ge_Block_Index
 < 56) {

261 
	gcÚ‹xt
->
	gMes§ge_Block
[
cÚ‹xt
->
Mes§ge_Block_Index
++] = 0;

266 
	gcÚ‹xt
->
	gMes§ge_Block
[56] = (
cÚ‹xt
->
L’gth_High
 >> 24) & 0xFF;

267 
	gcÚ‹xt
->
	gMes§ge_Block
[57] = (
cÚ‹xt
->
L’gth_High
 >> 16) & 0xFF;

268 
	gcÚ‹xt
->
	gMes§ge_Block
[58] = (
cÚ‹xt
->
L’gth_High
 >> 8) & 0xFF;

269 
	gcÚ‹xt
->
	gMes§ge_Block
[59] = (
cÚ‹xt
->
L’gth_High
) & 0xFF;

270 
	gcÚ‹xt
->
	gMes§ge_Block
[60] = (
cÚ‹xt
->
L’gth_Low
 >> 24) & 0xFF;

271 
	gcÚ‹xt
->
	gMes§ge_Block
[61] = (
cÚ‹xt
->
L’gth_Low
 >> 16) & 0xFF;

272 
	gcÚ‹xt
->
	gMes§ge_Block
[62] = (
cÚ‹xt
->
L’gth_Low
 >> 8) & 0xFF;

273 
	gcÚ‹xt
->
	gMes§ge_Block
[63] = (
cÚ‹xt
->
L’gth_Low
) & 0xFF;

275 
SHA1ProûssMes§geBlock
(
cÚ‹xt
);

279 
SHA1_Hash_PÜbË
(cÚ¡ * 
d©a
, 
size_t
 
Ën
, * 
hash_¬¿y
) {

280 
SHA1CÚ‹xt
 
	gcÚ‹xt
;

281 
SHA1Re£t
(&
cÚ‹xt
);

282 
SHA1IÅut
(&
cÚ‹xt
, 
»š‹½»t_ÿ¡
<cÚ¡ *>(
d©a
), 
Ën
);

283 
boŞ
 
	gok
 = 
SHA1ResuÉ
(&
cÚ‹xt
);

284 ià(!
	gok
) {

285 
årštf
(
¡d”r
, "Unexpectedƒrror in SHA1_Hash_Portable code\n");

286 
ex™
(1);

288 
	gi
 = 0; i < 5; i++) {

289 
ušt32_t
 
	gv®ue
 = 
cÚ‹xt
.
Mes§ge_Dige¡
[
i
];

290 
	ghash_¬¿y
[
i
*4 + 0] = (
v®ue
 >> 24) & 0xff;

291 
	ghash_¬¿y
[
i
*4 + 1] = (
v®ue
 >> 16) & 0xff;

292 
	ghash_¬¿y
[
i
*4 + 2] = (
v®ue
 >> 8) & 0xff;

293 
	ghash_¬¿y
[
i
*4 + 3] = 
v®ue
 & 0xff;

	@port/sha1_portable.h

5 #iâdeà
STORAGE_LEVELDB_PORT_SHA1_PORTABLE_H_


6 
	#STORAGE_LEVELDB_PORT_SHA1_PORTABLE_H_


	)

8 
	~<¡ddef.h
>

10 
Çme¥aû
 
	gËv–db
 {

11 
Çme¥aû
 
	gpÜt
 {

20 
SHA1_Hash_PÜbË
(cÚ¡ * 
d©a
, 
size_t
 
Ën
, * 
hash_¬¿y
);

	@port/sha1_test.cc

5 
	~"pÜt/pÜt.h
"

6 
	~"ut/‹¡h¬Ãss.h
"

8 
Çme¥aû
 
	gËv–db
 {

9 
Çme¥aû
 
	gpÜt
 {

11 şas 
	cSHA1
 { };

13 
	g¡d
::
¡ršg
 
Te¡SHA1
(cÚ¡ * 
d©a
, 
size_t
 
Ën
) {

14 
	ghash_v®
[20];

15 
SHA1_Hash
(
d©a
, 
Ën
, 
hash_v®
);

16 
	gbuf
[41];

17 
	gi
 = 0; i < 20; i++) {

18 
¢´štf
(
buf
 + 
i
 * 2, 41 - i * 2,

20 
¡©ic_ÿ¡
<>(static_cast<>(

21 
hash_v®
[
i
])));

23  
	g¡d
::
¡ršg
(
buf
, 40);

26 
TEST
(
SHA1
, 
Sim¶e
) {

27 
ASSERT_EQ
("da39a3“5e6b4b0d3255bãf95601890afd80709", 
Te¡SHA1
("", 0));

28 
ASSERT_EQ
("¯f4c61ddcc5e8a2dabede0f3b482cd9«a9434d", 
Te¡SHA1
("hello", 5));

29 
	g¡d
::
¡ršg
 
x
(10000, 'x');

30 
ASSERT_EQ
("f8c5cde791c5056cf515881e701c8a9ecb439a75",

31 
Te¡SHA1
(
x
.
d©a
(), x.
size
()));

37 
	$maš
(
¬gc
, ** 
¬gv
) {

38  
Ëv–db
::
‹¡
::
	`RunAÎTe¡s
();

39 
	}
}

	@port/win/stdint.h

7 #iâdeà
STORAGE_LEVELDB_PORT_WIN_STDINT_H_


8 
	#STORAGE_LEVELDB_PORT_WIN_STDINT_H_


	)

10 #ià!
defšed
(
_MSC_VER
)

11 #”rÜ 
This
 
fe
 
should
 
Úly
 
be
 
šşuded
 
wh’
 
compšg
 
w™h
 
MSVC
.

15 sigÃd 
	tšt8_t
;

16 sigÃd 
	tšt16_t
;

17 sigÃd 
	tšt32_t
;

18 sigÃd 
	tšt64_t
;

19 
	tušt8_t
;

20 
	tušt16_t
;

21 
	tušt32_t
;

22 
	tušt64_t
;

	@table/block.cc

7 
	~"bË/block.h
"

9 
	~<veùÜ
>

10 
	~<®gÜ™hm
>

11 
	~"Ëv–db/com·¿tÜ.h
"

12 
	~"ut/codšg.h
"

13 
	~"ut/loggšg.h
"

15 
Çme¥aû
 
	gËv–db
 {

17 
šlše
 
ušt32_t
 
	gBlock
::
NumRe¡¬ts
() const {

18 
as£¹
(
size_
 >ğ2*(
ušt32_t
));

19  
DecodeFixed32
(
d©a_
 + 
size_
 - (
ušt32_t
));

22 
	gBlock
::
Block
(cÚ¡ * 
d©a
, 
size_t
 
size
)

23 : 
d©a_
(
d©a
),

24 
size_
(
size
) {

25 ià(
	gsize_
 < (
	gušt32_t
)) {

26 
	gsize_
 = 0;

28 
	g»¡¬t_off£t_
 = 
size_
 - (1 + 
NumRe¡¬ts
()è* (
ušt32_t
);

29 ià(
	g»¡¬t_off£t_
 > 
	gsize_
 - (
	gušt32_t
)) {

32 
	gsize_
 = 0;

37 
	gBlock
::~
Block
() {

38 
d–‘e
[] 
d©a_
;

48 
šlše
 cÚ¡ * 
DecodeEÁry
(cÚ¡ * 
p
, cÚ¡ * 
lim™
,

49 
ušt32_t
* 
sh¬ed
,

50 
ušt32_t
* 
nÚ_sh¬ed
,

51 
ušt32_t
* 
v®ue_Ëngth
) {

52 ià(
	glim™
 - 
	gp
 < 3è 
	gNULL
;

53 *
	gsh¬ed
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
p
)[0];

54 *
	gnÚ_sh¬ed
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
p
)[1];

55 *
	gv®ue_Ëngth
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
p
)[2];

56 ià((*
	gsh¬ed
 | *
	gnÚ_sh¬ed
 | *
	gv®ue_Ëngth
) < 128) {

58 
	gp
 += 3;

60 ià((
	gp
 = 
G‘V¬št32PŒ
(
p
, 
lim™
, 
sh¬ed
)è=ğ
NULL
)  NULL;

61 ià((
	gp
 = 
G‘V¬št32PŒ
(
p
, 
lim™
, 
nÚ_sh¬ed
)è=ğ
NULL
)  NULL;

62 ià((
	gp
 = 
G‘V¬št32PŒ
(
p
, 
lim™
, 
v®ue_Ëngth
)è=ğ
NULL
)  NULL;

65 ià(
	g¡©ic_ÿ¡
<
	gušt32_t
>(
	glim™
 - 
	gp
è< (*
	gnÚ_sh¬ed
 + *
	gv®ue_Ëngth
)) {

66  
	gNULL
;

68  
	gp
;

71 şas 
	cBlock
::
I‹r
 : 
public
 
I‹¿tÜ
 {

72 
´iv©e
:

73 cÚ¡ 
Com·¿tÜ
* cÚ¡ 
com·¿tÜ_
;

74 cÚ¡ * cÚ¡ 
	gd©a_
;

75 
ušt32_t
 cÚ¡ 
	g»¡¬ts_
;

76 
ušt32_t
 cÚ¡ 
	gnum_»¡¬ts_
;

79 
ušt32_t
 
	gcu¼’t_
;

80 
ušt32_t
 
	g»¡¬t_šdex_
;

81 
	g¡d
::
¡ršg
 
key_
;

82 
Sliû
 
	gv®ue_
;

83 
Stus
 
	g¡©us_
;

85 
šlše
 
Com·»
(cÚ¡ 
Sliû
& 
a
, cÚ¡ Sliû& 
b
) const {

86  
	gcom·¿tÜ_
->
Com·»
(
a
, 
b
);

90 
šlše
 
ušt32_t
 
NextEÁryOff£t
() const {

91  (
	gv®ue_
.
d©a
(è+ v®ue_.
size
()è- 
	gd©a_
;

94 
ušt32_t
 
G‘Re¡¬tPošt
(ušt32_ˆ
šdex
) {

95 
as£¹
(
šdex
 < 
num_»¡¬ts_
);

96  
DecodeFixed32
(
d©a_
 + 
»¡¬ts_
 + 
šdex
 * (
ušt32_t
));

99 
S“kToRe¡¬tPošt
(
ušt32_t
 
šdex
) {

100 
	gkey_
.
ş—r
();

101 
	g»¡¬t_šdex_
 = 
šdex
;

105 
ušt32_t
 
	goff£t
 = 
G‘Re¡¬tPošt
(
šdex
);

106 
	gv®ue_
 = 
Sliû
(
d©a_
 + 
off£t
, 0);

109 
	gpublic
:

110 
I‹r
(cÚ¡ 
Com·¿tÜ
* 
com·¿tÜ
,

111 cÚ¡ * 
d©a
,

112 
ušt32_t
 
»¡¬ts
,

113 
ušt32_t
 
num_»¡¬ts
)

114 : 
com·¿tÜ_
(
com·¿tÜ
),

115 
d©a_
(
d©a
),

116 
»¡¬ts_
(
»¡¬ts
),

117 
num_»¡¬ts_
(
num_»¡¬ts
),

118 
cu¼’t_
(
»¡¬ts_
),

119 
»¡¬t_šdex_
(
num_»¡¬ts_
) {

120 
as£¹
(
num_»¡¬ts_
 > 0);

123 
vœtu®
 
boŞ
 
V®id
(ècÚ¡ {  
	gcu¼’t_
 < 
	g»¡¬ts_
; }

124 
vœtu®
 
Stus
 
¡©us
(ècÚ¡ {  
	g¡©us_
; }

125 
vœtu®
 
Sliû
 
key
() const {

126 
as£¹
(
V®id
());

127  
	gkey_
;

129 
vœtu®
 
Sliû
 
v®ue
() const {

130 
as£¹
(
V®id
());

131  
	gv®ue_
;

134 
vœtu®
 
Next
() {

135 
as£¹
(
V®id
());

136 
P¬£NextKey
();

139 
vœtu®
 
P»v
() {

140 
as£¹
(
V®id
());

143 cÚ¡ 
ušt32_t
 
	gÜigš®
 = 
cu¼’t_
;

144 
G‘Re¡¬tPošt
(
»¡¬t_šdex_
è>ğ
Üigš®
) {

145 ià(
»¡¬t_šdex_
 == 0) {

147 
cu¼’t_
 = 
»¡¬ts_
;

148 
	g»¡¬t_šdex_
 = 
num_»¡¬ts_
;

151 
	g»¡¬t_šdex_
--;

154 
S“kToRe¡¬tPošt
(
»¡¬t_šdex_
);

157 } 
P¬£NextKey
(è&& 
NextEÁryOff£t
(è< 
	gÜigš®
);

160 
vœtu®
 
S“k
(cÚ¡ 
Sliû
& 
rg‘
) {

163 
ušt32_t
 
	gËá
 = 0;

164 
ušt32_t
 
	gright
 = 
num_»¡¬ts_
 - 1;

165 
	gËá
 < 
	gright
) {

166 
ušt32_t
 
	gmid
 = (
Ëá
 + 
right
 + 1) / 2;

167 
ušt32_t
 
	g»giÚ_off£t
 = 
G‘Re¡¬tPošt
(
mid
);

168 
ušt32_t
 
	gsh¬ed
, 
	gnÚ_sh¬ed
, 
	gv®ue_Ëngth
;

169 cÚ¡ * 
	gkey_±r
 = 
DecodeEÁry
(
d©a_
 + 
»giÚ_off£t
,

170 
d©a_
 + 
»¡¬ts_
,

171 &
sh¬ed
, &
nÚ_sh¬ed
, &
v®ue_Ëngth
);

172 ià(
	gkey_±r
 =ğ
NULL
 || (
sh¬ed
 != 0)) {

173 
CÜru±iÚE¼Ü
();

176 
Sliû
 
mid_key
(
key_±r
, 
nÚ_sh¬ed
);

177 ià(
Com·»
(
mid_key
, 
rg‘
) < 0) {

180 
	gËá
 = 
mid
;

184 
	gright
 = 
mid
 - 1;

189 
S“kToRe¡¬tPošt
(
Ëá
);

190 
	gŒue
) {

191 ià(!
P¬£NextKey
()) {

194 ià(
Com·»
(
key_
, 
rg‘
) >= 0) {

200 
vœtu®
 
S“kToFœ¡
() {

201 
S“kToRe¡¬tPošt
(0);

202 
P¬£NextKey
();

205 
vœtu®
 
S“kToLa¡
() {

206 
S“kToRe¡¬tPošt
(
num_»¡¬ts_
 - 1);

207 
P¬£NextKey
(è&& 
NextEÁryOff£t
(è< 
	g»¡¬ts_
) {

212 
	g´iv©e
:

213 
CÜru±iÚE¼Ü
() {

214 
cu¼’t_
 = 
»¡¬ts_
;

215 
	g»¡¬t_šdex_
 = 
num_»¡¬ts_
;

216 
	g¡©us_
 = 
Stus
::
CÜru±iÚ
("badƒntry in block");

217 
	gkey_
.
ş—r
();

218 
	gv®ue_
.
ş—r
();

221 
boŞ
 
P¬£NextKey
() {

222 
	gcu¼’t_
 = 
NextEÁryOff£t
();

223 cÚ¡ * 
	gp
 = 
d©a_
 + 
cu¼’t_
;

224 cÚ¡ * 
	glim™
 = 
d©a_
 + 
»¡¬ts_
;

225 ià(
	gp
 >ğ
lim™
) {

227 
cu¼’t_
 = 
»¡¬ts_
;

228 
	g»¡¬t_šdex_
 = 
num_»¡¬ts_
;

229  
	gçl£
;

233 
ušt32_t
 
	gsh¬ed
, 
	gnÚ_sh¬ed
, 
	gv®ue_Ëngth
;

234 
	gp
 = 
DecodeEÁry
(
p
, 
lim™
, &
sh¬ed
, &
nÚ_sh¬ed
, &
v®ue_Ëngth
);

235 ià(
	gp
 =ğ
NULL
 || 
key_
.
size
(è< 
sh¬ed
) {

236 
CÜru±iÚE¼Ü
();

237  
	gçl£
;

239 
	gkey_
.
»size
(
sh¬ed
);

240 
	gkey_
.
­³nd
(
p
, 
nÚ_sh¬ed
);

241 
	gv®ue_
 = 
Sliû
(
p
 + 
nÚ_sh¬ed
, 
v®ue_Ëngth
);

242 
	g»¡¬t_šdex_
 + 1 < 
	gnum_»¡¬ts_
 &&

243 
G‘Re¡¬tPošt
(
»¡¬t_šdex_
 + 1è< 
	gcu¼’t_
) {

244 ++
	g»¡¬t_šdex_
;

246  
	gŒue
;

251 
I‹¿tÜ
* 
	gBlock
::
	$NewI‹¿tÜ
(cÚ¡ 
Com·¿tÜ
* 
cmp
) {

252 ià(
size_
 < 2*(
ušt32_t
)) {

253  
	`NewE¼ÜI‹¿tÜ
(
Stus
::
	`CÜru±iÚ
("bad block contents"));

255 cÚ¡ 
ušt32_t
 
num_»¡¬ts
 = 
	`NumRe¡¬ts
();

256 ià(
num_»¡¬ts
 == 0) {

257  
	`NewEm±yI‹¿tÜ
();

259  
Ãw
 
	`I‹r
(
cmp
, 
d©a_
, 
»¡¬t_off£t_
, 
num_»¡¬ts
);

261 
	}
}

	@table/block.h

5 #iâdeà
STORAGE_LEVELDB_TABLE_BLOCK_H_


6 
	#STORAGE_LEVELDB_TABLE_BLOCK_H_


	)

8 
	~<¡ddef.h
>

9 
	~<¡dšt.h
>

10 
	~"Ëv–db/™”©Ü.h
"

12 
Çme¥aû
 
	gËv–db
 {

14 
şass
 
	gCom·¿tÜ
;

16 şas 
	cBlock
 {

17 
	gpublic
:

20 
Block
(cÚ¡ * 
d©a
, 
size_t
 
size
);

22 ~
Block
();

24 
size_t
 
size
(ècÚ¡ {  
	gsize_
; }

25 
I‹¿tÜ
* 
NewI‹¿tÜ
(cÚ¡ 
Com·¿tÜ
* 
com·¿tÜ
);

27 
	g´iv©e
:

28 
ušt32_t
 
NumRe¡¬ts
() const;

30 cÚ¡ * 
	gd©a_
;

31 
size_t
 
	gsize_
;

32 
ušt32_t
 
	g»¡¬t_off£t_
;

35 
Block
(const Block&);

36 
	gİ”©Ü
=(cÚ¡ 
Block
&);

38 
şass
 
	gI‹r
;

	@table/block_builder.cc

29 
	~"bË/block_bud”.h
"

31 
	~<®gÜ™hm
>

32 
	~<as£¹.h
>

33 
	~"Ëv–db/com·¿tÜ.h
"

34 
	~"Ëv–db/bË_bud”.h
"

35 
	~"ut/codšg.h
"

37 
Çme¥aû
 
	gËv–db
 {

39 
	gBlockBud”
::
BlockBud”
(cÚ¡ 
O±iÚs
* 
İtiÚs
)

40 : 
İtiÚs_
(
İtiÚs
),

41 
»¡¬ts_
(),

42 
couÁ”_
(0),

43 
fšished_
(
çl£
) {

44 
as£¹
(
İtiÚs
->
block_»¡¬t_š‹rv®
 >= 1);

45 
	g»¡¬ts_
.
push_back
(0);

48 
	gBlockBud”
::
Re£t
() {

49 
bufãr_
.
ş—r
();

50 
	g»¡¬ts_
.
ş—r
();

51 
	g»¡¬ts_
.
push_back
(0);

52 
	gcouÁ”_
 = 0;

53 
	gfšished_
 = 
çl£
;

54 
	gÏ¡_key_
.
ş—r
();

57 
size_t
 
	gBlockBud”
::
Cu¼’tSizeE¡im©e
() const {

58  (
bufãr_
.
size
() +

59 
»¡¬ts_
.
size
(è* (
ušt32_t
) +

60 (
ušt32_t
));

63 
Sliû
 
	gBlockBud”
::
Fšish
() {

65 
size_t
 
i
 = 0; 
	gi
 < 
	g»¡¬ts_
.
size
(); i++) {

66 
PutFixed32
(&
bufãr_
, 
»¡¬ts_
[
i
]);

68 
PutFixed32
(&
bufãr_
, 
»¡¬ts_
.
size
());

69 
	gfšished_
 = 
Œue
;

70  
Sliû
(
bufãr_
);

73 
	gBlockBud”
::
Add
(cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
v®ue
) {

74 
Sliû
 
Ï¡_key_p›û
(
Ï¡_key_
);

75 
as£¹
(!
fšished_
);

76 
as£¹
(
couÁ”_
 <ğ
İtiÚs_
->
block_»¡¬t_š‹rv®
);

77 
as£¹
(
bufãr_
.
em±y
()

78 || 
İtiÚs_
->
com·¿tÜ
->
Com·»
(
key
, 
Ï¡_key_p›û
) > 0);

79 
size_t
 
	gsh¬ed
 = 0;

80 ià(
	gcouÁ”_
 < 
	gİtiÚs_
->
	gblock_»¡¬t_š‹rv®
) {

82 cÚ¡ 
size_t
 
	gmš_Ëngth
 = 
¡d
::
mš
(
Ï¡_key_p›û
.
size
(), 
key
.size());

83 (
	gsh¬ed
 < 
	gmš_Ëngth
è&& (
	gÏ¡_key_
[
sh¬ed
] =ğ
key
[shared])) {

84 
sh¬ed
++;

88 
	g»¡¬ts_
.
push_back
(
bufãr_
.
size
());

89 
	gcouÁ”_
 = 0;

91 cÚ¡ 
size_t
 
	gnÚ_sh¬ed
 = 
key
.
size
(è- 
sh¬ed
;

94 
PutV¬št32
(&
bufãr_
, 
sh¬ed
);

95 
PutV¬št32
(&
bufãr_
, 
nÚ_sh¬ed
);

96 
PutV¬št32
(&
bufãr_
, 
v®ue
.
size
());

99 
	gbufãr_
.
­³nd
(
key
.
d©a
(è+ 
sh¬ed
, 
nÚ_sh¬ed
);

100 
	gbufãr_
.
­³nd
(
v®ue
.
d©a
(), v®ue.
size
());

103 
	gÏ¡_key_
.
»size
(
sh¬ed
);

104 
	gÏ¡_key_
.
­³nd
(
key
.
d©a
(è+ 
sh¬ed
, 
nÚ_sh¬ed
);

105 
as£¹
(
Sliû
(
Ï¡_key_
è=ğ
key
);

106 
	gcouÁ”_
++;

	@table/block_builder.h

5 #iâdeà
STORAGE_LEVELDB_TABLE_BLOCK_BUILDER_H_


6 
	#STORAGE_LEVELDB_TABLE_BLOCK_BUILDER_H_


	)

8 
	~<veùÜ
>

10 
	~<¡dšt.h
>

11 
	~"Ëv–db/¦iû.h
"

13 
Çme¥aû
 
	gËv–db
 {

15 
	gO±iÚs
;

17 şas 
	cBlockBud”
 {

18 
	gpublic
:

19 
ex¶ic™
 
BlockBud”
(cÚ¡ 
O±iÚs
* 
İtiÚs
);

22 
Re£t
();

26 
Add
(cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
v®ue
);

31 
Sliû
 
Fšish
();

35 
size_t
 
Cu¼’tSizeE¡im©e
() const;

38 
boŞ
 
em±y
() const {

39  
	gbufãr_
.
em±y
();

42 
	g´iv©e
:

43 cÚ¡ 
O±iÚs
* 
İtiÚs_
;

44 
	g¡d
::
¡ršg
 
bufãr_
;

45 
	g¡d
::
veùÜ
<
ušt32_t
> 
»¡¬ts_
;

46 
	gcouÁ”_
;

47 
boŞ
 
	gfšished_
;

48 
	g¡d
::
¡ršg
 
Ï¡_key_
;

51 
BlockBud”
(const BlockBuilder&);

52 
	gİ”©Ü
=(cÚ¡ 
BlockBud”
&);

	@table/format.cc

5 
	~"bË/fÜm©.h
"

7 
	~"Ëv–db/’v.h
"

8 
	~"pÜt/pÜt.h
"

9 
	~"bË/block.h
"

10 
	~"ut/codšg.h
"

11 
	~"ut/üc32c.h
"

13 
Çme¥aû
 
	gËv–db
 {

15 
	gBlockHªdË
::
EncodeTo
(
¡d
::
¡ršg
* 
d¡
) const {

17 
as£¹
(
off£t_
 !ğ~
¡©ic_ÿ¡
<
ušt64_t
>(0));

18 
as£¹
(
size_
 !ğ~
¡©ic_ÿ¡
<
ušt64_t
>(0));

19 
PutV¬št64
(
d¡
, 
off£t_
);

20 
PutV¬št64
(
d¡
, 
size_
);

23 
Stus
 
	gBlockHªdË
::
DecodeFrom
(
Sliû
* 
šput
) {

24 ià(
G‘V¬št64
(
šput
, &
off£t_
) &&

25 
G‘V¬št64
(
šput
, &
size_
)) {

26  
	gStus
::
OK
();

28  
	gStus
::
CÜru±iÚ
("bad block handle");

32 
	gFoÙ”
::
EncodeTo
(
¡d
::
¡ršg
* 
d¡
) const {

33 #iâdeà
NDEBUG


34 cÚ¡ 
size_t
 
Üigš®_size
 = 
d¡
->
size
();

36 
	gm‘ašdex_hªdË_
.
EncodeTo
(
d¡
);

37 
	gšdex_hªdË_
.
EncodeTo
(
d¡
);

38 
	gd¡
->
»size
(2 * 
BlockHªdË
::
kMaxEncodedL’gth
);

39 
PutFixed32
(
d¡
, 
¡©ic_ÿ¡
<
ušt32_t
>(
kTabËMagicNumb”
 & 0xffffffffu));

40 
PutFixed32
(
d¡
, 
¡©ic_ÿ¡
<
ušt32_t
>(
kTabËMagicNumb”
 >> 32));

41 
as£¹
(
d¡
->
size
(è=ğ
Üigš®_size
 + 
kEncodedL’gth
);

44 
Stus
 
	gFoÙ”
::
DecodeFrom
(
Sliû
* 
šput
) {

45 cÚ¡ * 
magic_±r
 = 
šput
->
d©a
(è+ 
kEncodedL’gth
 - 8;

46 cÚ¡ 
ušt32_t
 
	gmagic_lo
 = 
DecodeFixed32
(
magic_±r
);

47 cÚ¡ 
ušt32_t
 
	gmagic_hi
 = 
DecodeFixed32
(
magic_±r
 + 4);

48 cÚ¡ 
ušt64_t
 
	gmagic
 = ((
¡©ic_ÿ¡
<ušt64_t>(
magic_hi
) << 32) |

49 (
¡©ic_ÿ¡
<
ušt64_t
>(
magic_lo
)));

50 ià(
	gmagic
 !ğ
kTabËMagicNumb”
) {

51  
Stus
::
Inv®idArgum’t
("not‡n sstable (bad magic‚umber)");

54 
Stus
 
	g»suÉ
 = 
m‘ašdex_hªdË_
.
DecodeFrom
(
šput
);

55 ià(
	g»suÉ
.
ok
()) {

56 
	g»suÉ
 = 
šdex_hªdË_
.
DecodeFrom
(
šput
);

58 ià(
	g»suÉ
.
ok
()) {

60 cÚ¡ * 
	g’d
 = 
magic_±r
 + 8;

61 *
	gšput
 = 
Sliû
(
’d
, 
šput
->
d©a
(è+ iÅut->
size
() -ƒnd);

63  
	g»suÉ
;

66 
Stus
 
R—dBlock
(
RªdomAcûssFe
* 
fe
,

67 cÚ¡ 
R—dO±iÚs
& 
İtiÚs
,

68 cÚ¡ 
BlockHªdË
& 
hªdË
,

69 
Block
** 
block
) {

70 *
	gblock
 = 
NULL
;

74 
size_t
 
	gn
 = 
¡©ic_ÿ¡
<size_t>(
hªdË
.
size
());

75 * 
	gbuf
 = 
Ãw
 [
n
 + 
kBlockT¿”Size
];

76 
Sliû
 
	gcÚ‹Ás
;

77 
Stus
 
	gs
 = 
fe
->
R—d
(
hªdË
.
off£t
(), 
n
 + 
kBlockT¿”Size
, &
cÚ‹Ás
, 
buf
);

78 ià(!
	gs
.
ok
()) {

79 
	gd–‘e
[] 
	gbuf
;

80  
	gs
;

82 ià(
	gcÚ‹Ás
.
size
(è!ğ
n
 + 
kBlockT¿”Size
) {

83 
d–‘e
[] 
buf
;

84  
	gStus
::
CÜru±iÚ
("truncated block„ead");

88 cÚ¡ * 
	gd©a
 = 
cÚ‹Ás
.
d©a
();

89 ià(
	gİtiÚs
.
	gv”ify_checksums
) {

90 cÚ¡ 
ušt32_t
 
	güc
 = 
üc32c
::
Unmask
(
DecodeFixed32
(
d©a
 + 
n
 + 1));

91 cÚ¡ 
ušt32_t
 
	gaùu®
 = 
üc32c
::
V®ue
(
d©a
, 
n
 + 1);

92 ià(
	gaùu®
 !ğ
üc
) {

93 
d–‘e
[] 
buf
;

94 
	gs
 = 
Stus
::
CÜru±iÚ
("block checksum mismatch");

95  
	gs
;

99 
	gd©a
[
n
]) {

100 
	gkNoCom´essiÚ
:

101 ià(
d©a
 !ğ
buf
) {

104 
memıy
(
buf
, 
d©a
, 
n
 + 
kBlockT¿”Size
);

109 
	gkSÇµyCom´essiÚ
: {

110 
¡d
::
¡ršg
 
decom´es£d
;

111 ià(!
	gpÜt
::
SÇµy_Uncom´ess
(
d©a
, 
n
, &
decom´es£d
)) {

112 
	gd–‘e
[] 
	gbuf
;

113 
	gs
 = 
Stus
::
CÜru±iÚ
("corrupted compressed block contents");

114  
	gs
;

116 
	gd–‘e
[] 
	gbuf
;

117 
	gbuf
 = 
Ãw
 [
decom´es£d
.
size
()];

118 
memıy
(
buf
, 
decom´es£d
.
d©a
(), decom´es£d.
size
());

119 
	gn
 = 
decom´es£d
.
size
();

123 
d–‘e
[] 
buf
;

124  
	gStus
::
CÜru±iÚ
("bad blockype");

127 *
	gblock
 = 
Ãw
 
Block
(
buf
, 
n
);

128  
	gStus
::
OK
();

	@table/format.h

5 #iâdeà
STORAGE_LEVELDB_TABLE_FORMAT_H_


6 
	#STORAGE_LEVELDB_TABLE_FORMAT_H_


	)

8 
	~<¡ršg
>

9 
	~<¡dšt.h
>

10 
	~"Ëv–db/¦iû.h
"

11 
	~"Ëv–db/¡©us.h
"

12 
	~"Ëv–db/bË_bud”.h
"

14 
Çme¥aû
 
	gËv–db
 {

16 
şass
 
	gBlock
;

17 
şass
 
	gRªdomAcûssFe
;

18 
	gR—dO±iÚs
;

22 şas 
	cBlockHªdË
 {

23 
	gpublic
:

24 
BlockHªdË
();

27 
ušt64_t
 
off£t
(ècÚ¡ {  
	goff£t_
; }

28 
£t_off£t
(
ušt64_t
 
off£t
è{ 
	goff£t_
 = offset; }

31 
ušt64_t
 
size
(ècÚ¡ {  
	gsize_
; }

32 
£t_size
(
ušt64_t
 
size
è{ 
	gsize_
 = size; }

34 
EncodeTo
(
¡d
::
¡ršg
* 
d¡
) const;

35 
Stus
 
DecodeFrom
(
Sliû
* 
šput
);

38 ’um { 
	gkMaxEncodedL’gth
 = 10 + 10 };

40 
	g´iv©e
:

41 
ušt64_t
 
off£t_
;

42 
ušt64_t
 
	gsize_
;

47 şas 
	cFoÙ”
 {

48 
	gpublic
:

49 
FoÙ”
() { }

52 cÚ¡ 
BlockHªdË
& 
m‘ašdex_hªdË
(ècÚ¡ {  
m‘ašdex_hªdË_
; }

53 
£t_m‘ašdex_hªdË
(cÚ¡ 
BlockHªdË
& 
h
è{ 
	gm‘ašdex_hªdË_
 = h; }

56 cÚ¡ 
	gBlockHªdË
& 
šdex_hªdË
() const {

57  
	gšdex_hªdË_
;

59 
£t_šdex_hªdË
(cÚ¡ 
BlockHªdË
& 
h
) {

60 
	gšdex_hªdË_
 = 
h
;

63 
EncodeTo
(
¡d
::
¡ršg
* 
d¡
) const;

64 
Stus
 
DecodeFrom
(
Sliû
* 
šput
);

70 
	gkEncodedL’gth
 = 2*
BlockHªdË
::
kMaxEncodedL’gth
 + 8

73 
	g´iv©e
:

74 
BlockHªdË
 
m‘ašdex_hªdË_
;

75 
BlockHªdË
 
	gšdex_hªdË_
;

81 cÚ¡ 
ušt64_t
 
	gkTabËMagicNumb”
 = 0xdb4775248b80fb57ull;

84 cÚ¡ 
size_t
 
	gkBlockT¿”Size
 = 5;

89 
Stus
 
R—dBlock
(
RªdomAcûssFe
* 
fe
,

90 cÚ¡ 
R—dO±iÚs
& 
İtiÚs
,

91 cÚ¡ 
BlockHªdË
& 
hªdË
,

92 
Block
** 
block
);

96 
šlše
 
	gBlockHªdË
::
	$BlockHªdË
()

97 : 
	`off£t_
(~
¡©ic_ÿ¡
<
ušt64_t
>(0)),

98 
	`size_
(~
¡©ic_ÿ¡
<
ušt64_t
>(0)) {

99 
	}
}

	@table/iterator.cc

5 
	~"Ëv–db/™”©Ü.h
"

6 
	~"ut/loggšg.h
"

8 
Çme¥aû
 
	gËv–db
 {

10 
	gI‹¿tÜ
::
I‹¿tÜ
() {

11 
ş—nup_
.
funùiÚ
 = 
NULL
;

12 
	gş—nup_
.
	gÃxt
 = 
NULL
;

15 
	gI‹¿tÜ
::~
I‹¿tÜ
() {

16 ià(
ş—nup_
.
funùiÚ
 !ğ
NULL
) {

17 (*
ş—nup_
.
funùiÚ
)(ş—nup_.
¬g1
, cËªup_.
¬g2
);

18 
CËªup
* 
	gc
 = 
ş—nup_
.
Ãxt
; c !ğ
NULL
; ) {

19 (*
	gc
->
	gfunùiÚ
)(c->
	g¬g1
, c->
	g¬g2
);

20 
CËªup
* 
	gÃxt
 = 
c
->
Ãxt
;

21 
d–‘e
 
	gc
;

22 
	gc
 = 
Ãxt
;

27 
	gI‹¿tÜ
::
Regi¡”CËªup
(
CËªupFunùiÚ
 
func
, * 
¬g1
, * 
¬g2
) {

28 
as£¹
(
func
 !ğ
NULL
);

29 
CËªup
* 
	gc
;

30 ià(
	gş—nup_
.
	gfunùiÚ
 =ğ
NULL
) {

31 
c
 = &
ş—nup_
;

33 
	gc
 = 
Ãw
 
CËªup
;

34 
	gc
->
	gÃxt
 = 
ş—nup_
.
Ãxt
;

35 
	gş—nup_
.
	gÃxt
 = 
c
;

37 
	gc
->
	gfunùiÚ
 = 
func
;

38 
	gc
->
	g¬g1
 = 
¬g1
;

39 
	gc
->
	g¬g2
 = 
¬g2
;

42 
	gÇme¥aû
 {

43 şas 
	cEm±yI‹¿tÜ
 : 
public
 
I‹¿tÜ
 {

44 
public
:

45 
Em±yI‹¿tÜ
(cÚ¡ 
Stus
& 
s
è: 
¡©us_
(s) { }

46 
vœtu®
 
boŞ
 
V®id
(ècÚ¡ {  
çl£
; }

47 
vœtu®
 
S“k
(cÚ¡ 
Sliû
& 
rg‘
) { }

48 
vœtu®
 
S“kToFœ¡
() { }

49 
vœtu®
 
S“kToLa¡
() { }

50 
vœtu®
 
Next
(è{ 
as£¹
(
çl£
); }

51 
vœtu®
 
P»v
(è{ 
as£¹
(
çl£
); }

52 
Sliû
 
key
(ècÚ¡ { 
as£¹
(
çl£
);  Slice(); }

53 
Sliû
 
v®ue
(ècÚ¡ { 
as£¹
(
çl£
);  Slice(); }

54 
vœtu®
 
Stus
 
¡©us
(ècÚ¡ {  
	g¡©us_
; }

55 
	g´iv©e
:

56 
Stus
 
¡©us_
;

60 
I‹¿tÜ
* 
	$NewEm±yI‹¿tÜ
() {

61  
Ãw
 
	`Em±yI‹¿tÜ
(
Stus
::
	`OK
());

62 
	}
}

64 
I‹¿tÜ
* 
	$NewE¼ÜI‹¿tÜ
(cÚ¡ 
Stus
& 
¡©us
) {

65  
Ãw
 
	`Em±yI‹¿tÜ
(
¡©us
);

66 
	}
}

	@table/iterator_wrapper.h

5 #iâdeà
STORAGE_LEVELDB_TABLE_ITERATOR_WRAPPER_H_


6 
	#STORAGE_LEVELDB_TABLE_ITERATOR_WRAPPER_H_


	)

8 
Çme¥aû
 
	gËv–db
 {

14 şas 
	cI‹¿tÜW¿µ”
 {

15 
	g´iv©e
:

16 
I‹¿tÜ
* 
™”_
;

17 
boŞ
 
	gv®id_
;

18 
Sliû
 
	gkey_
;

19 
	gpublic
:

20 
I‹¿tÜW¿µ”
(): 
™”_
(
NULL
), 
v®id_
(
çl£
) { }

21 
ex¶ic™
 
I‹¿tÜW¿µ”
(
I‹¿tÜ
* 
™”
): 
™”_
(
NULL
) {

22 
S‘
(
™”
);

24 ~
I‹¿tÜW¿µ”
(è{ 
d–‘e
 
	g™”_
; }

25 
I‹¿tÜ
* 
™”
(ècÚ¡ {  
	g™”_
; }

29 
S‘
(
I‹¿tÜ
* 
™”
) {

30 
d–‘e
 
	g™”_
;

31 
	g™”_
 = 
™”
;

32 ià(
	g™”_
 =ğ
NULL
) {

33 
v®id_
 = 
çl£
;

35 
Upd©e
();

41 
boŞ
 
V®id
(ècÚ¡ {  
	gv®id_
; }

42 
Sliû
 
key
(ècÚ¡ { 
as£¹
(
V®id
());  
	gkey_
; }

43 
Sliû
 
v®ue
(ècÚ¡ { 
as£¹
(
V®id
());  
	g™”_
->value(); }

45 
Stus
 
¡©us
(ècÚ¡ { 
as£¹
(
™”_
);  
	g™”_
->status(); }

46 
Next
(è{ 
as£¹
(
™”_
); 
	g™”_
->Next(); 
Upd©e
(); }

47 
P»v
(è{ 
as£¹
(
™”_
); 
	g™”_
->P»v(); 
Upd©e
(); }

48 
S“k
(cÚ¡ 
Sliû
& 
k
è{ 
as£¹
(
™”_
); 
	g™”_
->S“k(k); 
Upd©e
(); }

49 
S“kToFœ¡
(è{ 
as£¹
(
™”_
); 
	g™”_
->S“kToFœ¡(); 
Upd©e
(); }

50 
S“kToLa¡
(è{ 
as£¹
(
™”_
); 
	g™”_
->S“kToLa¡(); 
Upd©e
(); }

52 
	g´iv©e
:

53 
Upd©e
() {

54 
v®id_
 = 
™”_
->
V®id
();

55 ià(
	gv®id_
) {

56 
	gkey_
 = 
™”_
->
key
();

	@table/merger.cc

5 
	~"bË/m”g”.h
"

7 
	~"Ëv–db/com·¿tÜ.h
"

8 
	~"Ëv–db/™”©Ü.h
"

9 
	~"bË/™”©Ü_w¿µ”.h
"

11 
Çme¥aû
 
	gËv–db
 {

13 
	gÇme¥aû
 {

14 şas 
	cM”gšgI‹¿tÜ
 : 
public
 
I‹¿tÜ
 {

15 
public
:

16 
M”gšgI‹¿tÜ
(cÚ¡ 
Com·¿tÜ
* 
com·¿tÜ
, 
I‹¿tÜ
** 
chd»n
, 
n
)

17 : 
com·¿tÜ_
(
com·¿tÜ
),

18 
chd»n_
(
Ãw
 
I‹¿tÜW¿µ”
[
n
]),

19 
n_
(
n
),

20 
cu¼’t_
(
NULL
),

21 
dœeùiÚ_
(
kFÜw¬d
) {

22 
	gi
 = 0; i < 
	gn
; i++) {

23 
	gchd»n_
[
i
].
S‘
(
chd»n
[i]);

27 
	gvœtu®
 ~
M”gšgI‹¿tÜ
() {

28 
	gd–‘e
[] 
	gchd»n_
;

31 
vœtu®
 
boŞ
 
V®id
() const {

32  (
	gcu¼’t_
 !ğ
NULL
);

35 
vœtu®
 
S“kToFœ¡
() {

36 
	gi
 = 0; i < 
	gn_
; i++) {

37 
	gchd»n_
[
i
].
S“kToFœ¡
();

39 
FšdSm®Ë¡
();

40 
	gdœeùiÚ_
 = 
kFÜw¬d
;

43 
vœtu®
 
S“kToLa¡
() {

44 
	gi
 = 0; i < 
	gn_
; i++) {

45 
	gchd»n_
[
i
].
S“kToLa¡
();

47 
FšdL¬ge¡
();

48 
	gdœeùiÚ_
 = 
kRev”£
;

51 
vœtu®
 
S“k
(cÚ¡ 
Sliû
& 
rg‘
) {

52 
	gi
 = 0; i < 
	gn_
; i++) {

53 
	gchd»n_
[
i
].
S“k
(
rg‘
);

55 
FšdSm®Ë¡
();

56 
	gdœeùiÚ_
 = 
kFÜw¬d
;

59 
vœtu®
 
Next
() {

60 
as£¹
(
V®id
());

67 ià(
	gdœeùiÚ_
 !ğ
kFÜw¬d
) {

68 
i
 = 0; 
	gi
 < 
	gn_
; i++) {

69 
I‹¿tÜW¿µ”
* 
	gchd
 = &
chd»n_
[
i
];

70 ià(
	gchd
 !ğ
cu¼’t_
) {

71 
chd
->
S“k
(
key
());

72 ià(
	gchd
->
V®id
() &&

73 
	gcom·¿tÜ_
->
Com·»
(
key
(), 
chd
->key()) == 0) {

74 
chd
->
Next
();

78 
	gdœeùiÚ_
 = 
kFÜw¬d
;

81 
	gcu¼’t_
->
Next
();

82 
FšdSm®Ë¡
();

85 
vœtu®
 
P»v
() {

86 
as£¹
(
V®id
());

93 ià(
	gdœeùiÚ_
 !ğ
kRev”£
) {

94 
i
 = 0; 
	gi
 < 
	gn_
; i++) {

95 
I‹¿tÜW¿µ”
* 
	gchd
 = &
chd»n_
[
i
];

96 ià(
	gchd
 !ğ
cu¼’t_
) {

97 
chd
->
S“k
(
key
());

98 ià(
	gchd
->
V®id
()) {

100 
	gchd
->
P»v
();

103 
	gchd
->
S“kToLa¡
();

107 
	gdœeùiÚ_
 = 
kRev”£
;

110 
	gcu¼’t_
->
P»v
();

111 
FšdL¬ge¡
();

114 
vœtu®
 
Sliû
 
key
() const {

115 
as£¹
(
V®id
());

116  
	gcu¼’t_
->
key
();

119 
vœtu®
 
Sliû
 
v®ue
() const {

120 
as£¹
(
V®id
());

121  
	gcu¼’t_
->
v®ue
();

124 
vœtu®
 
Stus
 
¡©us
() const {

125 
Stus
 
	g¡©us
;

126 
	gi
 = 0; i < 
	gn_
; i++) {

127 
	g¡©us
 = 
chd»n_
[
i
].
¡©us
();

128 ià(!
	g¡©us
.
ok
()) {

132  
	g¡©us
;

135 
	g´iv©e
:

136 
FšdSm®Ë¡
();

137 
FšdL¬ge¡
();

142 cÚ¡ 
Com·¿tÜ
* 
	gcom·¿tÜ_
;

143 
I‹¿tÜW¿µ”
* 
	gchd»n_
;

144 
	gn_
;

145 
I‹¿tÜW¿µ”
* 
	gcu¼’t_
;

148 
	eDœeùiÚ
 {

149 
	gkFÜw¬d
,

150 
	gkRev”£


152 
DœeùiÚ
 
	gdœeùiÚ_
;

155 
	gM”gšgI‹¿tÜ
::
FšdSm®Ë¡
() {

156 
I‹¿tÜW¿µ”
* 
sm®Ë¡
 = 
NULL
;

157 
	gi
 = 0; i < 
	gn_
; i++) {

158 
I‹¿tÜW¿µ”
* 
	gchd
 = &
chd»n_
[
i
];

159 ià(
	gchd
->
V®id
()) {

160 ià(
	gsm®Ë¡
 =ğ
NULL
) {

161 
sm®Ë¡
 = 
chd
;

162 } ià(
	gcom·¿tÜ_
->
Com·»
(
chd
->
key
(), 
sm®Ë¡
->key()) < 0) {

163 
	gsm®Ë¡
 = 
chd
;

167 
	gcu¼’t_
 = 
sm®Ë¡
;

170 
	gM”gšgI‹¿tÜ
::
FšdL¬ge¡
() {

171 
I‹¿tÜW¿µ”
* 
Ïrge¡
 = 
NULL
;

172 
	gi
 = 
n_
-1; i >= 0; i--) {

173 
I‹¿tÜW¿µ”
* 
	gchd
 = &
chd»n_
[
i
];

174 ià(
	gchd
->
V®id
()) {

175 ià(
	gÏrge¡
 =ğ
NULL
) {

176 
Ïrge¡
 = 
chd
;

177 } ià(
	gcom·¿tÜ_
->
Com·»
(
chd
->
key
(), 
Ïrge¡
->key()) > 0) {

178 
	gÏrge¡
 = 
chd
;

182 
	gcu¼’t_
 = 
Ïrge¡
;

186 
I‹¿tÜ
* 
	$NewM”gšgI‹¿tÜ
(cÚ¡ 
Com·¿tÜ
* 
cmp
, 
I‹¿tÜ
** 
li¡
, 
n
) {

187 
	`as£¹
(
n
 >= 0);

188 ià(
n
 == 0) {

189  
	`NewEm±yI‹¿tÜ
();

190 } ià(
n
 == 1) {

191  
li¡
[0];

193  
Ãw
 
	`M”gšgI‹¿tÜ
(
cmp
, 
li¡
, 
n
);

195 
	}
}

	@table/merger.h

5 #iâdeà
STORAGE_LEVELDB_TABLE_MERGER_H_


6 
	#STORAGE_LEVELDB_TABLE_MERGER_H_


	)

8 
Çme¥aû
 
	gËv–db
 {

10 
şass
 
	gCom·¿tÜ
;

11 
şass
 
	gI‹¿tÜ
;

21 
I‹¿tÜ
* 
NewM”gšgI‹¿tÜ
(

22 cÚ¡ 
Com·¿tÜ
* 
com·¿tÜ
, 
I‹¿tÜ
** 
chd»n
, 
n
);

	@table/table.cc

5 
	~"Ëv–db/bË.h
"

7 
	~"Ëv–db/ÿche.h
"

8 
	~"Ëv–db/’v.h
"

9 
	~"bË/block.h
"

10 
	~"bË/fÜm©.h
"

11 
	~"bË/two_Ëv–_™”©Ü.h
"

12 
	~"ut/codšg.h
"

14 
Çme¥aû
 
	gËv–db
 {

16 
	gTabË
::
R•
 {

17 ~
R•
() {

18 
d–‘e
 
šdex_block
;

21 
O±iÚs
 
	gİtiÚs
;

22 
Stus
 
	g¡©us
;

23 
RªdomAcûssFe
* 
	gfe
;

24 
ušt64_t
 
	gÿche_id
;

26 
BlockHªdË
 
	gm‘ašdex_hªdË
;

27 
Block
* 
	gšdex_block
;

30 
Stus
 
	gTabË
::
O³n
(cÚ¡ 
O±iÚs
& 
İtiÚs
,

31 
RªdomAcûssFe
* 
fe
,

32 
ušt64_t
 
size
,

33 
TabË
** 
bË
) {

34 *
	gbË
 = 
NULL
;

35 ià(
	gsize
 < 
	gFoÙ”
::
kEncodedL’gth
) {

36  
Stus
::
Inv®idArgum’t
("file isoo shorto be‡n sstable");

39 
	gfoÙ”_¥aû
[
FoÙ”
::
kEncodedL’gth
];

40 
Sliû
 
	gfoÙ”_šput
;

41 
Stus
 
	gs
 = 
fe
->
R—d
(
size
 - 
FoÙ”
::
kEncodedL’gth
, Footer::kEncodedLength,

42 &
foÙ”_šput
, 
foÙ”_¥aû
);

43 ià(!
	gs
.
ok
())  s;

45 
FoÙ”
 
	gfoÙ”
;

46 
	gs
 = 
foÙ”
.
DecodeFrom
(&
foÙ”_šput
);

47 ià(!
	gs
.
ok
())  s;

50 
Block
* 
	gšdex_block
 = 
NULL
;

51 ià(
	gs
.
ok
()) {

52 
	gs
 = 
R—dBlock
(
fe
, 
R—dO±iÚs
(), 
foÙ”
.
šdex_hªdË
(), &
šdex_block
);

55 ià(
	gs
.
ok
()) {

58 
R•
* 
	g»p
 = 
Ãw
 
TabË
::Rep;

59 
	g»p
->
	gİtiÚs
 = 
İtiÚs
;

60 
	g»p
->
	gfe
 = 
fe
;

61 
	g»p
->
	gm‘ašdex_hªdË
 = 
foÙ”
.
m‘ašdex_hªdË
();

62 
	g»p
->
	gšdex_block
 = 
šdex_block
;

63 
	g»p
->
	gÿche_id
 = (
İtiÚs
.
block_ÿche
 ? o±iÚs.block_ÿche->
NewId
() : 0);

64 *
	gbË
 = 
Ãw
 
TabË
(
»p
);

66 ià(
	gšdex_block
è
d–‘e
 index_block;

69  
	gs
;

72 
	gTabË
::~
TabË
() {

73 
d–‘e
 
»p_
;

76 
D–‘eBlock
(* 
¬g
, * 
ignÜed
) {

77 
d–‘e
 
	g»š‹½»t_ÿ¡
<
	gBlock
*>(
	g¬g
);

80 
D–‘eCachedBlock
(cÚ¡ 
Sliû
& 
key
, * 
v®ue
) {

81 
Block
* 
	gblock
 = 
»š‹½»t_ÿ¡
<Block*>(
v®ue
);

82 
d–‘e
 
	gblock
;

85 
R–—£Block
(* 
¬g
, * 
h
) {

86 
Cache
* 
	gÿche
 = 
»š‹½»t_ÿ¡
<Cache*>(
¬g
);

87 
	gCache
::
HªdË
* 
hªdË
 = 
»š‹½»t_ÿ¡
<
Cache
::HªdË*>(
h
);

88 
	gÿche
->
R–—£
(
hªdË
);

93 
I‹¿tÜ
* 
	gTabË
::
BlockR—d”
(* 
¬g
,

94 cÚ¡ 
R—dO±iÚs
& 
İtiÚs
,

95 cÚ¡ 
Sliû
& 
šdex_v®ue
) {

96 
TabË
* 
	gbË
 = 
»š‹½»t_ÿ¡
<TabË*>(
¬g
);

97 
Cache
* 
	gblock_ÿche
 = 
bË
->
»p_
->
İtiÚs
.
block_ÿche
;

98 
Block
* 
	gblock
 = 
NULL
;

99 
	gCache
::
HªdË
* 
ÿche_hªdË
 = 
NULL
;

101 
BlockHªdË
 
	ghªdË
;

102 
Sliû
 
	gšput
 = 
šdex_v®ue
;

103 
Stus
 
	gs
 = 
hªdË
.
DecodeFrom
(&
šput
);

107 ià(
	gs
.
ok
()) {

108 ià(
	gblock_ÿche
 !ğ
NULL
) {

109 
ÿche_key_bufãr
[16];

110 
EncodeFixed64
(
ÿche_key_bufãr
, 
bË
->
»p_
->
ÿche_id
);

111 
EncodeFixed64
(
ÿche_key_bufãr
+8, 
hªdË
.
off£t
());

112 
Sliû
 
key
(
ÿche_key_bufãr
, (cache_key_buffer));

113 
	gÿche_hªdË
 = 
block_ÿche
->
Lookup
(
key
);

114 ià(
	gÿche_hªdË
 !ğ
NULL
) {

115 
block
 = 
»š‹½»t_ÿ¡
<
Block
*>(
block_ÿche
->
V®ue
(
ÿche_hªdË
));

117 
	gs
 = 
R—dBlock
(
bË
->
»p_
->
fe
, 
İtiÚs
, 
hªdË
, &
block
);

118 ià(
	gs
.
ok
(è&& 
	gİtiÚs
.
	gfl_ÿche
) {

119 
	gÿche_hªdË
 = 
block_ÿche
->
In£¹
(

120 
key
, 
block
, block->
size
(), &
D–‘eCachedBlock
);

124 
	gs
 = 
R—dBlock
(
bË
->
»p_
->
fe
, 
İtiÚs
, 
hªdË
, &
block
);

128 
I‹¿tÜ
* 
	g™”
;

129 ià(
	gblock
 !ğ
NULL
) {

130 
™”
 = 
block
->
NewI‹¿tÜ
(
bË
->
»p_
->
İtiÚs
.
com·¿tÜ
);

131 ià(
	gÿche_hªdË
 =ğ
NULL
) {

132 
™”
->
Regi¡”CËªup
(&
D–‘eBlock
, 
block
, 
NULL
);

134 
	g™”
->
Regi¡”CËªup
(&
R–—£Block
, 
block_ÿche
, 
ÿche_hªdË
);

137 
	g™”
 = 
NewE¼ÜI‹¿tÜ
(
s
);

139  
	g™”
;

142 
I‹¿tÜ
* 
	gTabË
::
NewI‹¿tÜ
(cÚ¡ 
R—dO±iÚs
& 
İtiÚs
) const {

143  
NewTwoLev–I‹¿tÜ
(

144 
»p_
->
šdex_block
->
NewI‹¿tÜ
Ô•_->
İtiÚs
.
com·¿tÜ
),

145 &
TabË
::
BlockR—d”
, 
cÚ¡_ÿ¡
<TabË*>(
this
), 
İtiÚs
);

148 
ušt64_t
 
	gTabË
::
Aµroxim©eOff£tOf
(cÚ¡ 
Sliû
& 
key
) const {

149 
I‹¿tÜ
* 
šdex_™”
 =

150 
»p_
->
šdex_block
->
NewI‹¿tÜ
Ô•_->
İtiÚs
.
com·¿tÜ
);

151 
	gšdex_™”
->
S“k
(
key
);

152 
ušt64_t
 
	g»suÉ
;

153 ià(
	gšdex_™”
->
V®id
()) {

154 
BlockHªdË
 
	ghªdË
;

155 
Sliû
 
	gšput
 = 
šdex_™”
->
v®ue
();

156 
Stus
 
	gs
 = 
hªdË
.
DecodeFrom
(&
šput
);

157 ià(
	gs
.
ok
()) {

158 
	g»suÉ
 = 
hªdË
.
off£t
();

163 
	g»suÉ
 = 
»p_
->
m‘ašdex_hªdË
.
off£t
();

169 
	g»suÉ
 = 
»p_
->
m‘ašdex_hªdË
.
off£t
();

171 
d–‘e
 
	gšdex_™”
;

172  
	g»suÉ
;

	@table/table_builder.cc

5 
	~"Ëv–db/bË_bud”.h
"

7 
	~<as£¹.h
>

8 
	~<¡dio.h
>

9 
	~"Ëv–db/com·¿tÜ.h
"

10 
	~"Ëv–db/’v.h
"

11 
	~"bË/block_bud”.h
"

12 
	~"bË/fÜm©.h
"

13 
	~"ut/codšg.h
"

14 
	~"ut/üc32c.h
"

15 
	~"ut/loggšg.h
"

17 
Çme¥aû
 
	gËv–db
 {

19 
	gTabËBud”
::
R•
 {

20 
O±iÚs
 
İtiÚs
;

21 
O±iÚs
 
	gšdex_block_İtiÚs
;

22 
Wr™abËFe
* 
	gfe
;

23 
ušt64_t
 
	goff£t
;

24 
Stus
 
	g¡©us
;

25 
BlockBud”
 
	gd©a_block
;

26 
BlockBud”
 
	gšdex_block
;

27 
	g¡d
::
¡ršg
 
Ï¡_key
;

28 
št64_t
 
	gnum_’Œ›s
;

29 
boŞ
 
	gşo£d
;

40 
boŞ
 
	g³ndšg_šdex_’Œy
;

41 
BlockHªdË
 
	g³ndšg_hªdË
;

43 
	g¡d
::
¡ršg
 
com´es£d_ouut
;

45 
R•
(cÚ¡ 
O±iÚs
& 
İt
, 
Wr™abËFe
* 
f
)

46 : 
İtiÚs
(
İt
),

47 
šdex_block_İtiÚs
(
İt
),

48 
fe
(
f
),

49 
off£t
(0),

50 
d©a_block
(&
İtiÚs
),

51 
šdex_block
(&
šdex_block_İtiÚs
),

52 
num_’Œ›s
(0),

53 
şo£d
(
çl£
),

54 
³ndšg_šdex_’Œy
(
çl£
) {

55 
	gšdex_block_İtiÚs
.
	gblock_»¡¬t_š‹rv®
 = 1;

59 
	gTabËBud”
::
TabËBud”
(cÚ¡ 
O±iÚs
& 
İtiÚs
, 
Wr™abËFe
* 
fe
)

60 : 
»p_
(
Ãw
 
R•
(
İtiÚs
, 
fe
)) {

63 
	gTabËBud”
::~
TabËBud”
() {

64 
as£¹
(
»p_
->
şo£d
);

65 
d–‘e
 
	g»p_
;

68 
Stus
 
	gTabËBud”
::
ChªgeO±iÚs
(cÚ¡ 
O±iÚs
& 
İtiÚs
) {

72 ià(
İtiÚs
.
com·¿tÜ
 !ğ
»p_
->options.comparator) {

73  
Stus
::
Inv®idArgum’t
("changing comparator while buildingable");

78 
	g»p_
->
	gİtiÚs
 = 
İtiÚs
;

79 
	g»p_
->
	gšdex_block_İtiÚs
 = 
İtiÚs
;

80 
	g»p_
->
	gšdex_block_İtiÚs
.
	gblock_»¡¬t_š‹rv®
 = 1;

81  
	gStus
::
OK
();

84 
	gTabËBud”
::
Add
(cÚ¡ 
Sliû
& 
key
, cÚ¡ Sliû& 
v®ue
) {

85 
R•
* 
	gr
 = 
»p_
;

86 
as£¹
(!
r
->
şo£d
);

87 ià(!
ok
()) ;

88 ià(
	gr
->
	gnum_’Œ›s
 > 0) {

89 
as£¹
(
r
->
İtiÚs
.
com·¿tÜ
->
Com·»
(
key
, 
Sliû
Ô->
Ï¡_key
)) > 0);

92 ià(
	gr
->
	g³ndšg_šdex_’Œy
) {

93 
as£¹
(
r
->
d©a_block
.
em±y
());

94 
	gr
->
	gİtiÚs
.
	gcom·¿tÜ
->
FšdShÜ‹¡S•¬©Ü
(&
r
->
Ï¡_key
, 
key
);

95 
	g¡d
::
¡ršg
 
hªdË_’codšg
;

96 
	gr
->
	g³ndšg_hªdË
.
EncodeTo
(&
hªdË_’codšg
);

97 
	gr
->
	gšdex_block
.
Add
(
r
->
Ï¡_key
, 
Sliû
(
hªdË_’codšg
));

98 
	gr
->
	g³ndšg_šdex_’Œy
 = 
çl£
;

101 
	gr
->
	gÏ¡_key
.
assign
(
key
.
d©a
(), key.
size
());

102 
	gr
->
	gnum_’Œ›s
++;

103 
	gr
->
	gd©a_block
.
Add
(
key
, 
v®ue
);

105 cÚ¡ 
size_t
 
	ge¡im©ed_block_size
 = 
r
->
d©a_block
.
Cu¼’tSizeE¡im©e
();

106 ià(
	ge¡im©ed_block_size
 >ğ
r
->
İtiÚs
.
block_size
) {

107 
Flush
();

111 
	gTabËBud”
::
Flush
() {

112 
R•
* 
r
 = 
»p_
;

113 
as£¹
(!
r
->
şo£d
);

114 ià(!
ok
()) ;

115 ià(
	gr
->
	gd©a_block
.
em±y
()) ;

116 
as£¹
(!
r
->
³ndšg_šdex_’Œy
);

117 
Wr™eBlock
(&
r
->
d©a_block
, &r->
³ndšg_hªdË
);

118 ià(
ok
()) {

119 
	gr
->
	g³ndšg_šdex_’Œy
 = 
Œue
;

120 
	gr
->
	g¡©us
 = 
r
->
fe
->
Flush
();

124 
	gTabËBud”
::
Wr™eBlock
(
BlockBud”
* 
block
, 
BlockHªdË
* 
hªdË
) {

129 
as£¹
(
ok
());

130 
R•
* 
	gr
 = 
»p_
;

131 
Sliû
 
	g¿w
 = 
block
->
Fšish
();

133 
Sliû
 
	gblock_cÚ‹Ás
;

134 
Com´essiÚTy³
 
	gty³
 = 
r
->
İtiÚs
.
com´essiÚ
;

136 
	gty³
) {

137 
	gkNoCom´essiÚ
:

138 
block_cÚ‹Ás
 = 
¿w
;

141 
	gkSÇµyCom´essiÚ
: {

142 
¡d
::
¡ršg
* 
com´es£d
 = &
r
->
com´es£d_ouut
;

143 ià(
	gpÜt
::
SÇµy_Com´ess
(
¿w
.
d©a
(),„aw.
size
(), 
com´es£d
) &&

144 
	gcom´es£d
->
size
(è< 
	g¿w
.size() - (raw.size() / 8u)) {

145 
	gblock_cÚ‹Ás
 = *
com´es£d
;

149 
	gblock_cÚ‹Ás
 = 
¿w
;

150 
	gty³
 = 
kNoCom´essiÚ
;

155 
	ghªdË
->
£t_off£t
(
r
->
off£t
);

156 
	ghªdË
->
£t_size
(
block_cÚ‹Ás
.
size
());

157 
	gr
->
	g¡©us
 = 
r
->
fe
->
Aµ’d
(
block_cÚ‹Ás
);

158 ià(
	gr
->
	g¡©us
.
ok
()) {

159 
	gŒa”
[
kBlockT¿”Size
];

160 
	gŒa”
[0] = 
ty³
;

161 
ušt32_t
 
	güc
 = 
üc32c
::
V®ue
(
block_cÚ‹Ás
.
d©a
(), block_cÚ‹Ás.
size
());

162 
	güc
 = 
üc32c
::
Ex‹nd
(
üc
, 
Œa”
, 1);

163 
EncodeFixed32
(
Œa”
+1, 
üc32c
::
Mask
(
üc
));

164 
	gr
->
	g¡©us
 = 
r
->
fe
->
Aµ’d
(
Sliû
(
Œa”
, 
kBlockT¿”Size
));

165 ià(
	gr
->
	g¡©us
.
ok
()) {

166 
	gr
->
	goff£t
 +ğ
block_cÚ‹Ás
.
size
(è+ 
kBlockT¿”Size
;

169 
	gr
->
	gcom´es£d_ouut
.
ş—r
();

170 
	gblock
->
Re£t
();

173 
Stus
 
	gTabËBud”
::
¡©us
() const {

174  
»p_
->
¡©us
;

177 
Stus
 
	gTabËBud”
::
Fšish
() {

178 
R•
* 
r
 = 
»p_
;

179 
Flush
();

180 
as£¹
(!
r
->
şo£d
);

181 
	gr
->
	gşo£d
 = 
Œue
;

182 
BlockHªdË
 
	gm‘ašdex_block_hªdË
;

183 
BlockHªdË
 
	gšdex_block_hªdË
;

184 ià(
ok
()) {

185 
BlockBud”
 
m‘a_šdex_block
(&
r
->
İtiÚs
);

187 
Wr™eBlock
(&
m‘a_šdex_block
, &
m‘ašdex_block_hªdË
);

189 ià(
ok
()) {

190 ià(
	gr
->
	g³ndšg_šdex_’Œy
) {

191 
	gr
->
	gİtiÚs
.
	gcom·¿tÜ
->
FšdShÜtSucûssÜ
(&
r
->
Ï¡_key
);

192 
	g¡d
::
¡ršg
 
hªdË_’codšg
;

193 
	gr
->
	g³ndšg_hªdË
.
EncodeTo
(&
hªdË_’codšg
);

194 
	gr
->
	gšdex_block
.
Add
(
r
->
Ï¡_key
, 
Sliû
(
hªdË_’codšg
));

195 
	gr
->
	g³ndšg_šdex_’Œy
 = 
çl£
;

197 
Wr™eBlock
(&
r
->
šdex_block
, &
šdex_block_hªdË
);

199 ià(
ok
()) {

200 
FoÙ”
 
	gfoÙ”
;

201 
	gfoÙ”
.
£t_m‘ašdex_hªdË
(
m‘ašdex_block_hªdË
);

202 
	gfoÙ”
.
£t_šdex_hªdË
(
šdex_block_hªdË
);

203 
	g¡d
::
¡ršg
 
foÙ”_’codšg
;

204 
	gfoÙ”
.
EncodeTo
(&
foÙ”_’codšg
);

205 
	gr
->
	g¡©us
 = 
r
->
fe
->
Aµ’d
(
foÙ”_’codšg
);

206 ià(
	gr
->
	g¡©us
.
ok
()) {

207 
	gr
->
	goff£t
 +ğ
foÙ”_’codšg
.
size
();

210  
	gr
->
	g¡©us
;

213 
	gTabËBud”
::
AbªdÚ
() {

214 
R•
* 
r
 = 
»p_
;

215 
as£¹
(!
r
->
şo£d
);

216 
	gr
->
	gşo£d
 = 
Œue
;

219 
ušt64_t
 
	gTabËBud”
::
NumEÁr›s
() const {

220  
»p_
->
num_’Œ›s
;

223 
ušt64_t
 
	gTabËBud”
::
FeSize
() const {

224  
»p_
->
off£t
;

	@table/table_test.cc

5 
	~"Ëv–db/bË.h
"

7 
	~<m­
>

8 
	~"db/dbfÜm©.h
"

9 
	~"db/membË.h
"

10 
	~"db/wr™e_b©ch_š‹º®.h
"

11 
	~"Ëv–db/db.h
"

12 
	~"Ëv–db/’v.h
"

13 
	~"Ëv–db/™”©Ü.h
"

14 
	~"Ëv–db/bË_bud”.h
"

15 
	~"bË/block.h
"

16 
	~"bË/block_bud”.h
"

17 
	~"bË/fÜm©.h
"

18 
	~"ut/¿ndom.h
"

19 
	~"ut/‹¡h¬Ãss.h
"

20 
	~"ut/‹¡ut.h
"

22 
Çme¥aû
 
	gËv–db
 {

26 
	g¡d
::
¡ršg
 
Rev”£
(cÚ¡ 
Sliû
& 
key
) {

27 
¡d
::
¡ršg
 
¡r
(
key
.
ToSŒšg
());

28 
	g¡d
::
¡ršg
 
»v
(
¡r
.
rbegš
(), sŒ.
»nd
());

29  
	g»v
;

32 
	gÇme¥aû
 {

33 şas 
	cRev”£KeyCom·¿tÜ
 : 
public
 
Com·¿tÜ
 {

34 
public
:

35 
vœtu®
 cÚ¡ * 
Name
() const {

39 
vœtu®
 
Com·»
(cÚ¡ 
Sliû
& 
a
, cÚ¡ Sliû& 
b
) const {

40  
By‹wi£Com·¿tÜ
()->
Com·»
(
Rev”£
(
a
), Rev”£(
b
));

43 
vœtu®
 
FšdShÜ‹¡S•¬©Ü
(

44 
¡d
::
¡ršg
* 
¡¬t
,

45 cÚ¡ 
Sliû
& 
lim™
) const {

46 
	g¡d
::
¡ršg
 
s
 = 
Rev”£
(*
¡¬t
);

47 
	g¡d
::
¡ršg
 
l
 = 
Rev”£
(
lim™
);

48 
By‹wi£Com·¿tÜ
()->
FšdShÜ‹¡S•¬©Ü
(&
s
, 
l
);

49 *
	g¡¬t
 = 
Rev”£
(
s
);

52 
vœtu®
 
FšdShÜtSucûssÜ
(
¡d
::
¡ršg
* 
key
) const {

53 
¡d
::
¡ršg
 
s
 = 
Rev”£
(*
key
);

54 
By‹wi£Com·¿tÜ
()->
FšdShÜtSucûssÜ
(&
s
);

55 *
	gkey
 = 
Rev”£
(
s
);

59 
Rev”£KeyCom·¿tÜ
 
	g»v”£_key_com·¿tÜ
;

61 
Inüem’t
(cÚ¡ 
Com·¿tÜ
* 
cmp
, 
¡d
::
¡ršg
* 
key
) {

62 ià(
cmp
 =ğ
By‹wi£Com·¿tÜ
()) {

63 
key
->
push_back
('\0');

65 
as£¹
(
cmp
 =ğ&
»v”£_key_com·¿tÜ
);

66 
	g¡d
::
¡ršg
 
»v
 = 
Rev”£
(*
key
);

67 
	g»v
.
push_back
('\0');

68 *
	gkey
 = 
Rev”£
(
»v
);

73 
	gÇme¥aû
 {

74 
	sSTLLessThª
 {

75 cÚ¡ 
Com·¿tÜ
* 
	gcmp
;

77 
STLLessThª
(è: 
cmp
(
By‹wi£Com·¿tÜ
()) { }

78 
STLLessThª
(cÚ¡ 
Com·¿tÜ
* 
c
è: 
cmp
(c) { }

79 
boŞ
 
İ”©Ü
()(cÚ¡ 
¡d
::
¡ršg
& 
a
, cÚ¡ 
	g¡d
::¡ršg& 
b
) const {

80  
cmp
->
Com·»
(
Sliû
(
a
), Sliû(
b
)) < 0;

85 şas 
	cSŒšgSšk
: 
public
 
Wr™abËFe
 {

86 
public
:

87 ~
SŒšgSšk
() { }

89 cÚ¡ 
¡d
::
¡ršg
& 
cÚ‹Ás
(ècÚ¡ {  
cÚ‹Ás_
; }

91 
vœtu®
 
Stus
 
Clo£
(è{  
	gStus
::
OK
(); }

92 
vœtu®
 
Stus
 
Flush
(è{  
	gStus
::
OK
(); }

93 
vœtu®
 
Stus
 
Sync
(è{  
	gStus
::
OK
(); }

95 
vœtu®
 
Stus
 
Aµ’d
(cÚ¡ 
Sliû
& 
d©a
) {

96 
	gcÚ‹Ás_
.
­³nd
(
d©a
.d©a(), d©a.
size
());

97  
	gStus
::
OK
();

100 
	g´iv©e
:

101 
¡d
::
¡ršg
 
cÚ‹Ás_
;

105 şas 
	cSŒšgSourû
: 
public
 
RªdomAcûssFe
 {

106 
public
:

107 
SŒšgSourû
(cÚ¡ 
Sliû
& 
cÚ‹Ás
)

108 : 
cÚ‹Ás_
(
cÚ‹Ás
.
d©a
(), cÚ‹Ás.
size
()) {

111 
	gvœtu®
 ~
SŒšgSourû
() { }

113 
ušt64_t
 
Size
(ècÚ¡ {  
	gcÚ‹Ás_
.
size
(); }

115 
vœtu®
 
Stus
 
R—d
(
ušt64_t
 
off£t
, 
size_t
 
n
, 
Sliû
* 
»suÉ
,

116 * 
sü©ch
) const {

117 ià(
	goff£t
 > 
	gcÚ‹Ás_
.
size
()) {

118  
	gStus
::
Inv®idArgum’t
("invalid Read offset");

120 ià(
	goff£t
 + 
	gn
 > 
	gcÚ‹Ás_
.
size
()) {

121 
	gn
 = 
cÚ‹Ás_
.
size
(è- 
off£t
;

123 
memıy
(
sü©ch
, &
cÚ‹Ás_
[
off£t
], 
n
);

124 *
	g»suÉ
 = 
Sliû
(
sü©ch
, 
n
);

125  
	gStus
::
OK
();

128 
	g´iv©e
:

129 
¡d
::
¡ršg
 
cÚ‹Ás_
;

132 
	g¡d
::
	tm­
<
	t¡d
::
	t¡ršg
, std::¡ršg, 
	tSTLLessThª
> 
	tKVM­
;

136 şas 
	cCÚ¡ruùÜ
 {

137 
	gpublic
:

138 
ex¶ic™
 
CÚ¡ruùÜ
(cÚ¡ 
Com·¿tÜ
* 
cmp
è: 
d©a_
(
STLLessThª
(cmp)) { }

139 
vœtu®
 ~
CÚ¡ruùÜ
() { }

141 
Add
(cÚ¡ 
¡d
::
¡ršg
& 
key
, cÚ¡ 
Sliû
& 
v®ue
) {

142 
	gd©a_
[
key
] = 
v®ue
.
ToSŒšg
();

148 
Fšish
(cÚ¡ 
O±iÚs
& 
İtiÚs
,

149 
¡d
::
veùÜ
<¡d::
¡ršg
>* 
keys
,

150 
KVM­
* 
kvm­
) {

151 *
	gkvm­
 = 
d©a_
;

152 
	gkeys
->
ş—r
();

153 
	gKVM­
::
cÚ¡_™”©Ü
 
™
 = 
d©a_
.
begš
();

154 
	g™
 !ğ
d©a_
.
’d
();

155 ++
	g™
) {

156 
	gkeys
->
push_back
(
™
->
fœ¡
);

158 
	gd©a_
.
ş—r
();

159 
Stus
 
	gs
 = 
FšishIm¶
(
İtiÚs
, *
kvm­
);

160 
ASSERT_TRUE
(
s
.
ok
()è<< 
	gs
.
ToSŒšg
();

164 
vœtu®
 
Stus
 
FšishIm¶
(cÚ¡ 
O±iÚs
& 
İtiÚs
, cÚ¡ 
KVM­
& 
d©a
) = 0;

166 
vœtu®
 
size_t
 
NumBy‹s
() const = 0;

168 
vœtu®
 
I‹¿tÜ
* 
NewI‹¿tÜ
() const = 0;

170 
vœtu®
 cÚ¡ 
	gKVM­
& 
d©a
(è{  
	gd©a_
; }

172 
vœtu®
 
DB
* 
db
(ècÚ¡ {  
	gNULL
; }

174 
	g´iv©e
:

175 
KVM­
 
d©a_
;

178 şas 
	cBlockCÚ¡ruùÜ
: 
public
 
CÚ¡ruùÜ
 {

179 
public
:

180 
ex¶ic™
 
BlockCÚ¡ruùÜ
(cÚ¡ 
Com·¿tÜ
* 
cmp
)

181 : 
CÚ¡ruùÜ
(
cmp
),

182 
com·¿tÜ_
(
cmp
),

183 
block_size_
(-1),

184 
block_
(
NULL
) { }

185 ~
BlockCÚ¡ruùÜ
() {

186 
d–‘e
 
	gblock_
;

188 
vœtu®
 
Stus
 
FšishIm¶
(cÚ¡ 
O±iÚs
& 
İtiÚs
, cÚ¡ 
KVM­
& 
d©a
) {

189 
d–‘e
 
	gblock_
;

190 
	gblock_
 = 
NULL
;

191 
BlockBud”
 
bud”
(&
İtiÚs
);

193 
	gKVM­
::
cÚ¡_™”©Ü
 
™
 = 
d©a
.
begš
();

194 
	g™
 !ğ
d©a
.
’d
();

195 ++
	g™
) {

196 
	gbud”
.
Add
(
™
->
fœ¡
, it->
£cÚd
);

199 
Sliû
 
	gblock_d©a
 = 
bud”
.
Fšish
();

200 
	gblock_size_
 = 
block_d©a
.
size
();

201 * 
	gblock_d©a_cİy
 = 
Ãw
 [
block_size_
];

202 
memıy
(
block_d©a_cİy
, 
block_d©a
.
d©a
(), 
block_size_
);

203 
	gblock_
 = 
Ãw
 
Block
(
block_d©a_cİy
, 
block_size_
);

204  
	gStus
::
OK
();

206 
vœtu®
 
size_t
 
NumBy‹s
(ècÚ¡ {  
	gblock_size_
; }

208 
vœtu®
 
I‹¿tÜ
* 
NewI‹¿tÜ
() const {

209  
	gblock_
->
NewI‹¿tÜ
(
com·¿tÜ_
);

212 
	g´iv©e
:

213 cÚ¡ 
Com·¿tÜ
* 
com·¿tÜ_
;

214 
	gblock_size_
;

215 
Block
* 
	gblock_
;

217 
BlockCÚ¡ruùÜ
();

220 şas 
	cTabËCÚ¡ruùÜ
: 
public
 
CÚ¡ruùÜ
 {

221 
public
:

222 
TabËCÚ¡ruùÜ
(cÚ¡ 
Com·¿tÜ
* 
cmp
)

223 : 
CÚ¡ruùÜ
(
cmp
),

224 
sourû_
(
NULL
), 
bË_
(NULL) {

226 ~
TabËCÚ¡ruùÜ
() {

227 
Re£t
();

229 
vœtu®
 
Stus
 
FšishIm¶
(cÚ¡ 
O±iÚs
& 
İtiÚs
, cÚ¡ 
KVM­
& 
d©a
) {

230 
Re£t
();

231 
SŒšgSšk
 
	gsšk
;

232 
TabËBud”
 
bud”
(
İtiÚs
, &
sšk
);

234 
	gKVM­
::
cÚ¡_™”©Ü
 
™
 = 
d©a
.
begš
();

235 
	g™
 !ğ
d©a
.
’d
();

236 ++
	g™
) {

237 
	gbud”
.
Add
(
™
->
fœ¡
, it->
£cÚd
);

238 
ASSERT_TRUE
(
bud”
.
¡©us
().
ok
());

240 
Stus
 
	gs
 = 
bud”
.
Fšish
();

241 
ASSERT_TRUE
(
s
.
ok
()è<< 
	gs
.
ToSŒšg
();

243 
ASSERT_EQ
(
sšk
.
cÚ‹Ás
().
size
(), 
bud”
.
FeSize
());

246 
	gsourû_
 = 
Ãw
 
SŒšgSourû
(
sšk
.
cÚ‹Ás
());

247 
O±iÚs
 
	gbË_İtiÚs
;

248 
	gbË_İtiÚs
.
	gcom·¿tÜ
 = 
İtiÚs
.
com·¿tÜ
;

249  
	gTabË
::
O³n
(
bË_İtiÚs
, 
sourû_
, 
sšk
.
cÚ‹Ás
().
size
(), &
bË_
);

251 
vœtu®
 
size_t
 
NumBy‹s
(ècÚ¡ {  
	gsourû_
->
Size
(); }

253 
vœtu®
 
I‹¿tÜ
* 
NewI‹¿tÜ
() const {

254  
	gbË_
->
NewI‹¿tÜ
(
R—dO±iÚs
());

257 
ušt64_t
 
Aµroxim©eOff£tOf
(cÚ¡ 
Sliû
& 
key
) const {

258  
	gbË_
->
Aµroxim©eOff£tOf
(
key
);

261 
	g´iv©e
:

262 
Re£t
() {

263 
d–‘e
 
bË_
;

264 
d–‘e
 
	gsourû_
;

265 
	gbË_
 = 
NULL
;

266 
	gsourû_
 = 
NULL
;

269 
SŒšgSourû
* 
	gsourû_
;

270 
TabË
* 
	gbË_
;

272 
TabËCÚ¡ruùÜ
();

276 şas 
	cKeyCÚv”tšgI‹¿tÜ
: 
public
 
I‹¿tÜ
 {

277 
public
:

278 
ex¶ic™
 
KeyCÚv”tšgI‹¿tÜ
(
I‹¿tÜ
* 
™”
è: 
™”_
(iter) { }

279 
vœtu®
 ~
KeyCÚv”tšgI‹¿tÜ
(è{ 
d–‘e
 
™”_
; }

280 
vœtu®
 
boŞ
 
V®id
(ècÚ¡ {  
	g™”_
->Valid(); }

281 
vœtu®
 
S“k
(cÚ¡ 
Sliû
& 
rg‘
) {

282 
P¬£dIÁ”ÇlKey
 
ikey
(
rg‘
, 
kMaxSequ’ûNumb”
, 
kTy³V®ue
);

283 
	g¡d
::
¡ršg
 
’coded
;

284 
Aµ’dIÁ”ÇlKey
(&
’coded
, 
ikey
);

285 
	g™”_
->
S“k
(
’coded
);

287 
vœtu®
 
S“kToFœ¡
(è{ 
	g™”_
->SeekToFirst(); }

288 
vœtu®
 
S“kToLa¡
(è{ 
	g™”_
->SeekToLast(); }

289 
vœtu®
 
Next
(è{ 
	g™”_
->Next(); }

290 
vœtu®
 
P»v
(è{ 
	g™”_
->Prev(); }

292 
vœtu®
 
Sliû
 
key
() const {

293 
as£¹
(
V®id
());

294 
P¬£dIÁ”ÇlKey
 
	gkey
;

295 ià(!
P¬£IÁ”ÇlKey
(
™”_
->
key
(), &key)) {

296 
	g¡©us_
 = 
Stus
::
CÜru±iÚ
("malformed internal key");

297  
Sliû
("corrupted key");

299  
	gkey
.
	gu£r_key
;

302 
vœtu®
 
Sliû
 
v®ue
(ècÚ¡ {  
	g™”_
->value(); }

303 
vœtu®
 
Stus
 
¡©us
() const {

304  
	g¡©us_
.
ok
(è? 
	g™”_
->
¡©us
(è: 
¡©us_
;

307 
	g´iv©e
:

308 
mubË
 
Stus
 
¡©us_
;

309 
I‹¿tÜ
* 
	g™”_
;

312 
KeyCÚv”tšgI‹¿tÜ
(const KeyConvertingIterator&);

313 
	gİ”©Ü
=(cÚ¡ 
KeyCÚv”tšgI‹¿tÜ
&);

316 şas 
	cMemTabËCÚ¡ruùÜ
: 
public
 
CÚ¡ruùÜ
 {

317 
public
:

318 
ex¶ic™
 
MemTabËCÚ¡ruùÜ
(cÚ¡ 
Com·¿tÜ
* 
cmp
)

319 : 
CÚ¡ruùÜ
(
cmp
),

320 
š‹º®_com·¿tÜ_
(
cmp
) {

321 
	gmembË_
 = 
Ãw
 
MemTabË
(
š‹º®_com·¿tÜ_
);

323 ~
MemTabËCÚ¡ruùÜ
() {

324 
d–‘e
 
	gmembË_
;

326 
vœtu®
 
Stus
 
FšishIm¶
(cÚ¡ 
O±iÚs
& 
İtiÚs
, cÚ¡ 
KVM­
& 
d©a
) {

327 
d–‘e
 
	gmembË_
;

328 
	gmembË_
 = 
Ãw
 
MemTabË
(
š‹º®_com·¿tÜ_
);

329 
	g£q
 = 1;

330 
	gKVM­
::
cÚ¡_™”©Ü
 
™
 = 
d©a
.
begš
();

331 
	g™
 !ğ
d©a
.
’d
();

332 ++
	g™
) {

333 
	gmembË_
->
Add
(
£q
, 
kTy³V®ue
, 
™
->
fœ¡
, it->
£cÚd
);

334 
	g£q
++;

336  
	gStus
::
OK
();

338 
vœtu®
 
size_t
 
NumBy‹s
() const {

339  
	gmembË_
->
Aµroxim©eMemÜyU§ge
();

342 
vœtu®
 
I‹¿tÜ
* 
NewI‹¿tÜ
() const {

343  
Ãw
 
KeyCÚv”tšgI‹¿tÜ
(
membË_
->
NewI‹¿tÜ
());

346 
	g´iv©e
:

347 
IÁ”ÇlKeyCom·¿tÜ
 
š‹º®_com·¿tÜ_
;

348 
MemTabË
* 
	gmembË_
;

351 şas 
	cDBCÚ¡ruùÜ
: 
public
 
CÚ¡ruùÜ
 {

352 
public
:

353 
ex¶ic™
 
DBCÚ¡ruùÜ
(cÚ¡ 
Com·¿tÜ
* 
cmp
)

354 : 
CÚ¡ruùÜ
(
cmp
),

355 
com·¿tÜ_
(
cmp
) {

356 
	gdb_
 = 
NULL
;

357 
NewDB
();

359 ~
DBCÚ¡ruùÜ
() {

360 
d–‘e
 
	gdb_
;

362 
vœtu®
 
Stus
 
FšishIm¶
(cÚ¡ 
O±iÚs
& 
İtiÚs
, cÚ¡ 
KVM­
& 
d©a
) {

363 
d–‘e
 
	gdb_
;

364 
	gdb_
 = 
NULL
;

365 
NewDB
();

366 
	gKVM­
::
cÚ¡_™”©Ü
 
™
 = 
d©a
.
begš
();

367 
	g™
 !ğ
d©a
.
’d
();

368 ++
	g™
) {

369 
Wr™eB©ch
 
	gb©ch
;

370 
	gb©ch
.
Put
(
™
->
fœ¡
, it->
£cÚd
);

371 
ASSERT_TRUE
(
db_
->
Wr™e
(
Wr™eO±iÚs
(), &
b©ch
).
ok
());

373  
	gStus
::
OK
();

375 
vœtu®
 
size_t
 
NumBy‹s
() const {

376 
Rªge
 
r
("", "\xff\xff");

377 
ušt64_t
 
	gsize
;

378 
	gdb_
->
G‘Aµroxim©eSizes
(&
r
, 1, &
size
);

379  
	gsize
;

382 
vœtu®
 
I‹¿tÜ
* 
NewI‹¿tÜ
() const {

383  
	gdb_
->
NewI‹¿tÜ
(
R—dO±iÚs
());

386 
vœtu®
 
DB
* 
db
(ècÚ¡ {  
	gdb_
; }

388 
	g´iv©e
:

389 
NewDB
() {

390 
¡d
::
¡ršg
 
Çme
 = 
‹¡
::
TmpDœ
() + "/table_testdb";

392 
O±iÚs
 
	gİtiÚs
;

393 
	gİtiÚs
.
	gcom·¿tÜ
 = 
com·¿tÜ_
;

394 
Stus
 
	g¡©us
 = 
De¡royDB
(
Çme
, 
İtiÚs
);

395 
ASSERT_TRUE
(
¡©us
.
ok
()è<< 
	g¡©us
.
ToSŒšg
();

397 
	gİtiÚs
.
	gü—‹_if_missšg
 = 
Œue
;

398 
	gİtiÚs
.
	g”rÜ_if_exi¡s
 = 
Œue
;

399 
	gİtiÚs
.
	gwr™e_bufãr_size
 = 10000;

400 
	g¡©us
 = 
DB
::
O³n
(
İtiÚs
, 
Çme
, &
db_
);

401 
ASSERT_TRUE
(
¡©us
.
ok
()è<< 
	g¡©us
.
ToSŒšg
();

404 cÚ¡ 
Com·¿tÜ
* 
	gcom·¿tÜ_
;

405 
DB
* 
	gdb_
;

408 
	eTe¡Ty³
 {

409 
	gTABLE_TEST
,

410 
	gBLOCK_TEST
,

411 
	gMEMTABLE_TEST
,

412 
	gDB_TEST
,

415 
	sTe¡Args
 {

416 
Te¡Ty³
 
	gty³
;

417 
boŞ
 
	g»v”£_com·»
;

418 
	g»¡¬t_š‹rv®
;

421 cÚ¡ 
Te¡Args
 
	gkTe¡ArgLi¡
[] = {

422 { 
TABLE_TEST
, 
çl£
, 16 },

423 { 
TABLE_TEST
, 
çl£
, 1 },

424 { 
TABLE_TEST
, 
çl£
, 1024 },

425 { 
TABLE_TEST
, 
Œue
, 16 },

426 { 
TABLE_TEST
, 
Œue
, 1 },

427 { 
TABLE_TEST
, 
Œue
, 1024 },

429 { 
BLOCK_TEST
, 
çl£
, 16 },

430 { 
BLOCK_TEST
, 
çl£
, 1 },

431 { 
BLOCK_TEST
, 
çl£
, 1024 },

432 { 
BLOCK_TEST
, 
Œue
, 16 },

433 { 
BLOCK_TEST
, 
Œue
, 1 },

434 { 
BLOCK_TEST
, 
Œue
, 1024 },

437 { 
MEMTABLE_TEST
, 
çl£
, 16 },

438 { 
MEMTABLE_TEST
, 
Œue
, 16 },

441 { 
DB_TEST
, 
çl£
, 16 },

442 { 
DB_TEST
, 
Œue
, 16 },

444 cÚ¡ 
	gkNumTe¡Args
 = (
kTe¡ArgLi¡
) / (kTestArgList[0]);

446 şas 
	cH¬Ãss
 {

447 
	gpublic
:

448 
H¬Ãss
(è: 
cÚ¡ruùÜ_
(
NULL
) { }

450 
In™
(cÚ¡ 
Te¡Args
& 
¬gs
) {

451 
d–‘e
 
cÚ¡ruùÜ_
;

452 
	gcÚ¡ruùÜ_
 = 
NULL
;

453 
	gİtiÚs_
 = 
O±iÚs
();

455 
	gİtiÚs_
.
	gblock_»¡¬t_š‹rv®
 = 
¬gs
.
»¡¬t_š‹rv®
;

458 
	gİtiÚs_
.
	gblock_size
 = 256;

459 ià(
	g¬gs
.
	g»v”£_com·»
) {

460 
	gİtiÚs_
.
	gcom·¿tÜ
 = &
»v”£_key_com·¿tÜ
;

462 
	g¬gs
.
	gty³
) {

463 
	gTABLE_TEST
:

464 
cÚ¡ruùÜ_
 = 
Ãw
 
TabËCÚ¡ruùÜ
(
İtiÚs_
.
com·¿tÜ
);

466 
	gBLOCK_TEST
:

467 
cÚ¡ruùÜ_
 = 
Ãw
 
BlockCÚ¡ruùÜ
(
İtiÚs_
.
com·¿tÜ
);

469 
	gMEMTABLE_TEST
:

470 
cÚ¡ruùÜ_
 = 
Ãw
 
MemTabËCÚ¡ruùÜ
(
İtiÚs_
.
com·¿tÜ
);

472 
	gDB_TEST
:

473 
cÚ¡ruùÜ_
 = 
Ãw
 
DBCÚ¡ruùÜ
(
İtiÚs_
.
com·¿tÜ
);

478 ~
H¬Ãss
() {

479 
d–‘e
 
	gcÚ¡ruùÜ_
;

482 
Add
(cÚ¡ 
¡d
::
¡ršg
& 
key
, cÚ¡ std::¡ršg& 
v®ue
) {

483 
cÚ¡ruùÜ_
->
Add
(
key
, 
v®ue
);

486 
Te¡
(
Rªdom
* 
ºd
) {

487 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
keys
;

488 
KVM­
 
	gd©a
;

489 
	gcÚ¡ruùÜ_
->
Fšish
(
İtiÚs_
, &
keys
, &
d©a
);

491 
Te¡FÜw¬dSÿn
(
keys
, 
d©a
);

492 
Te¡Backw¬dSÿn
(
keys
, 
d©a
);

493 
Te¡RªdomAcûss
(
ºd
, 
keys
, 
d©a
);

496 
Te¡FÜw¬dSÿn
(cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>& 
keys
,

497 cÚ¡ 
KVM­
& 
d©a
) {

498 
I‹¿tÜ
* 
	g™”
 = 
cÚ¡ruùÜ_
->
NewI‹¿tÜ
();

499 
ASSERT_TRUE
(!
™”
->
V®id
());

500 
	g™”
->
S“kToFœ¡
();

501 
	gKVM­
::
cÚ¡_™”©Ü
 
mod–_™”
 = 
d©a
.
begš
();

502 
	gmod–_™”
 !ğ
d©a
.
’d
();

503 ++
	gmod–_™”
) {

504 
ASSERT_EQ
(
ToSŒšg
(
d©a
, 
mod–_™”
), ToSŒšg(
™”
));

505 
	g™”
->
Next
();

507 
ASSERT_TRUE
(!
™”
->
V®id
());

508 
d–‘e
 
	g™”
;

511 
Te¡Backw¬dSÿn
(cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>& 
keys
,

512 cÚ¡ 
KVM­
& 
d©a
) {

513 
I‹¿tÜ
* 
	g™”
 = 
cÚ¡ruùÜ_
->
NewI‹¿tÜ
();

514 
ASSERT_TRUE
(!
™”
->
V®id
());

515 
	g™”
->
S“kToLa¡
();

516 
	gKVM­
::
cÚ¡_»v”£_™”©Ü
 
mod–_™”
 = 
d©a
.
rbegš
();

517 
	gmod–_™”
 !ğ
d©a
.
»nd
();

518 ++
	gmod–_™”
) {

519 
ASSERT_EQ
(
ToSŒšg
(
d©a
, 
mod–_™”
), ToSŒšg(
™”
));

520 
	g™”
->
P»v
();

522 
ASSERT_TRUE
(!
™”
->
V®id
());

523 
d–‘e
 
	g™”
;

526 
Te¡RªdomAcûss
(
Rªdom
* 
ºd
,

527 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
>& 
keys
,

528 cÚ¡ 
KVM­
& 
d©a
) {

529 cÚ¡ 
boŞ
 
	gkV”bo£
 = 
çl£
;

530 
I‹¿tÜ
* 
	g™”
 = 
cÚ¡ruùÜ_
->
NewI‹¿tÜ
();

531 
ASSERT_TRUE
(!
™”
->
V®id
());

532 
	gKVM­
::
cÚ¡_™”©Ü
 
mod–_™”
 = 
d©a
.
begš
();

533 ià(
	gkV”bo£
è
årštf
(
¡d”r
, "---\n");

534 
	gi
 = 0; i < 200; i++) {

535 cÚ¡ 
	gtoss
 = 
ºd
->
UnifÜm
(5);

536 
	gtoss
) {

538 ià(
™”
->
V®id
()) {

539 ià(
kV”bo£
è
årštf
(
¡d”r
, "Next\n");

540 
	g™”
->
Next
();

541 ++
	gmod–_™”
;

542 
ASSERT_EQ
(
ToSŒšg
(
d©a
, 
mod–_™”
), ToSŒšg(
™”
));

548 ià(
kV”bo£
è
årštf
(
¡d”r
, "SeekToFirst\n");

549 
	g™”
->
S“kToFœ¡
();

550 
	gmod–_™”
 = 
d©a
.
begš
();

551 
ASSERT_EQ
(
ToSŒšg
(
d©a
, 
mod–_™”
), ToSŒšg(
™”
));

556 
¡d
::
¡ršg
 
key
 = 
PickRªdomKey
(
ºd
, 
keys
);

557 
	gmod–_™”
 = 
d©a
.
low”_bound
(
key
);

558 ià(
	gkV”bo£
è
årštf
(
¡d”r
, "Seek '%s'\n",

559 
Esÿ³SŒšg
(
key
).
c_¡r
());

560 
	g™”
->
S“k
(
Sliû
(
key
));

561 
ASSERT_EQ
(
ToSŒšg
(
d©a
, 
mod–_™”
), ToSŒšg(
™”
));

566 ià(
™”
->
V®id
()) {

567 ià(
kV”bo£
è
årštf
(
¡d”r
, "Prev\n");

568 
	g™”
->
P»v
();

569 ià(
	gmod–_™”
 =ğ
d©a
.
begš
()) {

570 
mod–_™”
 = 
d©a
.
’d
();

572 --
	gmod–_™”
;

574 
ASSERT_EQ
(
ToSŒšg
(
d©a
, 
mod–_™”
), ToSŒšg(
™”
));

580 ià(
kV”bo£
è
årštf
(
¡d”r
, "SeekToLast\n");

581 
	g™”
->
S“kToLa¡
();

582 ià(
	gkeys
.
em±y
()) {

583 
	gmod–_™”
 = 
d©a
.
’d
();

585 
	g¡d
::
¡ršg
 
Ï¡
 = 
d©a
.
rbegš
()->
fœ¡
;

586 
	gmod–_™”
 = 
d©a
.
low”_bound
(
Ï¡
);

588 
ASSERT_EQ
(
ToSŒšg
(
d©a
, 
mod–_™”
), ToSŒšg(
™”
));

593 
d–‘e
 
	g™”
;

596 
	g¡d
::
¡ršg
 
ToSŒšg
(cÚ¡ 
KVM­
& 
d©a
, cÚ¡ KVM­::
cÚ¡_™”©Ü
& 
™
) {

597 ià(
™
 =ğ
d©a
.
’d
()) {

600  "'" + 
	g™
->
	gfœ¡
 + "->" + it->
	g£cÚd
 + "'";

604 
	g¡d
::
¡ršg
 
ToSŒšg
(cÚ¡ 
KVM­
& 
d©a
,

605 cÚ¡ 
KVM­
::
cÚ¡_»v”£_™”©Ü
& 
™
) {

606 ià(
™
 =ğ
d©a
.
»nd
()) {

609  "'" + 
	g™
->
	gfœ¡
 + "->" + it->
	g£cÚd
 + "'";

613 
	g¡d
::
¡ršg
 
ToSŒšg
(cÚ¡ 
I‹¿tÜ
* 
™
) {

614 ià(!
™
->
V®id
()) {

617  "'" + 
	g™
->
key
().
ToSŒšg
(è+ "->" + it->
v®ue
().ToString() + "'";

621 
	g¡d
::
¡ršg
 
PickRªdomKey
(
Rªdom
* 
ºd
, cÚ¡ 
¡d
::
veùÜ
<¡d::¡ršg>& 
keys
) {

622 ià(
keys
.
em±y
()) {

625 cÚ¡ 
	gšdex
 = 
ºd
->
UnifÜm
(
keys
.
size
());

626 
	g¡d
::
¡ršg
 
»suÉ
 = 
keys
[
šdex
];

627 
	gºd
->
UnifÜm
(3)) {

633 ià(
»suÉ
.
size
() > 0 &&„esult[result.size()-1] > '\0') {

634 
»suÉ
[»suÉ.
size
()-1]--;

640 
Inüem’t
(
İtiÚs_
.
com·¿tÜ
, &
»suÉ
);

644  
	g»suÉ
;

649 
DB
* 
db
(ècÚ¡ {  
	gcÚ¡ruùÜ_
->db(); }

651 
	g´iv©e
:

652 
O±iÚs
 
İtiÚs_
;

653 
CÚ¡ruùÜ
* 
	gcÚ¡ruùÜ_
;

657 
	$TEST
(
H¬Ãss
, 
Sim¶eEm±yKey
) {

658 
i
 = 0; i < 
kNumTe¡Args
; i++) {

659 
	`In™
(
kTe¡ArgLi¡
[
i
]);

660 
Rªdom
 
	`ºd
(
‹¡
::
	`RªdomS“d
() + 1);

661 
	`Add
("", "v");

662 
	`Te¡
(&
ºd
);

664 
	}
}

666 
	$TEST
(
H¬Ãss
, 
Sim¶eSšgË
) {

667 
i
 = 0; i < 
kNumTe¡Args
; i++) {

668 
	`In™
(
kTe¡ArgLi¡
[
i
]);

669 
Rªdom
 
	`ºd
(
‹¡
::
	`RªdomS“d
() + 2);

670 
	`Add
("abc", "v");

671 
	`Te¡
(&
ºd
);

673 
	}
}

675 
	$TEST
(
H¬Ãss
, 
Sim¶eMuÉi
) {

676 
i
 = 0; i < 
kNumTe¡Args
; i++) {

677 
	`In™
(
kTe¡ArgLi¡
[
i
]);

678 
Rªdom
 
	`ºd
(
‹¡
::
	`RªdomS“d
() + 3);

679 
	`Add
("abc", "v");

680 
	`Add
("abcd", "v");

681 
	`Add
("ac", "v2");

682 
	`Te¡
(&
ºd
);

684 
	}
}

686 
	$TEST
(
H¬Ãss
, 
Sim¶eS³cŸlKey
) {

687 
i
 = 0; i < 
kNumTe¡Args
; i++) {

688 
	`In™
(
kTe¡ArgLi¡
[
i
]);

689 
Rªdom
 
	`ºd
(
‹¡
::
	`RªdomS“d
() + 4);

690 
	`Add
("\xff\xff", "v3");

691 
	`Te¡
(&
ºd
);

693 
	}
}

695 
	$TEST
(
H¬Ãss
, 
Rªdomized
) {

696 
i
 = 0; i < 
kNumTe¡Args
; i++) {

697 
	`In™
(
kTe¡ArgLi¡
[
i
]);

698 
Rªdom
 
	`ºd
(
‹¡
::
	`RªdomS“d
() + 5);

699 
num_’Œ›s
 = 0;‚um_entries < 2000;

700 
num_’Œ›s
 += (num_entries < 50 ? 1 : 200)) {

701 ià((
num_’Œ›s
 % 10) == 0) {

702 
	`årštf
(
¡d”r
, "case %d of %d:‚um_entries = %d\n",

703 (
i
 + 1), (
kNumTe¡Args
), 
num_’Œ›s
);

705 
e
 = 0;ƒ < 
num_’Œ›s
;ƒ++) {

706 
¡d
::
¡ršg
 
v
;

707 
	`Add
(
‹¡
::
	`RªdomKey
(&
ºd
,„nd.
	`Skewed
(4)),

708 
‹¡
::
	`RªdomSŒšg
(&
ºd
,„nd.
	`Skewed
(5), &
v
).
	`ToSŒšg
());

710 
	`Te¡
(&
ºd
);

713 
	}
}

715 
	$TEST
(
H¬Ãss
, 
RªdomizedLÚgDB
) {

716 
Rªdom
 
	`ºd
(
‹¡
::
	`RªdomS“d
());

717 
Te¡Args
 
¬gs
 = { 
DB_TEST
, 
çl£
, 16 };

718 
	`In™
(
¬gs
);

719 
num_’Œ›s
 = 100000;

720 
e
 = 0;ƒ < 
num_’Œ›s
;ƒ++) {

721 
¡d
::
¡ršg
 
v
;

722 
	`Add
(
‹¡
::
	`RªdomKey
(&
ºd
,„nd.
	`Skewed
(4)),

723 
‹¡
::
	`RªdomSŒšg
(&
ºd
,„nd.
	`Skewed
(5), &
v
).
	`ToSŒšg
());

725 
	`Te¡
(&
ºd
);

728 
¡d
::
¡ršg
 
l0_fes
, 
l1_fes
;

729 
	`ASSERT_TRUE
(
	`db
()->
	`G‘Prİ”ty
("Ëv–db.num-fes-©-Ëv–0", &
l0_fes
));

730 
	`ASSERT_TRUE
(
	`db
()->
	`G‘Prİ”ty
("Ëv–db.num-fes-©-Ëv–1", &
l1_fes
));

731 
	`ASSERT_GT
(
	`©oi
(
l0_fes
.
	`c_¡r
()è+‡toi(
l1_fes
.c_str()), 0);

733 
	}
}

735 şas 
	cMemTabËTe¡
 { };

737 
	$TEST
(
MemTabËTe¡
, 
Sim¶e
) {

738 
IÁ”ÇlKeyCom·¿tÜ
 
	`cmp
(
	`By‹wi£Com·¿tÜ
());

739 
MemTabË
 
	`membË
(
cmp
);

740 
Wr™eB©ch
 
b©ch
;

741 
Wr™eB©chIÁ”Çl
::
	`S‘Sequ’û
(&
b©ch
, 100);

742 
b©ch
.
	`Put
(
¡d
::
	`¡ršg
("k1"), std::string("v1"));

743 
b©ch
.
	`Put
(
¡d
::
	`¡ršg
("k2"), std::string("v2"));

744 
b©ch
.
	`Put
(
¡d
::
	`¡ršg
("k3"), std::string("v3"));

745 
b©ch
.
	`Put
(
¡d
::
	`¡ršg
("largekey"), std::string("vlarge"));

746 
	`ASSERT_TRUE
(
Wr™eB©chIÁ”Çl
::
	`In£¹IÁo
(&
b©ch
, &
membË
).
	`ok
());

748 
I‹¿tÜ
* 
™”
 = 
membË
.
	`NewI‹¿tÜ
();

749 
™”
->
	`S“kToFœ¡
();

750 
™”
->
	`V®id
()) {

751 
	`årštf
(
¡d”r
, "key: '%s' -> '%s'\n",

752 
™”
->
	`key
().
	`ToSŒšg
().
	`c_¡r
(),

753 
™”
->
	`v®ue
().
	`ToSŒšg
().
	`c_¡r
());

754 
™”
->
	`Next
();

757 
d–‘e
 
™”
;

758 
	}
}

760 
boŞ
 
	$B‘w“n
(
ušt64_t
 
v®
, ušt64_ˆ
low
, ušt64_ˆ
high
) {

761 
boŞ
 
»suÉ
 = (
v®
 >ğ
low
è&& (v® <ğ
high
);

762 ià(!
»suÉ
) {

763 
	`årštf
(
¡d”r
, "Value %llu is‚ot in„ange [%llu, %llu]\n",

764 ()(
v®
),

765 ()(
low
),

766 ()(
high
));

768  
»suÉ
;

769 
	}
}

771 şas 
	cTabËTe¡
 { };

773 
	$TEST
(
TabËTe¡
, 
Aµroxim©eOff£tOfPÏš
) {

774 
TabËCÚ¡ruùÜ
 
	`c
(
	`By‹wi£Com·¿tÜ
());

775 
c
.
	`Add
("k01", "hello");

776 
c
.
	`Add
("k02", "hello2");

777 
c
.
	`Add
("k03", 
¡d
::
	`¡ršg
(10000, 'x'));

778 
c
.
	`Add
("k04", 
¡d
::
	`¡ršg
(200000, 'x'));

779 
c
.
	`Add
("k05", 
¡d
::
	`¡ršg
(300000, 'x'));

780 
c
.
	`Add
("k06", "hello3");

781 
c
.
	`Add
("k07", 
¡d
::
	`¡ršg
(100000, 'x'));

782 
¡d
::
veùÜ
<¡d::
¡ršg
> 
keys
;

783 
KVM­
 
kvm­
;

784 
O±iÚs
 
İtiÚs
;

785 
İtiÚs
.
block_size
 = 1024;

786 
İtiÚs
.
com´essiÚ
 = 
kNoCom´essiÚ
;

787 
c
.
	`Fšish
(
İtiÚs
, &
keys
, &
kvm­
);

789 
	`ASSERT_TRUE
(
	`B‘w“n
(
c
.
	`Aµroxim©eOff£tOf
("abc"), 0, 0));

790 
	`ASSERT_TRUE
(
	`B‘w“n
(
c
.
	`Aµroxim©eOff£tOf
("k01"), 0, 0));

791 
	`ASSERT_TRUE
(
	`B‘w“n
(
c
.
	`Aµroxim©eOff£tOf
("k01a"), 0, 0));

792 
	`ASSERT_TRUE
(
	`B‘w“n
(
c
.
	`Aµroxim©eOff£tOf
("k02"), 0, 0));

793 
	`ASSERT_TRUE
(
	`B‘w“n
(
c
.
	`Aµroxim©eOff£tOf
("k03"), 0, 0));

794 
	`ASSERT_TRUE
(
	`B‘w“n
(
c
.
	`Aµroxim©eOff£tOf
("k04"), 10000, 11000));

795 
	`ASSERT_TRUE
(
	`B‘w“n
(
c
.
	`Aµroxim©eOff£tOf
("k04a"), 210000, 211000));

796 
	`ASSERT_TRUE
(
	`B‘w“n
(
c
.
	`Aµroxim©eOff£tOf
("k05"), 210000, 211000));

797 
	`ASSERT_TRUE
(
	`B‘w“n
(
c
.
	`Aµroxim©eOff£tOf
("k06"), 510000, 511000));

798 
	`ASSERT_TRUE
(
	`B‘w“n
(
c
.
	`Aµroxim©eOff£tOf
("k07"), 510000, 511000));

799 
	`ASSERT_TRUE
(
	`B‘w“n
(
c
.
	`Aµroxim©eOff£tOf
("xyz"), 610000, 611000));

801 
	}
}

803 
boŞ
 
	$SÇµyCom´essiÚSuµÜ‹d
() {

804 
¡d
::
¡ršg
 
out
;

805 
Sliû
 
š
 = "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa";

806  
pÜt
::
	`SÇµy_Com´ess
(
š
.
	`d©a
(), in.
	`size
(), &
out
);

807 
	}
}

809 
	$TEST
(
TabËTe¡
, 
Aµroxim©eOff£tOfCom´es£d
) {

810 ià(!
	`SÇµyCom´essiÚSuµÜ‹d
()) {

811 
	`årštf
(
¡d”r
, "skipping compressionests\n");

815 
Rªdom
 
	`ºd
(301);

816 
TabËCÚ¡ruùÜ
 
	`c
(
	`By‹wi£Com·¿tÜ
());

817 
¡d
::
¡ršg
 
tmp
;

818 
c
.
	`Add
("k01", "hello");

819 
c
.
	`Add
("k02", 
‹¡
::
	`Com´essibËSŒšg
(&
ºd
, 0.25, 10000, &
tmp
));

820 
c
.
	`Add
("k03", "hello3");

821 
c
.
	`Add
("k04", 
‹¡
::
	`Com´essibËSŒšg
(&
ºd
, 0.25, 10000, &
tmp
));

822 
¡d
::
veùÜ
<¡d::
¡ršg
> 
keys
;

823 
KVM­
 
kvm­
;

824 
O±iÚs
 
İtiÚs
;

825 
İtiÚs
.
block_size
 = 1024;

826 
İtiÚs
.
com´essiÚ
 = 
kSÇµyCom´essiÚ
;

827 
c
.
	`Fšish
(
İtiÚs
, &
keys
, &
kvm­
);

829 
	`ASSERT_TRUE
(
	`B‘w“n
(
c
.
	`Aµroxim©eOff£tOf
("abc"), 0, 0));

830 
	`ASSERT_TRUE
(
	`B‘w“n
(
c
.
	`Aµroxim©eOff£tOf
("k01"), 0, 0));

831 
	`ASSERT_TRUE
(
	`B‘w“n
(
c
.
	`Aµroxim©eOff£tOf
("k02"), 0, 0));

832 
	`ASSERT_TRUE
(
	`B‘w“n
(
c
.
	`Aµroxim©eOff£tOf
("k03"), 2000, 3000));

833 
	`ASSERT_TRUE
(
	`B‘w“n
(
c
.
	`Aµroxim©eOff£tOf
("k04"), 2000, 3000));

834 
	`ASSERT_TRUE
(
	`B‘w“n
(
c
.
	`Aµroxim©eOff£tOf
("xyz"), 4000, 6000));

835 
	}
}

839 
	$maš
(
¬gc
, ** 
¬gv
) {

840  
Ëv–db
::
‹¡
::
	`RunAÎTe¡s
();

841 
	}
}

	@table/two_level_iterator.cc

5 
	~"bË/two_Ëv–_™”©Ü.h
"

7 
	~"Ëv–db/bË.h
"

8 
	~"bË/block.h
"

9 
	~"bË/fÜm©.h
"

10 
	~"bË/™”©Ü_w¿µ”.h
"

12 
Çme¥aû
 
	gËv–db
 {

14 
	gÇme¥aû
 {

16 
	gI‹¿tÜ
* (*
	tBlockFunùiÚ
)(*, cÚ¡ 
	tR—dO±iÚs
&, cÚ¡ 
	tSliû
&);

18 şas 
	cTwoLev–I‹¿tÜ
: 
public
 
I‹¿tÜ
 {

19 
public
:

20 
TwoLev–I‹¿tÜ
(

21 
I‹¿tÜ
* 
šdex_™”
,

22 
BlockFunùiÚ
 
block_funùiÚ
,

23 * 
¬g
,

24 cÚ¡ 
R—dO±iÚs
& 
İtiÚs
);

26 
	gvœtu®
 ~
TwoLev–I‹¿tÜ
();

28 
vœtu®
 
S“k
(cÚ¡ 
Sliû
& 
rg‘
);

29 
vœtu®
 
S“kToFœ¡
();

30 
vœtu®
 
S“kToLa¡
();

31 
vœtu®
 
Next
();

32 
vœtu®
 
P»v
();

34 
vœtu®
 
boŞ
 
V®id
() const {

35  
	gd©a_™”_
.
V®id
();

37 
vœtu®
 
Sliû
 
key
() const {

38 
as£¹
(
V®id
());

39  
	gd©a_™”_
.
key
();

41 
vœtu®
 
Sliû
 
v®ue
() const {

42 
as£¹
(
V®id
());

43  
	gd©a_™”_
.
v®ue
();

45 
vœtu®
 
Stus
 
¡©us
() const {

47 ià(!
	gšdex_™”_
.
¡©us
().
ok
()) {

48  
	gšdex_™”_
.
¡©us
();

49 } ià(
	gd©a_™”_
.
™”
(è!ğ
NULL
 && !
d©a_™”_
.
¡©us
().
ok
()) {

50  
d©a_™”_
.
¡©us
();

52  
	g¡©us_
;

56 
	g´iv©e
:

57 
SaveE¼Ü
(cÚ¡ 
Stus
& 
s
) {

58 ià(
¡©us_
.
ok
(è&& !
s
.ok()) status_ = s;

60 
SkEm±yD©aBlocksFÜw¬d
();

61 
SkEm±yD©aBlocksBackw¬d
();

62 
S‘D©aI‹¿tÜ
(
I‹¿tÜ
* 
d©a_™”
);

63 
In™D©aBlock
();

65 
BlockFunùiÚ
 
	gblock_funùiÚ_
;

66 * 
	g¬g_
;

67 cÚ¡ 
R—dO±iÚs
 
	gİtiÚs_
;

68 
Stus
 
	g¡©us_
;

69 
I‹¿tÜW¿µ”
 
	gšdex_™”_
;

70 
I‹¿tÜW¿µ”
 
	gd©a_™”_
;

73 
	g¡d
::
¡ršg
 
d©a_block_hªdË_
;

76 
	gTwoLev–I‹¿tÜ
::
TwoLev–I‹¿tÜ
(

77 
I‹¿tÜ
* 
šdex_™”
,

78 
BlockFunùiÚ
 
block_funùiÚ
,

79 * 
¬g
,

80 cÚ¡ 
R—dO±iÚs
& 
İtiÚs
)

81 : 
block_funùiÚ_
(
block_funùiÚ
),

82 
¬g_
(
¬g
),

83 
İtiÚs_
(
İtiÚs
),

84 
šdex_™”_
(
šdex_™”
),

85 
d©a_™”_
(
NULL
) {

88 
	gTwoLev–I‹¿tÜ
::~
TwoLev–I‹¿tÜ
() {

91 
TwoLev–I‹¿tÜ
::
S“k
(cÚ¡ 
Sliû
& 
rg‘
) {

92 
šdex_™”_
.
S“k
(
rg‘
);

93 
In™D©aBlock
();

94 ià(
	gd©a_™”_
.
™”
(è!ğ
NULL
è
d©a_™”_
.
S“k
(
rg‘
);

95 
SkEm±yD©aBlocksFÜw¬d
();

98 
	gTwoLev–I‹¿tÜ
::
S“kToFœ¡
() {

99 
šdex_™”_
.
S“kToFœ¡
();

100 
In™D©aBlock
();

101 ià(
	gd©a_™”_
.
™”
(è!ğ
NULL
è
d©a_™”_
.
S“kToFœ¡
();

102 
SkEm±yD©aBlocksFÜw¬d
();

105 
	gTwoLev–I‹¿tÜ
::
S“kToLa¡
() {

106 
šdex_™”_
.
S“kToLa¡
();

107 
In™D©aBlock
();

108 ià(
	gd©a_™”_
.
™”
(è!ğ
NULL
è
d©a_™”_
.
S“kToLa¡
();

109 
SkEm±yD©aBlocksBackw¬d
();

112 
	gTwoLev–I‹¿tÜ
::
Next
() {

113 
as£¹
(
V®id
());

114 
	gd©a_™”_
.
Next
();

115 
SkEm±yD©aBlocksFÜw¬d
();

118 
	gTwoLev–I‹¿tÜ
::
P»v
() {

119 
as£¹
(
V®id
());

120 
	gd©a_™”_
.
P»v
();

121 
SkEm±yD©aBlocksBackw¬d
();

125 
	gTwoLev–I‹¿tÜ
::
SkEm±yD©aBlocksFÜw¬d
() {

126 
d©a_™”_
.
™”
(è=ğ
NULL
 || !d©a_™”_.
V®id
()) {

128 ià(!
šdex_™”_
.
V®id
()) {

129 
S‘D©aI‹¿tÜ
(
NULL
);

132 
	gšdex_™”_
.
Next
();

133 
In™D©aBlock
();

134 ià(
	gd©a_™”_
.
™”
(è!ğ
NULL
è
d©a_™”_
.
S“kToFœ¡
();

138 
	gTwoLev–I‹¿tÜ
::
SkEm±yD©aBlocksBackw¬d
() {

139 
d©a_™”_
.
™”
(è=ğ
NULL
 || !d©a_™”_.
V®id
()) {

141 ià(!
šdex_™”_
.
V®id
()) {

142 
S‘D©aI‹¿tÜ
(
NULL
);

145 
	gšdex_™”_
.
P»v
();

146 
In™D©aBlock
();

147 ià(
	gd©a_™”_
.
™”
(è!ğ
NULL
è
d©a_™”_
.
S“kToLa¡
();

151 
	gTwoLev–I‹¿tÜ
::
S‘D©aI‹¿tÜ
(
I‹¿tÜ
* 
d©a_™”
) {

152 ià(
d©a_™”_
.
™”
(è!ğ
NULL
è
SaveE¼Ü
(d©a_™”_.
¡©us
());

153 
	gd©a_™”_
.
S‘
(
d©a_™”
);

156 
	gTwoLev–I‹¿tÜ
::
In™D©aBlock
() {

157 ià(!
šdex_™”_
.
V®id
()) {

158 
S‘D©aI‹¿tÜ
(
NULL
);

160 
Sliû
 
	ghªdË
 = 
šdex_™”_
.
v®ue
();

161 ià(
	gd©a_™”_
.
™”
(è!ğ
NULL
 && 
hªdË
.
com·»
(
d©a_block_hªdË_
) == 0) {

165 
I‹¿tÜ
* 
™”
 = (*
block_funùiÚ_
)(
¬g_
, 
	gİtiÚs_
, 
	ghªdË
);

166 
	gd©a_block_hªdË_
.
assign
(
hªdË
.
d©a
(), hªdË.
size
());

167 
S‘D©aI‹¿tÜ
(
™”
);

174 
I‹¿tÜ
* 
	$NewTwoLev–I‹¿tÜ
(

175 
I‹¿tÜ
* 
šdex_™”
,

176 
BlockFunùiÚ
 
block_funùiÚ
,

177 * 
¬g
,

178 cÚ¡ 
R—dO±iÚs
& 
İtiÚs
) {

179  
Ãw
 
	`TwoLev–I‹¿tÜ
(
šdex_™”
, 
block_funùiÚ
, 
¬g
, 
İtiÚs
);

180 
	}
}

	@table/two_level_iterator.h

5 #iâdeà
STORAGE_LEVELDB_TABLE_TWO_LEVEL_ITERATOR_H_


6 
	#STORAGE_LEVELDB_TABLE_TWO_LEVEL_ITERATOR_H_


	)

8 
	~"Ëv–db/™”©Ü.h
"

10 
Çme¥aû
 
	gËv–db
 {

12 
	gR—dO±iÚs
;

23 
I‹¿tÜ
* 
NewTwoLev–I‹¿tÜ
(

24 
I‹¿tÜ
* 
šdex_™”
,

25 
I‹¿tÜ
* (*
block_funùiÚ
)(

26 * 
¬g
,

27 cÚ¡ 
R—dO±iÚs
& 
İtiÚs
,

28 cÚ¡ 
Sliû
& 
šdex_v®ue
),

29 * 
¬g
,

30 cÚ¡ 
R—dO±iÚs
& 
İtiÚs
);

	@util/arena.cc

5 
	~"ut/¬’a.h
"

6 
	~<as£¹.h
>

8 
Çme¥aû
 
	gËv–db
 {

10 cÚ¡ 
	gkBlockSize
 = 4096;

12 
	gA»Ç
::
A»Ç
() {

13 
blocks_memÜy_
 = 0;

14 
	g®loc_±r_
 = 
NULL
;

15 
	g®loc_by‹s_»maššg_
 = 0;

18 
	gA»Ç
::~
A»Ç
() {

19 
size_t
 
i
 = 0; 
	gi
 < 
	gblocks_
.
size
(); i++) {

20 
	gd–‘e
[] 
	gblocks_
[
i
];

24 * 
	gA»Ç
::
AÎoÿ‹F®lback
(
size_t
 
by‹s
) {

25 ià(
by‹s
 > 
kBlockSize
 / 4) {

28 * 
»suÉ
 = 
AÎoÿ‹NewBlock
(
by‹s
);

29  
	g»suÉ
;

33 
	g®loc_±r_
 = 
AÎoÿ‹NewBlock
(
kBlockSize
);

34 
	g®loc_by‹s_»maššg_
 = 
kBlockSize
;

36 * 
	g»suÉ
 = 
®loc_±r_
;

37 
	g®loc_±r_
 +ğ
by‹s
;

38 
	g®loc_by‹s_»maššg_
 -ğ
by‹s
;

39  
	g»suÉ
;

42 * 
	gA»Ç
::
AÎoÿ‹AligÃd
(
size_t
 
by‹s
) {

43 cÚ¡ 
®ign
 = (*);

44 
as£¹
((
®ign
 & (align-1)) == 0);

45 
size_t
 
	gcu¼’t_mod
 = 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
®loc_±r_
è& (
®ign
-1);

46 
size_t
 
	g¦İ
 = (
cu¼’t_mod
 =ğ0 ? 0 : 
®ign
 - current_mod);

47 
size_t
 
	gÃeded
 = 
by‹s
 + 
¦İ
;

48 * 
	g»suÉ
;

49 ià(
	gÃeded
 <ğ
®loc_by‹s_»maššg_
) {

50 
»suÉ
 = 
®loc_±r_
 + 
¦İ
;

51 
	g®loc_±r_
 +ğ
Ãeded
;

52 
	g®loc_by‹s_»maššg_
 -ğ
Ãeded
;

55 
	g»suÉ
 = 
AÎoÿ‹F®lback
(
by‹s
);

57 
as£¹
((
»š‹½»t_ÿ¡
<
ušŒ_t
>(
»suÉ
è& (
®ign
-1)) == 0);

58  
	g»suÉ
;

61 * 
	gA»Ç
::
AÎoÿ‹NewBlock
(
size_t
 
block_by‹s
) {

62 * 
»suÉ
 = 
Ãw
 [
block_by‹s
];

63 
	gblocks_memÜy_
 +ğ
block_by‹s
;

64 
	gblocks_
.
push_back
(
»suÉ
);

65  
	g»suÉ
;

	@util/arena.h

5 #iâdeà
STORAGE_LEVELDB_UTIL_ARENA_H_


6 
	#STORAGE_LEVELDB_UTIL_ARENA_H_


	)

8 
	~<c¡ddef
>

9 
	~<veùÜ
>

10 
	~<as£¹.h
>

11 
	~<¡dšt.h
>

13 
Çme¥aû
 
	gËv–db
 {

15 şas 
	cA»Ç
 {

16 
	gpublic
:

17 
A»Ç
();

18 ~
A»Ç
();

21 * 
AÎoÿ‹
(
size_t
 
by‹s
);

24 * 
AÎoÿ‹AligÃd
(
size_t
 
by‹s
);

29 
size_t
 
MemÜyU§ge
() const {

30  
	gblocks_memÜy_
 + 
	gblocks_
.
ÿ·c™y
() * (*);

33 
	g´iv©e
:

34 * 
AÎoÿ‹F®lback
(
size_t
 
by‹s
);

35 * 
AÎoÿ‹NewBlock
(
size_t
 
block_by‹s
);

38 * 
	g®loc_±r_
;

39 
size_t
 
	g®loc_by‹s_»maššg_
;

42 
	g¡d
::
veùÜ
<*> 
blocks_
;

45 
size_t
 
	gblocks_memÜy_
;

48 
A»Ç
(const Arena&);

49 
	gİ”©Ü
=(cÚ¡ 
A»Ç
&);

52 
šlše
 * 
	gA»Ç
::
	$AÎoÿ‹
(
size_t
 
by‹s
) {

56 
	`as£¹
(
by‹s
 > 0);

57 ià(
by‹s
 <ğ
®loc_by‹s_»maššg_
) {

58 * 
»suÉ
 = 
®loc_±r_
;

59 
®loc_±r_
 +ğ
by‹s
;

60 
®loc_by‹s_»maššg_
 -ğ
by‹s
;

61  
»suÉ
;

63  
	`AÎoÿ‹F®lback
(
by‹s
);

64 
	}
}

	@util/arena_test.cc

5 
	~"ut/¬’a.h
"

7 
	~"ut/¿ndom.h
"

8 
	~"ut/‹¡h¬Ãss.h
"

10 
Çme¥aû
 
	gËv–db
 {

12 şas 
	cA»ÇTe¡
 { };

14 
	$TEST
(
A»ÇTe¡
, 
Em±y
) {

15 
A»Ç
 
¬’a
;

16 
	}
}

18 
	$TEST
(
A»ÇTe¡
, 
Sim¶e
) {

19 
¡d
::
veùÜ
<¡d::
·œ
<
size_t
, *> > 
®loÿ‹d
;

20 
A»Ç
 
¬’a
;

21 cÚ¡ 
N
 = 100000;

22 
size_t
 
by‹s
 = 0;

23 
Rªdom
 
	`ºd
(301);

24 
i
 = 0; i < 
N
; i++) {

25 
size_t
 
s
;

26 ià(
i
 % (
N
 / 10) == 0) {

27 
s
 = 
i
;

29 
s
 = 
ºd
.
	`OÃIn
(4000è?„nd.
	`UnifÜm
(6000) :

30 (
ºd
.
	`OÃIn
(10è?„nd.
	`UnifÜm
(100) :„nd.Uniform(20));

32 ià(
s
 == 0) {

34 
s
 = 1;

36 * 
r
;

37 ià(
ºd
.
	`OÃIn
(10)) {

38 
r
 = 
¬’a
.
	`AÎoÿ‹AligÃd
(
s
);

40 
r
 = 
¬’a
.
	`AÎoÿ‹
(
s
);

43 
b
 = 0; b < 
s
; b++) {

45 
r
[
b
] = 
i
 % 256;

47 
by‹s
 +ğ
s
;

48 
®loÿ‹d
.
	`push_back
(
¡d
::
	`make_·œ
(
s
, 
r
));

49 
	`ASSERT_GE
(
¬’a
.
	`MemÜyU§ge
(), 
by‹s
);

50 ià(
i
 > 
N
/10) {

51 
	`ASSERT_LE
(
¬’a
.
	`MemÜyU§ge
(), 
by‹s
 * 1.10);

54 
i
 = 0; i < 
®loÿ‹d
.
	`size
(); i++) {

55 
size_t
 
num_by‹s
 = 
®loÿ‹d
[
i
].
fœ¡
;

56 cÚ¡ * 
p
 = 
®loÿ‹d
[
i
].
£cÚd
;

57 
b
 = 0; b < 
num_by‹s
; b++) {

59 
	`ASSERT_EQ
((
p
[
b
]è& 0xff, 
i
 % 256);

62 
	}
}

66 
	$maš
(
¬gc
, ** 
¬gv
) {

67  
Ëv–db
::
‹¡
::
	`RunAÎTe¡s
();

68 
	}
}

	@util/cache.cc

5 #ià
defšed
(
LEVELDB_PLATFORM_POSIX
è|| defšed(
LEVELDB_PLATFORM_ANDROID
)

6 
	~<unÜd”ed_£t
>

7 #–ià
defšed
(
LEVELDB_PLATFORM_CHROMIUM
)

8 
	~"ba£/hash_bËs.h
"

10 
	~<hash_£t
>

13 
	~<as£¹.h
>

15 
	~"Ëv–db/ÿche.h
"

16 
	~"pÜt/pÜt.h
"

17 
	~"ut/hash.h
"

18 
	~"ut/mu‹xlock.h
"

20 
Çme¥aû
 
	gËv–db
 {

22 
	gCache
::~
Cache
() {

25 
Çme¥aû
 {

31 
	sLRUHªdË
 {

32 * 
v®ue
;

33 (*
	gd–‘”
)(cÚ¡ 
	gSliû
&, * 
	gv®ue
);

34 
LRUHªdË
* 
	gÃxt
;

35 
LRUHªdË
* 
	g´ev
;

36 
size_t
 
	gch¬ge
;

37 
size_t
 
	gkey_Ëngth
;

38 
size_t
 
	g»fs
;

39 
	gkey_d©a
[1];

41 
Sliû
 
key
() const {

44 ià(
	gÃxt
 =ğ
this
) {

45  *(
»š‹½»t_ÿ¡
<
Sliû
*>(
v®ue
));

47  
Sliû
(
key_d©a
, 
key_Ëngth
);

53 #ià
defšed
(
LEVELDB_PLATFORM_CHROMIUM
è&& defšed(
OS_WIN
)

58 
	gHªdËHashCom·»
 : 
public
 
¡dext
::
hash_com·»
<
LRUHªdË
*> {

59 
size_t
 
İ”©Ü
(è(
LRUHªdË
* 
h
) const {

60 
Sliû
 
k
 = 
h
->
key
();

61  
Hash
(
k
.
d©a
(), k.
size
(), 0);

63 
boŞ
 
İ”©Ü
(è(
LRUHªdË
* 
	ga
, LRUHªdË* 
	gb
) const {

64  
	ga
->
key
().
com·»
(
b
->key()) < 0;

67 
	gba£
::
	thash_£t
<
	tLRUHªdË
*, 
	tHªdËHashCom·»
> 
	tHªdËTabË
;

69 
	sHªdËHash
 {

70 
šlše
 
size_t
 
İ”©Ü
()(
LRUHªdË
* 
	gh
) const {

71 
Sliû
 
	gk
 = 
h
->
key
();

72  
Hash
(
k
.
d©a
(), k.
size
(), 0);

76 
	sHªdËEq
 {

77 
šlše
 
boŞ
 
İ”©Ü
()(
LRUHªdË
* 
	ga
, LRUHªdË* 
	gb
) const {

78  
	ga
->
key
(è=ğ
b
->key();

81 #ià
defšed
(
LEVELDB_PLATFORM_CHROMIUM
)

82 
	gba£
::
	thash_£t
<
	tLRUHªdË
*, 
	tHªdËHash
, 
	tHªdËEq
> 
	tHªdËTabË
;

83 #–ià
defšed
(
LEVELDB_PLATFORM_POSIX
è|| defšed(
LEVELDB_PLATFORM_ANDROID
)

84 
	g¡d
::
	tunÜd”ed_£t
<
	tLRUHªdË
*, 
	tHªdËHash
, 
	tHªdËEq
> 
	tHªdËTabË
;

86 
	g__gnu_cxx
::
	thash_£t
<
	tLRUHªdË
*, 
	tHªdËHash
, 
	tHªdËEq
> 
	tHªdËTabË
;

90 şas 
	cLRUCache
 : 
public
 
Cache
 {

91 
public
:

92 
ex¶ic™
 
LRUCache
(
size_t
 
ÿ·c™y
);

93 
	gvœtu®
 ~
LRUCache
();

95 
vœtu®
 
HªdË
* 
In£¹
(cÚ¡ 
Sliû
& 
key
, * 
v®ue
, 
size_t
 
ch¬ge
,

96 (*
d–‘”
)(cÚ¡ 
Sliû
& 
key
, * 
v®ue
));

97 
vœtu®
 
HªdË
* 
Lookup
(cÚ¡ 
Sliû
& 
key
);

98 
vœtu®
 
R–—£
(
HªdË
* 
hªdË
);

99 
vœtu®
 * 
V®ue
(
HªdË
* 
hªdË
);

100 
vœtu®
 
E¿£
(cÚ¡ 
Sliû
& 
key
);

101 
vœtu®
 
ušt64_t
 
NewId
();

103 
	g´iv©e
:

104 
LRU_Remove
(
LRUHªdË
* 
e
);

105 
LRU_Aµ’d
(
LRUHªdË
* 
e
);

106 
UÄef
(
LRUHªdË
* 
e
);

109 cÚ¡ 
size_t
 
	gÿ·c™y_
;

112 
	gpÜt
::
Mu‹x
 
mu‹x_
;

113 
size_t
 
	gu§ge_
;

114 
ušt64_t
 
	gÏ¡_id_
;

118 
LRUHªdË
 
	gÌu_
;

120 
HªdËTabË
 
	gbË_
;

123 
	gLRUCache
::
LRUCache
(
size_t
 
ÿ·c™y
)

124 : 
ÿ·c™y_
(
ÿ·c™y
),

125 
u§ge_
(0),

126 
Ï¡_id_
(0) {

128 
	gÌu_
.
	gÃxt
 = &
Ìu_
;

129 
	gÌu_
.
	g´ev
 = &
Ìu_
;

132 
	gLRUCache
::~
LRUCache
() {

133 
bË_
.
ş—r
();

134 
LRUHªdË
* 
	ge
 = 
Ìu_
.
Ãxt
;ƒ != &lru_; ) {

135 
LRUHªdË
* 
	gÃxt
 = 
e
->
Ãxt
;

136 
as£¹
(
e
->
»fs
 == 1);

137 
UÄef
(
e
);

138 
	ge
 = 
Ãxt
;

142 
	gLRUCache
::
UÄef
(
LRUHªdË
* 
e
) {

143 
as£¹
(
e
->
»fs
 > 0);

144 
	ge
->
	g»fs
--;

145 ià(
	ge
->
	g»fs
 <= 0) {

146 
u§ge_
 -ğ
e
->
ch¬ge
;

147 (*
	ge
->
	gd–‘”
)Ó->
key
(),ƒ->
	gv®ue
);

148 
ä“
(
e
);

152 
	gLRUCache
::
LRU_Remove
(
LRUHªdË
* 
e
) {

153 
e
->
Ãxt
->
´ev
 =ƒ->prev;

154 
	ge
->
	g´ev
->
	gÃxt
 = 
e
->
Ãxt
;

157 
	gLRUCache
::
LRU_Aµ’d
(
LRUHªdË
* 
e
) {

159 
e
->
Ãxt
 = &
Ìu_
;

160 
	ge
->
	g´ev
 = 
Ìu_
.
´ev
;

161 
	ge
->
	g´ev
->
	gÃxt
 = 
e
;

162 
	ge
->
	gÃxt
->
	g´ev
 = 
e
;

165 
	gCache
::
HªdË
* 
LRUCache
::
Lookup
(cÚ¡ 
Sliû
& 
key
) {

166 
Mu‹xLock
 
l
(&
mu‹x_
);

168 
LRUHªdË
 
	gdummy
;

169 
	gdummy
.
	gÃxt
 = &
dummy
;

170 
	gdummy
.
	gv®ue
 = 
cÚ¡_ÿ¡
<
Sliû
*>(&
key
);

171 
	gHªdËTabË
::
™”©Ü
 
™”
 = 
bË_
.
fšd
(&
dummy
);

172 ià(
	g™”
 =ğ
bË_
.
’d
()) {

173  
NULL
;

175 
LRUHªdË
* 
	ge
 = 
cÚ¡_ÿ¡
<LRUHªdË*>(*
™”
);

176 
	ge
->
	g»fs
++;

177 
LRU_Remove
(
e
);

178 
LRU_Aµ’d
(
e
);

179  
	g»š‹½»t_ÿ¡
<
	gHªdË
*>(
	ge
);

183 * 
	gLRUCache
::
V®ue
(
HªdË
* 
hªdË
) {

184  
»š‹½»t_ÿ¡
<
LRUHªdË
*>(
hªdË
)->
v®ue
;

187 
	gLRUCache
::
R–—£
(
HªdË
* 
hªdË
) {

188 
Mu‹xLock
 
l
(&
mu‹x_
);

189 
UÄef
(
»š‹½»t_ÿ¡
<
LRUHªdË
*>(
hªdË
));

192 
	gCache
::
HªdË
* 
LRUCache
::
In£¹
(cÚ¡ 
Sliû
& 
key
, * 
v®ue
, 
size_t
 
ch¬ge
,

193 (*
d–‘”
)(cÚ¡ 
Sliû
& 
key
, * 
v®ue
)) {

194 
Mu‹xLock
 
l
(&
mu‹x_
);

196 
LRUHªdË
* 
	ge
 = 
»š‹½»t_ÿ¡
<LRUHandle*>(

197 
m®loc
((
LRUHªdË
)-1 + 
key
.
size
()));

198 
	ge
->
	gv®ue
 = 
v®ue
;

199 
	ge
->
	gd–‘”
 = 
d–‘”
;

200 
	ge
->
	gch¬ge
 = 
ch¬ge
;

201 
	ge
->
	gkey_Ëngth
 = 
key
.
size
();

202 
	ge
->
	g»fs
 = 2;

203 
memıy
(
e
->
key_d©a
, 
key
.
d©a
(), key.
size
());

204 
LRU_Aµ’d
(
e
);

205 
	gu§ge_
 +ğ
ch¬ge
;

207 
	g¡d
::
·œ
<
HªdËTabË
::
™”©Ü
,
	gboŞ
> 
	gp
 = 
bË_
.
š£¹
(
e
);

208 ià(!
	gp
.
	g£cÚd
) {

210 
LRUHªdË
* 
	gŞd
 = 
cÚ¡_ÿ¡
<LRUHªdË*>(*(
p
.
fœ¡
));

211 
LRU_Remove
(
Şd
);

212 
	gbË_
.
”a£
(
p
.
fœ¡
);

213 
	gbË_
.
š£¹
(
e
);

214 
UÄef
(
Şd
);

217 
	gu§ge_
 > 
	gÿ·c™y_
 && 
	gÌu_
.
	gÃxt
 !ğ&
Ìu_
) {

218 
LRUHªdË
* 
Şd
 = 
Ìu_
.
Ãxt
;

219 
LRU_Remove
(
Şd
);

220 
	gbË_
.
”a£
(
Şd
);

221 
UÄef
(
Şd
);

224  
	g»š‹½»t_ÿ¡
<
	gHªdË
*>(
	ge
);

227 
	gLRUCache
::
E¿£
(cÚ¡ 
Sliû
& 
key
) {

228 
Mu‹xLock
 
l
(&
mu‹x_
);

230 
LRUHªdË
 
	gdummy
;

231 
	gdummy
.
	gÃxt
 = &
dummy
;

232 
	gdummy
.
	gv®ue
 = 
cÚ¡_ÿ¡
<
Sliû
*>(&
key
);

233 
	gHªdËTabË
::
™”©Ü
 
™”
 = 
bË_
.
fšd
(&
dummy
);

234 ià(
	g™”
 !ğ
bË_
.
’d
()) {

235 
LRUHªdË
* 
e
 = 
cÚ¡_ÿ¡
<LRUHªdË*>(*
™”
);

236 
LRU_Remove
(
e
);

237 
	gbË_
.
”a£
(
™”
);

238 
UÄef
(
e
);

242 
ušt64_t
 
	gLRUCache
::
NewId
() {

243 
Mu‹xLock
 
l
(&
mu‹x_
);

244  ++(
	gÏ¡_id_
);

249 
Cache
* 
	$NewLRUCache
(
size_t
 
ÿ·c™y
) {

250  
Ãw
 
	`LRUCache
(
ÿ·c™y
);

251 
	}
}

	@util/cache_test.cc

5 
	~"Ëv–db/ÿche.h
"

7 
	~<veùÜ
>

8 
	~"ut/codšg.h
"

9 
	~"ut/‹¡h¬Ãss.h
"

11 
Çme¥aû
 
	gËv–db
 {

14 
	g¡d
::
¡ršg
 
EncodeKey
(
k
) {

15 
¡d
::
¡ršg
 
»suÉ
;

16 
PutFixed32
(&
»suÉ
, 
k
);

17  
	g»suÉ
;

19 
DecodeKey
(cÚ¡ 
Sliû
& 
k
) {

20 
as£¹
(
k
.
size
() == 4);

21  
DecodeFixed32
(
k
.
d©a
());

23 * 
EncodeV®ue
(
ušŒ_t
 
v
è{  
	g»š‹½»t_ÿ¡
<*>(
	gv
); }

24 
DecodeV®ue
(* 
v
è{  
	g»š‹½»t_ÿ¡
<
	gušŒ_t
>(
	gv
); }

26 şas 
	cCacheTe¡
 {

27 
	gpublic
:

28 
CacheTe¡
* 
cu¼’t_
;

30 
D–‘”
(cÚ¡ 
Sliû
& 
key
, * 
v
) {

31 
	gcu¼’t_
->
	gd–‘ed_keys_
.
push_back
(
DecodeKey
(
key
));

32 
	gcu¼’t_
->
	gd–‘ed_v®ues_
.
push_back
(
DecodeV®ue
(
v
));

35 cÚ¡ 
	gkCacheSize
 = 100;

36 
	g¡d
::
veùÜ
<> 
d–‘ed_keys_
;

37 
	g¡d
::
veùÜ
<> 
d–‘ed_v®ues_
;

38 
Cache
* 
	gÿche_
;

40 
CacheTe¡
(è: 
ÿche_
(
NewLRUCache
(
kCacheSize
)) {

41 
cu¼’t_
 = 
this
;

44 ~
CacheTe¡
() {

45 
d–‘e
 
	gÿche_
;

48 
Lookup
(
key
) {

49 
	gCache
::
HªdË
* 
hªdË
 = 
ÿche_
->
Lookup
(
EncodeKey
(
key
));

50 cÚ¡ 
	gr
 = (
hªdË
 =ğ
NULL
è? -1 : 
DecodeV®ue
(
ÿche_
->
V®ue
(handle));

51 ià(
	ghªdË
 !ğ
NULL
) {

52 
ÿche_
->
R–—£
(
hªdË
);

54  
	gr
;

57 
In£¹
(
key
, 
v®ue
, 
ch¬ge
 = 1) {

58 
ÿche_
->
R–—£
(ÿche_->
In£¹
(
EncodeKey
(
key
), 
EncodeV®ue
(
v®ue
), 
ch¬ge
,

59 &
CacheTe¡
::
D–‘”
));

62 
E¿£
(
key
) {

63 
	gÿche_
->
E¿£
(
EncodeKey
(
key
));

66 
CacheTe¡
* 
	gCacheTe¡
::
cu¼’t_
;

68 
	$TEST
(
CacheTe¡
, 
H™AndMiss
) {

69 
	`ASSERT_EQ
(-1, 
	`Lookup
(100));

71 
	`In£¹
(100, 101);

72 
	`ASSERT_EQ
(101, 
	`Lookup
(100));

73 
	`ASSERT_EQ
(-1, 
	`Lookup
(200));

74 
	`ASSERT_EQ
(-1, 
	`Lookup
(300));

76 
	`In£¹
(200, 201);

77 
	`ASSERT_EQ
(101, 
	`Lookup
(100));

78 
	`ASSERT_EQ
(201, 
	`Lookup
(200));

79 
	`ASSERT_EQ
(-1, 
	`Lookup
(300));

81 
	`In£¹
(100, 102);

82 
	`ASSERT_EQ
(102, 
	`Lookup
(100));

83 
	`ASSERT_EQ
(201, 
	`Lookup
(200));

84 
	`ASSERT_EQ
(-1, 
	`Lookup
(300));

86 
	`ASSERT_EQ
(1, 
d–‘ed_keys_
.
	`size
());

87 
	`ASSERT_EQ
(100, 
d–‘ed_keys_
[0]);

88 
	`ASSERT_EQ
(101, 
d–‘ed_v®ues_
[0]);

89 
	}
}

91 
	$TEST
(
CacheTe¡
, 
E¿£
) {

92 
	`E¿£
(200);

93 
	`ASSERT_EQ
(0, 
d–‘ed_keys_
.
	`size
());

95 
	`In£¹
(100, 101);

96 
	`In£¹
(200, 201);

97 
	`E¿£
(100);

98 
	`ASSERT_EQ
(-1, 
	`Lookup
(100));

99 
	`ASSERT_EQ
(201, 
	`Lookup
(200));

100 
	`ASSERT_EQ
(1, 
d–‘ed_keys_
.
	`size
());

101 
	`ASSERT_EQ
(100, 
d–‘ed_keys_
[0]);

102 
	`ASSERT_EQ
(101, 
d–‘ed_v®ues_
[0]);

104 
	`E¿£
(100);

105 
	`ASSERT_EQ
(-1, 
	`Lookup
(100));

106 
	`ASSERT_EQ
(201, 
	`Lookup
(200));

107 
	`ASSERT_EQ
(1, 
d–‘ed_keys_
.
	`size
());

108 
	}
}

110 
	$TEST
(
CacheTe¡
, 
EÁr›sA»PšÃd
) {

111 
	`In£¹
(100, 101);

112 
Cache
::
HªdË
* 
h1
 = 
ÿche_
->
	`Lookup
(
	`EncodeKey
(100));

113 
	`ASSERT_EQ
(101, 
	`DecodeV®ue
(
ÿche_
->
	`V®ue
(
h1
)));

115 
	`In£¹
(100, 102);

116 
Cache
::
HªdË
* 
h2
 = 
ÿche_
->
	`Lookup
(
	`EncodeKey
(100));

117 
	`ASSERT_EQ
(102, 
	`DecodeV®ue
(
ÿche_
->
	`V®ue
(
h2
)));

118 
	`ASSERT_EQ
(0, 
d–‘ed_keys_
.
	`size
());

120 
ÿche_
->
	`R–—£
(
h1
);

121 
	`ASSERT_EQ
(1, 
d–‘ed_keys_
.
	`size
());

122 
	`ASSERT_EQ
(100, 
d–‘ed_keys_
[0]);

123 
	`ASSERT_EQ
(101, 
d–‘ed_v®ues_
[0]);

125 
	`E¿£
(100);

126 
	`ASSERT_EQ
(-1, 
	`Lookup
(100));

127 
	`ASSERT_EQ
(1, 
d–‘ed_keys_
.
	`size
());

129 
ÿche_
->
	`R–—£
(
h2
);

130 
	`ASSERT_EQ
(2, 
d–‘ed_keys_
.
	`size
());

131 
	`ASSERT_EQ
(100, 
d–‘ed_keys_
[1]);

132 
	`ASSERT_EQ
(102, 
d–‘ed_v®ues_
[1]);

133 
	}
}

135 
	$TEST
(
CacheTe¡
, 
EviùiÚPŞicy
) {

136 
	`In£¹
(100, 101);

137 
	`In£¹
(200, 201);

140 
i
 = 0; i < 
kCacheSize
; i++) {

141 
	`In£¹
(1000+
i
, 2000+i);

142 
	`ASSERT_EQ
(2000+
i
, 
	`Lookup
(1000+i));

143 
	`ASSERT_EQ
(101, 
	`Lookup
(100));

145 
	`ASSERT_EQ
(101, 
	`Lookup
(100));

146 
	`ASSERT_EQ
(2, 
d–‘ed_keys_
.
	`size
());

147 
	`ASSERT_EQ
(200, 
d–‘ed_keys_
[0]);

148 
	`ASSERT_EQ
(201, 
d–‘ed_v®ues_
[0]);

149 
	}
}

151 
	$TEST
(
CacheTe¡
, 
H—vyEÁry
) {

152 
	`In£¹
(100, 101);

153 
	`In£¹
(200, 201, 
kCacheSize
);

154 
	`ASSERT_EQ
(1, 
d–‘ed_keys_
.
	`size
());

155 
	`ASSERT_EQ
(100, 
d–‘ed_keys_
[0]);

156 
	`ASSERT_EQ
(101, 
d–‘ed_v®ues_
[0]);

157 
	}
}

159 
	$TEST
(
CacheTe¡
, 
NewId
) {

160 
ušt64_t
 
a
 = 
ÿche_
->
	`NewId
();

161 
ušt64_t
 
b
 = 
ÿche_
->
	`NewId
();

162 
	`ASSERT_NE
(
a
, 
b
);

163 
	}
}

167 
	$maš
(
¬gc
, ** 
¬gv
) {

168  
Ëv–db
::
‹¡
::
	`RunAÎTe¡s
();

169 
	}
}

	@util/coding.cc

5 
	~"ut/codšg.h
"

7 
Çme¥aû
 
	gËv–db
 {

9 
EncodeFixed32
(* 
buf
, 
ušt32_t
 
v®ue
) {

10 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


11 
memıy
(
buf
, &
v®ue
, (value));

13 
	gbuf
[0] = 
v®ue
 & 0xff;

14 
	gbuf
[1] = (
v®ue
 >> 8) & 0xff;

15 
	gbuf
[2] = (
v®ue
 >> 16) & 0xff;

16 
	gbuf
[3] = (
v®ue
 >> 24) & 0xff;

20 
EncodeFixed64
(* 
buf
, 
ušt64_t
 
v®ue
) {

21 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


22 
memıy
(
buf
, &
v®ue
, (value));

24 
	gbuf
[0] = 
v®ue
 & 0xff;

25 
	gbuf
[1] = (
v®ue
 >> 8) & 0xff;

26 
	gbuf
[2] = (
v®ue
 >> 16) & 0xff;

27 
	gbuf
[3] = (
v®ue
 >> 24) & 0xff;

28 
	gbuf
[4] = (
v®ue
 >> 32) & 0xff;

29 
	gbuf
[5] = (
v®ue
 >> 40) & 0xff;

30 
	gbuf
[6] = (
v®ue
 >> 48) & 0xff;

31 
	gbuf
[7] = (
v®ue
 >> 56) & 0xff;

35 
PutFixed32
(
¡d
::
¡ršg
* 
d¡
, 
ušt32_t
 
v®ue
) {

36 
	gbuf
[(
v®ue
)];

37 
EncodeFixed32
(
buf
, 
v®ue
);

38 
	gd¡
->
­³nd
(
buf
, (buf));

41 
PutFixed64
(
¡d
::
¡ršg
* 
d¡
, 
ušt64_t
 
v®ue
) {

42 
	gbuf
[(
v®ue
)];

43 
EncodeFixed64
(
buf
, 
v®ue
);

44 
	gd¡
->
­³nd
(
buf
, (buf));

47 * 
EncodeV¬št32
(* 
d¡
, 
ušt32_t
 
v
) {

49 * 
	g±r
 = 
»š‹½»t_ÿ¡
<*>(
d¡
);

50 cÚ¡ 
	gB
 = 128;

51 ià(
	gv
 < (1<<7)) {

52 *(
	g±r
++èğ
v
;

53 } ià(
	gv
 < (1<<14)) {

54 *(
	g±r
++èğ
v
 | 
B
;

55 *(
	g±r
++èğ
v
>>7;

56 } ià(
	gv
 < (1<<21)) {

57 *(
	g±r
++èğ
v
 | 
B
;

58 *(
	g±r
++èğ(
v
>>7è| 
B
;

59 *(
	g±r
++èğ
v
>>14;

60 } ià(
	gv
 < (1<<28)) {

61 *(
	g±r
++èğ
v
 | 
B
;

62 *(
	g±r
++èğ(
v
>>7è| 
B
;

63 *(
	g±r
++èğ(
v
>>14è| 
B
;

64 *(
	g±r
++èğ
v
>>21;

66 *(
	g±r
++èğ
v
 | 
B
;

67 *(
	g±r
++èğ(
v
>>7è| 
B
;

68 *(
	g±r
++èğ(
v
>>14è| 
B
;

69 *(
	g±r
++èğ(
v
>>21è| 
B
;

70 *(
	g±r
++èğ
v
>>28;

72  
	g»š‹½»t_ÿ¡
<*>(
	g±r
);

75 
PutV¬št32
(
¡d
::
¡ršg
* 
d¡
, 
ušt32_t
 
v
) {

76 
	gbuf
[5];

77 * 
	g±r
 = 
EncodeV¬št32
(
buf
, 
v
);

78 
	gd¡
->
­³nd
(
buf
, 
±r
 - buf);

81 * 
EncodeV¬št64
(* 
d¡
, 
ušt64_t
 
v
) {

82 cÚ¡ 
	gB
 = 128;

83 * 
	g±r
 = 
»š‹½»t_ÿ¡
<*>(
d¡
);

84 
	gv
 >ğ
B
) {

85 *(
±r
++èğ(
v
 & (
B
-1)) | B;

86 
	gv
 >>= 7;

88 *(
	g±r
++èğ
¡©ic_ÿ¡
<>(
v
);

89  
	g»š‹½»t_ÿ¡
<*>(
	g±r
);

92 
PutV¬št64
(
¡d
::
¡ršg
* 
d¡
, 
ušt64_t
 
v
) {

93 
	gbuf
[10];

94 * 
	g±r
 = 
EncodeV¬št64
(
buf
, 
v
);

95 
	gd¡
->
­³nd
(
buf
, 
±r
 - buf);

98 
PutL’gthP»fixedSliû
(
¡d
::
¡ršg
* 
d¡
, cÚ¡ 
Sliû
& 
v®ue
) {

99 
PutV¬št32
(
d¡
, 
v®ue
.
size
());

100 
	gd¡
->
­³nd
(
v®ue
.
d©a
(), v®ue.
size
());

103 
V¬štL’gth
(
ušt64_t
 
v
) {

104 
	gËn
 = 1;

105 
	gv
 >= 128) {

106 
v
 >>= 7;

107 
	gËn
++;

109  
	gËn
;

112 cÚ¡ * 
G‘V¬št32PŒF®lback
(cÚ¡ * 
p
,

113 cÚ¡ * 
lim™
,

114 
ušt32_t
* 
v®ue
) {

115 
ušt32_t
 
	g»suÉ
 = 0;

116 
ušt32_t
 
	gshiá
 = 0; shiá <ğ28 && 
p
 < 
lim™
; shift += 7) {

117 
ušt32_t
 
by‹
 = *(
»š‹½»t_ÿ¡
<cÚ¡ *>(
p
));

118 
	gp
++;

119 ià(
	gby‹
 & 128) {

121 
	g»suÉ
 |ğ((
by‹
 & 127è<< 
shiá
);

123 
	g»suÉ
 |ğ(
by‹
 << 
shiá
);

124 *
	gv®ue
 = 
»suÉ
;

125  
	g»š‹½»t_ÿ¡
<cÚ¡ *>(
	gp
);

128  
	gNULL
;

131 
boŞ
 
G‘V¬št32
(
Sliû
* 
šput
, 
ušt32_t
* 
v®ue
) {

132 cÚ¡ * 
	gp
 = 
šput
->
d©a
();

133 cÚ¡ * 
	glim™
 = 
p
 + 
šput
->
size
();

134 cÚ¡ * 
	gq
 = 
G‘V¬št32PŒ
(
p
, 
lim™
, 
v®ue
);

135 ià(
	gq
 =ğ
NULL
) {

136  
çl£
;

138 *
	gšput
 = 
Sliû
(
q
, 
lim™
 - q);

139  
	gŒue
;

143 cÚ¡ * 
G‘V¬št64PŒ
(cÚ¡ * 
p
, cÚ¡ * 
lim™
, 
ušt64_t
* 
v®ue
) {

144 
ušt64_t
 
	g»suÉ
 = 0;

145 
ušt32_t
 
	gshiá
 = 0; shiá <ğ63 && 
p
 < 
lim™
; shift += 7) {

146 
ušt64_t
 
by‹
 = *(
»š‹½»t_ÿ¡
<cÚ¡ *>(
p
));

147 
	gp
++;

148 ià(
	gby‹
 & 128) {

150 
	g»suÉ
 |ğ((
by‹
 & 127è<< 
shiá
);

152 
	g»suÉ
 |ğ(
by‹
 << 
shiá
);

153 *
	gv®ue
 = 
»suÉ
;

154  
	g»š‹½»t_ÿ¡
<cÚ¡ *>(
	gp
);

157  
	gNULL
;

160 
boŞ
 
G‘V¬št64
(
Sliû
* 
šput
, 
ušt64_t
* 
v®ue
) {

161 cÚ¡ * 
	gp
 = 
šput
->
d©a
();

162 cÚ¡ * 
	glim™
 = 
p
 + 
šput
->
size
();

163 cÚ¡ * 
	gq
 = 
G‘V¬št64PŒ
(
p
, 
lim™
, 
v®ue
);

164 ià(
	gq
 =ğ
NULL
) {

165  
çl£
;

167 *
	gšput
 = 
Sliû
(
q
, 
lim™
 - q);

168  
	gŒue
;

172 cÚ¡ * 
G‘L’gthP»fixedSliû
(cÚ¡ * 
p
, cÚ¡ * 
lim™
,

173 
Sliû
* 
»suÉ
) {

174 
ušt32_t
 
	gËn
;

175 
	gp
 = 
G‘V¬št32PŒ
(
p
, 
lim™
, &
Ën
);

176 ià(
	gp
 =ğ
NULL
)  NULL;

177 ià(
	gp
 + 
	gËn
 > 
	glim™
è 
	gNULL
;

178 *
	g»suÉ
 = 
Sliû
(
p
, 
Ën
);

179  
	gp
 + 
	gËn
;

182 
boŞ
 
G‘L’gthP»fixedSliû
(
Sliû
* 
šput
, Sliû* 
»suÉ
) {

183 
ušt32_t
 
	gËn
;

184 ià(
G‘V¬št32
(
šput
, &
Ën
) &&

185 
	gšput
->
size
(è>ğ
Ën
) {

186 *
»suÉ
 = 
Sliû
(
šput
->
d©a
(), 
Ën
);

187 
	gšput
->
»move_´efix
(
Ën
);

188  
	gŒue
;

190  
	gçl£
;

	@util/coding.h

10 #iâdeà
STORAGE_LEVELDB_UTIL_CODING_H_


11 
	#STORAGE_LEVELDB_UTIL_CODING_H_


	)

13 
	~<¡dšt.h
>

14 
	~<¡ršg.h
>

15 
	~<¡ršg
>

16 
	~"Ëv–db/¦iû.h
"

17 
	~"pÜt/pÜt.h
"

19 
Çme¥aû
 
	gËv–db
 {

22 
PutFixed32
(
¡d
::
¡ršg
* 
d¡
, 
ušt32_t
 
v®ue
);

23 
PutFixed64
(
¡d
::
¡ršg
* 
d¡
, 
ušt64_t
 
v®ue
);

24 
PutV¬št32
(
¡d
::
¡ršg
* 
d¡
, 
ušt32_t
 
v®ue
);

25 
PutV¬št64
(
¡d
::
¡ršg
* 
d¡
, 
ušt64_t
 
v®ue
);

26 
PutL’gthP»fixedSliû
(
¡d
::
¡ršg
* 
d¡
, cÚ¡ 
Sliû
& 
v®ue
);

30 
boŞ
 
G‘V¬št32
(
Sliû
* 
šput
, 
ušt32_t
* 
v®ue
);

31 
boŞ
 
G‘V¬št64
(
Sliû
* 
šput
, 
ušt64_t
* 
v®ue
);

32 
boŞ
 
G‘L’gthP»fixedSliû
(
Sliû
* 
šput
, Sliû* 
»suÉ
);

38 cÚ¡ * 
G‘V¬št32PŒ
(cÚ¡ * 
p
,cÚ¡ * 
lim™
, 
ušt32_t
* 
v
);

39 cÚ¡ * 
G‘V¬št64PŒ
(cÚ¡ * 
p
,cÚ¡ * 
lim™
, 
ušt64_t
* 
v
);

42 
V¬štL’gth
(
ušt64_t
 
v
);

46 
EncodeFixed32
(* 
d¡
, 
ušt32_t
 
v®ue
);

47 
EncodeFixed64
(* 
d¡
, 
ušt64_t
 
v®ue
);

52 * 
EncodeV¬št32
(* 
d¡
, 
ušt32_t
 
v®ue
);

53 * 
EncodeV¬št64
(* 
d¡
, 
ušt64_t
 
v®ue
);

58 
šlše
 
ušt32_t
 
DecodeFixed32
(cÚ¡ * 
±r
) {

59 ià(
	gpÜt
::
kL™eEndŸn
) {

61 
ušt32_t
 
»suÉ
;

62 
memıy
(&
»suÉ
, 
±r
, (result));

63  
	g»suÉ
;

65  ((
	g¡©ic_ÿ¡
<
	gušt32_t
>(
	g±r
[0]))

66 | (
	g¡©ic_ÿ¡
<
	gušt32_t
>(
	g±r
[1]) << 8)

67 | (
	g¡©ic_ÿ¡
<
	gušt32_t
>(
	g±r
[2]) << 16)

68 | (
	g¡©ic_ÿ¡
<
	gušt32_t
>(
	g±r
[3]) << 24));

72 
šlše
 
ušt64_t
 
DecodeFixed64
(cÚ¡ * 
±r
) {

73 ià(
	gpÜt
::
kL™eEndŸn
) {

75 
ušt64_t
 
»suÉ
;

76 
memıy
(&
»suÉ
, 
±r
, (result));

77  
	g»suÉ
;

79 
ušt64_t
 
	glo
 = 
DecodeFixed32
(
±r
);

80 
ušt64_t
 
	ghi
 = 
DecodeFixed32
(
±r
 + 4);

81  (
	ghi
 << 32è| 
	glo
;

86 cÚ¡ * 
G‘V¬št32PŒF®lback
(cÚ¡ * 
p
,

87 cÚ¡ * 
lim™
,

88 
ušt32_t
* 
v®ue
);

89 
šlše
 cÚ¡ * 
G‘V¬št32PŒ
(cÚ¡ * 
p
,

90 cÚ¡ * 
lim™
,

91 
ušt32_t
* 
v®ue
) {

92 ià(
	gp
 < 
	glim™
) {

93 
ušt32_t
 
	g»suÉ
 = *(
»š‹½»t_ÿ¡
<cÚ¡ *>(
p
));

94 ià((
	g»suÉ
 & 128) == 0) {

95 *
v®ue
 = 
»suÉ
;

96  
	gp
 + 1;

99  
G‘V¬št32PŒF®lback
(
p
, 
lim™
, 
v®ue
);

	@util/coding_test.cc

5 
	~"ut/codšg.h
"

7 
	~"ut/‹¡h¬Ãss.h
"

9 
Çme¥aû
 
	gËv–db
 {

11 şas 
	cCodšg
 { };

13 
	$TEST
(
Codšg
, 
Fixed32
) {

14 
¡d
::
¡ršg
 
s
;

15 
ušt32_t
 
v
 = 0; v < 100000; v++) {

16 
	`PutFixed32
(&
s
, 
v
);

19 cÚ¡ * 
p
 = 
s
.
	`d©a
();

20 
ušt32_t
 
v
 = 0; v < 100000; v++) {

21 
ušt32_t
 
aùu®
 = 
	`DecodeFixed32
(
p
);

22 
	`ASSERT_EQ
(
v
, 
aùu®
);

23 
p
 +ğ(
ušt32_t
);

25 
	}
}

27 
	$TEST
(
Codšg
, 
Fixed64
) {

28 
¡d
::
¡ršg
 
s
;

29 
pow”
 = 0;…ower <= 63;…ower++) {

30 
ušt64_t
 
v
 = 
¡©ic_ÿ¡
<ušt64_t>(1è<< 
pow”
;

31 
	`PutFixed64
(&
s
, 
v
 - 1);

32 
	`PutFixed64
(&
s
, 
v
 + 0);

33 
	`PutFixed64
(&
s
, 
v
 + 1);

36 cÚ¡ * 
p
 = 
s
.
	`d©a
();

37 
pow”
 = 0;…ower <= 63;…ower++) {

38 
ušt64_t
 
v
 = 
¡©ic_ÿ¡
<ušt64_t>(1è<< 
pow”
;

39 
ušt64_t
 
aùu®
;

40 
aùu®
 = 
	`DecodeFixed64
(
p
);

41 
	`ASSERT_EQ
(
v
-1, 
aùu®
);

42 
p
 +ğ(
ušt64_t
);

44 
aùu®
 = 
	`DecodeFixed64
(
p
);

45 
	`ASSERT_EQ
(
v
+0, 
aùu®
);

46 
p
 +ğ(
ušt64_t
);

48 
aùu®
 = 
	`DecodeFixed64
(
p
);

49 
	`ASSERT_EQ
(
v
+1, 
aùu®
);

50 
p
 +ğ(
ušt64_t
);

52 
	}
}

54 
	$TEST
(
Codšg
, 
V¬št32
) {

55 
¡d
::
¡ršg
 
s
;

56 
ušt32_t
 
i
 = 0; i < (32 * 32); i++) {

57 
ušt32_t
 
v
 = (
i
 / 32) << (i % 32);

58 
	`PutV¬št32
(&
s
, 
v
);

61 cÚ¡ * 
p
 = 
s
.
	`d©a
();

62 cÚ¡ * 
lim™
 = 
p
 + 
s
.
	`size
();

63 
ušt32_t
 
i
 = 0; i < (32 * 32); i++) {

64 
ušt32_t
 
ex³ùed
 = (
i
 / 32) << (i % 32);

65 
ušt32_t
 
aùu®
;

66 cÚ¡ * 
¡¬t
 = 
p
;

67 
p
 = 
	`G‘V¬št32PŒ
Õ, 
lim™
, &
aùu®
);

68 
	`ASSERT_TRUE
(
p
 !ğ
NULL
);

69 
	`ASSERT_EQ
(
ex³ùed
, 
aùu®
);

70 
	`ASSERT_EQ
(
	`V¬štL’gth
(
aùu®
), 
p
 - 
¡¬t
);

72 
	`ASSERT_EQ
(
p
, 
s
.
	`d©a
(è+ s.
	`size
());

73 
	}
}

75 
	$TEST
(
Codšg
, 
V¬št64
) {

77 
¡d
::
veùÜ
<
ušt64_t
> 
v®ues
;

79 
v®ues
.
	`push_back
(0);

80 
v®ues
.
	`push_back
(100);

81 
v®ues
.
	`push_back
(~
¡©ic_ÿ¡
<
ušt64_t
>(0));

82 
v®ues
.
	`push_back
(~
¡©ic_ÿ¡
<
ušt64_t
>(0) - 1);

83 
ušt32_t
 
k
 = 0; k < 64; k++) {

85 cÚ¡ 
ušt64_t
 
pow”
 = 1uÎ << 
k
;

86 
v®ues
.
	`push_back
(
pow”
);

87 
v®ues
.
	`push_back
(
pow”
-1);

88 
v®ues
.
	`push_back
(
pow”
+1);

91 
¡d
::
¡ršg
 
s
;

92 
i
 = 0; i < 
v®ues
.
	`size
(); i++) {

93 
	`PutV¬št64
(&
s
, 
v®ues
[
i
]);

96 cÚ¡ * 
p
 = 
s
.
	`d©a
();

97 cÚ¡ * 
lim™
 = 
p
 + 
s
.
	`size
();

98 
i
 = 0; i < 
v®ues
.
	`size
(); i++) {

99 
	`ASSERT_TRUE
(
p
 < 
lim™
);

100 
ušt64_t
 
aùu®
;

101 cÚ¡ * 
¡¬t
 = 
p
;

102 
p
 = 
	`G‘V¬št64PŒ
Õ, 
lim™
, &
aùu®
);

103 
	`ASSERT_TRUE
(
p
 !ğ
NULL
);

104 
	`ASSERT_EQ
(
v®ues
[
i
], 
aùu®
);

105 
	`ASSERT_EQ
(
	`V¬štL’gth
(
aùu®
), 
p
 - 
¡¬t
);

107 
	`ASSERT_EQ
(
p
, 
lim™
);

109 
	}
}

111 
	$TEST
(
Codšg
, 
V¬št32Ov”æow
) {

112 
ušt32_t
 
»suÉ
;

113 
¡d
::
¡ršg
 
	`šput
("\x81\x82\x83\x84\x85\x11");

114 
	`ASSERT_TRUE
(
	`G‘V¬št32PŒ
(
šput
.
	`d©a
(), iÅut.d©a(è+ iÅut.
	`size
(), &
»suÉ
)

115 =ğ
NULL
);

116 
	}
}

118 
	$TEST
(
Codšg
, 
V¬št32TrunÿtiÚ
) {

119 
ušt32_t
 
Ïrge_v®ue
 = (1u << 31) + 100;

120 
¡d
::
¡ršg
 
s
;

121 
	`PutV¬št32
(&
s
, 
Ïrge_v®ue
);

122 
ušt32_t
 
»suÉ
;

123 
Ën
 = 0;†’ < 
s
.
	`size
() - 1;†en++) {

124 
	`ASSERT_TRUE
(
	`G‘V¬št32PŒ
(
s
.
	`d©a
(), s.d©a(è+ 
Ën
, &
»suÉ
è=ğ
NULL
);

126 
	`ASSERT_TRUE
(
	`G‘V¬št32PŒ
(
s
.
	`d©a
(), s.d©a(è+ s.
	`size
(), &
»suÉ
è!ğ
NULL
);

127 
	`ASSERT_EQ
(
Ïrge_v®ue
, 
»suÉ
);

128 
	}
}

130 
	$TEST
(
Codšg
, 
V¬št64Ov”æow
) {

131 
ušt64_t
 
»suÉ
;

132 
¡d
::
¡ršg
 
	`šput
("\x81\x82\x83\x84\x85\x81\x82\x83\x84\x85\x11");

133 
	`ASSERT_TRUE
(
	`G‘V¬št64PŒ
(
šput
.
	`d©a
(), iÅut.d©a(è+ iÅut.
	`size
(), &
»suÉ
)

134 =ğ
NULL
);

135 
	}
}

137 
	$TEST
(
Codšg
, 
V¬št64TrunÿtiÚ
) {

138 
ušt64_t
 
Ïrge_v®ue
 = (1ull << 63) + 100ull;

139 
¡d
::
¡ršg
 
s
;

140 
	`PutV¬št64
(&
s
, 
Ïrge_v®ue
);

141 
ušt64_t
 
»suÉ
;

142 
Ën
 = 0;†’ < 
s
.
	`size
() - 1;†en++) {

143 
	`ASSERT_TRUE
(
	`G‘V¬št64PŒ
(
s
.
	`d©a
(), s.d©a(è+ 
Ën
, &
»suÉ
è=ğ
NULL
);

145 
	`ASSERT_TRUE
(
	`G‘V¬št64PŒ
(
s
.
	`d©a
(), s.d©a(è+ s.
	`size
(), &
»suÉ
è!ğ
NULL
);

146 
	`ASSERT_EQ
(
Ïrge_v®ue
, 
»suÉ
);

147 
	}
}

149 
	$TEST
(
Codšg
, 
SŒšgs
) {

150 
¡d
::
¡ršg
 
s
;

151 
	`PutL’gthP»fixedSliû
(&
s
, 
	`Sliû
(""));

152 
	`PutL’gthP»fixedSliû
(&
s
, 
	`Sliû
("foo"));

153 
	`PutL’gthP»fixedSliû
(&
s
, 
	`Sliû
("bar"));

154 
	`PutL’gthP»fixedSliû
(&
s
, 
	`Sliû
(
¡d
::
	`¡ršg
(200, 'x')));

156 
Sliû
 
	`šput
(
s
);

157 
Sliû
 
v
;

158 
	`ASSERT_TRUE
(
	`G‘L’gthP»fixedSliû
(&
šput
, &
v
));

159 
	`ASSERT_EQ
("", 
v
.
	`ToSŒšg
());

160 
	`ASSERT_TRUE
(
	`G‘L’gthP»fixedSliû
(&
šput
, &
v
));

161 
	`ASSERT_EQ
("foo", 
v
.
	`ToSŒšg
());

162 
	`ASSERT_TRUE
(
	`G‘L’gthP»fixedSliû
(&
šput
, &
v
));

163 
	`ASSERT_EQ
("b¬", 
v
.
	`ToSŒšg
());

164 
	`ASSERT_TRUE
(
	`G‘L’gthP»fixedSliû
(&
šput
, &
v
));

165 
	`ASSERT_EQ
(
¡d
::
	`¡ršg
(200, 'x'), 
v
.
	`ToSŒšg
());

166 
	`ASSERT_EQ
("", 
šput
.
	`ToSŒšg
());

167 
	}
}

171 
	$maš
(
¬gc
, ** 
¬gv
) {

172  
Ëv–db
::
‹¡
::
	`RunAÎTe¡s
();

173 
	}
}

	@util/comparator.cc

5 
	~<¡dšt.h
>

6 
	~"Ëv–db/com·¿tÜ.h
"

7 
	~"Ëv–db/¦iû.h
"

8 
	~"ut/loggšg.h
"

10 
Çme¥aû
 
	gËv–db
 {

12 
	gCom·¿tÜ
::~
Com·¿tÜ
() { }

14 
Çme¥aû
 {

15 şas 
	cBy‹wi£Com·¿tÜIm¶
 : 
public
 
Com·¿tÜ
 {

16 
public
:

17 
By‹wi£Com·¿tÜIm¶
() { }

19 
vœtu®
 cÚ¡ * 
Name
() const {

23 
vœtu®
 
Com·»
(cÚ¡ 
Sliû
& 
a
, cÚ¡ Sliû& 
b
) const {

24  
	ga
.
com·»
(
b
);

27 
vœtu®
 
FšdShÜ‹¡S•¬©Ü
(

28 
¡d
::
¡ršg
* 
¡¬t
,

29 cÚ¡ 
Sliû
& 
lim™
) const {

31 
size_t
 
	gmš_Ëngth
 = 
¡d
::
mš
(
¡¬t
->
size
(), 
lim™
.size());

32 
size_t
 
	gdiff_šdex
 = 0;

33 (
	gdiff_šdex
 < 
	gmš_Ëngth
) &&

34 ((*
	g¡¬t
)[
diff_šdex
] =ğ
lim™
[diff_index])) {

35 
diff_šdex
++;

38 ià(
	gdiff_šdex
 >ğ
mš_Ëngth
) {

41 
ušt8_t
 
diff_by‹
 = 
¡©ic_ÿ¡
<ušt8_t>((*
¡¬t
)[
diff_šdex
]);

42 ià(
	gdiff_by‹
 < 
	g¡©ic_ÿ¡
<
	gušt8_t
>(0xff) &&

43 
	gdiff_by‹
 + 1 < 
	g¡©ic_ÿ¡
<
	gušt8_t
>(
	glim™
[
diff_šdex
])) {

44 (*
	g¡¬t
)[
diff_šdex
]++;

45 
	g¡¬t
->
»size
(
diff_šdex
 + 1);

46 
as£¹
(
Com·»
(*
¡¬t
, 
lim™
) < 0);

51 
vœtu®
 
FšdShÜtSucûssÜ
(
¡d
::
¡ršg
* 
key
) const {

53 
size_t
 
n
 = 
key
->
size
();

54 
size_t
 
	gi
 = 0; i < 
	gn
; i++) {

55 cÚ¡ 
ušt8_t
 
	gby‹
 = (*
key
)[
i
];

56 ià(
	gby‹
 !ğ
¡©ic_ÿ¡
<
ušt8_t
>(0xff)) {

57 (*
key
)[
i
] = 
by‹
 + 1;

58 
	gkey
->
»size
(
i
+1);

66 cÚ¡ 
By‹wi£Com·¿tÜIm¶
 
	gby‹wi£
;

68 cÚ¡ 
Com·¿tÜ
* 
	$By‹wi£Com·¿tÜ
() {

69  &
by‹wi£
;

70 
	}
}

	@util/crc32c.cc

8 
	~"ut/üc32c.h
"

10 
	~<¡dšt.h
>

11 
	~"ut/codšg.h
"

13 
Çme¥aû
 
	gËv–db
 {

14 
Çme¥aû
 
	güc32c
 {

16 cÚ¡ 
ušt32_t
 
	gbË0_
[256] = {

82 cÚ¡ 
ušt32_t
 
	gbË1_
[256] = {

148 cÚ¡ 
ušt32_t
 
	gbË2_
[256] = {

214 cÚ¡ 
ušt32_t
 
	gbË3_
[256] = {

282 
šlše
 
ušt32_t
 
LE_LOAD32
(cÚ¡ 
ušt8_t
 *
p
) {

283  
DecodeFixed32
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
p
));

286 
ušt32_t
 
Ex‹nd
(ušt32_ˆ
üc
, cÚ¡ * 
buf
, 
size_t
 
size
) {

287 cÚ¡ 
ušt8_t
 *
	gp
 = 
»š‹½»t_ÿ¡
<cÚ¡ ušt8_ˆ*>(
buf
);

288 cÚ¡ 
ušt8_t
 *
	ge
 = 
p
 + 
size
;

289 
ušt32_t
 
	gl
 = 
üc
 ^ 0xffffffffu;

291 
	#STEP1
 do { \

292 
c
 = (
l
 & 0xffè^ *
p
++; \

293 
l
 = 
bË0_
[
c
] ^ (l >> 8); \

294 } 0)

	)

295 
	#STEP4
 do { \

296 
ušt32_t
 
c
 = 
l
 ^ 
	`LE_LOAD32
(
p
); \

297 
p
 += 4; \

298 
l
 = 
bË3_
[
c
 & 0xff] ^ \

299 
bË2_
[(
c
 >> 8) & 0xff] ^ \

300 
bË1_
[(
c
 >> 16) & 0xff] ^ \

301 
bË0_
[
c
 >> 24]; \

302 } 0)

	)

306 cÚ¡ 
ušŒ_t
 
	gpv®
 = 
»š‹½»t_ÿ¡
<ušŒ_t>(
p
);

307 cÚ¡ 
ušt8_t
* 
	gx
 = 
»š‹½»t_ÿ¡
<cÚ¡ ušt8_t*>(((
pv®
 + 3) >> 2) << 2);

308 ià(
	gx
 <ğ
e
) {

310 
p
 !ğ
x
) {

311 
STEP1
;

315 (
	ge
-
	gp
) >= 16) {

316 
STEP4
; 
	gSTEP4
; STEP4; STEP4;

319 (
	ge
-
	gp
) >= 4) {

320 
STEP4
;

323 
	gp
 !ğ
e
) {

324 
STEP1
;

326 #undeà
STEP4


327 #undeà
STEP1


328  
	gl
 ^ 0xffffffffu;

	@util/crc32c.h

5 #iâdeà
STORAGE_LEVELDB_UTIL_CRC32C_H_


6 
	#STORAGE_LEVELDB_UTIL_CRC32C_H_


	)

8 
	~<¡ddef.h
>

9 
	~<¡dšt.h
>

11 
Çme¥aû
 
	gËv–db
 {

12 
Çme¥aû
 
	güc32c
 {

17 
ušt32_t
 
Ex‹nd
(ušt32_ˆ
š™_üc
, cÚ¡ * 
d©a
, 
size_t
 
n
);

20 
šlše
 
ušt32_t
 
V®ue
(cÚ¡ * 
d©a
, 
size_t
 
n
) {

21  
Ex‹nd
(0, 
d©a
, 
n
);

24 cÚ¡ 
ušt32_t
 
	gkMaskD–
 = 0xa282ead8ul;

31 
šlše
 
ušt32_t
 
Mask
(ušt32_ˆ
üc
) {

33  ((
	güc
 >> 15è| (üø<< 17)è+ 
	gkMaskD–
;

37 
šlše
 
ušt32_t
 
Unmask
(ušt32_ˆ
masked_üc
) {

38 
ušt32_t
 
	grÙ
 = 
masked_üc
 - 
kMaskD–
;

39  ((
	grÙ
 >> 17) | (rot << 15));

	@util/crc32c_test.cc

5 
	~"ut/üc32c.h
"

6 
	~"ut/‹¡h¬Ãss.h
"

8 
Çme¥aû
 
	gËv–db
 {

9 
Çme¥aû
 
	güc32c
 {

11 şas 
	cCRC
 { };

13 
TEST
(
CRC
, 
Snd¬dResuÉs
) {

15 
	gbuf
[32];

17 
mem£t
(
buf
, 0, (buf));

18 
ASSERT_EQ
(0x8a9136¯, 
V®ue
(
buf
, (buf)));

20 
mem£t
(
buf
, 0xff, (buf));

21 
ASSERT_EQ
(0x62a8ab43, 
V®ue
(
buf
, (buf)));

23 
	gi
 = 0; i < 32; i++) {

24 
	gbuf
[
i
] = i;

26 
ASSERT_EQ
(0x46dd794e, 
V®ue
(
buf
, (buf)));

28 
	gi
 = 0; i < 32; i++) {

29 
	gbuf
[
i
] = 31 - i;

31 
ASSERT_EQ
(0x113fdb5c, 
V®ue
(
buf
, (buf)));

33 
	gd©a
[48] = {

47 
ASSERT_EQ
(0xd9963a56, 
V®ue
(
»š‹½»t_ÿ¡
<*>(
d©a
), (data)));

50 
TEST
(
CRC
, 
V®ues
) {

51 
ASSERT_NE
(
V®ue
("a", 1), Value("foo", 3));

54 
TEST
(
CRC
, 
Ex‹nd
) {

55 
ASSERT_EQ
(
V®ue
("hello world", 11),

56 
Ex‹nd
(
V®ue
("hello ", 6), "world", 5));

59 
TEST
(
CRC
, 
Mask
) {

60 
ušt32_t
 
	güc
 = 
V®ue
("foo", 3);

61 
ASSERT_NE
(
üc
, 
Mask
(crc));

62 
ASSERT_NE
(
üc
, 
Mask
(Mask(crc)));

63 
ASSERT_EQ
(
üc
, 
Unmask
(
Mask
(crc)));

64 
ASSERT_EQ
(
üc
, 
Unmask
(Unmask(
Mask
(Mask(crc)))));

70 
	$maš
(
¬gc
, ** 
¬gv
) {

71  
Ëv–db
::
‹¡
::
	`RunAÎTe¡s
();

72 
	}
}

	@util/env.cc

5 
	~"Ëv–db/’v.h
"

7 
Çme¥aû
 
	gËv–db
 {

9 
	gEnv
::~
Env
() {

12 
Sequ’tŸlFe
::~SequentialFile() {

15 
RªdomAcûssFe
::~RandomAccessFile() {

18 
Wr™abËFe
::~WritableFile() {

21 
FeLock
::~FileLock() {

24 
Log
(
Env
* 
’v
, 
Wr™abËFe
* 
šfo_log
, cÚ¡ * 
fÜm©
, ...) {

25 
va_li¡
 
	g­
;

26 
va_¡¬t
(
­
, 
fÜm©
);

27 
	g’v
->
Logv
(
šfo_log
, 
fÜm©
, 
­
);

28 
va_’d
(
­
);

31 
Stus
 
Wr™eSŒšgToFe
(
Env
* 
’v
, cÚ¡ 
Sliû
& 
d©a
,

32 cÚ¡ 
¡d
::
¡ršg
& 
âame
) {

33 
Wr™abËFe
* 
fe
;

34 
Stus
 
	gs
 = 
’v
->
NewWr™abËFe
(
âame
, &
fe
);

35 ià(!
	gs
.
ok
()) {

36  
	gs
;

38 
	gs
 = 
fe
->
Aµ’d
(
d©a
);

39 ià(
	gs
.
ok
()) {

40 
	gs
 = 
fe
->
Clo£
();

42 
d–‘e
 
	gfe
;

43 ià(!
	gs
.
ok
()) {

44 
	g’v
->
D–‘eFe
(
âame
);

46  
	gs
;

49 
Stus
 
R—dFeToSŒšg
(
Env
* 
’v
, cÚ¡ 
¡d
::
¡ršg
& 
âame
, std::¡ršg* 
d©a
) {

50 
d©a
->
ş—r
();

51 
Sequ’tŸlFe
* 
	gfe
;

52 
Stus
 
	gs
 = 
’v
->
NewSequ’tŸlFe
(
âame
, &
fe
);

53 ià(!
	gs
.
ok
()) {

54  
	gs
;

56 cÚ¡ 
	gkBufãrSize
 = 8192;

57 * 
	g¥aû
 = 
Ãw
 [
kBufãrSize
];

58 
	gŒue
) {

59 
Sliû
 
	gäagm’t
;

60 
	gs
 = 
fe
->
R—d
(
kBufãrSize
, &
äagm’t
, 
¥aû
);

61 ià(!
	gs
.
ok
()) {

64 
	gd©a
->
­³nd
(
äagm’t
.
d©a
(), f¿gm’t.
size
());

65 ià(
	gäagm’t
.
em±y
()) {

69 
	gd–‘e
[] 
	g¥aû
;

70 
d–‘e
 
	gfe
;

71  
	gs
;

74 
	gEnvW¿µ”
::~
EnvW¿µ”
() {

	@util/env_chromium.cc

5 
	~<deque
>

6 
	~<”ºo.h
>

7 
	~<¡dio.h
>

8 
	~"ba£/©_ex™.h
"

9 
	~"ba£/fe_·th.h
"

10 
	~"ba£/fe_ut.h
"

11 
	~"ba£/Ïzy_š¡ªû.h
"

12 
	~"ba£/memÜy/»f_couÁed.h
"

13 
	~"ba£/mes§ge_loİ.h
"

14 
	~"ba£/¶©fÜm_fe.h
"

15 
	~"ba£/´oûss_ut.h
"

16 
	~"ba£/synchrÚiz©iÚ/lock.h
"

17 
	~"ba£/sys_šfo.h
"

18 
	~"ba£/sk.h
"

19 
	~"ba£/th»adšg/¶©fÜm_th»ad.h
"

20 
	~"ba£/th»adšg/th»ad.h
"

21 
	~"ba£/utf_¡ršg_cÚv”siÚs.h
"

22 
	~"Ëv–db/’v.h
"

23 
	~"Ëv–db/¦iû.h
"

24 
	~"pÜt/pÜt.h
"

25 
	~"ut/loggšg.h
"

27 #ià
defšed
(
OS_WIN
)

28 
	~<io.h
>

29 
	~"ba£/wš/wš_ut.h
"

32 #ià
defšed
(
OS_MACOSX
è|| defšed(
OS_WIN
)

34 
	gÇme¥aû
 {

36 
size_t
 
ä—d_uÆocked
(*
±r
, size_ˆ
size
, size_ˆ
n
, 
FILE
 *
fe
) {

37  
ä—d
(
±r
, 
size
, 
n
, 
fe
);

40 
size_t
 
fwr™e_uÆocked
(cÚ¡ *
±r
, size_ˆ
size
, size_ˆ
n
, 
FILE
 *
fe
) {

41  
fwr™e
(
±r
, 
size
, 
n
, 
fe
);

44 
fæush_uÆocked
(
FILE
 *
fe
) {

45  
fæush
(
fe
);

48 
fd©async
(
fdes
) {

49 #ià
defšed
(
OS_WIN
)

50  
_comm™
(
fdes
);

52  
fsync
(
fdes
);

59 
Çme¥aû
 
	gËv–db
 {

61 
	gÇme¥aû
 {

63 
şass
 
	gTh»ad
;

65 cÚ¡ ::
FeP©h
::
Ch¬Ty³
 
kLev–DBTe¡DœeùÜyP»fix
[]

66 ğ
FILE_PATH_LITERAL
("leveldb-test-");

68 ::
FeP©h
 
C»©eFeP©h
(cÚ¡ 
¡d
::
¡ršg
& 
fe_·th
) {

69 #ià
defšed
(
OS_WIN
)

70  
FeP©h
(
UTF8ToUTF16
(
fe_·th
));

72  
FeP©h
(
fe_·th
);

76 
	g¡d
::
¡ršg
 
FeP©hToSŒšg
(cÚ¡ ::
FeP©h
& 
fe_·th
) {

77 #ià
defšed
(
OS_WIN
)

78  
UTF16ToUTF8
(
fe_·th
.
v®ue
());

80  
	gfe_·th
.
v®ue
();

85 cÚ¡ * 
PÏtfÜmFeE¼ÜSŒšg
(cÚ¡ ::
ba£
::
PÏtfÜmFeE¼Ü
& 
”rÜ
) {

86 
”rÜ
) {

87 ::
ba£
::
PLATFORM_FILE_ERROR_FAILED
:

89 ::
ba£
::
PLATFORM_FILE_ERROR_IN_USE
:

91 ::
ba£
::
PLATFORM_FILE_ERROR_EXISTS
:

93 ::
ba£
::
PLATFORM_FILE_ERROR_NOT_FOUND
:

95 ::
ba£
::
PLATFORM_FILE_ERROR_ACCESS_DENIED
:

97 ::
ba£
::
PLATFORM_FILE_ERROR_TOO_MANY_OPENED
:

99 ::
ba£
::
PLATFORM_FILE_ERROR_NO_MEMORY
:

101 ::
ba£
::
PLATFORM_FILE_ERROR_NO_SPACE
:

103 ::
ba£
::
PLATFORM_FILE_ERROR_NOT_A_DIRECTORY
:

105 ::
ba£
::
PLATFORM_FILE_ERROR_INVALID_OPERATION
:

107 ::
ba£
::
PLATFORM_FILE_ERROR_SECURITY
:

109 ::
ba£
::
PLATFORM_FILE_ERROR_ABORT
:

111 ::
ba£
::
PLATFORM_FILE_ERROR_NOT_A_FILE
:

113 ::
ba£
::
PLATFORM_FILE_ERROR_NOT_EMPTY
:

116 
NOTIMPLEMENTED
();

120 şas 
	cChromiumSequ’tŸlFe
: 
public
 
Sequ’tŸlFe
 {

121 
´iv©e
:

122 
¡d
::
¡ršg
 
f’ame_
;

123 
FILE
* 
	gfe_
;

125 
	gpublic
:

126 
ChromiumSequ’tŸlFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
, 
FILE
* 
f
)

127 : 
f’ame_
(
âame
), 
fe_
(
f
) { }

128 
	gvœtu®
 ~
ChromiumSequ’tŸlFe
(è{ 
fşo£
(
fe_
); }

130 
vœtu®
 
Stus
 
R—d
(
size_t
 
n
, 
Sliû
* 
»suÉ
, * 
sü©ch
) {

131 
Stus
 
	gs
;

132 
size_t
 
	gr
 = 
ä—d_uÆocked
(
sü©ch
, 1, 
n
, 
fe_
);

133 *
	g»suÉ
 = 
Sliû
(
sü©ch
, 
r
);

134 ià(
	gr
 < 
	gn
) {

135 ià(
ãof
(
fe_
)) {

139 
	gs
 = 
Stus
::
IOE¼Ü
(
f’ame_
, 
¡»¼Ü
(
”ºo
));

142  
	gs
;

146 şas 
	cChromiumRªdomAcûssFe
: 
public
 
RªdomAcûssFe
 {

147 
´iv©e
:

148 
¡d
::
¡ršg
 
f’ame_
;

149 ::
ba£
::
PÏtfÜmFe
 
fe_
;

151 
	gpublic
:

152 
ChromiumRªdomAcûssFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
, ::
ba£
::
PÏtfÜmFe
 
fe
)

153 : 
f’ame_
(
âame
), 
fe_
(
fe
) { }

154 
	gvœtu®
 ~
ChromiumRªdomAcûssFe
(è{ ::
ba£
::
Clo£PÏtfÜmFe
(
fe_
); }

156 
vœtu®
 
Stus
 
R—d
(
ušt64_t
 
off£t
, 
size_t
 
n
, 
Sliû
* 
»suÉ
,

157 * 
sü©ch
) const {

158 
Stus
 
	gs
;

159 
	gr
 = ::
ba£
::
R—dPÏtfÜmFe
(
fe_
, 
off£t
, 
sü©ch
, 
n
);

160 *
	g»suÉ
 = 
Sliû
(
sü©ch
, (
r
 < 0) ? 0 :„);

161 ià(
	gr
 < 0) {

163 
	gs
 = 
Stus
::
IOE¼Ü
(
f’ame_
, "Could‚ot…reform„ead");

165  
	gs
;

169 şas 
	cChromiumWr™abËFe
 : 
public
 
Wr™abËFe
 {

170 
´iv©e
:

171 
¡d
::
¡ršg
 
f’ame_
;

172 
FILE
* 
	gfe_
;

174 
	gpublic
:

175 
ChromiumWr™abËFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
, 
FILE
* 
f
)

176 : 
f’ame_
(
âame
), 
fe_
(
f
) { }

178 ~
ChromiumWr™abËFe
() {

179 ià(
	gfe_
 !ğ
NULL
) {

181 
fşo£
(
fe_
);

185 
vœtu®
 
Stus
 
Aµ’d
(cÚ¡ 
Sliû
& 
d©a
) {

186 
size_t
 
	gr
 = 
fwr™e_uÆocked
(
d©a
.d©a(), 1, d©a.
size
(), 
fe_
);

187 
Stus
 
	g»suÉ
;

188 ià(
	gr
 !ğ
d©a
.
size
()) {

189 
»suÉ
 = 
Stus
::
IOE¼Ü
(
f’ame_
, 
¡»¼Ü
(
”ºo
));

191  
	g»suÉ
;

194 
vœtu®
 
Stus
 
Clo£
() {

195 
Stus
 
	g»suÉ
;

196 ià(
fşo£
(
fe_
) != 0) {

197 
»suÉ
 = 
Stus
::
IOE¼Ü
(
f’ame_
, 
¡»¼Ü
(
”ºo
));

199 
	gfe_
 = 
NULL
;

200  
	g»suÉ
;

203 
vœtu®
 
Stus
 
Flush
() {

204 
Stus
 
	g»suÉ
;

205 ià(
fæush_uÆocked
(
fe_
) != 0) {

206 
»suÉ
 = 
Stus
::
IOE¼Ü
(
f’ame_
, 
¡»¼Ü
(
”ºo
));

208  
	g»suÉ
;

211 
vœtu®
 
Stus
 
Sync
() {

212 
Stus
 
	g»suÉ
;

213 ià((
fæush_uÆocked
(
fe_
) != 0) ||

214 (
fd©async
(
f’o
(
fe_
)) != 0)) {

215 
»suÉ
 = 
Stus
::
IOE¼Ü
(
f’ame_
, 
¡»¼Ü
(
”ºo
));

217  
	g»suÉ
;

221 şas 
	cChromiumFeLock
 : 
public
 
FeLock
 {

222 
public
:

223 ::
ba£
::
PÏtfÜmFe
 
fe_
;

226 şas 
	cChromiumEnv
 : 
public
 
Env
 {

227 
public
:

228 
ChromiumEnv
();

229 
	gvœtu®
 ~
ChromiumEnv
() {

230 
årštf
(
¡d”r
, "Destroying Env::Default()\n");

231 
ex™
(1);

234 
vœtu®
 
Stus
 
NewSequ’tŸlFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
,

235 
Sequ’tŸlFe
** 
»suÉ
) {

236 
FILE
* 
	gf
 = 
fİ’
(
âame
.
c_¡r
(), "rb");

237 ià(
	gf
 =ğ
NULL
) {

238 *
»suÉ
 = 
NULL
;

239  
	gStus
::
IOE¼Ü
(
âame
, 
¡»¼Ü
(
”ºo
));

241 *
	g»suÉ
 = 
Ãw
 
ChromiumSequ’tŸlFe
(
âame
, 
f
);

242  
	gStus
::
OK
();

246 
vœtu®
 
Stus
 
NewRªdomAcûssFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
,

247 
RªdomAcûssFe
** 
»suÉ
) {

248 
	gæags
 = ::
ba£
::
PLATFORM_FILE_READ
 | ::ba£::
PLATFORM_FILE_OPEN
;

249 
boŞ
 
	gü—‹d
;

250 ::
ba£
::
PÏtfÜmFeE¼Ü
 
”rÜ_code
;

251 ::
ba£
::
PÏtfÜmFe
 
fe
 = ::ba£::
C»©ePÏtfÜmFe
(

252 
C»©eFeP©h
(
âame
), 
æags
, &
ü—‹d
, &
”rÜ_code
);

253 ià(
	g”rÜ_code
 !ğ::
ba£
::
PLATFORM_FILE_OK
) {

254 *
»suÉ
 = 
NULL
;

255  
	gStus
::
IOE¼Ü
(
âame
, 
PÏtfÜmFeE¼ÜSŒšg
(
”rÜ_code
));

257 *
	g»suÉ
 = 
Ãw
 
ChromiumRªdomAcûssFe
(
âame
, 
fe
);

258  
	gStus
::
OK
();

261 
vœtu®
 
Stus
 
NewWr™abËFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
,

262 
Wr™abËFe
** 
»suÉ
) {

263 *
	g»suÉ
 = 
NULL
;

264 
FILE
* 
	gf
 = 
fİ’
(
âame
.
c_¡r
(), "wb");

265 ià(
	gf
 =ğ
NULL
) {

266  
Stus
::
IOE¼Ü
(
âame
, 
¡»¼Ü
(
”ºo
));

268 *
	g»suÉ
 = 
Ãw
 
ChromiumWr™abËFe
(
âame
, 
f
);

269  
	gStus
::
OK
();

273 
vœtu®
 
boŞ
 
FeExi¡s
(cÚ¡ 
¡d
::
¡ršg
& 
âame
) {

274  ::
fe_ut
::
P©hExi¡s
(
C»©eFeP©h
(
âame
));

277 
vœtu®
 
Stus
 
G‘Chd»n
(cÚ¡ 
¡d
::
¡ršg
& 
dœ
,

278 
¡d
::
veùÜ
<¡d::
¡ršg
>* 
»suÉ
) {

279 
»suÉ
->
ş—r
();

280 ::
fe_ut
::
FeEnum”©Ü
 
™”
(

281 
C»©eFeP©h
(
dœ
), 
çl£
, ::
fe_ut
::
FeEnum”©Ü
::
FILES
);

282 ::
FeP©h
 
cu¼’t
 = 
™”
.
Next
();

283 !
	gcu¼’t
.
em±y
()) {

284 
	g»suÉ
->
push_back
(
FeP©hToSŒšg
(
cu¼’t
.
Ba£Name
()));

285 
	gcu¼’t
 = 
™”
.
Next
();

290  
	gStus
::
OK
();

293 
vœtu®
 
Stus
 
D–‘eFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
) {

294 
Stus
 
»suÉ
;

296 ià(!::
fe_ut
::
D–‘e
(
C»©eFeP©h
(
âame
), 
çl£
)) {

297 
	g»suÉ
 = 
Stus
::
IOE¼Ü
(
âame
, "Could‚ot delete file.");

299  
	g»suÉ
;

302 
vœtu®
 
Stus
 
C»©eDœ
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
) {

303 
Stus
 
»suÉ
;

304 ià(!::
fe_ut
::
C»©eDœeùÜy
(
C»©eFeP©h
(
Çme
))) {

305 
»suÉ
 = 
Stus
::
IOE¼Ü
(
Çme
, "Could‚ot create directory.");

307  
	g»suÉ
;

310 
vœtu®
 
Stus
 
D–‘eDœ
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
) {

311 
Stus
 
»suÉ
;

313 ià(!::
fe_ut
::
D–‘e
(
C»©eFeP©h
(
Çme
), 
çl£
)) {

314 
	g»suÉ
 = 
Stus
::
IOE¼Ü
(
Çme
, "Could‚ot delete directory.");

316  
	g»suÉ
;

319 
vœtu®
 
Stus
 
G‘FeSize
(cÚ¡ 
¡d
::
¡ršg
& 
âame
, 
ušt64_t
* 
size
) {

320 
Stus
 
	gs
;

321 
št64_t
 
	gsigÃd_size
;

322 ià(!::
fe_ut
::
G‘FeSize
(
C»©eFeP©h
(
âame
), &
sigÃd_size
)) {

323 *
	gsize
 = 0;

324 
	gs
 = 
Stus
::
IOE¼Ü
(
âame
, "Could‚ot determine file size.");

326 *
	gsize
 = 
¡©ic_ÿ¡
<
ušt64_t
>(
sigÃd_size
);

328  
	gs
;

331 
vœtu®
 
Stus
 
R’ameFe
(cÚ¡ 
¡d
::
¡ršg
& 
¤c
, cÚ¡ std::¡ršg& 
d¡
) {

332 
Stus
 
»suÉ
;

333 ià(!::
fe_ut
::
R•ÏûFe
(
C»©eFeP©h
(
¤c
), C»©eFeP©h(
d¡
))) {

334 
	g»suÉ
 = 
Stus
::
IOE¼Ü
(
¤c
, "Could‚ot„ename file.");

336  
	g»suÉ
;

339 
vœtu®
 
Stus
 
LockFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
, 
FeLock
** 
lock
) {

340 *
	glock
 = 
NULL
;

341 
Stus
 
	g»suÉ
;

342 
	gæags
 = ::
ba£
::
PLATFORM_FILE_OPEN_ALWAYS
 |

343 ::
ba£
::
PLATFORM_FILE_READ
 |

344 ::
ba£
::
PLATFORM_FILE_WRITE
 |

345 ::
ba£
::
PLATFORM_FILE_EXCLUSIVE_READ
 |

346 ::
ba£
::
PLATFORM_FILE_EXCLUSIVE_WRITE
;

347 
boŞ
 
	gü—‹d
;

348 ::
ba£
::
PÏtfÜmFeE¼Ü
 
”rÜ_code
;

349 ::
ba£
::
PÏtfÜmFe
 
fe
 = ::ba£::
C»©ePÏtfÜmFe
(

350 
C»©eFeP©h
(
âame
), 
æags
, &
ü—‹d
, &
”rÜ_code
);

351 ià(
	g”rÜ_code
 !ğ::
ba£
::
PLATFORM_FILE_OK
) {

352 
»suÉ
 = 
Stus
::
IOE¼Ü
(
âame
, 
PÏtfÜmFeE¼ÜSŒšg
(
”rÜ_code
));

354 
ChromiumFeLock
* 
	gmy_lock
 = 
Ãw
 ChromiumFileLock;

355 
	gmy_lock
->
	gfe_
 = 
fe
;

356 *
	glock
 = 
my_lock
;

358  
	g»suÉ
;

361 
vœtu®
 
Stus
 
UÆockFe
(
FeLock
* 
lock
) {

362 
ChromiumFeLock
* 
	gmy_lock
 = 
»š‹½»t_ÿ¡
<ChromiumFeLock*>(
lock
);

363 
Stus
 
	g»suÉ
;

364 ià(!::
ba£
::
Clo£PÏtfÜmFe
(
my_lock
->
fe_
)) {

365 
»suÉ
 = 
Stus
::
IOE¼Ü
("Could‚ot close†ock file.");

367 
d–‘e
 
	gmy_lock
;

368  
	g»suÉ
;

371 
vœtu®
 
ScheduË
((*
funùiÚ
)(*), * 
¬g
);

373 
vœtu®
 
S¹Th»ad
((*
funùiÚ
)(* 
¬g
), *‡rg);

375 
vœtu®
 
	g¡d
::
¡ršg
 
U£rId’tif›r
() {

376 #ià
defšed
(
OS_WIN
)

377 
¡d
::
w¡ršg
 
u£r_sid
;

378 
boŞ
 
	g»t
 = ::
ba£
::
wš
::
G‘U£rSidSŒšg
(&
u£r_sid
);

379 
DCHECK
(
»t
);

380  
UTF16ToUTF8
(
u£r_sid
);

382 
	gbuf
[100];

383 
¢´štf
(
buf
, (buf), "%d", (
g‘euid
()));

384  
	gbuf
;

388 
vœtu®
 
Stus
 
G‘Te¡DœeùÜy
(
¡d
::
¡ršg
* 
·th
) {

389 
mu_
.
Acquœe
();

390 ià(
	g‹¡_dœeùÜy_
.
em±y
()) {

391 ià(!::
fe_ut
::
C»©eNewTempDœeùÜy
(
kLev–DBTe¡DœeùÜyP»fix
,

392 &
‹¡_dœeùÜy_
)) {

393 
	gmu_
.
R–—£
();

394  
	gStus
::
IOE¼Ü
("Could‚ot createemp directory.");

397 *
	g·th
 = 
FeP©hToSŒšg
(
‹¡_dœeùÜy_
);

398 
	gmu_
.
R–—£
();

399  
	gStus
::
OK
();

402 
vœtu®
 
Logv
(
Wr™abËFe
* 
šfo_log
, cÚ¡ * 
fÜm©
, 
va_li¡
 
­
) {

405 
ušt64_t
 
	gth»ad_id
 = 0;

407 #ià
defšed
(
OS_WIN
)

408 
	gth»ad_id
 = 
G‘Cu¼’tTh»adId
();

409 #–ià
defšed
(
OS_MACOSX
)

410 
	gth»ad_id
 = 
mach_th»ad_£lf
();

411 #–ià
defšed
(
OS_LINUX
)

412 
	gth»ad_id
 = 
sysÿÎ
(
__NR_g‘tid
);

413 #–ià
defšed
(
OS_FREEBSD
è|| defšed(
OS_NACL
)

415 
±h»ad_t
 
	gtid
 = 
±h»ad_£lf
();

416 
memıy
(&
th»ad_id
, &
tid
, 
mš
((
r
), (tid)));

421 
	gbufãr
[500];

422 
	g™”
 = 0; iter < 2; iter++) {

423 * 
	gba£
;

424 
	gbufsize
;

425 ià(
	g™”
 == 0) {

426 
bufsize
 = (
bufãr
);

427 
	gba£
 = 
bufãr
;

429 
	gbufsize
 = 30000;

430 
	gba£
 = 
Ãw
 [
bufsize
];

432 * 
	gp
 = 
ba£
;

433 * 
	glim™
 = 
ba£
 + 
bufsize
;

435 ::
ba£
::
Time
::
Ex¶oded
 
t
;

436 ::
ba£
::
Time
::
Now
().
LoÿlEx¶ode
(&
t
);

437 
	gp
 +ğ
¢´štf
(
p
, 
lim™
 -…,

439 
t
.
y—r
,

440 
t
.
mÚth
,

441 
t
.
day_of_mÚth
,

442 
t
.
hour
,

443 
t
.
mšu‹
,

444 
t
.
£cÚd
,

445 
¡©ic_ÿ¡
<>(
t
.
mli£cÚd
) * 1000,

446 
¡©ic_ÿ¡
<>(
th»ad_id
));

449 ià(
	gp
 < 
	glim™
) {

450 
va_li¡
 
	gbackup_­
;

451 
va_cİy
(
backup_­
, 
­
);

452 
	gp
 +ğ
v¢´štf
(
p
, 
lim™
 -…, 
fÜm©
, 
backup_­
);

453 
va_’d
(
backup_­
);

457 ià(
	gp
 >ğ
lim™
) {

458 ià(
™”
 == 0) {

461 
	gp
 = 
lim™
 - 1;

466 ià(
	gp
 =ğ
ba£
 || 
p
[-1] != '\n') {

467 *
p
++ = '\n';

470 
as£¹
(
p
 <ğ
lim™
);

471 
	gšfo_log
->
Aµ’d
(
Sliû
(
ba£
, 
p
 - base));

472 
	gšfo_log
->
Flush
();

473 ià(
	gba£
 !ğ
bufãr
) {

474 
d–‘e
[] 
ba£
;

480 
vœtu®
 
Aµ’dLoÿlTimeToBufãr
(* 
bufãr
, 
size_t
 
size
) {

481 ::
ba£
::
Time
::
Ex¶oded
 
t
;

482 ::
ba£
::
Time
::
Now
().
LoÿlEx¶ode
(&
t
);

483  
¢´štf
(
bufãr
, 
size
,

485 
t
.
y—r
,

486 
t
.
mÚth
,

487 
t
.
day_of_mÚth
,

488 
t
.
hour
,

489 
t
.
mšu‹
,

490 
t
.
£cÚd
,

491 
¡©ic_ÿ¡
<>(
t
.
mli£cÚd
) * 1000);

494 
vœtu®
 
ušt64_t
 
NowMiüos
() {

495  ::
ba£
::
TimeTicks
::
HighResNow
().
ToIÁ”ÇlV®ue
();

498 
vœtu®
 
SË•FÜMiüo£cÚds
(
miüos
) {

500 ::
ba£
::
PÏtfÜmTh»ad
::
SË•
((
miüos
 + 999) / 1000);

503 
	g´iv©e
:

505 
BGTh»ad
();

506 
BGTh»adW¿µ”
(* 
¬g
) {

507 
	g»š‹½»t_ÿ¡
<
	gChromiumEnv
*>(
	g¬g
)->
BGTh»ad
();

510 
FeP©h
 
	g‹¡_dœeùÜy_
;

512 
size_t
 
	g·ge_size_
;

513 ::
ba£
::
Lock
 
mu_
;

514 ::
ba£
::
CÚd™iÚV¬ŸbË
 
bgsigÇl_
;

515 
boŞ
 
	g¡¬‹d_bgth»ad_
;

518 
	sBGI‹m
 { * 
	g¬g
; (*
	gfunùiÚ
)(*); };

519 
	g¡d
::
	tdeque
<
	tBGI‹m
> 
	tBGQueue
;

520 
BGQueue
 
	gqueue_
;

523 
	gChromiumEnv
::
ChromiumEnv
()

524 : 
·ge_size_
(::
ba£
::
SysInfo
::
VMAÎoÿtiÚG¿nuÏr™y
()),

525 
bgsigÇl_
(&
mu_
),

526 
¡¬‹d_bgth»ad_
(
çl£
) {

527 #ià
defšed
(
OS_MACOSX
)

528 ::
ba£
::
EÇbËT”mš©iÚOnH—pCÜru±iÚ
();

529 ::
ba£
::
EÇbËT”mš©iÚOnOutOfMemÜy
();

533 şas 
	cTh»ad
 : 
public
 ::
ba£
::
PÏtfÜmTh»ad
::
D–eg©e
 {

534 
public
:

535 
Th»ad
((*
funùiÚ
)(* 
¬g
), *‡rg)

536 : 
funùiÚ_
(
funùiÚ
), 
¬g_
(
¬g
) {

537 ::
ba£
::
PÏtfÜmTh»adHªdË
 
hªdË
;

538 
boŞ
 
	gsucûss
 = ::
ba£
::
PÏtfÜmTh»ad
::
C»©e
(0, 
this
, &
hªdË
);

539 
DCHECK
(
sucûss
);

541 
	gvœtu®
 ~
Th»ad
() {}

542 
vœtu®
 
Th»adMaš
() {

543 (*
	gfunùiÚ_
)(
	g¬g_
);

544 
d–‘e
 
	gthis
;

547 
	g´iv©e
:

548 (*
funùiÚ_
)(* 
¬g
);

549 * 
	g¬g_
;

552 
	gChromiumEnv
::
ScheduË
((*
funùiÚ
)(*), * 
¬g
) {

553 
	gmu_
.
Acquœe
();

556 ià(!
	g¡¬‹d_bgth»ad_
) {

557 
	g¡¬‹d_bgth»ad_
 = 
Œue
;

558 
S¹Th»ad
(&
ChromiumEnv
::
BGTh»adW¿µ”
, 
this
);

563 ià(
	gqueue_
.
em±y
()) {

564 
	gbgsigÇl_
.
SigÇl
();

568 
	gqueue_
.
push_back
(
BGI‹m
());

569 
	gqueue_
.
back
().
	gfunùiÚ
 = 
funùiÚ
;

570 
	gqueue_
.
back
().
	g¬g
 = 
¬g
;

572 
	gmu_
.
R–—£
();

575 
	gChromiumEnv
::
BGTh»ad
() {

576 
Œue
) {

578 
mu_
.
Acquœe
();

579 
	gqueue_
.
em±y
()) {

580 
	gbgsigÇl_
.
Wa™
();

583 (*
	gfunùiÚ
)(*èğ
queue_
.
äÚt
().
funùiÚ
;

584 * 
	g¬g
 = 
queue_
.
äÚt
().
¬g
;

585 
	gqueue_
.
pİ_äÚt
();

587 
	gmu_
.
R–—£
();

588 (*
	gfunùiÚ
)(
	g¬g
);

592 
	gChromiumEnv
::
S¹Th»ad
((*
funùiÚ
)(* 
¬g
), *‡rg) {

593 
Ãw
 
Th»ad
(
funùiÚ
, 
¬g
);

596 ::
ba£
::
LazyIn¡ªû
<
ChromiumEnv
, ::ba£::
L—kyLazyIn¡ªûT¿™s
<ChromiumEnv> >

597 
deçuÉ_’v
(::
ba£
::
LINKER_INITIALIZED
);

601 
Env
* 
	gEnv
::
	$DeçuÉ
() {

602  
deçuÉ_’v
.
	`Poš‹r
();

603 
	}
}

	@util/env_posix.cc

5 
	~<deque
>

6 
	~<dœ’t.h
>

7 
	~<”ºo.h
>

8 
	~<fú.h
>

9 
	~<±h»ad.h
>

10 
	~<¡dio.h
>

11 
	~<¡dlib.h
>

12 
	~<¡ršg.h
>

13 
	~<sys/mmª.h
>

14 
	~<sys/¡©.h
>

15 
	~<sys/time.h
>

16 
	~<sys/ty³s.h
>

17 
	~<time.h
>

18 
	~<uni¡d.h
>

19 #ià
defšed
(
LEVELDB_PLATFORM_ANDROID
)

20 
	~<sys/¡©.h
>

22 
	~"Ëv–db/’v.h
"

23 
	~"Ëv–db/¦iû.h
"

24 
	~"pÜt/pÜt.h
"

25 
	~"ut/loggšg.h
"

27 
Çme¥aû
 
	gËv–db
 {

29 
	gÇme¥aû
 {

31 şas 
	cPosixSequ’tŸlFe
: 
public
 
Sequ’tŸlFe
 {

32 
´iv©e
:

33 
¡d
::
¡ršg
 
f’ame_
;

34 
FILE
* 
	gfe_
;

36 
	gpublic
:

37 
PosixSequ’tŸlFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
, 
FILE
* 
f
)

38 : 
f’ame_
(
âame
), 
fe_
(
f
) { }

39 
	gvœtu®
 ~
PosixSequ’tŸlFe
(è{ 
fşo£
(
fe_
); }

41 
vœtu®
 
Stus
 
R—d
(
size_t
 
n
, 
Sliû
* 
»suÉ
, * 
sü©ch
) {

42 
Stus
 
	gs
;

43 
size_t
 
	gr
 = 
ä—d_uÆocked
(
sü©ch
, 1, 
n
, 
fe_
);

44 *
	g»suÉ
 = 
Sliû
(
sü©ch
, 
r
);

45 ià(
	gr
 < 
	gn
) {

46 ià(
ãof
(
fe_
)) {

50 
	gs
 = 
Stus
::
IOE¼Ü
(
f’ame_
, 
¡»¼Ü
(
”ºo
));

53  
	gs
;

57 şas 
	cPosixRªdomAcûssFe
: 
public
 
RªdomAcûssFe
 {

58 
´iv©e
:

59 
¡d
::
¡ršg
 
f’ame_
;

60 
	gfd_
;

62 
	gpublic
:

63 
PosixRªdomAcûssFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
, 
fd
)

64 : 
f’ame_
(
âame
), 
fd_
(
fd
) { }

65 
	gvœtu®
 ~
PosixRªdomAcûssFe
(è{ 
şo£
(
fd_
); }

67 
vœtu®
 
Stus
 
R—d
(
ušt64_t
 
off£t
, 
size_t
 
n
, 
Sliû
* 
»suÉ
,

68 * 
sü©ch
) const {

69 
Stus
 
	gs
;

70 
ssize_t
 
	gr
 = 
´—d
(
fd_
, 
sü©ch
, 
n
, 
¡©ic_ÿ¡
<
off_t
>(
off£t
));

71 *
	g»suÉ
 = 
Sliû
(
sü©ch
, (
r
 < 0) ? 0 :„);

72 ià(
	gr
 < 0) {

74 
	gs
 = 
Stus
::
IOE¼Ü
(
f’ame_
, 
¡»¼Ü
(
”ºo
));

76  
	gs
;

84 şas 
	cPosixMm­Fe
 : 
public
 
Wr™abËFe
 {

85 
´iv©e
:

86 
¡d
::
¡ršg
 
f’ame_
;

87 
	gfd_
;

88 
size_t
 
	g·ge_size_
;

89 
size_t
 
	gm­_size_
;

90 * 
	gba£_
;

91 * 
	glim™_
;

92 * 
	gd¡_
;

93 * 
	gÏ¡_sync_
;

94 
ušt64_t
 
	gfe_off£t_
;

97 
boŞ
 
	g³ndšg_sync_
;

100 
size_t
 
Roundup
(size_ˆ
x
, size_ˆ
y
) {

101  ((
	gx
 + 
	gy
 - 1) / y) * y;

104 
size_t
 
Trunÿ‹ToPageBound¬y
(size_ˆ
s
) {

105 
	gs
 -ğ(
s
 & (
·ge_size_
 - 1));

106 
as£¹
((
s
 % 
·ge_size_
) == 0);

107  
	gs
;

110 
Unm­Cu¼’tRegiÚ
() {

111 ià(
	gba£_
 !ğ
NULL
) {

112 ià(
Ï¡_sync_
 < 
lim™_
) {

114 
³ndšg_sync_
 = 
Œue
;

116 
munm­
(
ba£_
, 
lim™_
 - base_);

117 
	gfe_off£t_
 +ğ
lim™_
 - 
ba£_
;

118 
	gba£_
 = 
NULL
;

119 
	glim™_
 = 
NULL
;

120 
	gÏ¡_sync_
 = 
NULL
;

121 
	gd¡_
 = 
NULL
;

124 ià(
	gm­_size_
 < (1<<20)) {

125 
	gm­_size_
 *= 2;

130 
boŞ
 
M­NewRegiÚ
() {

131 
as£¹
(
ba£_
 =ğ
NULL
);

132 ià(
árunÿ‹
(
fd_
, 
fe_off£t_
 + 
m­_size_
) < 0) {

133  
	gçl£
;

135 * 
	g±r
 = 
mm­
(
NULL
, 
m­_size_
, 
PROT_READ
 | 
PROT_WRITE
, 
MAP_SHARED
,

136 
fd_
, 
fe_off£t_
);

137 ià(
	g±r
 =ğ
MAP_FAILED
) {

138  
çl£
;

140 
	gba£_
 = 
»š‹½»t_ÿ¡
<*>(
±r
);

141 
	glim™_
 = 
ba£_
 + 
m­_size_
;

142 
	gd¡_
 = 
ba£_
;

143 
	gÏ¡_sync_
 = 
ba£_
;

144  
	gŒue
;

147 
	gpublic
:

148 
PosixMm­Fe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
, 
fd
, 
size_t
 
·ge_size
)

149 : 
f’ame_
(
âame
),

150 
fd_
(
fd
),

151 
·ge_size_
(
·ge_size
),

152 
m­_size_
(
Roundup
(65536, 
·ge_size
)),

153 
ba£_
(
NULL
),

154 
lim™_
(
NULL
),

155 
d¡_
(
NULL
),

156 
Ï¡_sync_
(
NULL
),

157 
fe_off£t_
(0),

158 
³ndšg_sync_
(
çl£
) {

159 
as£¹
((
·ge_size
 & (page_size - 1)) == 0);

163 ~
PosixMm­Fe
() {

164 ià(
	gfd_
 >= 0) {

165 
PosixMm­Fe
::
Clo£
();

169 
vœtu®
 
Stus
 
Aµ’d
(cÚ¡ 
Sliû
& 
d©a
) {

170 cÚ¡ * 
	g¤c
 = 
d©a
.data();

171 
size_t
 
	gËá
 = 
d©a
.
size
();

172 
	gËá
 > 0) {

173 
as£¹
(
ba£_
 <ğ
d¡_
);

174 
as£¹
(
d¡_
 <ğ
lim™_
);

175 
size_t
 
	gava
 = 
lim™_
 - 
d¡_
;

176 ià(
	gava
 == 0) {

177 
Unm­Cu¼’tRegiÚ
();

178 
M­NewRegiÚ
();

181 
size_t
 
	gn
 = (
Ëá
 <ğ
ava
) ?†eft :‡vail;

182 
memıy
(
d¡_
, 
¤c
, 
n
);

183 
	gd¡_
 +ğ
n
;

184 
	g¤c
 +ğ
n
;

185 
	gËá
 -ğ
n
;

187  
	gStus
::
OK
();

190 
vœtu®
 
Stus
 
Clo£
() {

191 
Stus
 
	gs
;

192 
size_t
 
	gunu£d
 = 
lim™_
 - 
d¡_
;

193 
Unm­Cu¼’tRegiÚ
();

194 ià(
	gunu£d
 > 0) {

196 ià(
árunÿ‹
(
fd_
, 
fe_off£t_
 - 
unu£d
) < 0) {

197 
	gs
 = 
Stus
::
IOE¼Ü
(
f’ame_
, 
¡»¼Ü
(
”ºo
));

201 ià(
şo£
(
fd_
) < 0) {

202 ià(
	gs
.
ok
()) {

203 
	gs
 = 
Stus
::
IOE¼Ü
(
f’ame_
, 
¡»¼Ü
(
”ºo
));

207 
	gfd_
 = -1;

208 
	gba£_
 = 
NULL
;

209 
	glim™_
 = 
NULL
;

210  
	gs
;

213 
vœtu®
 
Stus
 
Flush
() {

214  
	gStus
::
OK
();

217 
vœtu®
 
Stus
 
Sync
() {

218 
Stus
 
	gs
;

220 ià(
	g³ndšg_sync_
) {

222 
	g³ndšg_sync_
 = 
çl£
;

223 ià(
fd©async
(
fd_
) < 0) {

224 
	gs
 = 
Stus
::
IOE¼Ü
(
f’ame_
, 
¡»¼Ü
(
”ºo
));

228 ià(
	gd¡_
 > 
	gÏ¡_sync_
) {

231 
size_t
 
	gp1
 = 
Trunÿ‹ToPageBound¬y
(
Ï¡_sync_
 - 
ba£_
);

232 
size_t
 
	gp2
 = 
Trunÿ‹ToPageBound¬y
(
d¡_
 - 
ba£_
 - 1);

233 
	gÏ¡_sync_
 = 
d¡_
;

234 ià(
msync
(
ba£_
 + 
p1
, 
p2
 -…1 + 
·ge_size_
, 
MS_SYNC
) < 0) {

235 
	gs
 = 
Stus
::
IOE¼Ü
(
f’ame_
, 
¡»¼Ü
(
”ºo
));

239  
	gs
;

243 
LockOrUÆock
(
fd
, 
boŞ
 
lock
) {

244 
	g”ºo
 = 0;

245 
æock
 
	gf
;

246 
mem£t
(&
f
, 0, (f));

247 
	gf
.
	gl_ty³
 = (
lock
 ? 
F_WRLCK
 : 
F_UNLCK
);

248 
	gf
.
	gl_wh’û
 = 
SEEK_SET
;

249 
	gf
.
	gl_¡¬t
 = 0;

250 
	gf
.
	gl_Ën
 = 0;

251  
fú
(
fd
, 
F_SETLK
, &
f
);

254 şas 
	cPosixFeLock
 : 
public
 
FeLock
 {

255 
public
:

256 
fd_
;

259 şas 
	cPosixEnv
 : 
public
 
Env
 {

260 
public
:

261 
PosixEnv
();

262 
	gvœtu®
 ~
PosixEnv
() {

263 
årštf
(
¡d”r
, "Destroying Env::Default()\n");

264 
ex™
(1);

267 
vœtu®
 
Stus
 
NewSequ’tŸlFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
,

268 
Sequ’tŸlFe
** 
»suÉ
) {

269 
FILE
* 
	gf
 = 
fİ’
(
âame
.
c_¡r
(), "r");

270 ià(
	gf
 =ğ
NULL
) {

271 *
»suÉ
 = 
NULL
;

272  
	gStus
::
IOE¼Ü
(
âame
, 
¡»¼Ü
(
”ºo
));

274 *
	g»suÉ
 = 
Ãw
 
PosixSequ’tŸlFe
(
âame
, 
f
);

275  
	gStus
::
OK
();

279 
vœtu®
 
Stus
 
NewRªdomAcûssFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
,

280 
RªdomAcûssFe
** 
»suÉ
) {

281 
	gfd
 = 
İ’
(
âame
.
c_¡r
(), 
O_RDONLY
);

282 ià(
	gfd
 < 0) {

283 *
	g»suÉ
 = 
NULL
;

284  
	gStus
::
IOE¼Ü
(
âame
, 
¡»¼Ü
(
”ºo
));

286 *
	g»suÉ
 = 
Ãw
 
PosixRªdomAcûssFe
(
âame
, 
fd
);

287  
	gStus
::
OK
();

290 
vœtu®
 
Stus
 
NewWr™abËFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
,

291 
Wr™abËFe
** 
»suÉ
) {

292 
Stus
 
	gs
;

293 cÚ¡ 
	gfd
 = 
İ’
(
âame
.
c_¡r
(), 
O_CREAT
 | 
O_RDWR
 | 
O_TRUNC
, 0644);

294 ià(
	gfd
 < 0) {

295 *
	g»suÉ
 = 
NULL
;

296 
	gs
 = 
Stus
::
IOE¼Ü
(
âame
, 
¡»¼Ü
(
”ºo
));

298 *
	g»suÉ
 = 
Ãw
 
PosixMm­Fe
(
âame
, 
fd
, 
·ge_size_
);

300  
	gs
;

303 
vœtu®
 
boŞ
 
FeExi¡s
(cÚ¡ 
¡d
::
¡ršg
& 
âame
) {

304  
acûss
(
âame
.
c_¡r
(), 
F_OK
) == 0;

307 
vœtu®
 
Stus
 
G‘Chd»n
(cÚ¡ 
¡d
::
¡ršg
& 
dœ
,

308 
¡d
::
veùÜ
<¡d::
¡ršg
>* 
»suÉ
) {

309 
»suÉ
->
ş—r
();

310 
DIR
* 
	gd
 = 
İ’dœ
(
dœ
.
c_¡r
());

311 ià(
	gd
 =ğ
NULL
) {

312  
Stus
::
IOE¼Ü
(
dœ
, 
¡»¼Ü
(
”ºo
));

314 
dœ’t
* 
	g’Œy
;

315 (
	g’Œy
 = 
»addœ
(
d
)è!ğ
NULL
) {

316 
»suÉ
->
push_back
(
’Œy
->
d_Çme
);

318 
şo£dœ
(
d
);

319  
	gStus
::
OK
();

322 
vœtu®
 
Stus
 
D–‘eFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
) {

323 
Stus
 
»suÉ
;

324 ià(
uÆšk
(
âame
.
c_¡r
()) != 0) {

325 
»suÉ
 = 
Stus
::
IOE¼Ü
(
âame
, 
¡»¼Ü
(
”ºo
));

327  
	g»suÉ
;

330 
vœtu®
 
Stus
 
C»©eDœ
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
) {

331 
Stus
 
»suÉ
;

332 ià(
mkdœ
(
Çme
.
c_¡r
(), 0755) != 0) {

333 
»suÉ
 = 
Stus
::
IOE¼Ü
(
Çme
, 
¡»¼Ü
(
”ºo
));

335  
	g»suÉ
;

338 
vœtu®
 
Stus
 
D–‘eDœ
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
) {

339 
Stus
 
»suÉ
;

340 ià(
rmdœ
(
Çme
.
c_¡r
()) != 0) {

341 
»suÉ
 = 
Stus
::
IOE¼Ü
(
Çme
, 
¡»¼Ü
(
”ºo
));

343  
	g»suÉ
;

346 
vœtu®
 
Stus
 
G‘FeSize
(cÚ¡ 
¡d
::
¡ršg
& 
âame
, 
ušt64_t
* 
size
) {

347 
Stus
 
	gs
;

348 
¡©
 
	gsbuf
;

349 ià(
¡©
(
âame
.
c_¡r
(), &
sbuf
) != 0) {

350 *
size
 = 0;

351 
	gs
 = 
Stus
::
IOE¼Ü
(
âame
, 
¡»¼Ü
(
”ºo
));

353 *
	gsize
 = 
sbuf
.
¡_size
;

355  
	gs
;

358 
vœtu®
 
Stus
 
R’ameFe
(cÚ¡ 
¡d
::
¡ršg
& 
¤c
, cÚ¡ std::¡ršg& 
rg‘
) {

359 
Stus
 
»suÉ
;

360 ià(
»Çme
(
¤c
.
c_¡r
(), 
rg‘
.c_str()) != 0) {

361 
»suÉ
 = 
Stus
::
IOE¼Ü
(
¤c
, 
¡»¼Ü
(
”ºo
));

363  
	g»suÉ
;

366 
vœtu®
 
Stus
 
LockFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
, 
FeLock
** 
lock
) {

367 *
	glock
 = 
NULL
;

368 
Stus
 
	g»suÉ
;

369 
	gfd
 = 
İ’
(
âame
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
, 0644);

370 ià(
	gfd
 < 0) {

371 
	g»suÉ
 = 
Stus
::
IOE¼Ü
(
âame
, 
¡»¼Ü
(
”ºo
));

372 } ià(
LockOrUÆock
(
fd
, 
Œue
) == -1) {

373 
»suÉ
 = 
Stus
::
IOE¼Ü
("lock " + 
âame
, 
¡»¼Ü
(
”ºo
));

374 
şo£
(
fd
);

376 
PosixFeLock
* 
	gmy_lock
 = 
Ãw
 PosixFileLock;

377 
	gmy_lock
->
	gfd_
 = 
fd
;

378 *
	glock
 = 
my_lock
;

380  
	g»suÉ
;

383 
vœtu®
 
Stus
 
UÆockFe
(
FeLock
* 
lock
) {

384 
PosixFeLock
* 
	gmy_lock
 = 
»š‹½»t_ÿ¡
<PosixFeLock*>(
lock
);

385 
Stus
 
	g»suÉ
;

386 ià(
LockOrUÆock
(
my_lock
->
fd_
, 
çl£
) == -1) {

387 
»suÉ
 = 
Stus
::
IOE¼Ü
(
¡»¼Ü
(
”ºo
));

389 
şo£
(
my_lock
->
fd_
);

390 
d–‘e
 
	gmy_lock
;

391  
	g»suÉ
;

394 
vœtu®
 
ScheduË
((*
funùiÚ
)(*), * 
¬g
);

396 
vœtu®
 
S¹Th»ad
((*
funùiÚ
)(* 
¬g
), *‡rg);

398 
vœtu®
 
Stus
 
G‘Te¡DœeùÜy
(
¡d
::
¡ršg
* 
»suÉ
) {

399 cÚ¡ * 
’v
 = 
g‘’v
("TEST_TMPDIR");

400 ià(
	g’v
 &&ƒnv[0] != '\0') {

401 *
»suÉ
 = 
’v
;

403 
	gbuf
[100];

404 
¢´štf
(
buf
, (buf), "/tmp/Ëv–db‹¡-%d", (
g‘euid
()));

405 *
	g»suÉ
 = 
buf
;

408 
C»©eDœ
(*
»suÉ
);

409  
	gStus
::
OK
();

412 
vœtu®
 
Logv
(
Wr™abËFe
* 
šfo_log
, cÚ¡ * 
fÜm©
, 
va_li¡
 
­
) {

413 
±h»ad_t
 
	gtid
 = 
±h»ad_£lf
();

414 
ušt64_t
 
	gth»ad_id
 = 0;

415 
memıy
(&
th»ad_id
, &
tid
, 
¡d
::
mš
((thread_id), (tid)));

419 
	gbufãr
[500];

420 
	g™”
 = 0; iter < 2; iter++) {

421 * 
	gba£
;

422 
	gbufsize
;

423 ià(
	g™”
 == 0) {

424 
bufsize
 = (
bufãr
);

425 
	gba£
 = 
bufãr
;

427 
	gbufsize
 = 30000;

428 
	gba£
 = 
Ãw
 [
bufsize
];

430 * 
	gp
 = 
ba£
;

431 * 
	glim™
 = 
ba£
 + 
bufsize
;

433 
timev®
 
	gnow_tv
;

434 
g‘timeofday
(&
now_tv
, 
NULL
);

435 cÚ¡ 
time_t
 
	g£cÚds
 = 
now_tv
.
tv_£c
;

436 
tm
 
	gt
;

437 
loÿÉime_r
(&
£cÚds
, &
t
);

438 
	gp
 +ğ
¢´štf
(
p
, 
lim™
 -…,

440 
t
.
tm_y—r
 + 1900,

441 
t
.
tm_mÚ
 + 1,

442 
t
.
tm_mday
,

443 
t
.
tm_hour
,

444 
t
.
tm_mš
,

445 
t
.
tm_£c
,

446 
¡©ic_ÿ¡
<>(
now_tv
.
tv_u£c
),

447 
¡©ic_ÿ¡
<>(
th»ad_id
));

450 ià(
	gp
 < 
	glim™
) {

451 
va_li¡
 
	gbackup_­
;

452 
va_cİy
(
backup_­
, 
­
);

453 
	gp
 +ğ
v¢´štf
(
p
, 
lim™
 -…, 
fÜm©
, 
backup_­
);

454 
va_’d
(
backup_­
);

458 ià(
	gp
 >ğ
lim™
) {

459 ià(
™”
 == 0) {

462 
	gp
 = 
lim™
 - 1;

467 ià(
	gp
 =ğ
ba£
 || 
p
[-1] != '\n') {

468 *
p
++ = '\n';

471 
as£¹
(
p
 <ğ
lim™
);

472 
	gšfo_log
->
Aµ’d
(
Sliû
(
ba£
, 
p
 - base));

473 
	gšfo_log
->
Flush
();

474 ià(
	gba£
 !ğ
bufãr
) {

475 
d–‘e
[] 
ba£
;

481 
vœtu®
 
ušt64_t
 
NowMiüos
() {

482 
timev®
 
	gtv
;

483 
g‘timeofday
(&
tv
, 
NULL
);

484  
	g¡©ic_ÿ¡
<
	gušt64_t
>(
	gtv
.
	gtv_£c
è* 1000000 +v.
	gtv_u£c
;

487 
vœtu®
 
SË•FÜMiüo£cÚds
(
miüos
) {

488 
u¦“p
(
miüos
);

491 
	g´iv©e
:

492 
Pth»adC®l
(cÚ¡ * 
Ïb–
, 
»suÉ
) {

493 ià(
	g»suÉ
 != 0) {

494 
årštf
(
¡d”r
, "±h»ad %s: %s\n", 
Ïb–
, 
¡»¼Ü
(
»suÉ
));

495 
ex™
(1);

500 
BGTh»ad
();

501 * 
BGTh»adW¿µ”
(* 
¬g
) {

502 
	g»š‹½»t_ÿ¡
<
	gPosixEnv
*>(
	g¬g
)->
BGTh»ad
();

503  
	gNULL
;

506 
size_t
 
	g·ge_size_
;

507 
±h»ad_mu‹x_t
 
	gmu_
;

508 
±h»ad_cÚd_t
 
	gbgsigÇl_
;

509 
±h»ad_t
 
	gbgth»ad_
;

510 
boŞ
 
	g¡¬‹d_bgth»ad_
;

513 
	sBGI‹m
 { * 
	g¬g
; (*
	gfunùiÚ
)(*); };

514 
	g¡d
::
	tdeque
<
	tBGI‹m
> 
	tBGQueue
;

515 
BGQueue
 
	gqueue_
;

518 
	gPosixEnv
::
PosixEnv
(è: 
·ge_size_
(
g‘·gesize
()),

519 
¡¬‹d_bgth»ad_
(
çl£
) {

520 
Pth»adC®l
("mu‹x_š™", 
±h»ad_mu‹x_š™
(&
mu_
, 
NULL
));

521 
Pth»adC®l
("cv¬_š™", 
±h»ad_cÚd_š™
(&
bgsigÇl_
, 
NULL
));

524 
	gPosixEnv
::
ScheduË
((*
funùiÚ
)(*), * 
¬g
) {

525 
Pth»adC®l
("lock", 
±h»ad_mu‹x_lock
(&
mu_
));

528 ià(!
	g¡¬‹d_bgth»ad_
) {

529 
	g¡¬‹d_bgth»ad_
 = 
Œue
;

530 
Pth»adC®l
(

532 
±h»ad_ü—‹
(&
bgth»ad_
, 
NULL
, &
PosixEnv
::
BGTh»adW¿µ”
, 
this
));

537 ià(
	gqueue_
.
em±y
()) {

538 
Pth»adC®l
("sigÇl", 
±h»ad_cÚd_sigÇl
(&
bgsigÇl_
));

542 
	gqueue_
.
push_back
(
BGI‹m
());

543 
	gqueue_
.
back
().
	gfunùiÚ
 = 
funùiÚ
;

544 
	gqueue_
.
back
().
	g¬g
 = 
¬g
;

546 
Pth»adC®l
("uÆock", 
±h»ad_mu‹x_uÆock
(&
mu_
));

549 
	gPosixEnv
::
BGTh»ad
() {

550 
Œue
) {

552 
Pth»adC®l
("lock", 
±h»ad_mu‹x_lock
(&
mu_
));

553 
	gqueue_
.
em±y
()) {

554 
Pth»adC®l
("wa™", 
±h»ad_cÚd_wa™
(&
bgsigÇl_
, &
mu_
));

557 (*
	gfunùiÚ
)(*èğ
queue_
.
äÚt
().
funùiÚ
;

558 * 
	g¬g
 = 
queue_
.
äÚt
().
¬g
;

559 
	gqueue_
.
pİ_äÚt
();

561 
Pth»adC®l
("uÆock", 
±h»ad_mu‹x_uÆock
(&
mu_
));

562 (*
	gfunùiÚ
)(
	g¬g
);

566 
	gÇme¥aû
 {

567 
	sS¹Th»adS‹
 {

568 (*
	gu£r_funùiÚ
)(*);

569 * 
	g¬g
;

572 * 
S¹Th»adW¿µ”
(* 
¬g
) {

573 
S¹Th»adS‹
* 
	g¡©e
 = 
»š‹½»t_ÿ¡
<S¹Th»adS‹*>(
¬g
);

574 
	g¡©e
->
u£r_funùiÚ
(
¡©e
->
¬g
);

575 
d–‘e
 
	g¡©e
;

576  
	gNULL
;

579 
	gPosixEnv
::
S¹Th»ad
((*
funùiÚ
)(* 
¬g
), *‡rg) {

580 
±h»ad_t
 
	gt
;

581 
S¹Th»adS‹
* 
	g¡©e
 = 
Ãw
 StartThreadState;

582 
	g¡©e
->
	gu£r_funùiÚ
 = 
funùiÚ
;

583 
	g¡©e
->
	g¬g
 = 
¬g
;

584 
Pth»adC®l
("starthread",

585 
±h»ad_ü—‹
(&
t
, 
NULL
, &
S¹Th»adW¿µ”
, 
¡©e
));

590 
±h»ad_Úû_t
 
	gÚû
 = 
PTHREAD_ONCE_INIT
;

591 
Env
* 
	gdeçuÉ_’v
;

592 
	$In™DeçuÉEnv
(è{ 
deçuÉ_’v
 = 
Ãw
 
PosixEnv
; 
	}
}

594 
Env
* 
	gEnv
::
	$DeçuÉ
() {

595 
	`±h»ad_Úû
(&
Úû
, 
In™DeçuÉEnv
);

596  
deçuÉ_’v
;

597 
	}
}

	@util/env_test.cc

5 
	~"Ëv–db/’v.h
"

7 
	~"pÜt/pÜt.h
"

8 
	~"ut/‹¡h¬Ãss.h
"

10 
Çme¥aû
 
	gËv–db
 {

12 cÚ¡ 
	gkD–ayMiüos
 = 100000;

14 şas 
	cEnvPosixTe¡
 {

15 
	g´iv©e
:

16 
pÜt
::
Mu‹x
 
mu_
;

17 
	g¡d
::
¡ršg
 
ev’ts_
;

19 
	gpublic
:

20 
Env
* 
’v_
;

21 
EnvPosixTe¡
(è: 
’v_
(
Env
::
DeçuÉ
()) { }

24 
	$S‘BoŞ
(* 
±r
) {

25 *(
»š‹½»t_ÿ¡
<
boŞ
*>(
±r
)èğ
Œue
;

26 
	}
}

28 
	$TEST
(
EnvPosixTe¡
, 
RunImmedŸ‹ly
) {

29 
boŞ
 
ÿÎed
 = 
çl£
;

30 
’v_
->
	`ScheduË
(&
S‘BoŞ
, &
ÿÎed
);

31 
Env
::
	`DeçuÉ
()->
	`SË•FÜMiüo£cÚds
(
kD–ayMiüos
);

32 
	`ASSERT_TRUE
(
ÿÎed
);

33 
	}
}

35 
	$TEST
(
EnvPosixTe¡
, 
RunMªy
) {

36 
Ï¡_id
 = 0;

38 
	sCB
 {

39 * 
Ï¡_id_±r
;

40 
id
;

42 
	`CB
(* 
p
, 
i
è: 
	`Ï¡_id_±r
Õ), 
	`id
(i) { }

44 
	`Run
(* 
v
) {

45 
CB
* 
cb
 = 
»š‹½»t_ÿ¡
<CB*>(
v
);

46 
	`ASSERT_EQ
(
cb
->
id
-1, *cb->
Ï¡_id_±r
);

47 *
cb
->
Ï¡_id_±r
 = cb->
id
;

52 
CB
 
	`cb1
(&
Ï¡_id
, 1);

53 
CB
 
	`cb2
(&
Ï¡_id
, 2);

54 
CB
 
	`cb3
(&
Ï¡_id
, 3);

55 
CB
 
	`cb4
(&
Ï¡_id
, 4);

56 
’v_
->
	`ScheduË
(&
CB
::
Run
, &
cb1
);

57 
’v_
->
	`ScheduË
(&
CB
::
Run
, &
cb2
);

58 
’v_
->
	`ScheduË
(&
CB
::
Run
, &
cb3
);

59 
’v_
->
	`ScheduË
(&
CB
::
Run
, &
cb4
);

61 
Env
::
	`DeçuÉ
()->
	`SË•FÜMiüo£cÚds
(
kD–ayMiüos
);

62 
	`ASSERT_EQ
(4, 
Ï¡_id
);

63 
	}
}

65 
	sS‹
 {

66 
	gpÜt
::
Mu‹x
 
mu
;

67 
	gv®
;

68 
	gnum_ruÂšg
;

71 
	$Th»adBody
(* 
¬g
) {

72 
S‹
* 
s
 = 
»š‹½»t_ÿ¡
<S‹*>(
¬g
);

73 
s
->
mu
.
	`Lock
();

74 
s
->
v®
 += 1;

75 
s
->
num_ruÂšg
 -= 1;

76 
s
->
mu
.
	`UÆock
();

77 
	}
}

79 
	$TEST
(
EnvPosixTe¡
, 
S¹Th»ad
) {

80 
S‹
 
¡©e
;

81 
¡©e
.
v®
 = 0;

82 
¡©e
.
num_ruÂšg
 = 3;

83 
i
 = 0; i < 3; i++) {

84 
’v_
->
	`S¹Th»ad
(&
Th»adBody
, &
¡©e
);

86 
Œue
) {

87 
¡©e
.
mu
.
	`Lock
();

88 
num
 = 
¡©e
.
num_ruÂšg
;

89 
¡©e
.
mu
.
	`UÆock
();

90 ià(
num
 == 0) {

93 
Env
::
	`DeçuÉ
()->
	`SË•FÜMiüo£cÚds
(
kD–ayMiüos
);

95 
	`ASSERT_EQ
(
¡©e
.
v®
, 3);

96 
	}
}

100 
	$maš
(
¬gc
, ** 
¬gv
) {

101  
Ëv–db
::
‹¡
::
	`RunAÎTe¡s
();

102 
	}
}

	@util/hash.cc

5 
	~<¡ršg.h
>

6 
	~"ut/codšg.h
"

7 
	~"ut/hash.h
"

9 
Çme¥aû
 
	gËv–db
 {

11 
ušt32_t
 
Hash
(cÚ¡ * 
d©a
, 
size_t
 
n
, ušt32_ˆ
£ed
) {

13 cÚ¡ 
ušt32_t
 
	gm
 = 0xc6a4a793;

14 cÚ¡ 
ušt32_t
 
	gr
 = 24;

15 cÚ¡ * 
	glim™
 = 
d©a
 + 
n
;

16 
ušt32_t
 
	gh
 = 
£ed
 ^ (
n
 * 
m
);

19 
	gd©a
 + 4 <ğ
lim™
) {

20 
ušt32_t
 
w
 = 
DecodeFixed32
(
d©a
);

21 
	gd©a
 += 4;

22 
	gh
 +ğ
w
;

23 
	gh
 *ğ
m
;

24 
	gh
 ^ğ(
h
 >> 16);

28 
	glim™
 - 
	gd©a
) {

30 
h
 +ğ
d©a
[2] << 16;

33 
h
 +ğ
d©a
[1] << 8;

36 
h
 +ğ
d©a
[0];

37 
	gh
 *ğ
m
;

38 
	gh
 ^ğ(
h
 >> 
r
);

41  
	gh
;

	@util/hash.h

7 #iâdeà
STORAGE_LEVELDB_UTIL_HASH_H_


8 
	#STORAGE_LEVELDB_UTIL_HASH_H_


	)

10 
	~<¡ddef.h
>

11 
	~<¡dšt.h
>

13 
Çme¥aû
 
	gËv–db
 {

15 
ušt32_t
 
Hash
(cÚ¡ * 
d©a
, 
size_t
 
n
, ušt32_ˆ
£ed
);

	@util/histogram.cc

5 
	~<m©h.h
>

6 
	~<¡dio.h
>

7 
	~"pÜt/pÜt.h
"

8 
	~"ut/hi¡og¿m.h
"

10 
Çme¥aû
 
	gËv–db
 {

12 cÚ¡ 
	gHi¡og¿m
::
kBuck‘Lim™
[
kNumBuck‘s
] = {

33 
	gHi¡og¿m
::
CË¬
() {

34 
mš_
 = 
kBuck‘Lim™
[
kNumBuck‘s
-1];

35 
	gmax_
 = 0;

36 
	gnum_
 = 0;

37 
	gsum_
 = 0;

38 
	gsum_squ¬es_
 = 0;

39 
	gi
 = 0; i < 
	gkNumBuck‘s
; i++) {

40 
	gbuck‘s_
[
i
] = 0;

44 
	gHi¡og¿m
::
Add
(
v®ue
) {

46 
b
 = 0;

47 
	gb
 < 
	gkNumBuck‘s
 - 1 && 
	gkBuck‘Lim™
[
b
] <ğ
v®ue
) {

48 
b
++;

50 
	gbuck‘s_
[
b
] += 1.0;

51 ià(
	gmš_
 > 
	gv®ue
èmš_ = 
v®ue
;

52 ià(
	gmax_
 < 
	gv®ue
èmax_ = 
v®ue
;

53 
	gnum_
++;

54 
	gsum_
 +ğ
v®ue
;

55 
	gsum_squ¬es_
 +ğ(
v®ue
 * value);

58 
	gHi¡og¿m
::
MedŸn
() const {

59  
P”ûÁe
(50.0);

62 
	gHi¡og¿m
::
P”ûÁe
(
p
) const {

63 
th»shŞd
 = 
num_
 * (
p
 / 100.0);

64 
	gsum
 = 0;

65 
	gb
 = 0; b < 
	gkNumBuck‘s
; b++) {

66 
	gsum
 +ğ
buck‘s_
[
b
];

67 ià(
	gsum
 >ğ
th»shŞd
) {

69 
Ëá_pošt
 = (
b
 =ğ0è? 0 : 
kBuck‘Lim™
[b-1];

70 
	gright_pošt
 = 
kBuck‘Lim™
[
b
];

71 
	gËá_sum
 = 
sum
 - 
buck‘s_
[
b
];

72 
	gright_sum
 = 
sum
;

73 
	gpos
 = (
th»shŞd
 - 
Ëá_sum
è/ (
right_sum
 -†eft_sum);

74 
	gr
 = 
Ëá_pošt
 + (
right_pošt
 -†eá_poštè* 
pos
;

75 ià(
	gr
 < 
	gmš_
è¸ğ
mš_
;

76 ià(
	gr
 > 
	gmax_
è¸ğ
max_
;

77  
	gr
;

80  
	gmax_
;

83 
	gHi¡og¿m
::
Av”age
() const {

84 ià(
num_
 == 0.0)  0;

85  
	gsum_
 / 
	gnum_
;

88 
	gHi¡og¿m
::
Snd¬dDevŸtiÚ
() const {

89 ià(
num_
 == 0.0)  0;

90 
	gv¬Ÿnû
 = (
sum_squ¬es_
 * 
num_
 - 
sum_
 * sum_) / (num_ *‚um_);

91  
sq¹
(
v¬Ÿnû
);

94 
	g¡d
::
¡ršg
 
Hi¡og¿m
::
ToSŒšg
() const {

95 
¡d
::
¡ršg
 
r
;

96 
	gbuf
[200];

97 
¢´štf
(
buf
, (buf),

99 
num_
, 
Av”age
(), 
Snd¬dDevŸtiÚ
());

100 
	gr
.
­³nd
(
buf
);

101 
¢´štf
(
buf
, (buf),

103 (
num_
 =ğ0.0 ? 0.0 : 
mš_
), 
MedŸn
(), 
max_
);

104 
	gr
.
­³nd
(
buf
);

105 
	gr
.
­³nd
("------------------------------------------------------\n");

106 cÚ¡ 
	gmuÉ
 = 100.0 / 
num_
;

107 
	gsum
 = 0;

108 
	gb
 = 0; b < 
	gkNumBuck‘s
; b++) {

109 ià(
	gbuck‘s_
[
b
] <= 0.0) ;

110 
	gsum
 +ğ
buck‘s_
[
b
];

111 
¢´štf
(
buf
, (buf),

113 ((
b
 =ğ0è? 0.0 : 
kBuck‘Lim™
[b-1]),

114 
kBuck‘Lim™
[
b
],

115 
buck‘s_
[
b
],

116 
muÉ
 * 
buck‘s_
[
b
],

117 
muÉ
 * 
sum
);

118 
	gr
.
­³nd
(
buf
);

121 
	gm¬ks
 = 
¡©ic_ÿ¡
<>(20*(
buck‘s_
[
b
] / 
num_
) + 0.5);

122 
	gr
.
­³nd
(
m¬ks
, '#');

123 
	gr
.
push_back
('\n');

125  
	gr
;

	@util/histogram.h

5 #iâdeà
STORAGE_LEVELDB_UTIL_HISTOGRAM_H_


6 
	#STORAGE_LEVELDB_UTIL_HISTOGRAM_H_


	)

8 
	~<¡ršg
>

10 
Çme¥aû
 
	gËv–db
 {

12 şas 
	cHi¡og¿m
 {

13 
	gpublic
:

14 
Hi¡og¿m
() { }

15 ~
Hi¡og¿m
() { }

17 
CË¬
();

18 
Add
(
v®ue
);

20 
	g¡d
::
¡ršg
 
ToSŒšg
() const;

22 
	g´iv©e
:

23 
mš_
;

24 
	gmax_
;

25 
	gnum_
;

26 
	gsum_
;

27 
	gsum_squ¬es_
;

29 ’um { 
	gkNumBuck‘s
 = 154 };

30 cÚ¡ 
	gkBuck‘Lim™
[
kNumBuck‘s
];

31 
	gbuck‘s_
[
kNumBuck‘s
];

33 
MedŸn
() const;

34 
P”ûÁe
(
p
) const;

35 
Av”age
() const;

36 
Snd¬dDevŸtiÚ
() const;

	@util/logging.cc

5 
	~"ut/loggšg.h
"

7 
	~<”ºo.h
>

8 
	~<¡d¬g.h
>

9 
	~<¡dio.h
>

10 
	~<¡dlib.h
>

11 
	~"Ëv–db/’v.h
"

12 
	~"Ëv–db/¦iû.h
"

14 
Çme¥aû
 
	gËv–db
 {

16 
Aµ’dNumb”To
(
¡d
::
¡ršg
* 
¡r
, 
ušt64_t
 
num
) {

17 
	gbuf
[30];

18 
¢´štf
(
buf
, (buf), "%Îu", (è
num
);

19 
	g¡r
->
­³nd
(
buf
);

22 
Aµ’dEsÿ³dSŒšgTo
(
¡d
::
¡ršg
* 
¡r
, cÚ¡ 
Sliû
& 
v®ue
) {

23 
size_t
 
	gi
 = 0; i < 
	gv®ue
.
size
(); i++) {

24 
	gc
 = 
v®ue
[
i
];

25 ià(
	gc
 >ğ' ' && 
c
 <= '~') {

26 
¡r
->
push_back
(
c
);

28 
	gbuf
[10];

29 
¢´štf
(
buf
, (buf), "\\x%02x",

30 
¡©ic_ÿ¡
<>(
c
) & 0xff);

31 
	g¡r
->
­³nd
(
buf
);

36 
	g¡d
::
¡ršg
 
Numb”ToSŒšg
(
ušt64_t
 
num
) {

37 
¡d
::
¡ršg
 
r
;

38 
Aµ’dNumb”To
(&
r
, 
num
);

39  
	gr
;

42 
	g¡d
::
¡ršg
 
Esÿ³SŒšg
(cÚ¡ 
Sliû
& 
v®ue
) {

43 
¡d
::
¡ršg
 
r
;

44 
Aµ’dEsÿ³dSŒšgTo
(&
r
, 
v®ue
);

45  
	gr
;

48 
boŞ
 
CÚsumeCh¬
(
Sliû
* 
š
, 
c
) {

49 ià(!
	gš
->
em±y
(è&& (*š)[0] =ğ
c
) {

50 
š
->
»move_´efix
(1);

51  
	gŒue
;

53  
	gçl£
;

57 
boŞ
 
CÚsumeDecim®Numb”
(
Sliû
* 
š
, 
ušt64_t
* 
v®
) {

58 
ušt64_t
 
	gv
 = 0;

59 
	gdig™s
 = 0;

60 !
	gš
->
em±y
()) {

61 
	gc
 = (*
š
)[0];

62 ià(
	gc
 >ğ'0' && 
c
 <= '9') {

63 ++
dig™s
;

64 cÚ¡ 
	gd–
 = (
c
 - '0');

65 cÚ¡ 
ušt64_t
 
	gkMaxUšt64
 = ~
¡©ic_ÿ¡
<uint64_t>(0);

66 ià(
	gv
 > 
	gkMaxUšt64
/10 ||

67 (
	gv
 =ğ
kMaxUšt64
/10 && 
d–
 > kMaxUint64%10)) {

69  
çl£
;

71 
	gv
 = (
v
 * 10è+ 
d–
;

72 
	gš
->
»move_´efix
(1);

77 *
	gv®
 = 
v
;

78  (
	gdig™s
 > 0);

	@util/logging.h

8 #iâdeà
STORAGE_LEVELDB_UTIL_LOGGING_H_


9 
	#STORAGE_LEVELDB_UTIL_LOGGING_H_


	)

11 
	~<¡dio.h
>

12 
	~<¡dšt.h
>

13 
	~<¡ršg
>

14 
	~"pÜt/pÜt.h
"

16 
Çme¥aû
 
	gËv–db
 {

18 
şass
 
	gSliû
;

19 
şass
 
	gWr™abËFe
;

22 
Aµ’dNumb”To
(
¡d
::
¡ršg
* 
¡r
, 
ušt64_t
 
num
);

26 
Aµ’dEsÿ³dSŒšgTo
(
¡d
::
¡ršg
* 
¡r
, cÚ¡ 
Sliû
& 
v®ue
);

29 
¡d
::
¡ršg
 
Numb”ToSŒšg
(
ušt64_t
 
num
);

33 
¡d
::
¡ršg
 
Esÿ³SŒšg
(cÚ¡ 
Sliû
& 
v®ue
);

37 
boŞ
 
CÚsumeCh¬
(
Sliû
* 
š
, 
c
);

43 
boŞ
 
CÚsumeDecim®Numb”
(
Sliû
* 
š
, 
ušt64_t
* 
v®
);

	@util/mutexlock.h

5 #iâdeà
STORAGE_LEVELDB_UTIL_MUTEXLOCK_H_


6 
	#STORAGE_LEVELDB_UTIL_MUTEXLOCK_H_


	)

8 
	~"pÜt/pÜt.h
"

10 
Çme¥aû
 
	gËv–db
 {

22 şas 
	cMu‹xLock
 {

23 
	gpublic
:

24 
ex¶ic™
 
Mu‹xLock
(
pÜt
::
Mu‹x
 *
mu
è: 
mu_
(mu) {

25 
this
->
mu_
->
Lock
();

27 ~
Mu‹xLock
(è{ 
	gthis
->
	gmu_
->
UÆock
(); }

29 
	g´iv©e
:

30 
pÜt
::
Mu‹x
 *cÚ¡ 
mu_
;

32 
Mu‹xLock
(const MutexLock&);

33 
	gİ”©Ü
=(cÚ¡ 
Mu‹xLock
&);

	@util/options.cc

5 
	~"Ëv–db/İtiÚs.h
"

7 
	~"Ëv–db/com·¿tÜ.h
"

8 
	~"Ëv–db/’v.h
"

10 
Çme¥aû
 
	gËv–db
 {

12 
	gO±iÚs
::
O±iÚs
()

13 : 
com·¿tÜ
(
By‹wi£Com·¿tÜ
()),

14 
ü—‹_if_missšg
(
çl£
),

15 
”rÜ_if_exi¡s
(
çl£
),

16 
·¿noid_checks
(
çl£
),

17 
’v
(
Env
::
DeçuÉ
()),

18 
šfo_log
(
NULL
),

19 
wr™e_bufãr_size
(4<<20),

20 
max_İ’_fes
(1000),

21 
block_ÿche
(
NULL
),

22 
block_size
(4096),

23 
block_»¡¬t_š‹rv®
(16),

24 
com´essiÚ
(
kSÇµyCom´essiÚ
) {

	@util/random.h

5 #iâdeà
STORAGE_LEVELDB_UTIL_RANDOM_H_


6 
	#STORAGE_LEVELDB_UTIL_RANDOM_H_


	)

8 
	~<¡dšt.h
>

10 
Çme¥aû
 
	gËv–db
 {

15 şas 
	cRªdom
 {

16 
	g´iv©e
:

17 
ušt32_t
 
£ed_
;

18 
	gpublic
:

19 
ex¶ic™
 
Rªdom
(
ušt32_t
 
s
è: 
£ed_
(s & 0x7fffffffu) { }

20 
ušt32_t
 
Next
() {

21 cÚ¡ 
ušt32_t
 
M
 = 2147483647L;

22 cÚ¡ 
ušt64_t
 
	gA
 = 16807;

29 
ušt64_t
 
	g´oduù
 = 
£ed_
 * 
A
;

32 
	g£ed_
 = 
¡©ic_ÿ¡
<
ušt32_t
>((
´oduù
 >> 31è+ (´oduù & 
M
));

36 ià(
	g£ed_
 > 
	gM
) {

37 
	g£ed_
 -ğ
M
;

39  
	g£ed_
;

43 
ušt32_t
 
UnifÜm
(
n
è{  
Next
(è% 
	gn
; }

47 
boŞ
 
OÃIn
(
n
è{  (
Next
(è% 
	gn
) == 0; }

52 
ušt32_t
 
Skewed
(
max_log
) {

53  
UnifÜm
(1 << UnifÜm(
max_log
 + 1));

	@util/status.cc

5 
	~<¡dio.h
>

6 
	~"pÜt/pÜt.h
"

7 
	~"Ëv–db/¡©us.h
"

9 
Çme¥aû
 
	gËv–db
 {

11 
	gStus
::
Stus
(
Code
 
code
, cÚ¡ 
Sliû
& 
msg
, cÚ¡ Sliû& 
msg2
) {

12 
as£¹
(
code
 !ğ
kOk
);

13 
	g¡©e_
 = 
Ãw
 
S‹
(
make_·œ
(
code
, 
¡d
::
¡ršg
(
msg
.
d©a
(), msg.
size
())));

14 ià(!
	gmsg2
.
em±y
()) {

15 
	g¡©e_
->
	g£cÚd
.
­³nd
(": ");

16 
	g¡©e_
->
	g£cÚd
.
­³nd
(
msg2
.
d©a
(), msg2.
size
());

20 
	g¡d
::
¡ršg
 
Stus
::
ToSŒšg
() const {

21 ià(
¡©e_
 =ğ
NULL
) {

24 
	gtmp
[30];

25 cÚ¡ * 
	gty³
;

26 
	g¡©e_
->
	gfœ¡
) {

27 
	gkOk
:

28 
ty³
 = "OK";

30 
	gkNÙFound
:

31 
ty³
 = "NotFound";

33 
	gkCÜru±iÚ
:

34 
ty³
 = "Corruption: ";

36 
	gkNÙSuµÜ‹d
:

37 
ty³
 = "Not implemented: ";

39 
	gkInv®idArgum’t
:

40 
ty³
 = "Invalid‡rgument: ";

42 
	gkIOE¼Ü
:

43 
ty³
 = "IOƒrror: ";

46 
¢´štf
(
tmp
, (tmp), "Unknown code(%d): ",

47 
¡©ic_ÿ¡
<>(
¡©e_
->
fœ¡
));

48 
	gty³
 = 
tmp
;

51 
	g¡d
::
¡ršg
 
»suÉ
(
ty³
);

52 ià(!
	g¡©e_
->
	g£cÚd
.
em±y
()) {

53 
	g»suÉ
.
­³nd
(
¡©e_
->
£cÚd
);

55  
	g»suÉ
;

	@util/testharness.cc

5 
	~"ut/‹¡h¬Ãss.h
"

7 
	~<sys/¡©.h
>

8 
	~<sys/ty³s.h
>

10 
Çme¥aû
 
	gËv–db
 {

11 
Çme¥aû
 
	g‹¡
 {

13 
	gÇme¥aû
 {

14 
	sTe¡
 {

15 cÚ¡ * 
	gba£
;

16 cÚ¡ * 
	gÇme
;

17 (*
	gfunc
)();

19 
	g¡d
::
veùÜ
<
Te¡
>* 
‹¡s
;

22 
boŞ
 
Regi¡”Te¡
(cÚ¡ * 
ba£
, cÚ¡ * 
Çme
, (*
func
)()) {

23 ià(
	g‹¡s
 =ğ
NULL
) {

24 
‹¡s
 = 
Ãw
 
¡d
::
veùÜ
<
Te¡
>;

26 
Te¡
 
	gt
;

27 
	gt
.
	gba£
 = 
ba£
;

28 
	gt
.
	gÇme
 = 
Çme
;

29 
	gt
.
	gfunc
 = 
func
;

30 
	g‹¡s
->
push_back
(
t
);

31  
	gŒue
;

34 
RunAÎTe¡s
() {

35 
	gnum
 = 0;

36 ià(
	g‹¡s
 !ğ
NULL
) {

37 
i
 = 0; 
	gi
 < 
	g‹¡s
->
size
(); i++) {

38 cÚ¡ 
	gTe¡
& 
	gt
 = (*
‹¡s
)[
i
];

39 
årštf
(
¡d”r
, "===ğTe¡ %s.%s\n", 
t
.
ba£
,.
Çme
);

40 (*
	gt
.
	gfunc
)();

41 ++
	gnum
;

44 
årštf
(
¡d”r
, "===ğPASSED %de¡s\n", 
num
);

48 
	g¡d
::
¡ršg
 
TmpDœ
() {

49 
¡d
::
¡ršg
 
dœ
;

50 
Stus
 
	gs
 = 
Env
::
DeçuÉ
()->
G‘Te¡DœeùÜy
(&
dœ
);

51 
ASSERT_TRUE
(
s
.
ok
()è<< 
	gs
.
ToSŒšg
();

52  
	gdœ
;

55 
RªdomS“d
() {

56 cÚ¡ * 
	g’v
 = 
g‘’v
("TEST_RANDOM_SEED");

57 
	g»suÉ
 = (
’v
 !ğ
NULL
 ? 
©oi
(env) : 301);

58 ià(
	g»suÉ
 <= 0) {

59 
»suÉ
 = 301;

61  
	g»suÉ
;

	@util/testharness.h

5 #iâdeà
STORAGE_LEVELDB_UTIL_TESTHARNESS_H_


6 
	#STORAGE_LEVELDB_UTIL_TESTHARNESS_H_


	)

8 
	~<¡dio.h
>

9 
	~<¡dlib.h
>

10 
	~<s¡»am
>

11 
	~"Ëv–db/’v.h
"

12 
	~"Ëv–db/¦iû.h
"

13 
	~"ut/¿ndom.h
"

15 
Çme¥aû
 
	gËv–db
 {

16 
Çme¥aû
 
	g‹¡
 {

21 
RunAÎTe¡s
();

24 
¡d
::
¡ršg
 
TmpDœ
();

29 
RªdomS“d
();

33 şas 
	cTe¡”
 {

34 
	g´iv©e
:

35 
boŞ
 
ok_
;

36 cÚ¡ * 
	gâame_
;

37 
	glše_
;

38 
	g¡d
::
¡ršg¡»am
 
ss_
;

40 
	gpublic
:

41 
Te¡”
(cÚ¡ * 
f
, 
l
)

42 : 
ok_
(
Œue
), 
âame_
(
f
), 
lše_
(
l
) {

45 ~
Te¡”
() {

46 ià(!
	gok_
) {

47 
årštf
(
¡d”r
, "%s:%d:%s\n", 
âame_
, 
lše_
, 
ss_
.
¡r
().
c_¡r
());

48 
ex™
(1);

52 
	gTe¡”
& 
Is
(
boŞ
 
b
, cÚ¡ * 
msg
) {

53 ià(!
	gb
) {

54 
	gss_
 << " As£¹iÚ fau» " << 
	gmsg
;

55 
	gok_
 = 
çl£
;

57  *
	gthis
;

60 
	gTe¡”
& 
IsOk
(cÚ¡ 
Stus
& 
s
) {

61 ià(!
	gs
.
ok
()) {

62 
	gss_
 << " " << 
	gs
.
ToSŒšg
();

63 
	gok_
 = 
çl£
;

65  *
	gthis
;

68 
	#BINARY_OP
(
Çme
,
İ
) \

69 
‹m¶©e
 <
şass
 
X
, cÏs 
Y
> \

70 
Te¡”
& 
	`Çme
(cÚ¡ 
X
& 
x
, cÚ¡ 
Y
& 
y
) { \

71 ià(! (
x
 
İ
 
y
)) { \

72 
ss_
 << " faed: " << 
x
 << (" " #İ " "è<< 
y
; \

73 
ok_
 = 
çl£
; \

75  *
this
; \

76 }

	)

78 
BINARY_OP
(
IsEq
, ==)

79 
BINARY_OP
(
IsNe
, !=)

80 
BINARY_OP
(
IsGe
, >=)

81 
BINARY_OP
(
IsGt
, >)

82 
BINARY_OP
(
IsLe
, <=)

83 
BINARY_OP
(
IsLt
, <)

84 #undeà
BINARY_OP


87 
	g‹m¶©e
 <
şass
 
	gV
>

88 
	gTe¡”
& 
	gİ”©Ü
<<(cÚ¡ 
	gV
& 
	gv®ue
) {

89 ià(!
	gok_
) {

90 
	gss_
 << " " << 
	gv®ue
;

92  *
	gthis
;

96 
	#ASSERT_TRUE
(
c
è::
Ëv–db
::
‹¡
::
	`Te¡”
(
__FILE__
, 
__LINE__
).
	`Is
((c), #c)

	)

97 
	#ASSERT_OK
(
s
è::
Ëv–db
::
‹¡
::
	`Te¡”
(
__FILE__
, 
__LINE__
).
	`IsOk
((s))

	)

98 
	#ASSERT_EQ
(
a
,
b
è::
Ëv–db
::
‹¡
::
	`Te¡”
(
__FILE__
, 
__LINE__
).
	`IsEq
(×),(b))

	)

99 
	#ASSERT_NE
(
a
,
b
è::
Ëv–db
::
‹¡
::
	`Te¡”
(
__FILE__
, 
__LINE__
).
	`IsNe
(×),(b))

	)

100 
	#ASSERT_GE
(
a
,
b
è::
Ëv–db
::
‹¡
::
	`Te¡”
(
__FILE__
, 
__LINE__
).
	`IsGe
(×),(b))

	)

101 
	#ASSERT_GT
(
a
,
b
è::
Ëv–db
::
‹¡
::
	`Te¡”
(
__FILE__
, 
__LINE__
).
	`IsGt
(×),(b))

	)

102 
	#ASSERT_LE
(
a
,
b
è::
Ëv–db
::
‹¡
::
	`Te¡”
(
__FILE__
, 
__LINE__
).
	`IsLe
(×),(b))

	)

103 
	#ASSERT_LT
(
a
,
b
è::
Ëv–db
::
‹¡
::
	`Te¡”
(
__FILE__
, 
__LINE__
).
	`IsLt
(×),(b))

	)

105 
	#TCONCAT
(
a
,
b
è
	`TCONCAT1
×,b)

	)

106 
	#TCONCAT1
(
a
,
b
èa##
	)
b

108 
	#TEST
(
ba£
,
Çme
) \

109 
şass
 
	`TCONCAT
(
_Te¡_
,
Çme
è: 
public
 
ba£
 { \

110 
public
: \

111 
	`_Run
(); \

112 
	`_RunIt
() { \

113 
	`TCONCAT
(
_Te¡_
,
Çme
è
t
; \

114 
t
.
	`_Run
(); \

117 
boŞ
 
	`TCONCAT
(
_Te¡_ignÜed_
,
Çme
) = \

118 ::
Ëv–db
::
‹¡
::
	`Regi¡”Te¡
(#ba£, #Çme, &
	`TCONCAT
(
_Te¡_
,
Çme
)::
_RunIt
); \

119 
	`TCONCAT
(
_Te¡_
,
Çme
)::
	`_Run
()

	)

123 
boŞ
 
Regi¡”Te¡
(cÚ¡ * 
ba£
, cÚ¡ * 
Çme
, (*
func
)());

	@util/testutil.cc

5 
	~"ut/‹¡ut.h
"

7 
	~"ut/¿ndom.h
"

9 
Çme¥aû
 
	gËv–db
 {

10 
Çme¥aû
 
	g‹¡
 {

12 
Sliû
 
RªdomSŒšg
(
Rªdom
* 
ºd
, 
Ën
, 
¡d
::
¡ršg
* 
d¡
) {

13 
d¡
->
»size
(
Ën
);

14 
	gi
 = 0; i < 
	gËn
; i++) {

15 (*
	gd¡
)[
i
] = 
¡©ic_ÿ¡
<>(' ' + 
ºd
->
UnifÜm
(95));

17  
Sliû
(*
d¡
);

20 
	g¡d
::
¡ršg
 
RªdomKey
(
Rªdom
* 
ºd
, 
Ën
) {

23 cÚ¡ 
	gkTe¡Ch¬s
[] = {

26 
	g¡d
::
¡ršg
 
»suÉ
;

27 
	gi
 = 0; i < 
	gËn
; i++) {

28 
	g»suÉ
 +ğ
kTe¡Ch¬s
[
ºd
->
UnifÜm
((kTestChars))];

30  
	g»suÉ
;

34 
Sliû
 
Com´essibËSŒšg
(
Rªdom
* 
ºd
, 
com´es£d_äaùiÚ
,

35 
Ën
, 
¡d
::
¡ršg
* 
d¡
) {

36 
¿w
 = 
¡©ic_ÿ¡
<>(
Ën
 * 
com´es£d_äaùiÚ
);

37 ià(
¿w
 < 1)„aw = 1;

38 
¡d
::
¡ršg
 
¿w_d©a
;

39 
RªdomSŒšg
(
ºd
, 
¿w
, &
¿w_d©a
);

42 
d¡
->
ş—r
();

43 
d¡
->
size
(è< 
Ën
) {

44 
d¡
->
­³nd
(
¿w_d©a
);

46 
d¡
->
»size
(
Ën
);

47  
Sliû
(*
d¡
);

	@util/testutil.h

5 #iâdeà
STORAGE_LEVELDB_UTIL_TESTUTIL_H_


6 
	#STORAGE_LEVELDB_UTIL_TESTUTIL_H_


	)

8 
	~"Ëv–db/’v.h
"

9 
	~"Ëv–db/¦iû.h
"

10 
	~"ut/¿ndom.h
"

12 
Çme¥aû
 
	gËv–db
 {

13 
Çme¥aû
 
	g‹¡
 {

17 
Sliû
 
RªdomSŒšg
(
Rªdom
* 
ºd
, 
Ën
, 
¡d
::
¡ršg
* 
d¡
);

21 
¡d
::
¡ršg
 
RªdomKey
(
Rªdom
* 
ºd
, 
Ën
);

26 
Sliû
 
Com´essibËSŒšg
(
Rªdom
* 
ºd
, 
com´es£d_äaùiÚ
,

27 
Ën
, 
¡d
::
¡ršg
* 
d¡
);

30 şas 
	cE¼ÜEnv
 : 
public
 
EnvW¿µ”
 {

31 
public
:

32 
boŞ
 
wr™abË_fe_”rÜ_
;

33 
	gnum_wr™abË_fe_”rÜs_
;

35 
E¼ÜEnv
(è: 
EnvW¿µ”
(
Env
::
DeçuÉ
()),

36 
wr™abË_fe_”rÜ_
(
çl£
),

37 
num_wr™abË_fe_”rÜs_
(0) { }

39 
vœtu®
 
Stus
 
NewWr™abËFe
(cÚ¡ 
¡d
::
¡ršg
& 
âame
,

40 
Wr™abËFe
** 
»suÉ
) {

41 ià(
	gwr™abË_fe_”rÜ_
) {

42 ++
	gnum_wr™abË_fe_”rÜs_
;

43 *
	g»suÉ
 = 
NULL
;

44  
	gStus
::
IOE¼Ü
(
âame
, "fakeƒrror");

46  
rg‘
()->
NewWr™abËFe
(
âame
, 
»suÉ
);

	@
1
.
0
105
1912
db/builder.cc
db/builder.h
db/corruption_test.cc
db/db_bench.cc
db/db_impl.cc
db/db_impl.h
db/db_iter.cc
db/db_iter.h
db/db_test.cc
db/dbformat.cc
db/dbformat.h
db/dbformat_test.cc
db/filename.cc
db/filename.h
db/filename_test.cc
db/log_format.h
db/log_reader.cc
db/log_reader.h
db/log_test.cc
db/log_writer.cc
db/log_writer.h
db/memtable.cc
db/memtable.h
db/repair.cc
db/skiplist.h
db/skiplist_test.cc
db/snapshot.h
db/table_cache.cc
db/table_cache.h
db/version_edit.cc
db/version_edit.h
db/version_edit_test.cc
db/version_set.cc
db/version_set.h
db/write_batch.cc
db/write_batch_internal.h
db/write_batch_test.cc
include/leveldb/cache.h
include/leveldb/comparator.h
include/leveldb/db.h
include/leveldb/env.h
include/leveldb/iterator.h
include/leveldb/options.h
include/leveldb/slice.h
include/leveldb/status.h
include/leveldb/table.h
include/leveldb/table_builder.h
include/leveldb/write_batch.h
port/port.h
port/port_android.cc
port/port_android.h
port/port_chromium.cc
port/port_chromium.h
port/port_example.h
port/port_posix.cc
port/port_posix.h
port/sha1_portable.cc
port/sha1_portable.h
port/sha1_test.cc
port/win/stdint.h
table/block.cc
table/block.h
table/block_builder.cc
table/block_builder.h
table/format.cc
table/format.h
table/iterator.cc
table/iterator_wrapper.h
table/merger.cc
table/merger.h
table/table.cc
table/table_builder.cc
table/table_test.cc
table/two_level_iterator.cc
table/two_level_iterator.h
util/arena.cc
util/arena.h
util/arena_test.cc
util/cache.cc
util/cache_test.cc
util/coding.cc
util/coding.h
util/coding_test.cc
util/comparator.cc
util/crc32c.cc
util/crc32c.h
util/crc32c_test.cc
util/env.cc
util/env_chromium.cc
util/env_posix.cc
util/env_test.cc
util/hash.cc
util/hash.h
util/histogram.cc
util/histogram.h
util/logging.cc
util/logging.h
util/mutexlock.h
util/options.cc
util/random.h
util/status.cc
util/testharness.cc
util/testharness.h
util/testutil.cc
util/testutil.h
